<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Characters — Chronicle & Forge</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d0d0f;--bg2:#13131a;--bg3:#1a1a24;--bg4:#222230;
  --border:#2e2e42;--border2:#3d3d58;
  --gold:#c9a84c;--gold2:#e8c97a;--gold3:#8a6a20;
  --text:#d4d4e8;--text2:#9090aa;--text3:#5a5870;
  --red:#cc5555;--green:#55aa77;--accent:#7b6cee;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:16px;padding:0 0 60px;}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.4;}

/* ── TOPBAR ── */
.topbar{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);background:var(--bg2);position:sticky;top:0;z-index:10;}
.topbar-back{background:none;border:none;color:var(--text2);font-family:'Cinzel',serif;font-size:10px;letter-spacing:.08em;cursor:pointer;padding:4px 0;}
.topbar-back:active{color:var(--gold);}
.topbar-title{font-family:'Cinzel',serif;font-size:13px;color:var(--gold);letter-spacing:.08em;flex:1;}
.btn{padding:6px 12px;border:1px solid var(--border2);background:var(--bg3);color:var(--text);border-radius:3px;font-family:'Cinzel',serif;font-size:10px;letter-spacing:.06em;cursor:pointer;transition:all .15s;white-space:nowrap;}
.btn:active{border-color:var(--gold);color:var(--gold);}
.btn-gold{background:linear-gradient(135deg,var(--gold3),var(--gold));border-color:var(--gold2);color:#1a1200;font-weight:600;}
.btn-sm{padding:4px 9px;font-size:9px;}
.btn-danger{border-color:var(--red);color:var(--red);}

/* ── MODE TABS ── */
.mode-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);background:var(--bg2);}
.mode-tab{flex:1;padding:10px;text-align:center;font-family:'Cinzel',serif;font-size:9px;letter-spacing:.1em;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;}
.mode-tab.active{color:var(--gold);border-bottom-color:var(--gold);}

/* ── CONTENT ── */
.view{display:none;padding:14px;}
.view.active{display:block;}
.section-label{font-family:'Cinzel',serif;font-size:9px;letter-spacing:.15em;color:var(--text3);text-transform:uppercase;margin-bottom:10px;margin-top:16px;}
.section-label:first-child{margin-top:0;}

/* ── CHARACTER CARDS ── */
.char-card{background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--gold3);border-radius:5px;padding:12px 14px;margin-bottom:8px;cursor:pointer;transition:all .15s;}
.char-card:active{border-left-color:var(--gold);}
.char-card-name{font-family:'Cinzel',serif;font-size:13px;color:var(--text);letter-spacing:.04em;margin-bottom:3px;}
.char-card-sub{font-size:12px;color:var(--text3);}
.char-card-stats{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
.char-stat-pip{background:var(--bg3);border:1px solid var(--border);border-radius:3px;padding:3px 8px;font-family:'Cinzel',serif;font-size:9px;color:var(--text2);}
.char-stat-pip span{color:var(--gold);margin-left:3px;}
.empty-state{text-align:center;padding:30px 20px;color:var(--text3);font-style:italic;font-size:14px;}

/* ── TEMPLATE FIELDS ── */
.template-field{background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:11px 13px;margin-bottom:7px;display:flex;align-items:center;gap:10px;}
.template-field-info{flex:1;}
.template-field-name{font-family:'Cinzel',serif;font-size:11px;color:var(--text);letter-spacing:.04em;}
.template-field-type{font-size:11px;color:var(--text3);margin-top:2px;}
.template-field-actions{display:flex;gap:6px;}

/* ── SHEET VIEW ── */
.sheet-header{background:var(--bg2);border:1px solid var(--border);border-top:2px solid var(--gold3);border-radius:5px;padding:14px;margin-bottom:12px;}
.sheet-name-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.sheet-name{font-family:'Cinzel',serif;font-size:18px;color:var(--gold2);flex:1;}
.sheet-stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.stat-block{background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:10px;text-align:center;}
.stat-block-label{font-family:'Cinzel',serif;font-size:8px;letter-spacing:.1em;color:var(--text3);margin-bottom:4px;}
.stat-block-val{font-family:'Cinzel',serif;font-size:22px;color:var(--gold);line-height:1;}
.stat-block-input{background:none;border:none;border-bottom:1px solid var(--border2);color:var(--gold);font-family:'Cinzel',serif;font-size:22px;width:100%;text-align:center;outline:none;padding:2px 0;}
.stat-block-input:focus{border-bottom-color:var(--gold);}
.conditions-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;}
.condition-tag{padding:3px 10px;border-radius:10px;font-family:'Cinzel',serif;font-size:8px;letter-spacing:.08em;border:1px solid var(--border);color:var(--text3);cursor:pointer;transition:all .15s;}
.condition-tag.active{background:rgba(204,85,85,.2);border-color:var(--red);color:var(--red);}
.sheet-section{background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:12px;margin-bottom:8px;}
.sheet-section-title{font-family:'Cinzel',serif;font-size:10px;letter-spacing:.1em;color:var(--text2);text-transform:uppercase;margin-bottom:8px;}
.inventory-item{display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--border);}
.inventory-item:last-child{border-bottom:none;}
.inventory-name{flex:1;font-size:14px;}
.xp-bar-wrap{background:var(--bg3);border:1px solid var(--border);border-radius:3px;height:8px;overflow:hidden;margin-top:6px;}
.xp-bar-fill{height:100%;background:linear-gradient(90deg,var(--gold3),var(--gold));transition:width .5s;}
.notes-area{background:none;border:none;color:var(--text);font-family:'Crimson Pro',serif;font-size:14px;line-height:1.7;resize:none;width:100%;min-height:80px;outline:none;}

/* ── MODAL ── */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:200;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-top:1px solid var(--gold3);border-radius:8px 8px 0 0;width:100%;max-width:600px;max-height:90vh;overflow-y:auto;padding:18px;padding-bottom:calc(18px + env(safe-area-inset-bottom,0));}
.modal h2{font-family:'Cinzel',serif;font-size:14px;color:var(--gold);letter-spacing:.1em;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border);}
.field{margin-bottom:12px;}
label{display:block;font-family:'Cinzel',serif;font-size:9px;letter-spacing:.1em;color:var(--text2);text-transform:uppercase;margin-bottom:5px;}
input[type="text"],input[type="number"],textarea,select{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:3px;font-family:'Crimson Pro',serif;font-size:15px;width:100%;outline:none;}
input:focus,textarea:focus{border-color:var(--gold);}
textarea{resize:vertical;min-height:60px;line-height:1.6;}
select option{background:var(--bg3);}
.modal-actions{display:flex;gap:8px;margin-top:14px;justify-content:space-between;align-items:center;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:var(--bg);}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
</style>
</head>
<body>

<div class="topbar">
  <button class="topbar-back" onclick="goBack()">← Hub</button>
  <div class="topbar-title" id="topTitle">Characters</div>
  <button class="btn btn-sm btn-gold" id="topAddBtn" onclick="topAdd()">+ New</button>
</div>

<div class="mode-tabs">
  <div class="mode-tab active" id="tabSheets" onclick="switchMode('sheets')">Characters</div>
  <div class="mode-tab" id="tabTemplate" onclick="switchMode('template')">Sheet Template</div>
</div>

<!-- ── CHARACTERS VIEW ── -->
<div class="view active" id="view-sheets">
  <div id="charList"></div>
  <div id="charEmpty" class="empty-state" style="display:none;">No characters yet.<br>Tap + New to create one.</div>
</div>

<!-- ── TEMPLATE VIEW ── -->
<div class="view" id="view-template">
  <div class="section-label">Stat Fields</div>
  <div id="templateFields"></div>
  <button class="btn btn-sm" onclick="openAddField()" style="margin-top:4px;">+ Add Stat Field</button>

  <div class="section-label">Conditions</div>
  <div style="background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:12px;">
    <div style="font-size:13px;color:var(--text2);margin-bottom:8px;">Players can toggle these during play.</div>
    <div id="conditionsDisplay" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;"></div>
    <button class="btn btn-sm" onclick="openAddCondition()">+ Add Condition</button>
  </div>

  <div class="section-label">Inventory</div>
  <div style="background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:12px;">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div style="font-size:13px;color:var(--text2);">Slot-based inventory</div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span style="font-family:Cinzel,serif;font-size:9px;color:var(--text3);">MAX SLOTS</span>
        <input type="number" id="maxSlots" min="1" max="20" value="10" style="width:60px;text-align:center;" oninput="saveTemplateQuick()">
      </div>
    </div>
  </div>

  <div class="section-label">XP & Advancement</div>
  <div style="background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:12px;">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div style="font-size:13px;color:var(--text2);">XP to next level</div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span style="font-family:Cinzel,serif;font-size:9px;color:var(--text3);">XP PER LEVEL</span>
        <input type="number" id="xpPerLevel" min="1" max="999" value="10" style="width:70px;text-align:center;" oninput="saveTemplateQuick()">
      </div>
    </div>
  </div>
</div>

<!-- ── CHARACTER SHEET (full view, overlaid) ── -->
<div id="sheetView" style="display:none;padding:14px;">
  <div style="display:flex;gap:8px;margin-bottom:14px;align-items:center;">
    <button class="btn btn-sm" onclick="closeSheet()">← Back</button>
    <span style="font-family:Cinzel,serif;font-size:11px;color:var(--text3);flex:1;" id="sheetLabel">Character</span>
    <button class="btn btn-sm btn-danger" onclick="deleteChar()">Delete</button>
  </div>

  <div class="sheet-header">
    <div class="sheet-name-row">
      <input type="text" id="sheetName" placeholder="Character name…" style="background:none;border:none;border-bottom:1px solid var(--border2);color:var(--gold2);font-family:'Cinzel',serif;font-size:18px;outline:none;flex:1;padding:2px 0;" oninput="autoSaveChar()">
      <input type="text" id="sheetPlayer" placeholder="Player" style="background:none;border:none;border-bottom:1px solid var(--border2);color:var(--text2);font-family:'Crimson Pro',serif;font-size:13px;outline:none;width:90px;text-align:right;padding:2px 0;" oninput="autoSaveChar()">
    </div>
    <div class="sheet-stats-grid" id="sheetStatsGrid"></div>
    <div style="margin-top:10px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
        <span style="font-family:Cinzel,serif;font-size:8px;letter-spacing:.1em;color:var(--text3);">XP</span>
        <span style="font-family:Cinzel,serif;font-size:8px;color:var(--text2);" id="xpLabel">0 / 10</span>
      </div>
      <div class="xp-bar-wrap"><div class="xp-bar-fill" id="xpBar" style="width:0%"></div></div>
      <div style="display:flex;gap:6px;margin-top:6px;">
        <button class="btn btn-sm" onclick="adjustXP(-1)">- XP</button>
        <button class="btn btn-sm" onclick="adjustXP(1)">+ XP</button>
        <span style="font-family:Cinzel,serif;font-size:9px;color:var(--text3);margin-left:auto;align-self:center;" id="levelLabel">Level 1</span>
      </div>
    </div>
    <div style="margin-top:8px;">
      <div style="font-family:Cinzel,serif;font-size:8px;letter-spacing:.1em;color:var(--text3);margin-bottom:6px;">CONDITIONS</div>
      <div class="conditions-row" id="sheetConditions"></div>
    </div>
  </div>

  <div class="sheet-section">
    <div class="sheet-section-title">Inventory (<span id="slotCount">0</span> / <span id="slotMax">10</span>)</div>
    <div id="inventoryList"></div>
    <div style="display:flex;gap:6px;margin-top:8px;">
      <input type="text" id="newItemInput" placeholder="Add item…" style="flex:1;" onkeydown="if(event.key==='Enter')addItem()">
      <button class="btn btn-sm" onclick="addItem()">Add</button>
    </div>
  </div>

  <div class="sheet-section">
    <div class="sheet-section-title">Notes</div>
    <textarea class="notes-area" id="charNotes" placeholder="Character notes, background, goals…" oninput="autoSaveChar()"></textarea>
  </div>
</div>

<!-- FIELD MODAL -->
<div class="modal-overlay" id="modal-field">
  <div class="modal">
    <h2 id="fieldModalTitle">Add Stat Field</h2>
    <div class="field"><label>Field Name</label><input type="text" id="inputFieldName" placeholder="e.g. Strength"></div>
    <div class="field"><label>Type</label>
      <select id="inputFieldType">
        <option value="number">Number (e.g. 0–20)</option>
        <option value="text">Text</option>
        <option value="checkbox">Checkbox (yes/no)</option>
      </select>
    </div>
    <div class="field" id="fieldDefaultWrap"><label>Default Value</label><input type="text" id="inputFieldDefault" placeholder="0"></div>
    <div class="modal-actions">
      <button class="btn btn-danger" id="deleteFieldBtn" style="display:none;" onclick="deleteField()">Delete</button>
      <div style="display:flex;gap:8px;">
        <button class="btn" onclick="closeModal('modal-field')">Cancel</button>
        <button class="btn btn-gold" onclick="saveField()">Save ✦</button>
      </div>
    </div>
  </div>
</div>

<!-- CHAR MODAL -->
<div class="modal-overlay" id="modal-char">
  <div class="modal">
    <h2>New Character</h2>
    <div class="field"><label>Character Name</label><input type="text" id="inputCharName" placeholder="Name…"></div>
    <div class="field"><label>Player Name</label><input type="text" id="inputCharPlayer" placeholder="Player (optional)"></div>
    <div class="modal-actions">
      <div></div>
      <div style="display:flex;gap:8px;">
        <button class="btn" onclick="closeModal('modal-char')">Cancel</button>
        <button class="btn btn-gold" onclick="createChar()">Create ✦</button>
      </div>
    </div>
  </div>
</div>

<!-- CONDITION MODAL -->
<div class="modal-overlay" id="modal-condition">
  <div class="modal">
    <h2>Add Condition</h2>
    <div class="field"><label>Condition Name</label><input type="text" id="inputCondition" placeholder="e.g. Poisoned, Exhausted…"></div>
    <div class="modal-actions">
      <div></div>
      <div style="display:flex;gap:8px;">
        <button class="btn" onclick="closeModal('modal-condition')">Cancel</button>
        <button class="btn btn-gold" onclick="saveCondition()">Add ✦</button>
      </div>
    </div>
  </div>
</div>

<script>
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6);}
function esc(t){return String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function getData(){try{return JSON.parse(localStorage.getItem('chronicle_ttrpg')||'{}');}catch{return {};}}
function saveData(d){localStorage.setItem('chronicle_ttrpg',JSON.stringify(d));}
function getTemplate(){const d=getData();return d.sheet_template||{stats:[],conditions:['Injured','Exhausted','Poisoned'],maxSlots:10,xpPerLevel:10};}
function getChars(){const d=getData();return d.characters||[];}

let currentMode='sheets';
let activeCharId=null;
let editingFieldId=null;
let charSaveTimer=null;

// ── MODE ──
function switchMode(mode){
  currentMode=mode;
  document.querySelectorAll('.mode-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('tab'+mode.charAt(0).toUpperCase()+mode.slice(1)).classList.add('active');
  document.getElementById('view-'+mode).classList.add('active');
  document.getElementById('sheetView').style.display='none';
  if(mode==='sheets'){renderChars();document.getElementById('topAddBtn').textContent='+ New';document.getElementById('topTitle').textContent='Characters';}
  else{renderTemplate();document.getElementById('topAddBtn').textContent='+ Stat';document.getElementById('topTitle').textContent='Sheet Template';}
}
function topAdd(){if(currentMode==='sheets')openModal('modal-char');else openAddField();}
function goBack(){if(window.parent&&window.parent!==window){window.parent.postMessage({type:'navigate',module:'rpg.html'},'*');}else{window.location.href='rpg.html';}}

// ── CHARACTERS ──
function renderChars(){
  const chars=getChars();const tmpl=getTemplate();
  const list=document.getElementById('charList');const empty=document.getElementById('charEmpty');
  if(!chars.length){list.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  list.innerHTML=chars.map(c=>{
    const statPips=(tmpl.stats||[]).slice(0,4).map(s=>`<div class="char-stat-pip">${esc(s.label||s.name)}<span>${c.stats&&c.stats[s.id]!==undefined?c.stats[s.id]:s.defaultValue||0}</span></div>`).join('');
    return `<div class="char-card" onclick="openSheet('${c.id}')">
      <div class="char-card-name">${esc(c.name||'Unnamed')}</div>
      <div class="char-card-sub">${esc(c.player?'Player: '+c.player:'')} ${c.level?'· Lv '+c.level:''}</div>
      ${statPips?`<div class="char-card-stats">${statPips}</div>`:''}
    </div>`;
  }).join('');
}

function createChar(){
  const name=document.getElementById('inputCharName').value.trim();
  if(!name)return;
  const player=document.getElementById('inputCharPlayer').value.trim();
  const tmpl=getTemplate();
  const stats={};(tmpl.stats||[]).forEach(s=>{stats[s.id]=s.type==='number'?parseInt(s.defaultValue||0):s.defaultValue||'';});
  const d=getData();
  if(!d.characters)d.characters=[];
  d.characters.push({id:uid(),name,player,stats,inventory:[],conditions:[],notes:'',xp:0,level:1,created:Date.now()});
  saveData(d);closeModal('modal-char');renderChars();
  document.getElementById('inputCharName').value='';document.getElementById('inputCharPlayer').value='';
}

// ── SHEET ──
function openSheet(id){
  activeCharId=id;
  const d=getData();const char=d.characters.find(c=>c.id===id);if(!char)return;
  const tmpl=getTemplate();
  document.getElementById('view-sheets').classList.remove('active');
  document.getElementById('sheetView').style.display='block';
  document.getElementById('sheetLabel').textContent=char.name||'Character';
  document.getElementById('sheetName').value=char.name||'';
  document.getElementById('sheetPlayer').value=char.player||'';
  document.getElementById('charNotes').value=char.notes||'';
  renderSheetStats(char,tmpl);renderSheetConditions(char,tmpl);renderInventory(char,tmpl);updateXP(char,tmpl);
}
function closeSheet(){
  activeCharId=null;
  document.getElementById('sheetView').style.display='none';
  document.getElementById('view-sheets').classList.add('active');
  renderChars();
}
function renderSheetStats(char,tmpl){
  const grid=document.getElementById('sheetStatsGrid');
  grid.innerHTML=(tmpl.stats||[]).map(s=>{
    const val=char.stats&&char.stats[s.id]!==undefined?char.stats[s.id]:s.defaultValue||0;
    if(s.type==='checkbox'){
      return `<div class="stat-block"><div class="stat-block-label">${esc(s.label||s.name)}</div>
        <input type="checkbox" ${val?'checked':''} onchange="updateStat('${s.id}',this.checked)" style="transform:scale(1.4);margin-top:4px;accent-color:var(--gold);">
      </div>`;
    }
    return `<div class="stat-block"><div class="stat-block-label">${esc(s.label||s.name)}</div>
      <input class="stat-block-input" type="${s.type==='number'?'number':'text'}" value="${esc(val)}" oninput="updateStat('${s.id}',this.value)">
    </div>`;
  }).join('');
}
function renderSheetConditions(char,tmpl){
  const el=document.getElementById('sheetConditions');
  const active=char.conditions||[];
  el.innerHTML=(tmpl.conditions||[]).map(c=>`<div class="condition-tag${active.includes(c)?' active':''}" onclick="toggleCondition('${esc(c)}')">${esc(c)}</div>`).join('');
}
function renderInventory(char,tmpl){
  const items=char.inventory||[];
  const max=tmpl.maxSlots||10;
  document.getElementById('slotCount').textContent=items.length;
  document.getElementById('slotMax').textContent=max;
  document.getElementById('inventoryList').innerHTML=items.map((item,i)=>
    `<div class="inventory-item"><span class="inventory-name">${esc(item)}</span><button style="background:none;border:none;color:var(--red);cursor:pointer;font-size:16px;" onclick="removeItem(${i})">×</button></div>`
  ).join('');
}
function updateXP(char,tmpl){
  const xpPerLvl=tmpl.xpPerLevel||10;
  const xp=char.xp||0;const lvl=char.level||1;
  const progress=(xp%xpPerLvl)/xpPerLvl*100;
  document.getElementById('xpBar').style.width=progress+'%';
  document.getElementById('xpLabel').textContent=`${xp%xpPerLvl} / ${xpPerLvl}`;
  document.getElementById('levelLabel').textContent=`Level ${lvl}`;
}
function updateStat(statId,val){
  const d=getData();const c=d.characters.find(x=>x.id===activeCharId);if(!c)return;
  if(!c.stats)c.stats={};c.stats[statId]=val;
  saveData(d);scheduleCharSave();
}
function toggleCondition(cond){
  const d=getData();const c=d.characters.find(x=>x.id===activeCharId);if(!c)return;
  if(!c.conditions)c.conditions=[];
  const idx=c.conditions.indexOf(cond);
  if(idx>=0)c.conditions.splice(idx,1);else c.conditions.push(cond);
  saveData(d);renderSheetConditions(c,getTemplate());
}
function addItem(){
  const inp=document.getElementById('newItemInput');const val=inp.value.trim();if(!val)return;
  const d=getData();const c=d.characters.find(x=>x.id===activeCharId);if(!c)return;
  if(!c.inventory)c.inventory=[];c.inventory.push(val);
  inp.value='';saveData(d);renderInventory(c,getTemplate());
}
function removeItem(i){
  const d=getData();const c=d.characters.find(x=>x.id===activeCharId);if(!c)return;
  c.inventory.splice(i,1);saveData(d);renderInventory(c,getTemplate());
}
function adjustXP(delta){
  const d=getData();const c=d.characters.find(x=>x.id===activeCharId);if(!c)return;
  const tmpl=getTemplate();const xpPerLvl=tmpl.xpPerLevel||10;
  c.xp=Math.max(0,(c.xp||0)+delta);
  const newLvl=Math.floor(c.xp/xpPerLvl)+1;
  if(newLvl>c.level){c.level=newLvl;}
  saveData(d);updateXP(c,tmpl);
}
function autoSaveChar(){scheduleCharSave();}
function scheduleCharSave(){clearTimeout(charSaveTimer);charSaveTimer=setTimeout(()=>{
  if(!activeCharId)return;
  const d=getData();const c=d.characters.find(x=>x.id===activeCharId);if(!c)return;
  c.name=document.getElementById('sheetName').value.trim();
  c.player=document.getElementById('sheetPlayer').value.trim();
  c.notes=document.getElementById('charNotes').value;
  saveData(d);document.getElementById('sheetLabel').textContent=c.name||'Character';
},800);}
function deleteChar(){
  if(!activeCharId||!confirm('Delete this character?'))return;
  const d=getData();d.characters=(d.characters||[]).filter(c=>c.id!==activeCharId);
  saveData(d);closeSheet();
}

// ── TEMPLATE ──
function renderTemplate(){
  const tmpl=getTemplate();
  document.getElementById('maxSlots').value=tmpl.maxSlots||10;
  document.getElementById('xpPerLevel').value=tmpl.xpPerLevel||10;
  const fields=document.getElementById('templateFields');
  if(!(tmpl.stats||[]).length){fields.innerHTML='<div class="empty-state" style="padding:16px;">No stat fields yet. Add one to design your sheet.</div>';return;}
  fields.innerHTML=tmpl.stats.map(s=>`
    <div class="template-field">
      <div class="template-field-info">
        <div class="template-field-name">${esc(s.label||s.name)}</div>
        <div class="template-field-type">${s.type} · default: ${esc(s.defaultValue||'0')}</div>
      </div>
      <div class="template-field-actions">
        <button class="btn btn-sm" onclick="openEditField('${s.id}')">Edit</button>
      </div>
    </div>`).join('');
  const conds=document.getElementById('conditionsDisplay');
  conds.innerHTML=(tmpl.conditions||[]).map((c,i)=>`<div class="condition-tag" style="cursor:default;">${esc(c)} <span onclick="removeCondition(${i})" style="cursor:pointer;color:var(--red);margin-left:4px;">×</span></div>`).join('');
}
function saveTemplateQuick(){
  const d=getData();if(!d.sheet_template)d.sheet_template={stats:[],conditions:[],maxSlots:10,xpPerLevel:10};
  d.sheet_template.maxSlots=parseInt(document.getElementById('maxSlots').value)||10;
  d.sheet_template.xpPerLevel=parseInt(document.getElementById('xpPerLevel').value)||10;
  saveData(d);
}

// ── FIELDS ──
function openAddField(){editingFieldId=null;document.getElementById('fieldModalTitle').textContent='Add Stat Field';document.getElementById('inputFieldName').value='';document.getElementById('inputFieldType').value='number';document.getElementById('inputFieldDefault').value='0';document.getElementById('deleteFieldBtn').style.display='none';openModal('modal-field');}
function openEditField(id){
  const tmpl=getTemplate();const f=tmpl.stats.find(s=>s.id===id);if(!f)return;
  editingFieldId=id;document.getElementById('fieldModalTitle').textContent='Edit Stat Field';
  document.getElementById('inputFieldName').value=f.label||f.name;document.getElementById('inputFieldType').value=f.type;document.getElementById('inputFieldDefault').value=f.defaultValue||'';
  document.getElementById('deleteFieldBtn').style.display='inline-block';openModal('modal-field');
}
function saveField(){
  const name=document.getElementById('inputFieldName').value.trim();if(!name)return;
  const type=document.getElementById('inputFieldType').value;
  const def=document.getElementById('inputFieldDefault').value.trim();
  const d=getData();if(!d.sheet_template)d.sheet_template={stats:[],conditions:[],maxSlots:10,xpPerLevel:10};
  if(editingFieldId){const f=d.sheet_template.stats.find(s=>s.id===editingFieldId);if(f){f.label=name;f.name=name;f.type=type;f.defaultValue=def;}}
  else{d.sheet_template.stats.push({id:uid(),name,label:name,type,defaultValue:def});}
  saveData(d);closeModal('modal-field');renderTemplate();
}
function deleteField(){
  if(!editingFieldId)return;const d=getData();
  d.sheet_template.stats=(d.sheet_template.stats||[]).filter(s=>s.id!==editingFieldId);
  saveData(d);closeModal('modal-field');renderTemplate();
}
function openAddCondition(){document.getElementById('inputCondition').value='';openModal('modal-condition');}
function saveCondition(){
  const name=document.getElementById('inputCondition').value.trim();if(!name)return;
  const d=getData();if(!d.sheet_template)d.sheet_template={stats:[],conditions:[],maxSlots:10,xpPerLevel:10};
  if(!d.sheet_template.conditions)d.sheet_template.conditions=[];
  d.sheet_template.conditions.push(name);saveData(d);closeModal('modal-condition');renderTemplate();
}
function removeCondition(i){
  const d=getData();if(!d.sheet_template)return;
  d.sheet_template.conditions.splice(i,1);saveData(d);renderTemplate();
}

// ── MODAL ──
function openModal(id){document.getElementById(id).classList.add('open');document.body.style.overflow='hidden';}
function closeModal(id){document.getElementById(id).classList.remove('open');document.body.style.overflow='';}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)closeModal(o.id);}));

// ── INIT ──
renderChars();
document.addEventListener('visibilitychange',()=>{if(!document.hidden&&!activeCharId)renderChars();});
</script>
</body>
</html>
