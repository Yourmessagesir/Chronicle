<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d0d0f">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Chronicle</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
:root{--bg:#0d0d0f;--bg2:#13131a;--bg3:#1a1a24;--bg4:#222230;--border:#2e2e42;--border2:#3d3d58;--gold:#c9a84c;--gold2:#e8c97a;--text:#d4d4e8;--text2:#9090aa;--accent:#7b6cee;--accent2:#a99bff;--red:#cc5555;--green:#55aa77;--amber:#cc8844;}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:16px;min-height:100vh;overflow-x:hidden;-webkit-tap-highlight-color:transparent;}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.4;}

/* LOCK SCREEN */
#lockScreen{position:fixed;inset:0;background:var(--bg);z-index:5000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:20px;}
#lockScreen h1{font-family:'Cinzel',serif;font-size:28px;color:var(--gold);letter-spacing:0.2em;text-shadow:0 0 40px rgba(201,168,76,0.4);}
#lockSubtitle{font-size:13px;color:var(--text2);letter-spacing:0.05em;}
.pin-dots{display:flex;gap:14px;}
.pin-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--border2);background:transparent;transition:all 0.15s;}
.pin-dot.filled{background:var(--gold);border-color:var(--gold);box-shadow:0 0 10px rgba(201,168,76,0.5);}
.pin-pad{display:grid;grid-template-columns:repeat(3,72px);gap:12px;}
.pin-btn{width:72px;height:72px;border-radius:50%;background:var(--bg3);border:1px solid var(--border2);color:var(--text);font-family:'Cinzel',serif;font-size:20px;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center;}
.pin-btn:active{background:var(--bg4);border-color:var(--gold);color:var(--gold);transform:scale(0.95);}
.pin-btn.del{font-size:16px;color:var(--text2);}
.pin-btn.bio-icon{font-size:22px;}
.pin-error{color:var(--red);font-family:'Cinzel',serif;font-size:12px;letter-spacing:0.1em;min-height:18px;text-align:center;}
#lockSetupMsg{font-size:12px;color:var(--text2);text-align:center;max-width:240px;line-height:1.6;display:none;}

/* NAV */
nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg2);border-top:1px solid var(--border);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom,0);}
nav button{flex:1;background:none;border:none;color:var(--text2);padding:10px 2px 8px;font-family:'Cinzel',serif;font-size:7.5px;letter-spacing:0.05em;text-transform:uppercase;cursor:pointer;transition:color 0.2s;display:flex;flex-direction:column;align-items:center;gap:3px;}
nav button svg{width:18px;height:18px;}
nav button.active{color:var(--gold);}

/* HEADER */
header{background:linear-gradient(180deg,#0d0d0f 0%,var(--bg2) 100%);border-bottom:1px solid var(--border);padding:14px 16px 10px;position:sticky;top:0;z-index:50;}
header h1{font-family:'Cinzel',serif;font-size:20px;font-weight:600;color:var(--gold);letter-spacing:0.15em;text-shadow:0 0 30px rgba(201,168,76,0.3);}
header p{font-size:11px;color:var(--text2);letter-spacing:0.05em;margin-top:1px;}

/* SECTIONS */
.section{display:none;padding:16px 14px 100px;}
.section.active{display:block;}

/* CARDS */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:16px;margin-bottom:12px;position:relative;}
.card::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(180deg,var(--gold),transparent);border-radius:4px 0 0 4px;}

/* BUTTONS */
.btn{background:var(--bg3);border:1px solid var(--border2);color:var(--text);padding:8px 14px;border-radius:3px;font-family:'Cinzel',serif;font-size:11px;letter-spacing:0.08em;cursor:pointer;transition:all 0.2s;}
.btn:hover,.btn:active{background:var(--bg4);border-color:var(--gold);color:var(--gold);}
.btn-gold{background:linear-gradient(135deg,#8a6a20,var(--gold));border-color:var(--gold2);color:#1a1200;font-weight:600;}
.btn-gold:hover{filter:brightness(1.1);color:#1a1200;}
.btn-danger{border-color:var(--red);color:var(--red);}

/* INPUTS */
input[type="text"],input[type="date"],input[type="password"],input[type="time"],textarea,select{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:3px;font-family:'Crimson Pro',serif;font-size:15px;width:100%;outline:none;transition:border-color 0.2s;}
input:focus,textarea:focus,select:focus{border-color:var(--gold);}
select option{background:var(--bg3);}
textarea{resize:vertical;min-height:80px;}
label{display:block;font-size:11px;letter-spacing:0.08em;color:var(--text2);font-family:'Cinzel',serif;text-transform:uppercase;margin-bottom:4px;}
.field{margin-bottom:12px;}

/* DIVIDER */
.divider{display:flex;align-items:center;gap:12px;margin:16px 0;color:var(--text2);font-family:'Cinzel',serif;font-size:11px;letter-spacing:0.15em;}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border);}

/* TOGGLE */
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;}
.toggle-label{font-family:'Cinzel',serif;font-size:11px;color:var(--text2);letter-spacing:0.06em;}
.toggle{position:relative;width:44px;height:24px;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;inset:0;background:var(--bg4);border-radius:12px;cursor:pointer;transition:0.2s;border:1px solid var(--border2);}
.toggle-slider::before{content:'';position:absolute;width:18px;height:18px;left:2px;top:2px;background:var(--text2);border-radius:50%;transition:0.2s;}
.toggle input:checked+.toggle-slider{background:var(--gold);border-color:var(--gold2);}
.toggle input:checked+.toggle-slider::before{transform:translateX(20px);background:#1a1200;}

/* CALENDAR */
.week-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.week-nav h2{font-family:'Cinzel',serif;font-size:13px;color:var(--gold);letter-spacing:0.08em;text-align:center;flex:1;}
.day-card{background:var(--bg2);border:1px solid var(--border);border-radius:4px;margin-bottom:8px;overflow:hidden;}
.day-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg3);cursor:pointer;user-select:none;}
.day-header-left{display:flex;align-items:center;gap:10px;}
.day-name{font-family:'Cinzel',serif;font-size:12px;letter-spacing:0.1em;color:var(--gold2);}
.day-date{font-size:12px;color:var(--text2);}
.day-badge{background:var(--accent);color:white;border-radius:10px;padding:1px 7px;font-size:10px;font-family:'Cinzel',serif;}
.day-body{padding:12px 14px;display:none;}
.day-body.open{display:block;}
.entry-item{display:flex;align-items:flex-start;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);}
.entry-item:last-child{border-bottom:none;}
.entry-time{font-family:'Cinzel',serif;font-size:10px;color:var(--text2);min-width:40px;padding-top:3px;}
.entry-text{flex:1;font-size:15px;color:var(--text);line-height:1.4;}
.entry-bell{background:none;border:none;cursor:pointer;padding:0 2px;font-size:13px;line-height:1;opacity:0.4;transition:opacity 0.2s;}
.entry-bell.on{opacity:1;}
.entry-badge{font-size:9px;padding:1px 5px;border-radius:10px;font-family:'Cinzel',serif;white-space:nowrap;}
.badge-routine{background:rgba(201,168,76,0.15);color:var(--gold);border:1px solid rgba(201,168,76,0.3);}
.badge-note{background:rgba(123,108,238,0.15);color:var(--accent2);border:1px solid rgba(123,108,238,0.3);}
.entry-delete{background:none;border:none;color:var(--text2);cursor:pointer;padding:0 2px;font-size:16px;line-height:1;transition:color 0.2s;}
.entry-delete:hover{color:var(--red);}
.day-card.today .day-name{color:var(--accent2);}
.day-card.today .day-header{background:#1a1620;}
.chevron{transition:transform 0.2s;color:var(--text2);font-size:12px;}
.chevron.open{transform:rotate(90deg);}

/* PERSONA */
.persona-active-card{background:linear-gradient(135deg,#1a1624 0%,#141020 100%);border:1px solid var(--accent);border-radius:6px;padding:20px;margin-bottom:16px;position:relative;overflow:hidden;}
.persona-active-card::after{content:'';position:absolute;top:-40px;right:-40px;width:140px;height:140px;background:radial-gradient(circle,rgba(123,108,238,0.12) 0%,transparent 70%);pointer-events:none;}
.persona-name{font-family:'Cinzel',serif;font-size:20px;font-weight:600;color:var(--accent2);letter-spacing:0.1em;margin-bottom:4px;}
.persona-class{font-size:13px;color:var(--text2);font-style:italic;margin-bottom:16px;}
.stat-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.stat-label{font-family:'Cinzel',serif;font-size:10px;letter-spacing:0.08em;color:var(--text2);min-width:90px;text-transform:uppercase;}
.stat-bar-bg{flex:1;height:6px;background:var(--bg4);border-radius:3px;overflow:hidden;}
.stat-bar-fill{height:100%;border-radius:3px;transition:width 0.5s ease;}
.stat-value{font-family:'Cinzel',serif;font-size:11px;color:var(--text);min-width:28px;text-align:right;}
.persona-list-item{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;margin-bottom:8px;}
.pill-active{background:rgba(123,108,238,0.2);color:var(--accent2);border:1px solid rgba(123,108,238,0.4);padding:2px 8px;border-radius:10px;font-family:'Cinzel',serif;font-size:9px;letter-spacing:0.08em;}

/* PEOPLE */
.person-card{background:var(--bg2);border:1px solid var(--border);border-radius:4px;margin-bottom:10px;overflow:hidden;}
.person-header{display:flex;align-items:center;gap:12px;padding:14px;cursor:pointer;}
.person-avatar{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--bg4),var(--bg3));border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;font-family:'Cinzel',serif;font-size:16px;color:var(--gold);flex-shrink:0;}
.person-body{padding:0 14px 14px;display:none;}
.person-body.open{display:block;}
.info-tag{display:inline-block;background:var(--bg3);border:1px solid var(--border);border-radius:3px;padding:2px 8px;font-size:12px;color:var(--text);margin:2px;}
.section-label{font-family:'Cinzel',serif;font-size:10px;letter-spacing:0.12em;color:var(--gold);text-transform:uppercase;margin:12px 0 6px;display:flex;align-items:center;gap:8px;}
.section-label::after{content:'';flex:1;height:1px;background:var(--border);}
.tag-list{display:flex;flex-wrap:wrap;gap:4px;}

/* BOOK */
.book-meta{background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:16px;margin-bottom:14px;}
.book-cover-img{width:100%;max-height:180px;object-fit:cover;border-radius:4px;margin-bottom:12px;border:1px solid var(--border);}
.chapter-item{background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:border-color 0.2s;}
.chapter-item:hover{border-color:var(--gold);}
.chapter-num{font-family:'Cinzel',serif;font-size:10px;color:var(--text2);letter-spacing:0.1em;}
.chapter-title-text{font-family:'Cinzel',serif;font-size:14px;color:var(--text);}
.book-editor-area{display:none;}
.book-editor-area.active{display:block;}
.book-editor-area textarea{min-height:55vh;font-size:16px;line-height:1.9;font-family:'Crimson Pro',serif;}
.full-view-content{background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:20px;line-height:1.9;font-size:17px;white-space:pre-wrap;word-break:break-word;}
.full-view-content .ch-heading{font-family:'Cinzel',serif;font-size:15px;color:var(--gold);margin:24px 0 12px;letter-spacing:0.1em;border-bottom:1px solid var(--border);padding-bottom:8px;}

/* PASSWORDS */
.pw-entry{background:var(--bg2);border:1px solid var(--border);border-radius:4px;margin-bottom:8px;overflow:hidden;}
.pw-entry-header{display:flex;align-items:center;gap:12px;padding:12px 14px;cursor:pointer;}
.pw-site-icon{width:36px;height:36px;border-radius:8px;background:var(--bg4);border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;font-family:'Cinzel',serif;font-size:15px;color:var(--gold);flex-shrink:0;}
.pw-body{padding:0 14px 14px;display:none;}
.pw-body.open{display:block;}
.pw-field-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;}
.pw-field-label{font-family:'Cinzel',serif;font-size:10px;color:var(--text2);letter-spacing:0.08em;min-width:72px;}
.pw-field-val{flex:1;font-size:14px;color:var(--text);word-break:break-all;min-width:80px;}
.pw-copy{background:none;border:1px solid var(--border);border-radius:3px;color:var(--text2);padding:3px 10px;font-size:10px;font-family:'Cinzel',serif;cursor:pointer;transition:all 0.2s;white-space:nowrap;}
.pw-copy:hover{border-color:var(--gold);color:var(--gold);}
.pw-reveal{background:none;border:none;color:var(--text2);cursor:pointer;font-size:15px;padding:2px 4px;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:200;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:8px 8px 0 0;width:100%;max-width:600px;max-height:92vh;overflow-y:auto;padding:20px;padding-bottom:calc(20px + env(safe-area-inset-bottom,0));}
.modal h2{font-family:'Cinzel',serif;font-size:16px;color:var(--gold);letter-spacing:0.1em;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);}
.modal-actions{display:flex;gap:8px;margin-top:16px;justify-content:flex-end;}

/* MISC */
input[type="range"]{-webkit-appearance:none;width:100%;height:4px;background:var(--bg4);border-radius:2px;outline:none;cursor:pointer;}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;background:var(--accent2);border-radius:50%;box-shadow:0 0 8px rgba(123,108,238,0.5);}
.row{display:flex;gap:8px;}.row>*{flex:1;}
.empty-state{text-align:center;padding:32px 16px;color:var(--text2);font-style:italic;font-size:15px;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:var(--bg);}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:var(--green);color:#fff;padding:8px 20px;border-radius:20px;font-family:'Cinzel',serif;font-size:12px;z-index:9000;transition:opacity 0.4s;pointer-events:none;}
</style>
</head>
<body>

<!-- â•â•â• LOCK SCREEN â•â•â• -->
<div id="lockScreen">
  <h1>CHRONICLE</h1>
  <p id="lockSubtitle">Enter your PIN</p>
  <div class="pin-dots">
    <div class="pin-dot" id="d0"></div><div class="pin-dot" id="d1"></div>
    <div class="pin-dot" id="d2"></div><div class="pin-dot" id="d3"></div>
  </div>
  <div class="pin-error" id="pinError"></div>
  <div class="pin-pad">
    <button class="pin-btn" onclick="pinPress('1')">1</button>
    <button class="pin-btn" onclick="pinPress('2')">2</button>
    <button class="pin-btn" onclick="pinPress('3')">3</button>
    <button class="pin-btn" onclick="pinPress('4')">4</button>
    <button class="pin-btn" onclick="pinPress('5')">5</button>
    <button class="pin-btn" onclick="pinPress('6')">6</button>
    <button class="pin-btn" onclick="pinPress('7')">7</button>
    <button class="pin-btn" onclick="pinPress('8')">8</button>
    <button class="pin-btn" onclick="pinPress('9')">9</button>
    <button class="pin-btn bio-icon" id="bioPadBtn" onclick="pinPress('bio')" style="display:none;">â¬¡</button>
    <button class="pin-btn" onclick="pinPress('0')" id="zeroBtn">0</button>
    <button class="pin-btn del" onclick="pinPress('del')">âŒ«</button>
  </div>
  <div id="lockSetupMsg"></div>
</div>

<!-- â•â•â• APP SHELL â•â•â• -->
<div id="appShell" style="display:none;">
<header>
  <div style="display:flex;align-items:center;justify-content:space-between;">
    <div><h1>CHRONICLE</h1><p id="headerSub">Your personal tome</p></div>
    <button class="btn" style="font-size:10px;padding:5px 10px;display:flex;align-items:center;gap:5px;" onclick="openModal('modal-backup')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Backup
    </button>
  </div>
</header>

<!-- CALENDAR -->
<section class="section active" id="sec-calendar">
  <div class="week-nav">
    <button class="btn" onclick="changeWeek(-1)">â—€</button>
    <h2 id="weekLabel"></h2>
    <button class="btn" onclick="changeWeek(1)">â–¶</button>
  </div>
  <button class="btn btn-gold" style="width:100%;margin-bottom:14px;" onclick="openAddEntry()">+ Add Entry</button>
  <div id="calendarDays"></div>
</section>

<!-- PERSONA -->
<section class="section" id="sec-persona">
  <div id="activePersonaArea"></div>
  <div class="divider">All Personas</div>
  <div id="personaList"></div>
  <button class="btn btn-gold" style="width:100%;margin-top:8px;" onclick="openAddPersona()">+ New Persona</button>
</section>

<!-- PEOPLE -->
<section class="section" id="sec-people">
  <button class="btn btn-gold" style="width:100%;margin-bottom:14px;" onclick="openAddPerson()">+ Add Person</button>
  <div id="peopleList"></div>
</section>

<!-- BOOK -->
<section class="section" id="sec-book">
  <div id="bookMainView">
    <div class="book-meta" id="bookMetaCard">
      <div id="bookCoverWrap"></div>
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <div style="font-family:'Cinzel',serif;font-size:18px;color:var(--gold);letter-spacing:0.1em;" id="bookTitleDisplay">My Book</div>
          <div style="font-size:13px;color:var(--text2);font-style:italic;margin-top:2px;" id="bookSubDisplay"></div>
        </div>
        <button class="btn" style="font-size:10px;padding:4px 10px;" onclick="openBookSettings()">Edit Info</button>
      </div>
      <div style="margin-top:8px;" id="bookStatsDisplay"></div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <button class="btn btn-gold" onclick="openAddChapter()" style="flex:1;">+ New Chapter</button>
      <button class="btn" onclick="toggleFullView()" id="fullViewBtn" style="flex:1;">Full View</button>
    </div>
    <div id="chapterListEl"></div>
    <div id="fullViewArea" style="display:none;">
      <button class="btn" style="width:100%;margin-bottom:12px;" onclick="toggleFullView()">â† Chapter List</button>
      <div class="full-view-content" id="fullViewContent"></div>
    </div>
  </div>
  <div class="book-editor-area" id="bookEditorEl">
    <div style="display:flex;gap:8px;margin-bottom:14px;">
      <button class="btn" onclick="closeEditor()" style="flex:1;">â† Back</button>
      <button class="btn btn-gold" onclick="saveChapter()" style="flex:1;">Save</button>
    </div>
    <div class="field"><label>Chapter Title</label><input type="text" id="chapterTitleInput" placeholder="Chapter title..."></div>
    <div class="field"><label>Write</label><textarea id="chapterContentInput" placeholder="Your story begins here..."></textarea></div>
    <div id="chapterWordCount" style="font-family:'Cinzel',serif;font-size:10px;color:var(--text2);text-align:right;margin-top:4px;"></div>
    <button class="btn btn-danger" id="deleteChapterBtn" style="width:100%;margin-top:12px;display:none;" onclick="deleteChapter()">Delete Chapter</button>
  </div>
</section>

<!-- PASSWORDS -->
<section class="section" id="sec-passwords">
  <div id="pwLockedMsg" style="text-align:center;padding:40px 16px;">
    <div style="font-size:52px;margin-bottom:16px;">ğŸ”</div>
    <p style="color:var(--text2);font-style:italic;margin-bottom:20px;line-height:1.6;">Password vault is sealed.<br>Authenticate to enter.</p>
    <button class="btn btn-gold" style="padding:12px 28px;" onclick="unlockVault()">Unlock Vault</button>
  </div>
  <div id="pwVaultEl" style="display:none;">
    <button class="btn btn-gold" style="width:100%;margin-bottom:14px;" onclick="openAddPassword()">+ Add Password</button>
    <div id="pwListEl"></div>
    <button class="btn btn-danger" style="width:100%;margin-top:16px;" onclick="lockVault()">ğŸ”’ Lock Vault</button>
  </div>
</section>

<!-- NAV -->
<nav>
  <button class="active" onclick="showSection('calendar')" id="nav-calendar">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="16" y1="2" x2="16" y2="6"/></svg>
    Calendar
  </button>
  <button onclick="showSection('persona')" id="nav-persona">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>
    Persona
  </button>
  <button onclick="showSection('people')" id="nav-people">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="9" cy="7" r="3"/><path d="M2 19c0-3.3 3.1-6 7-6s7 2.7 7 6"/><circle cx="17" cy="7" r="2"/><path d="M22 19c0-2.2-2.1-4-5-4"/></svg>
    People
  </button>
  <button onclick="showSection('book')" id="nav-book">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
    Book
  </button>
  <button onclick="showSection('passwords')" id="nav-passwords">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/><circle cx="12" cy="16" r="1" fill="currentColor"/></svg>
    Vault
  </button>
</nav>
</div>

<!-- â•â•â• MODALS â•â•â• -->

<!-- BACKUP -->
<div class="modal-overlay" id="modal-backup">
  <div class="modal">
    <h2>âš” Backup &amp; Settings</h2>
    <div class="divider">Export</div>
    <div class="field">
      <label>Encryption Password (optional)</label>
      <div style="position:relative;">
        <input type="password" id="exportPassword" placeholder="Leave blank for plain JSON" oninput="checkExportStrength()">
        <button onclick="togglePwVis('exportPassword',this)" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text2);cursor:pointer;font-size:11px;font-family:'Cinzel',serif;">SHOW</button>
      </div>
    </div>
    <div id="exportStrength" style="font-size:12px;height:16px;margin-top:-8px;margin-bottom:10px;padding-left:2px;"></div>
    <button class="btn btn-gold" style="width:100%;" onclick="doExport()">â†“ Download Backup</button>
    <div class="divider">Import</div>
    <p style="font-size:13px;color:var(--amber);margin-bottom:10px;">âš  Merges with existing data. IDs deduplicated.</p>
    <div class="field"><label>Backup File</label><input type="file" id="importFile" accept=".json" style="padding:6px;color:var(--text);"></div>
    <div class="field"><label>Password (if encrypted)</label><input type="password" id="importPassword" placeholder="Leave blank if unencrypted"></div>
    <button class="btn btn-gold" style="width:100%;" onclick="doImport()">â†‘ Import</button>
    <div id="importStatus" style="margin-top:10px;font-size:13px;text-align:center;min-height:18px;font-family:'Cinzel',serif;"></div>
    <div class="divider">Security</div>
    <button class="btn" style="width:100%;margin-bottom:10px;" onclick="openPinSetup()">ğŸ”‘ Change PIN</button>
    <div class="toggle-row">
      <span class="toggle-label">Biometric Unlock (fingerprint/face)</span>
      <label class="toggle"><input type="checkbox" id="bioToggle" onchange="toggleBio()"><span class="toggle-slider"></span></label>
    </div>
    <div class="divider">Danger Zone</div>
    <button class="btn btn-danger" style="width:100%;" onclick="clearAllData()">âœ• Clear All Data</button>
    <div class="modal-actions"><button class="btn" onclick="closeModal('modal-backup')">Close</button></div>
  </div>
</div>

<!-- PIN SETUP -->
<div class="modal-overlay" id="modal-pin-setup">
  <div class="modal">
    <h2>Change PIN</h2>
    <p style="font-size:14px;color:var(--text2);margin-bottom:16px;">Choose a 4-digit PIN to lock Chronicle on startup and when you leave the app.</p>
    <div class="field"><label>New PIN</label><input type="password" id="newPin1" maxlength="4" inputmode="numeric" placeholder="4 digits"></div>
    <div class="field"><label>Confirm PIN</label><input type="password" id="newPin2" maxlength="4" inputmode="numeric" placeholder="Same 4 digits"></div>
    <div id="pinSetupError" style="color:var(--red);font-size:12px;min-height:18px;font-family:'Cinzel',serif;"></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('modal-pin-setup')">Cancel</button>
      <button class="btn btn-gold" onclick="saveNewPin()">Save PIN</button>
    </div>
  </div>
</div>

<!-- ADD ENTRY -->
<div class="modal-overlay" id="modal-entry">
  <div class="modal">
    <h2>Add Calendar Entry</h2>
    <div class="field"><label>Day</label>
      <select id="entryDay">
        <option value="0">Sunday</option><option value="1">Monday</option><option value="2">Tuesday</option>
        <option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option>
      </select>
    </div>
    <div class="field"><label>Time (optional)</label><input type="text" id="entryTime" placeholder="e.g. 9:00 AM"></div>
    <div class="field"><label>Entry</label><textarea id="entryText" placeholder="What are you recording?"></textarea></div>
    <div class="field"><label>Type</label>
      <select id="entryType">
        <option value="routine">Routine (repeats weekly)</option>
        <option value="note">Note (this week only)</option>
      </select>
    </div>
    <div class="toggle-row">
      <span class="toggle-label">ğŸ”” Push notification reminder</span>
      <label class="toggle"><input type="checkbox" id="entryNotif" onchange="toggleNotifTime()"><span class="toggle-slider"></span></label>
    </div>
    <div class="field" id="notifTimeField" style="display:none;">
      <label>Remind me at</label><input type="time" id="entryNotifTime" value="09:00">
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('modal-entry')">Cancel</button>
      <button class="btn btn-gold" onclick="saveEntry()">Save</button>
    </div>
  </div>
</div>

<!-- ADD PERSONA -->
<div class="modal-overlay" id="modal-persona">
  <div class="modal">
    <h2>New Persona</h2>
    <div class="field"><label>Name</label><input type="text" id="pName" placeholder="Persona name"></div>
    <div class="field"><label>Role / Archetype</label><input type="text" id="pRole" placeholder="e.g. The Strategist, Work Mode..."></div>
    <div class="divider">Attributes</div>
    <div id="statFields"></div>
    <div class="field"><label>Notes</label><textarea id="pNotes" placeholder="Notes about this persona..."></textarea></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('modal-persona')">Cancel</button>
      <button class="btn btn-gold" onclick="savePersona()">Save</button>
    </div>
  </div>
</div>

<!-- EDIT PERSONA -->
<div class="modal-overlay" id="modal-edit-persona">
  <div class="modal">
    <h2 id="editPersonaTitle">Edit Persona</h2>
    <div id="editStatFields"></div>
    <div class="field" style="margin-top:12px;"><label>Notes</label><textarea id="editPNotes"></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="deletePersona()">Delete</button>
      <button class="btn" onclick="closeModal('modal-edit-persona')">Cancel</button>
      <button class="btn btn-gold" onclick="saveEditPersona()">Save</button>
    </div>
  </div>
</div>

<!-- ADD PERSON -->
<div class="modal-overlay" id="modal-person">
  <div class="modal">
    <h2 id="personModalTitle">Add Person</h2>
    <div class="row">
      <div class="field"><label>Name</label><input type="text" id="personName" placeholder="Full name"></div>
      <div class="field"><label>Relationship</label><input type="text" id="personRel" placeholder="Friend, colleague..."></div>
    </div>
    <div class="field"><label>Likes (comma separated)</label><input type="text" id="personLikes" placeholder="coffee, hiking, jazz"></div>
    <div class="field"><label>Dislikes (comma separated)</label><input type="text" id="personDislikes" placeholder="crowds, deadlines"></div>
    <div class="field"><label>Personality (comma separated)</label><input type="text" id="personTraits" placeholder="introverted, analytical"></div>
    <div class="field"><label>Important Dates (one per line)</label><textarea id="personDates" placeholder="Birthday: Jan 5&#10;Anniversary: March 12"></textarea></div>
    <div class="field"><label>Notes</label><textarea id="personNotes" placeholder="Anything else worth remembering..."></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-danger" id="deletePersonBtn" onclick="deletePerson()" style="display:none;">Delete</button>
      <button class="btn" onclick="closeModal('modal-person')">Cancel</button>
      <button class="btn btn-gold" onclick="savePerson()">Save</button>
    </div>
  </div>
</div>

<!-- BOOK SETTINGS -->
<div class="modal-overlay" id="modal-book-settings">
  <div class="modal">
    <h2>Book Info</h2>
    <div class="field"><label>Title</label><input type="text" id="bookTitleInput" placeholder="My Novel"></div>
    <div class="field"><label>Author</label><input type="text" id="bookAuthorInput" placeholder="Your name"></div>
    <div class="field"><label>Genre / Tagline</label><input type="text" id="bookGenreInput" placeholder="Dark fantasy, 2026..."></div>
    <div class="field"><label>Cover Image URL</label><input type="text" id="bookCoverUrl" placeholder="https://... paste image link"></div>
    <div class="field"><label>â€” or upload from device â€”</label><input type="file" id="bookCoverFile" accept="image/*" style="padding:6px;color:var(--text);" onchange="handleCoverUpload()"></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('modal-book-settings')">Cancel</button>
      <button class="btn btn-gold" onclick="saveBookSettings()">Save</button>
    </div>
  </div>
</div>

<!-- ADD PASSWORD -->
<div class="modal-overlay" id="modal-password">
  <div class="modal">
    <h2 id="pwModalTitle">Add Password</h2>
    <div class="field"><label>Site / App</label><input type="text" id="pwSite" placeholder="Google, Netflix, Bank..."></div>
    <div class="field"><label>Username / Email</label><input type="text" id="pwUser" placeholder="you@email.com"></div>
    <div class="field">
      <label>Password</label>
      <div style="position:relative;">
        <input type="password" id="pwPass" placeholder="Password">
        <button onclick="togglePwVis('pwPass',this)" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text2);cursor:pointer;font-size:11px;font-family:'Cinzel',serif;">SHOW</button>
      </div>
    </div>
    <button class="btn" style="width:100%;margin-bottom:12px;" onclick="generatePassword()">âš¡ Generate Strong Password</button>
    <div class="field"><label>URL (optional)</label><input type="text" id="pwUrl" placeholder="https://..."></div>
    <div class="field"><label>Notes</label><textarea id="pwNotes" placeholder="Security questions, backup codes..."></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-danger" id="deletePwBtn" onclick="deletePassword()" style="display:none;">Delete</button>
      <button class="btn" onclick="closeModal('modal-password')">Cancel</button>
      <button class="btn btn-gold" onclick="savePassword()">Save</button>
    </div>
  </div>
</div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let data = {
  entries:[], personas:[], people:[],
  book:{ title:'My Book', author:'', genre:'', coverUrl:'', chapters:[] },
  passwords:[]
};
const DAYS=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const STATS=['Happiness','Confidence','Energy','Anger','Anxiety','Focus','Creativity','Motivation'];
const STAT_COLORS={Happiness:'#55aa77',Confidence:'#c9a84c',Energy:'#e8c97a',Anger:'#cc5555',Anxiety:'#cc8844',Focus:'#5588cc',Creativity:'#9955cc',Motivation:'#55aacc'};
let currentWeekOffset=0, editingPersonaId=null, editingPersonId=null, editingChapterId=null, editingPwId=null;
let vaultUnlocked=false, vaultKey=null;

function save(){localStorage.setItem('chronicle_data',JSON.stringify(data));}
function load(){
  try{const r=localStorage.getItem('chronicle_data');if(r){const d=JSON.parse(r);data={...data,...d,book:{...data.book,...(d.book||{})},passwords:d.passwords||[]};}}catch(e){}
}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PIN / BIOMETRIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pinBuffer='',pinMode='unlock',pinSetupFirst='';

async function sha256(str){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode('chronicle_salt_v1_'+str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

function getSavedHash(){return localStorage.getItem('chronicle_pin');}

function pinPress(v){
  if(v==='bio'){tryBiometric();return;}
  if(v==='del'){pinBuffer=pinBuffer.slice(0,-1);updateDots();return;}
  if(pinBuffer.length>=4)return;
  pinBuffer+=v; updateDots();
  if(pinBuffer.length===4) setTimeout(processPinEntry,80);
}

function updateDots(){for(let i=0;i<4;i++)document.getElementById('d'+i).classList.toggle('filled',i<pinBuffer.length);}

async function processPinEntry(){
  const saved=getSavedHash();
  if(pinMode==='setup2'){
    if(pinBuffer!==pinSetupFirst){
      showPinErr('PINs did not match â€” try again');
      pinBuffer='';pinSetupFirst='';pinMode='setup1';updateDots();
      document.getElementById('lockSubtitle').textContent='Choose a new PIN';
      return;
    }
    localStorage.setItem('chronicle_pin',await sha256(pinBuffer));
    pinBuffer='';pinMode='unlock';unlock();return;
  }
  if(!saved||pinMode==='setup1'){
    pinSetupFirst=pinBuffer; pinBuffer=''; updateDots();
    document.getElementById('lockSubtitle').textContent='Confirm your PIN';
    document.getElementById('lockSetupMsg').textContent='Enter the same PIN again to confirm.';
    document.getElementById('lockSetupMsg').style.display='block';
    pinMode='setup2'; return;
  }
  if(await sha256(pinBuffer)===saved){pinBuffer='';updateDots();unlock();}
  else{showPinErr('Incorrect PIN');pinBuffer='';updateDots();}
}

function showPinErr(msg){
  const el=document.getElementById('pinError');el.textContent=msg;
  setTimeout(()=>{el.textContent='';},2200);
}

function unlock(){
  document.getElementById('lockScreen').style.display='none';
  document.getElementById('appShell').style.display='block';
}

function tryBiometric(){
  const cid=localStorage.getItem('chronicle_bio_cred');
  if(!cid||!window.PublicKeyCredential){showPinErr('No biometric enrolled');return;}
  navigator.credentials.get({publicKey:{
    challenge:crypto.getRandomValues(new Uint8Array(32)),
    allowCredentials:[{id:Uint8Array.from(atob(cid),c=>c.charCodeAt(0)),type:'public-key'}],
    userVerification:'required',timeout:30000
  }}).then(()=>unlock()).catch(()=>showPinErr('Biometric failed'));
}

async function enrollBiometric(){
  if(!window.PublicKeyCredential){alert('WebAuthn not supported on this browser.');return false;}
  try{
    const cred=await navigator.credentials.create({publicKey:{
      challenge:crypto.getRandomValues(new Uint8Array(32)),
      rp:{name:'Chronicle'},
      user:{id:crypto.getRandomValues(new Uint8Array(16)),name:'chronicle_user',displayName:'Chronicle User'},
      pubKeyCredParams:[{alg:-7,type:'public-key'},{alg:-257,type:'public-key'}],
      authenticatorSelection:{userVerification:'required',authenticatorAttachment:'platform'},
      timeout:60000
    }});
    localStorage.setItem('chronicle_bio_cred',btoa(String.fromCharCode(...new Uint8Array(cred.rawId))));
    localStorage.setItem('chronicle_bio_on','1');
    return true;
  }catch(e){alert('Biometric enrollment failed: '+e.message);return false;}
}

async function toggleBio(){
  const on=document.getElementById('bioToggle').checked;
  if(on){const ok=await enrollBiometric();if(!ok)document.getElementById('bioToggle').checked=false;}
  else{localStorage.removeItem('chronicle_bio_cred');localStorage.removeItem('chronicle_bio_on');}
  document.getElementById('bioPadBtn').style.display=localStorage.getItem('chronicle_bio_on')==='1'?'flex':'none';
}

function openPinSetup(){
  closeModal('modal-backup');
  document.getElementById('newPin1').value='';document.getElementById('newPin2').value='';
  document.getElementById('pinSetupError').textContent='';
  openModal('modal-pin-setup');
}
async function saveNewPin(){
  const p1=document.getElementById('newPin1').value,p2=document.getElementById('newPin2').value;
  if(!/^\d{4}$/.test(p1)){document.getElementById('pinSetupError').textContent='Must be exactly 4 digits.';return;}
  if(p1!==p2){document.getElementById('pinSetupError').textContent='PINs do not match.';return;}
  localStorage.setItem('chronicle_pin',await sha256(p1));
  closeModal('modal-pin-setup');toast('PIN updated âœ“');
}

// Auto-lock when app hidden
document.addEventListener('visibilitychange',()=>{
  if(document.hidden&&document.getElementById('appShell').style.display!=='none'){
    document.getElementById('appShell').style.display='none';
    document.getElementById('lockScreen').style.display='flex';
    pinBuffer='';updateDots();
    document.getElementById('pinError').textContent='';
    document.getElementById('lockSubtitle').textContent='Enter your PIN';
  }
});

function initLock(){
  const hasBio=localStorage.getItem('chronicle_bio_on')==='1';
  document.getElementById('bioPadBtn').style.display=hasBio?'flex':'none';
  if(document.getElementById('bioToggle'))document.getElementById('bioToggle').checked=hasBio;
  if(!getSavedHash()){
    document.getElementById('lockSubtitle').textContent='Choose a 4-digit PIN';
    document.getElementById('lockSetupMsg').textContent='First time â€” pick a PIN to secure Chronicle.';
    document.getElementById('lockSetupMsg').style.display='block';
    // Re-arrange zero btn
    const zeroPad=document.getElementById('zeroBtn');
    zeroPad.style.gridColumn='2';
    pinMode='setup1';
  } else {
    document.getElementById('lockSubtitle').textContent='Enter your PIN';
    if(hasBio) setTimeout(tryBiometric,400);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSection(name){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById('sec-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');
  const subs={calendar:'Weekly scroll of time',persona:'Who you are today',people:'Those who walk beside you',book:'Your written world',passwords:'The sealed vault'};
  document.getElementById('headerSub').textContent=subs[name]||'';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleNotifTime(){
  document.getElementById('notifTimeField').style.display=document.getElementById('entryNotif').checked?'block':'none';
}
async function requestNotif(){
  if(!('Notification' in window))return false;
  if(Notification.permission==='granted')return true;
  return (await Notification.requestPermission())==='granted';
}
function scheduleNotif(e){
  if(!e.notif||!e.notifTime)return;
  const [h,m]=e.notifTime.split(':').map(Number);
  const now=new Date(),day=now.getDay();
  let daysUntil=((parseInt(e.dayOfWeek)-day+7)%7)||7;
  const next=new Date(now);next.setDate(now.getDate()+daysUntil);next.setHours(h,m,0,0);
  const ms=next.getTime()-now.getTime();
  if(ms>0&&ms<7*24*60*60*1000){
    setTimeout(()=>{
      if(Notification.permission==='granted')new Notification('Chronicle',{body:e.text,icon:'./icon-192.png'});
    },ms);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function changeWeek(d){currentWeekOffset+=d;renderCalendar();}
function getWeekStart(off){const d=new Date();d.setDate(d.getDate()-d.getDay()+off*7);d.setHours(0,0,0,0);return d;}
function weekKey(off){return getWeekStart(off).toISOString().slice(0,10);}

function renderCalendar(){
  const ws=getWeekStart(currentWeekOffset),we=new Date(ws);we.setDate(we.getDate()+6);
  document.getElementById('weekLabel').textContent=ws.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' â€“ '+we.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  const today=new Date();today.setHours(0,0,0,0);
  const wk=weekKey(currentWeekOffset);
  const cont=document.getElementById('calendarDays');cont.innerHTML='';
  for(let i=0;i<7;i++){
    const dd=new Date(ws);dd.setDate(ws.getDate()+i);
    const isToday=dd.getTime()===today.getTime();
    const entries=data.entries.filter(e=>parseInt(e.dayOfWeek)===i&&(e.type==='routine'||(e.type==='note'&&e.weekKey===wk)));
    const card=document.createElement('div');card.className='day-card'+(isToday?' today':'');
    const hdr=document.createElement('div');hdr.className='day-header';
    hdr.innerHTML=`<div class="day-header-left"><span class="day-name">${DAYS[i]}</span><span class="day-date">${dd.toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span>${entries.length?`<span class="day-badge">${entries.length}</span>`:''}</div><span class="chevron${isToday?' open':''}">â–¶</span>`;
    const body=document.createElement('div');body.className='day-body'+(isToday?' open':'');
    if(!entries.length){body.innerHTML='<div class="empty-state">No entries</div>';}
    else{
      entries.sort((a,b)=>(a.time||'').localeCompare(b.time||'')).forEach(e=>{
        const d2=document.createElement('div');d2.className='entry-item';
        d2.innerHTML=`<span class="entry-time">${e.time||'â€”'}</span><span class="entry-text">${escHtml(e.text)}</span><button class="entry-bell${e.notif?' on':''}" onclick="toggleEntryNotif('${e.id}')" title="${e.notif?'Notification on':'Notification off'}">${e.notif?'ğŸ””':'ğŸ”•'}</button><span class="entry-badge ${e.type==='routine'?'badge-routine':'badge-note'}">${e.type}</span><button class="entry-delete" onclick="deleteEntry('${e.id}')">Ã—</button>`;
        body.appendChild(d2);
      });
    }
    hdr.onclick=()=>{body.classList.toggle('open');hdr.querySelector('.chevron').classList.toggle('open',body.classList.contains('open'));};
    card.appendChild(hdr);card.appendChild(body);cont.appendChild(card);
  }
}

async function toggleEntryNotif(id){
  const e=data.entries.find(x=>x.id===id);if(!e)return;
  if(!e.notif){
    const ok=await requestNotif();if(!ok){alert('Enable notifications in browser settings.');return;}
    const t=prompt('Remind me at (HH:MM):','09:00');if(!t)return;
    e.notif=true;e.notifTime=t;scheduleNotif(e);
  }else{e.notif=false;e.notifTime=null;}
  save();renderCalendar();
}

function openAddEntry(){
  document.getElementById('entryDay').value=new Date().getDay();
  ['entryTime','entryText'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('entryType').value='routine';
  document.getElementById('entryNotif').checked=false;
  document.getElementById('notifTimeField').style.display='none';
  document.getElementById('entryNotifTime').value='09:00';
  openModal('modal-entry');
}

async function saveEntry(){
  const text=document.getElementById('entryText').value.trim();if(!text)return;
  const notif=document.getElementById('entryNotif').checked;
  if(notif){const ok=await requestNotif();if(!ok){alert('Notification permission denied.');}}
  const e={id:uid(),dayOfWeek:parseInt(document.getElementById('entryDay').value),time:document.getElementById('entryTime').value.trim(),text,type:document.getElementById('entryType').value,weekKey:weekKey(currentWeekOffset),notif,notifTime:notif?document.getElementById('entryNotifTime').value:null};
  data.entries.push(e);if(e.notif)scheduleNotif(e);
  save();closeModal('modal-entry');renderCalendar();
}

function deleteEntry(id){data.entries=data.entries.filter(e=>e.id!==id);save();renderCalendar();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PERSONA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPersona(){
  const active=data.personas.find(p=>p.active);
  document.getElementById('activePersonaArea').innerHTML=active?buildPersonaCard(active):'<div class="empty-state">No active persona yet.</div>';
  document.getElementById('personaList').innerHTML=!data.personas.length?'<div class="empty-state">No personas yet.</div>':data.personas.map(p=>`<div class="persona-list-item"><div><div style="font-family:'Cinzel',serif;font-size:13px;">${escHtml(p.name)}</div><div style="font-size:12px;color:var(--text2);font-style:italic;">${escHtml(p.role||'')}</div></div><div style="display:flex;gap:6px;align-items:center;">${p.active?'<span class="pill-active">ACTIVE</span>':`<button class="btn" style="font-size:10px;padding:3px 8px;" onclick="setActivePersona('${p.id}')">Activate</button>`}<button class="btn" style="font-size:10px;padding:3px 8px;" onclick="editPersona('${p.id}')">Edit</button></div></div>`).join('');
}

function buildPersonaCard(p){
  return`<div class="persona-active-card"><div style="display:flex;justify-content:space-between;align-items:flex-start;"><div><div class="persona-name">${escHtml(p.name)}</div><div class="persona-class">${escHtml(p.role||'')}</div></div><button class="btn" style="font-size:10px;padding:3px 8px;" onclick="editPersona('${p.id}')">Edit</button></div>${STATS.map(s=>{const v=p.stats?.[s]??50;return`<div class="stat-row"><span class="stat-label">${s}</span><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${v}%;background:${STAT_COLORS[s]};"></div></div><span class="stat-value">${v}</span></div>`;}).join('')}${p.notes?`<div style="margin-top:12px;font-size:14px;color:var(--text2);font-style:italic;">${escHtml(p.notes)}</div>`:''}</div>`;
}

function openAddPersona(){
  editingPersonaId=null;
  ['pName','pRole','pNotes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('statFields').innerHTML=STATS.map(s=>`<div class="field"><label>${s} <span id="sv-${s}" style="color:var(--gold);float:right;">50</span></label><input type="range" min="0" max="100" value="50" id="sr-${s}" oninput="document.getElementById('sv-${s}').textContent=this.value"></div>`).join('');
  openModal('modal-persona');
}
function savePersona(){
  const name=document.getElementById('pName').value.trim();if(!name)return;
  const stats={};STATS.forEach(s=>stats[s]=parseInt(document.getElementById('sr-'+s).value));
  data.personas.push({id:uid(),name,role:document.getElementById('pRole').value.trim(),notes:document.getElementById('pNotes').value.trim(),stats,active:!data.personas.length});
  save();closeModal('modal-persona');renderPersona();
}
function editPersona(id){
  editingPersonaId=id;const p=data.personas.find(x=>x.id===id);if(!p)return;
  document.getElementById('editPersonaTitle').textContent=p.name;
  document.getElementById('editPNotes').value=p.notes||'';
  document.getElementById('editStatFields').innerHTML=STATS.map(s=>{const v=p.stats?.[s]??50;return`<div class="field"><label>${s} <span id="esv-${s}" style="color:var(--gold);float:right;">${v}</span></label><input type="range" min="0" max="100" value="${v}" id="esr-${s}" oninput="document.getElementById('esv-${s}').textContent=this.value"></div>`;}).join('');
  openModal('modal-edit-persona');
}
function saveEditPersona(){
  const p=data.personas.find(x=>x.id===editingPersonaId);if(!p)return;
  STATS.forEach(s=>p.stats[s]=parseInt(document.getElementById('esr-'+s).value));
  p.notes=document.getElementById('editPNotes').value.trim();
  save();closeModal('modal-edit-persona');renderPersona();
}
function deletePersona(){
  if(!confirm('Delete this persona?'))return;
  data.personas=data.personas.filter(x=>x.id!==editingPersonaId);
  if(data.personas.length&&!data.personas.find(p=>p.active))data.personas[0].active=true;
  save();closeModal('modal-edit-persona');renderPersona();
}
function setActivePersona(id){data.personas.forEach(p=>p.active=p.id===id);save();renderPersona();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PEOPLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPeople(){
  const list=document.getElementById('peopleList');
  if(!data.people.length){list.innerHTML='<div class="empty-state">No people added yet.</div>';return;}
  list.innerHTML='';
  data.people.forEach(p=>{
    const c=document.createElement('div');c.className='person-card';
    const init=p.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
    const likes=p.likes?p.likes.split(',').map(x=>x.trim()).filter(Boolean):[];
    const dislikes=p.dislikes?p.dislikes.split(',').map(x=>x.trim()).filter(Boolean):[];
    const traits=p.traits?p.traits.split(',').map(x=>x.trim()).filter(Boolean):[];
    c.innerHTML=`<div class="person-header" onclick="toggleEl('pc-${p.id}','ch-${p.id}')"><div class="person-avatar">${init}</div><div style="flex:1;"><div style="font-family:'Cinzel',serif;font-size:14px;">${escHtml(p.name)}</div><div style="font-size:12px;color:var(--text2);font-style:italic;">${escHtml(p.rel||'')}</div></div><span class="chevron" id="ch-${p.id}">â–¶</span></div><div class="person-body" id="pc-${p.id}">${traits.length?`<div class="section-label">Traits</div><div class="tag-list">${traits.map(t=>`<span class="info-tag">${escHtml(t)}</span>`).join('')}</div>`:''} ${likes.length?`<div class="section-label">Likes</div><div class="tag-list">${likes.map(t=>`<span class="info-tag" style="border-color:rgba(85,170,119,0.4);color:var(--green);">${escHtml(t)}</span>`).join('')}</div>`:''} ${dislikes.length?`<div class="section-label">Dislikes</div><div class="tag-list">${dislikes.map(t=>`<span class="info-tag" style="border-color:rgba(204,85,85,0.4);color:var(--red);">${escHtml(t)}</span>`).join('')}</div>`:''} ${p.dates?`<div class="section-label">Dates</div><div style="font-size:14px;white-space:pre-wrap;">${escHtml(p.dates)}</div>`:''} ${p.notes?`<div class="section-label">Notes</div><div style="font-size:15px;font-style:italic;white-space:pre-wrap;">${escHtml(p.notes)}</div>`:''}<div style="margin-top:12px;"><button class="btn" style="font-size:10px;padding:3px 8px;" onclick="openEditPerson('${p.id}')">Edit</button></div></div>`;
    list.appendChild(c);
  });
}
function toggleEl(bodyId,chevId){const b=document.getElementById(bodyId),ch=document.getElementById(chevId);b.classList.toggle('open');ch.classList.toggle('open',b.classList.contains('open'));}
function openAddPerson(){editingPersonId=null;document.getElementById('personModalTitle').textContent='Add Person';document.getElementById('deletePersonBtn').style.display='none';['personName','personRel','personLikes','personDislikes','personTraits','personDates','personNotes'].forEach(id=>document.getElementById(id).value='');openModal('modal-person');}
function openEditPerson(id){
  editingPersonId=id;const p=data.people.find(x=>x.id===id);if(!p)return;
  document.getElementById('personModalTitle').textContent='Edit '+p.name;document.getElementById('deletePersonBtn').style.display='inline-block';
  document.getElementById('personName').value=p.name||'';document.getElementById('personRel').value=p.rel||'';document.getElementById('personLikes').value=p.likes||'';document.getElementById('personDislikes').value=p.dislikes||'';document.getElementById('personTraits').value=p.traits||'';document.getElementById('personDates').value=p.dates||'';document.getElementById('personNotes').value=p.notes||'';
  openModal('modal-person');
}
function savePerson(){
  const name=document.getElementById('personName').value.trim();if(!name)return;
  const obj={id:editingPersonId||uid(),name,rel:document.getElementById('personRel').value.trim(),likes:document.getElementById('personLikes').value.trim(),dislikes:document.getElementById('personDislikes').value.trim(),traits:document.getElementById('personTraits').value.trim(),dates:document.getElementById('personDates').value.trim(),notes:document.getElementById('personNotes').value.trim()};
  if(editingPersonId){const i=data.people.findIndex(x=>x.id===editingPersonId);if(i>=0)data.people[i]=obj;}else data.people.push(obj);
  save();closeModal('modal-person');renderPeople();
}
function deletePerson(){if(!confirm('Delete?'))return;data.people=data.people.filter(x=>x.id!==editingPersonId);save();closeModal('modal-person');renderPeople();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let fullViewOpen=false;

function renderBook(){
  const b=data.book;
  document.getElementById('bookTitleDisplay').textContent=b.title||'My Book';
  const sub=[b.author?'by '+b.author:'',b.genre].filter(Boolean).join(' Â· ');
  document.getElementById('bookSubDisplay').textContent=sub;
  const wrap=document.getElementById('bookCoverWrap');
  wrap.innerHTML=b.coverUrl?`<img src="${escHtml(b.coverUrl)}" class="book-cover-img" onerror="this.style.display='none'">` :'';
  const words=b.chapters.reduce((a,c)=>a+(c.content||'').trim().split(/\s+/).filter(Boolean).length,0);
  document.getElementById('bookStatsDisplay').innerHTML=`<span style="font-family:'Cinzel',serif;font-size:10px;color:var(--text2);">${b.chapters.length} chapter${b.chapters.length!==1?'s':''} &nbsp;Â·&nbsp; ~${words.toLocaleString()} words</span>`;
  const cl=document.getElementById('chapterListEl');
  cl.innerHTML=!b.chapters.length?'<div class="empty-state">No chapters yet. Start writing!</div>':b.chapters.map((c,i)=>{const w=(c.content||'').trim().split(/\s+/).filter(Boolean).length;return`<div class="chapter-item" onclick="openEditor('${c.id}')"><div><div class="chapter-num">CHAPTER ${i+1}</div><div class="chapter-title-text">${escHtml(c.title||'Untitled')}</div></div><div style="text-align:right;"><div style="font-size:11px;color:var(--text2);">${w} words</div><div style="font-size:10px;color:var(--border2);margin-top:2px;">tap to edit â–¶</div></div></div>`;}).join('');
  if(fullViewOpen)renderFullView();
}

function openBookSettings(){
  const b=data.book;
  document.getElementById('bookTitleInput').value=b.title||'';document.getElementById('bookAuthorInput').value=b.author||'';document.getElementById('bookGenreInput').value=b.genre||'';document.getElementById('bookCoverUrl').value='';
  openModal('modal-book-settings');
}
function handleCoverUpload(){
  const f=document.getElementById('bookCoverFile').files[0];if(!f)return;
  const r=new FileReader();r.onload=e=>{document.getElementById('bookCoverUrl').value=e.target.result;};r.readAsDataURL(f);
}
function saveBookSettings(){
  data.book.title=document.getElementById('bookTitleInput').value.trim()||'My Book';
  data.book.author=document.getElementById('bookAuthorInput').value.trim();
  data.book.genre=document.getElementById('bookGenreInput').value.trim();
  const cu=document.getElementById('bookCoverUrl').value.trim();if(cu)data.book.coverUrl=cu;
  save();closeModal('modal-book-settings');renderBook();
}

function openAddChapter(){
  editingChapterId=null;
  document.getElementById('chapterTitleInput').value='';document.getElementById('chapterContentInput').value='';
  document.getElementById('deleteChapterBtn').style.display='none';
  document.getElementById('chapterWordCount').textContent='';
  document.getElementById('bookMainView').style.display='none';
  document.getElementById('bookEditorEl').classList.add('active');
  setupWordCount();
}
function openEditor(id){
  editingChapterId=id;const c=data.book.chapters.find(x=>x.id===id);if(!c)return;
  document.getElementById('chapterTitleInput').value=c.title||'';document.getElementById('chapterContentInput').value=c.content||'';
  document.getElementById('deleteChapterBtn').style.display='block';
  document.getElementById('bookMainView').style.display='none';
  document.getElementById('bookEditorEl').classList.add('active');
  setupWordCount();
}
function setupWordCount(){
  const ta=document.getElementById('chapterContentInput'),wc=document.getElementById('chapterWordCount');
  const update=()=>{const w=ta.value.trim().split(/\s+/).filter(Boolean).length;wc.textContent=w+' words';};
  update();ta.oninput=update;
}
function closeEditor(){
  document.getElementById('bookEditorEl').classList.remove('active');
  document.getElementById('bookMainView').style.display='block';
  editingChapterId=null;renderBook();
}
function saveChapter(){
  const title=document.getElementById('chapterTitleInput').value.trim();
  const content=document.getElementById('chapterContentInput').value;
  if(editingChapterId){const c=data.book.chapters.find(x=>x.id===editingChapterId);if(c){c.title=title;c.content=content;c.updated=Date.now();}}
  else data.book.chapters.push({id:uid(),title,content,created:Date.now(),updated:Date.now()});
  save();closeEditor();
}
function deleteChapter(){if(!confirm('Delete this chapter?'))return;data.book.chapters=data.book.chapters.filter(x=>x.id!==editingChapterId);save();closeEditor();}

function toggleFullView(){
  fullViewOpen=!fullViewOpen;
  document.getElementById('chapterListEl').style.display=fullViewOpen?'none':'block';
  document.getElementById('bookMetaCard').style.display=fullViewOpen?'none':'block';
  document.getElementById('fullViewArea').style.display=fullViewOpen?'block':'none';
  document.getElementById('fullViewBtn').textContent=fullViewOpen?'Chapter View':'Full View';
  if(fullViewOpen)renderFullView();
}
function renderFullView(){
  document.getElementById('fullViewContent').innerHTML=data.book.chapters.map((c,i)=>`<div class="ch-heading">Chapter ${i+1}: ${escHtml(c.title||'Untitled')}</div>${escHtml(c.content||'')}`).join('\n\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VAULT (AES-GCM encrypted passwords)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function getVaultSalt(){
  let s=localStorage.getItem('chronicle_vsalt');
  if(!s){s=btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(16))));localStorage.setItem('chronicle_vsalt',s);}
  return Uint8Array.from(atob(s),c=>c.charCodeAt(0));
}
async function deriveVaultKey(pw){
  const km=await crypto.subtle.importKey('raw',new TextEncoder().encode(pw),'PBKDF2',false,['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2',salt:await getVaultSalt(),iterations:310000,hash:'SHA-256'},km,{name:'AES-GCM',length:256},false,['encrypt','decrypt']);
}
async function encField(key,pt){
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,new TextEncoder().encode(pt));
  const b=new Uint8Array(12+ct.byteLength);b.set(iv,0);b.set(new Uint8Array(ct),12);
  return btoa(String.fromCharCode(...b));
}
async function decField(key,b64){
  const b=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
  return new TextDecoder().decode(await crypto.subtle.decrypt({name:'AES-GCM',iv:b.slice(0,12)},key,b.slice(12)));
}

async function unlockVault(){
  const pw=prompt('Enter vault master password:');if(!pw)return;
  let key;
  try{key=await deriveVaultKey(pw);}catch(e){alert('Key derivation failed.');return;}
  // Verify key with token
  const token=localStorage.getItem('chronicle_vtoken');
  if(token){
    try{const t=await decField(key,token);if(t!=='chronicle_vault_ok'){alert('Wrong password.');return;}}
    catch(e){alert('Wrong password.');return;}
  } else {
    // First use â€” set token
    localStorage.setItem('chronicle_vtoken',await encField(key,'chronicle_vault_ok'));
  }
  vaultKey=key;vaultUnlocked=true;
  document.getElementById('pwLockedMsg').style.display='none';
  document.getElementById('pwVaultEl').style.display='block';
  renderPasswords();
}

function lockVault(){
  vaultUnlocked=false;vaultKey=null;
  document.getElementById('pwVaultEl').style.display='none';
  document.getElementById('pwLockedMsg').style.display='block';
}

async function renderPasswords(){
  const list=document.getElementById('pwListEl');
  if(!data.passwords.length){list.innerHTML='<div class="empty-state">No passwords saved yet.</div>';return;}
  list.innerHTML='';
  for(const pw of data.passwords){
    let user='[encrypted]';
    try{user=await decField(vaultKey,pw.encUser);}catch(e){}
    const c=document.createElement('div');c.className='pw-entry';
    const init=(pw.site||'?')[0].toUpperCase();
    c.innerHTML=`<div class="pw-entry-header" onclick="toggleEl('pwb-${pw.id}','pwch-${pw.id}')"><div class="pw-site-icon">${init}</div><div style="flex:1;"><div style="font-family:'Cinzel',serif;font-size:14px;">${escHtml(pw.site||'')}</div><div style="font-size:12px;color:var(--text2);">${escHtml(user)}</div></div><span class="chevron" id="pwch-${pw.id}">â–¶</span></div><div class="pw-body" id="pwb-${pw.id}"><div class="pw-field-row"><span class="pw-field-label">Username</span><span class="pw-field-val" id="pwu-${pw.id}">${escHtml(user)}</span><button class="pw-copy" onclick="copyText('pwu-${pw.id}')">Copy</button></div><div class="pw-field-row"><span class="pw-field-label">Password</span><span class="pw-field-val" id="pwp-${pw.id}" style="letter-spacing:0.15em;font-size:18px;">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span><button class="pw-reveal" onclick="toggleReveal('${pw.id}')">ğŸ‘</button><button class="pw-copy" onclick="copyPw('${pw.id}')">Copy</button></div>${pw.url?`<div class="pw-field-row"><span class="pw-field-label">URL</span><a href="${escHtml(pw.url)}" target="_blank" style="color:var(--accent2);font-size:13px;word-break:break-all;">${escHtml(pw.url)}</a></div>`:''} ${pw.notes?`<div class="pw-field-row" style="align-items:flex-start;"><span class="pw-field-label">Notes</span><span style="font-size:13px;color:var(--text2);white-space:pre-wrap;">${escHtml(pw.notes)}</span></div>`:''}<div style="margin-top:10px;"><button class="btn" style="font-size:10px;padding:3px 8px;" onclick="openEditPw('${pw.id}')">Edit</button></div></div>`;
    list.appendChild(c);
  }
}

async function toggleReveal(id){
  const el=document.getElementById('pwp-'+id);const pw=data.passwords.find(x=>x.id===id);if(!pw)return;
  if(el.dataset.revealed){el.textContent='â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';el.style.letterSpacing='0.15em';el.style.fontSize='18px';delete el.dataset.revealed;return;}
  try{el.textContent=await decField(vaultKey,pw.encPass);el.style.letterSpacing='normal';el.style.fontSize='14px';el.dataset.revealed='1';}catch(e){el.textContent='[error]';}
}
async function copyPw(id){
  const pw=data.passwords.find(x=>x.id===id);if(!pw)return;
  try{await navigator.clipboard.writeText(await decField(vaultKey,pw.encPass));toast('Password copied');}catch(e){}
}
async function copyText(elId){
  try{await navigator.clipboard.writeText(document.getElementById(elId)?.textContent||'');toast('Copied');}catch(e){}
}

function openAddPassword(){
  if(!vaultUnlocked){unlockVault();return;}
  editingPwId=null;document.getElementById('pwModalTitle').textContent='Add Password';document.getElementById('deletePwBtn').style.display='none';
  ['pwSite','pwUser','pwPass','pwUrl','pwNotes'].forEach(id=>document.getElementById(id).value='');
  openModal('modal-password');
}
async function openEditPw(id){
  editingPwId=id;const pw=data.passwords.find(x=>x.id===id);if(!pw)return;
  document.getElementById('pwModalTitle').textContent='Edit '+pw.site;document.getElementById('deletePwBtn').style.display='inline-block';
  document.getElementById('pwSite').value=pw.site||'';document.getElementById('pwUrl').value=pw.url||'';document.getElementById('pwNotes').value=pw.notes||'';
  try{document.getElementById('pwUser').value=await decField(vaultKey,pw.encUser);}catch(e){}
  try{document.getElementById('pwPass').value=await decField(vaultKey,pw.encPass);}catch(e){}
  openModal('modal-password');
}
async function savePassword(){
  if(!vaultKey){alert('Vault not unlocked.');return;}
  const site=document.getElementById('pwSite').value.trim(),pass=document.getElementById('pwPass').value;if(!site||!pass)return;
  if(!localStorage.getItem('chronicle_vtoken'))localStorage.setItem('chronicle_vtoken',await encField(vaultKey,'chronicle_vault_ok'));
  const obj={id:editingPwId||uid(),site,encUser:await encField(vaultKey,document.getElementById('pwUser').value),encPass:await encField(vaultKey,pass),url:document.getElementById('pwUrl').value.trim(),notes:document.getElementById('pwNotes').value.trim(),updated:Date.now()};
  if(editingPwId){const i=data.passwords.findIndex(x=>x.id===editingPwId);if(i>=0)data.passwords[i]=obj;}else data.passwords.push(obj);
  save();closeModal('modal-password');renderPasswords();
}
function deletePassword(){if(!confirm('Delete?'))return;data.passwords=data.passwords.filter(x=>x.id!==editingPwId);save();closeModal('modal-password');renderPasswords();}
function generatePassword(){
  const c='ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#$%^&*';
  document.getElementById('pwPass').value=Array.from({length:20},()=>c[Math.floor(Math.random()*c.length)]).join('');
  document.getElementById('pwPass').type='text';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BACKUP / CRYPTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togglePwVis(id,btn){const el=document.getElementById(id);el.type=el.type==='password'?'text':'password';btn.textContent=el.type==='password'?'SHOW':'HIDE';}
function checkExportStrength(){
  const pw=document.getElementById('exportPassword').value,el=document.getElementById('exportStrength');
  if(!pw){el.textContent='';return;}
  let s=0;if(pw.length>=8)s++;if(pw.length>=14)s++;if(/[A-Z]/.test(pw))s++;if(/[0-9]/.test(pw))s++;if(/[^A-Za-z0-9]/.test(pw))s++;
  el.textContent='â— Strength: '+['','Weak','Fair','Good','Strong','Very Strong'][s];
  el.style.color=['','var(--red)','var(--amber)','var(--amber)','var(--green)','var(--green)'][s];
}

async function deriveKey(pw,salt){
  const km=await crypto.subtle.importKey('raw',new TextEncoder().encode(pw),'PBKDF2',false,['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:310000,hash:'SHA-256'},km,{name:'AES-GCM',length:256},false,['encrypt','decrypt']);
}
async function encData(pt,pw){
  const salt=crypto.getRandomValues(new Uint8Array(16)),iv=crypto.getRandomValues(new Uint8Array(12));
  const key=await deriveKey(pw,salt),ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,new TextEncoder().encode(pt));
  const b=new Uint8Array(28+ct.byteLength);b.set(salt,0);b.set(iv,16);b.set(new Uint8Array(ct),28);
  return btoa(String.fromCharCode(...b));
}
async function decData(b64,pw){
  const b=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
  const key=await deriveKey(pw,b.slice(0,16));
  return new TextDecoder().decode(await crypto.subtle.decrypt({name:'AES-GCM',iv:b.slice(16,28)},key,b.slice(28)));
}

async function doExport(){
  const pw=document.getElementById('exportPassword').value;
  const ts=new Date().toISOString().slice(0,16).replace('T','_').replace(':','-');
  const payload=JSON.stringify({version:2,exported:new Date().toISOString(),data});
  let fc,fn;
  if(pw){try{fc=JSON.stringify({chronicle_encrypted:true,version:2,payload:await encData(payload,pw)});fn=`chronicle_${ts}.enc.json`;}catch(e){alert('Encryption failed');return;}}
  else{fc=payload;fn=`chronicle_${ts}.json`;}
  const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([fc],{type:'application/json'})),download:fn});
  document.body.appendChild(a);a.click();document.body.removeChild(a);
}

async function doImport(){
  const file=document.getElementById('importFile').files[0];
  const st=document.getElementById('importStatus');
  if(!file){st.textContent='No file selected.';st.style.color='var(--amber)';return;}
  st.textContent='Readingâ€¦';st.style.color='var(--text2)';
  let parsed;try{parsed=JSON.parse(await file.text());}catch(e){st.textContent='âœ• Invalid file.';st.style.color='var(--red)';return;}
  let id2;
  if(parsed.chronicle_encrypted){
    const pw=document.getElementById('importPassword').value;if(!pw){st.textContent='âœ• Enter password.';st.style.color='var(--amber)';return;}
    try{id2=JSON.parse(await decData(parsed.payload,pw)).data;}catch(e){st.textContent='âœ• Wrong password.';st.style.color='var(--red)';return;}
  }else if(parsed.data){id2=parsed.data;}else{st.textContent='âœ• Unrecognised format.';st.style.color='var(--red)';return;}
  let a={entries:0,personas:0,people:0,chapters:0,passwords:0};
  const eI=new Set(data.entries.map(x=>x.id)),pI=new Set(data.personas.map(x=>x.id)),peI=new Set(data.people.map(x=>x.id)),cI=new Set(data.book.chapters.map(x=>x.id)),pwI=new Set(data.passwords.map(x=>x.id));
  (id2.entries||[]).forEach(e=>{if(!eI.has(e.id)){data.entries.push(e);a.entries++;}});
  (id2.personas||[]).forEach(e=>{if(!pI.has(e.id)){data.personas.push(e);a.personas++;}});
  (id2.people||[]).forEach(e=>{if(!peI.has(e.id)){data.people.push(e);a.people++;}});
  ((id2.book||{}).chapters||[]).forEach(e=>{if(!cI.has(e.id)){data.book.chapters.push(e);a.chapters++;}});
  (id2.passwords||[]).forEach(e=>{if(!pwI.has(e.id)){data.passwords.push(e);a.passwords++;}});
  save();renderCalendar();renderPersona();renderPeople();renderBook();if(vaultUnlocked)renderPasswords();
  st.style.color='var(--green)';st.textContent=`âœ“ ${a.entries} entries Â· ${a.personas} personas Â· ${a.people} people Â· ${a.chapters} chapters Â· ${a.passwords} passwords`;
}

function clearAllData(){
  if(!confirm('Permanently delete ALL Chronicle data?'))return;
  if(!confirm('Final warning â€” cannot be undone!'))return;
  data={entries:[],personas:[],people:[],book:{title:'My Book',author:'',genre:'',coverUrl:'',chapters:[]},passwords:[]};
  localStorage.removeItem('chronicle_vtoken');
  save();closeModal('modal-backup');renderCalendar();renderPersona();renderPeople();renderBook();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODALS + UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){document.getElementById(id).classList.add('open');document.body.style.overflow='hidden';}
function closeModal(id){document.getElementById(id).classList.remove('open');document.body.style.overflow='';}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)closeModal(o.id);}));

function escHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

function toast(msg){
  const el=document.createElement('div');el.className='toast';el.textContent=msg;
  document.body.appendChild(el);setTimeout(()=>{el.style.opacity='0';setTimeout(()=>el.remove(),400);},1400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
load();
initLock();
renderCalendar();renderPersona();renderPeople();renderBook();
</script>
<script>
if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('./sw.js').then(r=>console.log('Chronicle SW:',r.scope)).catch(e=>console.warn('SW:',e));});}
</script>
</body>
</html>
