<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d0d0f">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Chronicle</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0d0f;
    --bg2: #13131a;
    --bg3: #1a1a24;
    --bg4: #222230;
    --border: #2e2e42;
    --border2: #3d3d58;
    --gold: #c9a84c;
    --gold2: #e8c97a;
    --silver: #8899bb;
    --text: #d4d4e8;
    --text2: #9090aa;
    --text3: #6060788;
    --accent: #7b6cee;
    --accent2: #a99bff;
    --red: #cc5555;
    --green: #55aa77;
    --amber: #cc8844;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Crimson Pro', Georgia, serif;
    font-size: 16px;
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-tap-highlight-color: transparent;
  }

  /* Decorative noise overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }

  /* ── Navigation ── */
  nav {
    position: fixed;
    bottom: 0;
    left: 0; right: 0;
    background: var(--bg2);
    border-top: 1px solid var(--border);
    display: flex;
    z-index: 100;
    padding-bottom: env(safe-area-inset-bottom, 0);
  }

  nav button {
    flex: 1;
    background: none;
    border: none;
    color: var(--text2);
    padding: 12px 4px 10px;
    font-family: 'Cinzel', serif;
    font-size: 9px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: color 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  nav button svg { width: 20px; height: 20px; }
  nav button.active { color: var(--gold); }
  nav button:hover { color: var(--text); }

  /* ── Header ── */
  header {
    background: linear-gradient(180deg, #0d0d0f 0%, var(--bg2) 100%);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px 12px;
    position: sticky;
    top: 0;
    z-index: 50;
  }

  header h1 {
    font-family: 'Cinzel', serif;
    font-size: 22px;
    font-weight: 600;
    color: var(--gold);
    letter-spacing: 0.15em;
    text-shadow: 0 0 30px rgba(201,168,76,0.3);
  }

  header p {
    font-size: 12px;
    color: var(--text2);
    letter-spacing: 0.05em;
    margin-top: 2px;
  }

  /* ── Sections ── */
  .section { display: none; padding: 20px 16px 100px; }
  .section.active { display: block; }

  /* ── Cards ── */
  .card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 16px;
    margin-bottom: 12px;
    position: relative;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 3px; height: 100%;
    background: linear-gradient(180deg, var(--gold), transparent);
    border-radius: 4px 0 0 4px;
  }

  .card h3 {
    font-family: 'Cinzel', serif;
    font-size: 13px;
    letter-spacing: 0.1em;
    color: var(--gold2);
    margin-bottom: 8px;
  }

  /* ── Buttons ── */
  .btn {
    background: var(--bg3);
    border: 1px solid var(--border2);
    color: var(--text);
    padding: 8px 16px;
    border-radius: 3px;
    font-family: 'Cinzel', serif;
    font-size: 11px;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn:hover, .btn:active { background: var(--bg4); border-color: var(--gold); color: var(--gold); }
  .btn-gold {
    background: linear-gradient(135deg, #8a6a20, var(--gold));
    border-color: var(--gold2);
    color: #1a1200;
    font-weight: 600;
  }
  .btn-gold:hover { filter: brightness(1.1); color: #1a1200; }
  .btn-danger { border-color: var(--red); color: var(--red); }

  /* ── Inputs ── */
  input[type="text"], input[type="date"], textarea, select {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 3px;
    font-family: 'Crimson Pro', serif;
    font-size: 15px;
    width: 100%;
    outline: none;
    transition: border-color 0.2s;
  }
  input:focus, textarea:focus, select:focus { border-color: var(--gold); }
  select option { background: var(--bg3); }
  textarea { resize: vertical; min-height: 80px; }

  label {
    display: block;
    font-size: 11px;
    letter-spacing: 0.08em;
    color: var(--text2);
    font-family: 'Cinzel', serif;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .field { margin-bottom: 12px; }

  /* ── Divider ── */
  .divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 16px 0;
    color: var(--text2);
    font-family: 'Cinzel', serif;
    font-size: 11px;
    letter-spacing: 0.15em;
  }
  .divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* ════════════════════════════
     CALENDAR SECTION
  ════════════════════════════ */
  .week-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .week-nav h2 {
    font-family: 'Cinzel', serif;
    font-size: 14px;
    color: var(--gold);
    letter-spacing: 0.1em;
    text-align: center;
    flex: 1;
  }

  .day-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 4px;
    margin-bottom: 8px;
    overflow: hidden;
  }

  .day-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    background: var(--bg3);
    cursor: pointer;
    user-select: none;
  }

  .day-header-left { display: flex; align-items: center; gap: 10px; }
  
  .day-name {
    font-family: 'Cinzel', serif;
    font-size: 12px;
    letter-spacing: 0.1em;
    color: var(--gold2);
  }

  .day-date {
    font-size: 12px;
    color: var(--text2);
  }

  .day-badge {
    background: var(--accent);
    color: white;
    border-radius: 10px;
    padding: 1px 7px;
    font-size: 10px;
    font-family: 'Cinzel', serif;
  }

  .day-body {
    padding: 12px 14px;
    display: none;
  }
  .day-body.open { display: block; }

  .entry-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
  }
  .entry-item:last-child { border-bottom: none; }

  .entry-time {
    font-family: 'Cinzel', serif;
    font-size: 10px;
    color: var(--text2);
    min-width: 45px;
    padding-top: 2px;
  }

  .entry-text { flex: 1; font-size: 15px; color: var(--text); line-height: 1.4; }

  .entry-badge {
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 10px;
    font-family: 'Cinzel', serif;
  }
  .badge-routine { background: rgba(201,168,76,0.15); color: var(--gold); border: 1px solid rgba(201,168,76,0.3); }
  .badge-note { background: rgba(123,108,238,0.15); color: var(--accent2); border: 1px solid rgba(123,108,238,0.3); }

  .entry-delete {
    background: none;
    border: none;
    color: var(--text2);
    cursor: pointer;
    padding: 0 2px;
    font-size: 16px;
    line-height: 1;
    transition: color 0.2s;
  }
  .entry-delete:hover { color: var(--red); }

  /* ════════════════════════════
     PERSONA SECTION
  ════════════════════════════ */
  .persona-active-card {
    background: linear-gradient(135deg, #1a1624 0%, #141020 100%);
    border: 1px solid var(--accent);
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
  }

  .persona-active-card::after {
    content: '';
    position: absolute;
    top: -40px; right: -40px;
    width: 140px; height: 140px;
    background: radial-gradient(circle, rgba(123,108,238,0.12) 0%, transparent 70%);
    pointer-events: none;
  }

  .persona-name {
    font-family: 'Cinzel', serif;
    font-size: 20px;
    font-weight: 600;
    color: var(--accent2);
    letter-spacing: 0.1em;
    margin-bottom: 4px;
  }

  .persona-class {
    font-size: 13px;
    color: var(--text2);
    font-style: italic;
    margin-bottom: 16px;
  }

  .stat-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }

  .stat-label {
    font-family: 'Cinzel', serif;
    font-size: 10px;
    letter-spacing: 0.08em;
    color: var(--text2);
    min-width: 90px;
    text-transform: uppercase;
  }

  .stat-bar-bg {
    flex: 1;
    height: 6px;
    background: var(--bg4);
    border-radius: 3px;
    overflow: hidden;
  }

  .stat-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.5s ease;
  }

  .stat-value {
    font-family: 'Cinzel', serif;
    font-size: 11px;
    color: var(--text);
    min-width: 28px;
    text-align: right;
  }

  .persona-list-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 14px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 4px;
    margin-bottom: 8px;
  }

  .persona-list-item .name {
    font-family: 'Cinzel', serif;
    font-size: 13px;
    color: var(--text);
  }
  .persona-list-item .role {
    font-size: 12px;
    color: var(--text2);
    font-style: italic;
  }

  .pill-active {
    background: rgba(123,108,238,0.2);
    color: var(--accent2);
    border: 1px solid rgba(123,108,238,0.4);
    padding: 2px 8px;
    border-radius: 10px;
    font-family: 'Cinzel', serif;
    font-size: 9px;
    letter-spacing: 0.08em;
  }

  /* ════════════════════════════
     PEOPLE SECTION
  ════════════════════════════ */
  .person-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 4px;
    margin-bottom: 10px;
    overflow: hidden;
  }

  .person-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px;
    cursor: pointer;
  }

  .person-avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--bg4), var(--bg3));
    border: 1px solid var(--border2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Cinzel', serif;
    font-size: 16px;
    color: var(--gold);
    flex-shrink: 0;
  }

  .person-info { flex: 1; }
  .person-name { font-family: 'Cinzel', serif; font-size: 14px; color: var(--text); }
  .person-rel { font-size: 12px; color: var(--text2); font-style: italic; }

  .person-body { padding: 0 14px 14px; display: none; }
  .person-body.open { display: block; }

  .info-tag {
    display: inline-block;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 2px 8px;
    font-size: 12px;
    color: var(--text);
    margin: 2px;
  }

  .section-label {
    font-family: 'Cinzel', serif;
    font-size: 10px;
    letter-spacing: 0.12em;
    color: var(--gold);
    text-transform: uppercase;
    margin: 12px 0 6px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* ── Modal ── */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    z-index: 200;
    display: none;
    align-items: flex-end;
    justify-content: center;
    padding: 0;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--bg2);
    border: 1px solid var(--border2);
    border-radius: 8px 8px 0 0;
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 20px;
    padding-bottom: calc(20px + env(safe-area-inset-bottom, 0));
    transform: translateY(0);
  }

  .modal h2 {
    font-family: 'Cinzel', serif;
    font-size: 16px;
    color: var(--gold);
    letter-spacing: 0.1em;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }

  .modal-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    justify-content: flex-end;
  }

  /* Range slider */
  input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 4px;
    background: var(--bg4);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: var(--accent2);
    border-radius: 50%;
    box-shadow: 0 0 8px rgba(123,108,238,0.5);
  }

  /* Today highlight */
  .day-card.today .day-header { background: #1a1620; }
  .day-card.today .day-name { color: var(--accent2); }

  /* Scroll bar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  /* Row utils */
  .row { display: flex; gap: 8px; }
  .row > * { flex: 1; }

  /* Ornament */
  .ornament {
    text-align: center;
    color: var(--border2);
    font-size: 18px;
    margin: 8px 0;
    letter-spacing: 8px;
  }

  .empty-state {
    text-align: center;
    padding: 32px 16px;
    color: var(--text2);
    font-style: italic;
    font-size: 15px;
  }

  .tag-list { display: flex; flex-wrap: wrap; gap: 4px; }

  .chevron {
    transition: transform 0.2s;
    color: var(--text2);
    font-size: 12px;
  }
  .chevron.open { transform: rotate(90deg); }
</style>
</head>
<body>

<!-- ── HEADER ── -->
<header>
  <div style="display:flex;align-items:center;justify-content:space-between;">
    <div>
      <h1>CHRONICLE</h1>
      <p id="headerSub">Your personal tome</p>
    </div>
    <button class="btn" style="font-size:10px;padding:6px 12px;display:flex;align-items:center;gap:6px;" onclick="openModal('modal-backup')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Backup
    </button>
  </div>
</header>

<!-- ══════════ CALENDAR SECTION ══════════ -->
<section class="section active" id="sec-calendar">
  <div class="week-nav">
    <button class="btn" onclick="changeWeek(-1)">◀</button>
    <h2 id="weekLabel"></h2>
    <button class="btn" onclick="changeWeek(1)">▶</button>
  </div>
  <button class="btn btn-gold" style="width:100%;margin-bottom:16px;" onclick="openAddEntry()">+ Add Entry</button>
  <div id="calendarDays"></div>
</section>

<!-- ══════════ PERSONA SECTION ══════════ -->
<section class="section" id="sec-persona">
  <div id="activePersonaArea"></div>
  <div class="divider">All Personas</div>
  <div id="personaList"></div>
  <button class="btn btn-gold" style="width:100%;margin-top:8px;" onclick="openAddPersona()">+ New Persona</button>
</section>

<!-- ══════════ PEOPLE SECTION ══════════ -->
<section class="section" id="sec-people">
  <button class="btn btn-gold" style="width:100%;margin-bottom:16px;" onclick="openAddPerson()">+ Add Person</button>
  <div id="peopleList"></div>
</section>

<!-- ── BOTTOM NAV ── -->
<nav>
  <button class="active" onclick="showSection('calendar')" id="nav-calendar">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="16" y1="2" x2="16" y2="6"/></svg>
    Calendar
  </button>
  <button onclick="showSection('persona')" id="nav-persona">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/><path d="M17 5l1 1 2-2"/></svg>
    Persona
  </button>
  <button onclick="showSection('people')" id="nav-people">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="9" cy="7" r="3"/><path d="M2 19c0-3.3 3.1-6 7-6s7 2.7 7 6"/><circle cx="17" cy="7" r="2"/><path d="M22 19c0-2.2-2.1-4-5-4"/></svg>
    People
  </button>
</nav>

<!-- ════════════ MODALS ════════════ -->

<!-- Add Calendar Entry -->
<!-- Backup / Export / Import -->
<div class="modal-overlay" id="modal-backup">
  <div class="modal">
    <h2>⚔ Backup &amp; Restore</h2>

    <p style="font-size:14px;color:var(--text2);margin-bottom:16px;line-height:1.6;">
      Export your Chronicle data and store it anywhere — iCloud, Google Drive, a password manager. Import on any device to restore.
    </p>

    <div class="divider">Export</div>

    <div class="field">
      <label>Password (optional — encrypts your backup)</label>
      <div style="position:relative;">
        <input type="password" id="exportPassword" placeholder="Leave blank for plain JSON export" oninput="checkExportStrength()">
        <button onclick="togglePw('exportPassword',this)" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text2);cursor:pointer;font-size:11px;font-family:'Cinzel',serif;letter-spacing:0.05em;">SHOW</button>
      </div>
    </div>
    <div id="exportStrength" style="font-size:12px;height:18px;margin-top:-6px;margin-bottom:10px;padding-left:2px;"></div>

    <button class="btn btn-gold" style="width:100%;" onclick="doExport()">
      ↓ Download Backup File
    </button>

    <div class="divider">Import &amp; Restore</div>

    <p style="font-size:13px;color:var(--amber);margin-bottom:10px;line-height:1.5;">⚠ Importing <strong>merges</strong> with existing data. Identical IDs are skipped to prevent duplicates.</p>

    <div class="field">
      <label>Select backup file (.json)</label>
      <input type="file" id="importFile" accept=".json" style="padding:6px;color:var(--text);">
    </div>
    <div class="field">
      <label>Password (if file was encrypted)</label>
      <input type="password" id="importPassword" placeholder="Leave blank if not encrypted">
    </div>

    <button class="btn btn-gold" style="width:100%;" onclick="doImport()">↑ Import from File</button>

    <div id="importStatus" style="margin-top:10px;font-size:13px;text-align:center;min-height:20px;font-family:'Cinzel',serif;letter-spacing:0.05em;"></div>

    <div class="divider">Danger Zone</div>
    <button class="btn btn-danger" style="width:100%;" onclick="clearAllData()">✕ Clear All Data</button>

    <div class="modal-actions" style="margin-top:20px;">
      <button class="btn" onclick="closeModal('modal-backup')">Close</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-entry">
  <div class="modal">
    <h2>Add Calendar Entry</h2>
    <div class="field">
      <label>Day of Week</label>
      <select id="entryDay">
        <option value="0">Sunday</option>
        <option value="1">Monday</option>
        <option value="2">Tuesday</option>
        <option value="3">Wednesday</option>
        <option value="4">Thursday</option>
        <option value="5">Friday</option>
        <option value="6">Saturday</option>
      </select>
    </div>
    <div class="field">
      <label>Time (optional)</label>
      <input type="text" id="entryTime" placeholder="e.g. 9:00 AM">
    </div>
    <div class="field">
      <label>Entry</label>
      <textarea id="entryText" placeholder="What are you recording?"></textarea>
    </div>
    <div class="field">
      <label>Type</label>
      <select id="entryType">
        <option value="routine">Routine (repeats weekly)</option>
        <option value="note">Note (this week only)</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('modal-entry')">Cancel</button>
      <button class="btn btn-gold" onclick="saveEntry()">Save</button>
    </div>
  </div>
</div>

<!-- Add Persona -->
<div class="modal-overlay" id="modal-persona">
  <div class="modal">
    <h2>New Persona</h2>
    <div class="field">
      <label>Name</label>
      <input type="text" id="pName" placeholder="Persona name">
    </div>
    <div class="field">
      <label>Role / Description</label>
      <input type="text" id="pRole" placeholder="e.g. The Strategist, Work Mode...">
    </div>
    <div class="divider">Attributes</div>
    <div id="statFields"></div>
    <div class="field">
      <label>Notes</label>
      <textarea id="pNotes" placeholder="Notes about this persona..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('modal-persona')">Cancel</button>
      <button class="btn btn-gold" onclick="savePersona()">Save</button>
    </div>
  </div>
</div>

<!-- Edit Persona Stats -->
<div class="modal-overlay" id="modal-edit-persona">
  <div class="modal">
    <h2 id="editPersonaTitle">Edit Persona</h2>
    <div id="editStatFields"></div>
    <div class="field" style="margin-top:12px;">
      <label>Notes</label>
      <textarea id="editPNotes"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="deletePersona()">Delete</button>
      <button class="btn" onclick="closeModal('modal-edit-persona')">Cancel</button>
      <button class="btn btn-gold" onclick="saveEditPersona()">Save</button>
    </div>
  </div>
</div>

<!-- Add Person -->
<div class="modal-overlay" id="modal-person">
  <div class="modal">
    <h2 id="personModalTitle">Add Person</h2>
    <div class="row">
      <div class="field">
        <label>Name</label>
        <input type="text" id="personName" placeholder="Full name">
      </div>
      <div class="field">
        <label>Relationship</label>
        <input type="text" id="personRel" placeholder="Friend, colleague...">
      </div>
    </div>
    <div class="field">
      <label>Likes (comma separated)</label>
      <input type="text" id="personLikes" placeholder="e.g. coffee, hiking, jazz">
    </div>
    <div class="field">
      <label>Dislikes (comma separated)</label>
      <input type="text" id="personDislikes" placeholder="e.g. crowds, deadlines">
    </div>
    <div class="field">
      <label>Personality Traits (comma separated)</label>
      <input type="text" id="personTraits" placeholder="e.g. introverted, analytical">
    </div>
    <div class="field">
      <label>Important Dates (one per line)</label>
      <textarea id="personDates" placeholder="Birthday: Jan 5&#10;Anniversary: March 12"></textarea>
    </div>
    <div class="field">
      <label>Notes</label>
      <textarea id="personNotes" placeholder="Anything else worth remembering..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger" id="deletePersonBtn" onclick="deletePerson()" style="display:none;">Delete</button>
      <button class="btn" onclick="closeModal('modal-person')">Cancel</button>
      <button class="btn btn-gold" onclick="savePerson()">Save</button>
    </div>
  </div>
</div>

<script>
// ══════════════════════════════════
//  DATA MODEL
// ══════════════════════════════════
let data = {
  entries: [],       // {id, dayOfWeek(0-6), time, text, type:'routine'|'note', weekKey(for notes)}
  personas: [],      // {id, name, role, notes, stats:{happiness,confidence,...}, active:bool}
  people: []         // {id, name, rel, likes, dislikes, traits, dates, notes}
};

const DAYS = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const STATS = ['Happiness','Confidence','Energy','Anger','Anxiety','Focus','Creativity','Motivation'];
const STAT_COLORS = {
  Happiness:'#55aa77', Confidence:'#c9a84c', Energy:'#e8c97a',
  Anger:'#cc5555', Anxiety:'#cc8844', Focus:'#5588cc',
  Creativity:'#9955cc', Motivation:'#55aacc'
};

let currentWeekOffset = 0;
let editingPersonaId = null;
let editingPersonId = null;

// ── Persistence ──
function save() { localStorage.setItem('chronicle_data', JSON.stringify(data)); }
function load() {
  const raw = localStorage.getItem('chronicle_data');
  if (raw) {
    try { data = JSON.parse(raw); } catch(e) {}
  }
}

// ── Utilities ──
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

function getWeekStart(offset) {
  const d = new Date();
  const day = d.getDay();
  d.setDate(d.getDate() - day + offset * 7);
  d.setHours(0,0,0,0);
  return d;
}

function weekKey(offset) {
  const d = getWeekStart(offset);
  return d.toISOString().slice(0,10);
}

// ══════════════════════════════════
//  NAVIGATION
// ══════════════════════════════════
function showSection(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('sec-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');

  const subtitles = {
    calendar: 'Weekly scroll of time',
    persona: 'Who you are today',
    people: 'Those who walk beside you'
  };
  document.getElementById('headerSub').textContent = subtitles[name];
}

// ══════════════════════════════════
//  CALENDAR
// ══════════════════════════════════
function changeWeek(delta) {
  currentWeekOffset += delta;
  renderCalendar();
}

function renderCalendar() {
  const ws = getWeekStart(currentWeekOffset);
  const we = new Date(ws); we.setDate(we.getDate()+6);
  document.getElementById('weekLabel').textContent =
    ws.toLocaleDateString('en-US',{month:'short',day:'numeric'}) + ' – ' +
    we.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});

  const today = new Date(); today.setHours(0,0,0,0);
  const wk = weekKey(currentWeekOffset);

  const container = document.getElementById('calendarDays');
  container.innerHTML = '';

  for (let i = 0; i < 7; i++) {
    const dayDate = new Date(ws); dayDate.setDate(ws.getDate()+i);
    const isToday = dayDate.getTime() === today.getTime();

    // Gather entries: routines for this day + notes for this week+day
    const dayEntries = data.entries.filter(e =>
      parseInt(e.dayOfWeek) === i &&
      (e.type === 'routine' || (e.type === 'note' && e.weekKey === wk))
    );

    const card = document.createElement('div');
    card.className = 'day-card' + (isToday ? ' today' : '');

    const header = document.createElement('div');
    header.className = 'day-header';
    header.innerHTML = `
      <div class="day-header-left">
        <span class="day-name">${DAYS[i]}</span>
        <span class="day-date">${dayDate.toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span>
        ${dayEntries.length ? `<span class="day-badge">${dayEntries.length}</span>` : ''}
      </div>
      <span class="chevron" id="chev-${i}">▶</span>
    `;

    const body = document.createElement('div');
    body.className = 'day-body' + (isToday ? ' open' : '');
    if (isToday) document.getElementById && setTimeout(()=>{
      const ch = document.getElementById('chev-'+i);
      if(ch) ch.classList.toggle('open', true);
    },0);

    if (dayEntries.length === 0) {
      body.innerHTML = '<div class="empty-state">No entries for this day</div>';
    } else {
      dayEntries.sort((a,b) => (a.time||'').localeCompare(b.time||'')).forEach(e => {
        const div = document.createElement('div');
        div.className = 'entry-item';
        div.innerHTML = `
          <span class="entry-time">${e.time || '—'}</span>
          <span class="entry-text">${escHtml(e.text)}</span>
          <span class="entry-badge ${e.type==='routine'?'badge-routine':'badge-note'}">${e.type}</span>
          <button class="entry-delete" onclick="deleteEntry('${e.id}')">×</button>
        `;
        body.appendChild(div);
      });
    }

    header.addEventListener('click', () => {
      body.classList.toggle('open');
      const ch = header.querySelector('.chevron');
      ch.classList.toggle('open', body.classList.contains('open'));
    });

    card.appendChild(header);
    card.appendChild(body);
    container.appendChild(card);
  }
}

function openAddEntry() {
  const today = new Date().getDay();
  document.getElementById('entryDay').value = today;
  document.getElementById('entryTime').value = '';
  document.getElementById('entryText').value = '';
  document.getElementById('entryType').value = 'routine';
  openModal('modal-entry');
}

function saveEntry() {
  const text = document.getElementById('entryText').value.trim();
  if (!text) return;
  data.entries.push({
    id: uid(),
    dayOfWeek: parseInt(document.getElementById('entryDay').value),
    time: document.getElementById('entryTime').value.trim(),
    text,
    type: document.getElementById('entryType').value,
    weekKey: weekKey(currentWeekOffset)
  });
  save();
  closeModal('modal-entry');
  renderCalendar();
}

function deleteEntry(id) {
  data.entries = data.entries.filter(e => e.id !== id);
  save();
  renderCalendar();
}

// ══════════════════════════════════
//  PERSONA
// ══════════════════════════════════
function renderPersona() {
  const active = data.personas.find(p => p.active);
  const area = document.getElementById('activePersonaArea');
  if (!active) {
    area.innerHTML = '<div class="empty-state">No active persona. Create one below.</div>';
  } else {
    area.innerHTML = buildPersonaCard(active, true);
  }

  const list = document.getElementById('personaList');
  if (data.personas.length === 0) {
    list.innerHTML = '<div class="empty-state">No personas yet.</div>';
    return;
  }
  list.innerHTML = data.personas.map(p => `
    <div class="persona-list-item">
      <div>
        <div class="name">${escHtml(p.name)}</div>
        <div class="role">${escHtml(p.role||'')}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        ${p.active ? '<span class="pill-active">ACTIVE</span>' : `<button class="btn" style="font-size:10px;padding:4px 10px;" onclick="setActivePersona('${p.id}')">Set Active</button>`}
        <button class="btn" style="font-size:10px;padding:4px 10px;" onclick="editPersona('${p.id}')">Edit</button>
      </div>
    </div>
  `).join('');
}

function buildPersonaCard(p, isMain) {
  const statBars = STATS.map(s => {
    const val = p.stats?.[s] ?? 50;
    const color = STAT_COLORS[s] || '#888';
    return `
      <div class="stat-row">
        <span class="stat-label">${s}</span>
        <div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${val}%;background:${color};"></div></div>
        <span class="stat-value">${val}</span>
      </div>`;
  }).join('');

  return `
    <div class="persona-active-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <div class="persona-name">${escHtml(p.name)}</div>
          <div class="persona-class">${escHtml(p.role||'')}</div>
        </div>
        <button class="btn" style="font-size:10px;padding:4px 10px;" onclick="editPersona('${p.id}')">Edit</button>
      </div>
      ${statBars}
      ${p.notes ? `<div style="margin-top:12px;font-size:14px;color:var(--text2);font-style:italic;">${escHtml(p.notes)}</div>` : ''}
    </div>`;
}

function openAddPersona() {
  editingPersonaId = null;
  document.getElementById('pName').value = '';
  document.getElementById('pRole').value = '';
  document.getElementById('pNotes').value = '';
  const sf = document.getElementById('statFields');
  sf.innerHTML = STATS.map(s => `
    <div class="field">
      <label>${s} <span id="sv-${s}" style="color:var(--gold);float:right;">50</span></label>
      <input type="range" min="0" max="100" value="50" id="sr-${s}"
        oninput="document.getElementById('sv-${s}').textContent=this.value">
    </div>`).join('');
  openModal('modal-persona');
}

function savePersona() {
  const name = document.getElementById('pName').value.trim();
  if (!name) return;
  const stats = {};
  STATS.forEach(s => stats[s] = parseInt(document.getElementById('sr-'+s).value));
  const persona = {
    id: uid(), name,
    role: document.getElementById('pRole').value.trim(),
    notes: document.getElementById('pNotes').value.trim(),
    stats,
    active: data.personas.length === 0
  };
  data.personas.push(persona);
  save();
  closeModal('modal-persona');
  renderPersona();
}

function editPersona(id) {
  editingPersonaId = id;
  const p = data.personas.find(x => x.id === id);
  if (!p) return;
  document.getElementById('editPersonaTitle').textContent = p.name;
  document.getElementById('editPNotes').value = p.notes || '';
  const ef = document.getElementById('editStatFields');
  ef.innerHTML = STATS.map(s => {
    const v = p.stats?.[s] ?? 50;
    return `
      <div class="field">
        <label>${s} <span id="esv-${s}" style="color:var(--gold);float:right;">${v}</span></label>
        <input type="range" min="0" max="100" value="${v}" id="esr-${s}"
          oninput="document.getElementById('esv-${s}').textContent=this.value">
      </div>`;
  }).join('');
  openModal('modal-edit-persona');
}

function saveEditPersona() {
  const p = data.personas.find(x => x.id === editingPersonaId);
  if (!p) return;
  STATS.forEach(s => p.stats[s] = parseInt(document.getElementById('esr-'+s).value));
  p.notes = document.getElementById('editPNotes').value.trim();
  save();
  closeModal('modal-edit-persona');
  renderPersona();
}

function deletePersona() {
  if (!confirm('Delete this persona?')) return;
  data.personas = data.personas.filter(x => x.id !== editingPersonaId);
  if (data.personas.length > 0 && !data.personas.find(p => p.active)) {
    data.personas[0].active = true;
  }
  save();
  closeModal('modal-edit-persona');
  renderPersona();
}

function setActivePersona(id) {
  data.personas.forEach(p => p.active = p.id === id);
  save();
  renderPersona();
}

// ══════════════════════════════════
//  PEOPLE
// ══════════════════════════════════
function renderPeople() {
  const list = document.getElementById('peopleList');
  if (data.people.length === 0) {
    list.innerHTML = '<div class="empty-state">No people added yet.</div>';
    return;
  }
  list.innerHTML = '';
  data.people.forEach(p => {
    const card = document.createElement('div');
    card.className = 'person-card';
    const initials = p.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();

    const likes = p.likes ? p.likes.split(',').map(x=>x.trim()).filter(Boolean) : [];
    const dislikes = p.dislikes ? p.dislikes.split(',').map(x=>x.trim()).filter(Boolean) : [];
    const traits = p.traits ? p.traits.split(',').map(x=>x.trim()).filter(Boolean) : [];

    card.innerHTML = `
      <div class="person-header" onclick="togglePerson('pc-${p.id}', 'ch-${p.id}')">
        <div class="person-avatar">${initials}</div>
        <div class="person-info">
          <div class="person-name">${escHtml(p.name)}</div>
          <div class="person-rel">${escHtml(p.rel||'')}</div>
        </div>
        <span class="chevron" id="ch-${p.id}">▶</span>
      </div>
      <div class="person-body" id="pc-${p.id}">
        ${traits.length ? `<div class="section-label">Traits</div><div class="tag-list">${traits.map(t=>`<span class="info-tag">${escHtml(t)}</span>`).join('')}</div>` : ''}
        ${likes.length ? `<div class="section-label">Likes</div><div class="tag-list">${likes.map(t=>`<span class="info-tag" style="border-color:rgba(85,170,119,0.4);color:var(--green);">${escHtml(t)}</span>`).join('')}</div>` : ''}
        ${dislikes.length ? `<div class="section-label">Dislikes</div><div class="tag-list">${dislikes.map(t=>`<span class="info-tag" style="border-color:rgba(204,85,85,0.4);color:var(--red);">${escHtml(t)}</span>`).join('')}</div>` : ''}
        ${p.dates ? `<div class="section-label">Important Dates</div><div style="font-size:14px;color:var(--text);white-space:pre-wrap;">${escHtml(p.dates)}</div>` : ''}
        ${p.notes ? `<div class="section-label">Notes</div><div style="font-size:15px;color:var(--text);white-space:pre-wrap;font-style:italic;">${escHtml(p.notes)}</div>` : ''}
        <div style="margin-top:12px;">
          <button class="btn" style="font-size:10px;padding:4px 10px;" onclick="openEditPerson('${p.id}')">Edit</button>
        </div>
      </div>
    `;
    list.appendChild(card);
  });
}

function togglePerson(bodyId, chevId) {
  const body = document.getElementById(bodyId);
  const chev = document.getElementById(chevId);
  body.classList.toggle('open');
  chev.classList.toggle('open', body.classList.contains('open'));
}

function openAddPerson() {
  editingPersonId = null;
  document.getElementById('personModalTitle').textContent = 'Add Person';
  document.getElementById('deletePersonBtn').style.display = 'none';
  ['personName','personRel','personLikes','personDislikes','personTraits','personDates','personNotes'].forEach(id => {
    document.getElementById(id).value = '';
  });
  openModal('modal-person');
}

function openEditPerson(id) {
  editingPersonId = id;
  const p = data.people.find(x => x.id === id);
  if (!p) return;
  document.getElementById('personModalTitle').textContent = 'Edit ' + p.name;
  document.getElementById('deletePersonBtn').style.display = 'inline-block';
  document.getElementById('personName').value = p.name || '';
  document.getElementById('personRel').value = p.rel || '';
  document.getElementById('personLikes').value = p.likes || '';
  document.getElementById('personDislikes').value = p.dislikes || '';
  document.getElementById('personTraits').value = p.traits || '';
  document.getElementById('personDates').value = p.dates || '';
  document.getElementById('personNotes').value = p.notes || '';
  openModal('modal-person');
}

function savePerson() {
  const name = document.getElementById('personName').value.trim();
  if (!name) return;
  const obj = {
    id: editingPersonId || uid(),
    name,
    rel: document.getElementById('personRel').value.trim(),
    likes: document.getElementById('personLikes').value.trim(),
    dislikes: document.getElementById('personDislikes').value.trim(),
    traits: document.getElementById('personTraits').value.trim(),
    dates: document.getElementById('personDates').value.trim(),
    notes: document.getElementById('personNotes').value.trim()
  };
  if (editingPersonId) {
    const idx = data.people.findIndex(x => x.id === editingPersonId);
    if (idx >= 0) data.people[idx] = obj;
  } else {
    data.people.push(obj);
  }
  save();
  closeModal('modal-person');
  renderPeople();
}

function deletePerson() {
  if (!confirm('Delete this person?')) return;
  data.people = data.people.filter(x => x.id !== editingPersonId);
  save();
  closeModal('modal-person');
  renderPeople();
}

// ══════════════════════════════════
//  MODAL HELPERS
// ══════════════════════════════════
function openModal(id) {
  document.getElementById(id).classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  document.body.style.overflow = '';
}

// Close on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) closeModal(overlay.id);
  });
});

// ══════════════════════════════════
//  BACKUP / EXPORT / IMPORT
// ══════════════════════════════════

function togglePw(id, btn) {
  const el = document.getElementById(id);
  el.type = el.type === 'password' ? 'text' : 'password';
  btn.textContent = el.type === 'password' ? 'SHOW' : 'HIDE';
}

function checkExportStrength() {
  const pw = document.getElementById('exportPassword').value;
  const el = document.getElementById('exportStrength');
  if (!pw) { el.textContent = ''; return; }
  let score = 0;
  if (pw.length >= 8) score++;
  if (pw.length >= 14) score++;
  if (/[A-Z]/.test(pw)) score++;
  if (/[0-9]/.test(pw)) score++;
  if (/[^A-Za-z0-9]/.test(pw)) score++;
  const labels = ['','Weak','Fair','Good','Strong','Very Strong'];
  const colors = ['','var(--red)','var(--amber)','var(--amber)','var(--green)','var(--green)'];
  el.textContent = '● Strength: ' + (labels[score]||'Weak');
  el.style.color = colors[score] || 'var(--red)';
}

// ── Crypto helpers (AES-GCM via Web Crypto API) ──
async function deriveKey(password, salt) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt, iterations: 310000, hash: 'SHA-256' },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt', 'decrypt']
  );
}

async function encryptData(plaintext, password) {
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv   = crypto.getRandomValues(new Uint8Array(12));
  const key  = await deriveKey(password, salt);
  const enc  = new TextEncoder();
  const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(plaintext));
  // Pack: salt(16) + iv(12) + ciphertext
  const buf = new Uint8Array(16 + 12 + ciphertext.byteLength);
  buf.set(salt, 0);
  buf.set(iv, 16);
  buf.set(new Uint8Array(ciphertext), 28);
  return btoa(String.fromCharCode(...buf));
}

async function decryptData(b64, password) {
  const buf  = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
  const salt = buf.slice(0, 16);
  const iv   = buf.slice(16, 28);
  const ct   = buf.slice(28);
  const key  = await deriveKey(password, salt);
  const plain = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ct);
  return new TextDecoder().decode(plain);
}

// ── Export ──
async function doExport() {
  const password = document.getElementById('exportPassword').value;
  const timestamp = new Date().toISOString().slice(0,16).replace('T','_').replace(':','-');
  const payload = JSON.stringify({ version: 1, exported: new Date().toISOString(), data });

  let fileContent, filename;
  if (password) {
    try {
      const encrypted = await encryptData(payload, password);
      fileContent = JSON.stringify({ chronicle_encrypted: true, version: 1, payload: encrypted });
      filename = `chronicle_backup_${timestamp}.enc.json`;
    } catch(e) {
      alert('Encryption failed: ' + e.message);
      return;
    }
  } else {
    fileContent = payload;
    filename = `chronicle_backup_${timestamp}.json`;
  }

  const blob = new Blob([fileContent], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ── Import ──
async function doImport() {
  const file = document.getElementById('importFile').files[0];
  const statusEl = document.getElementById('importStatus');
  if (!file) { statusEl.textContent = 'No file selected.'; statusEl.style.color = 'var(--amber)'; return; }

  statusEl.textContent = 'Reading…'; statusEl.style.color = 'var(--text2)';

  const text = await file.text();
  let parsed;
  try {
    parsed = JSON.parse(text);
  } catch(e) {
    statusEl.textContent = '✕ Invalid file format.'; statusEl.style.color = 'var(--red)'; return;
  }

  let importedData;
  if (parsed.chronicle_encrypted) {
    const password = document.getElementById('importPassword').value;
    if (!password) { statusEl.textContent = '✕ This file is encrypted — enter a password.'; statusEl.style.color = 'var(--amber)'; return; }
    try {
      const plain = await decryptData(parsed.payload, password);
      importedData = JSON.parse(plain).data;
    } catch(e) {
      statusEl.textContent = '✕ Wrong password or corrupted file.'; statusEl.style.color = 'var(--red)'; return;
    }
  } else if (parsed.data) {
    importedData = parsed.data;
  } else {
    statusEl.textContent = '✕ Unrecognised file structure.'; statusEl.style.color = 'var(--red)'; return;
  }

  // Merge: add items whose IDs don't already exist
  let added = { entries: 0, personas: 0, people: 0 };
  const existingIds = {
    entries: new Set(data.entries.map(x=>x.id)),
    personas: new Set(data.personas.map(x=>x.id)),
    people: new Set(data.people.map(x=>x.id))
  };

  (importedData.entries||[]).forEach(e => { if (!existingIds.entries.has(e.id)) { data.entries.push(e); added.entries++; } });
  (importedData.personas||[]).forEach(e => { if (!existingIds.personas.has(e.id)) { data.personas.push(e); added.personas++; } });
  (importedData.people||[]).forEach(e => { if (!existingIds.people.has(e.id)) { data.people.push(e); added.people++; } });

  save();
  renderCalendar(); renderPersona(); renderPeople();
  statusEl.style.color = 'var(--green)';
  statusEl.textContent = `✓ Imported: ${added.entries} entries, ${added.personas} personas, ${added.people} people`;
}

// ── Clear ──
function clearAllData() {
  if (!confirm('This will permanently delete ALL your Chronicle data. Are you sure?')) return;
  if (!confirm('Last warning — this cannot be undone. Delete everything?')) return;
  data = { entries: [], personas: [], people: [] };
  save();
  closeModal('modal-backup');
  renderCalendar(); renderPersona(); renderPeople();
}

// ══════════════════════════════════
//  UTILS
// ══════════════════════════════════
function escHtml(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ══════════════════════════════════
//  INIT
// ══════════════════════════════════
load();
renderCalendar();
renderPersona();
renderPeople();
</script>
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js")
      .then(reg => console.log("Chronicle SW registered:", reg.scope))
      .catch(err => console.warn("SW registration failed:", err));
  });
}
</script>
</body>
</html>
