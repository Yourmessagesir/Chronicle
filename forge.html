<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d0d0f">
<link rel="manifest" href="forge_manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Forge â€” Card Game Lab</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d0d0f;--bg2:#13131a;--bg3:#1a1a24;--bg4:#222230;
  --border:#2e2e42;--border2:#3d3d58;
  --gold:#c9a84c;--gold2:#e8c97a;
  --text:#d4d4e8;--text2:#9090aa;
  --accent:#7b6cee;--accent2:#a99bff;
  --red:#cc5555;--green:#55aa77;--amber:#cc8844;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:16px;min-height:100vh;overflow-x:hidden;-webkit-tap-highlight-color:transparent;}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.4;}

/* â”€â”€ HEADER â”€â”€ */
header{background:linear-gradient(180deg,#0d0d0f,var(--bg2));border-bottom:1px solid var(--border);padding:14px 16px 10px;position:sticky;top:0;z-index:50;}
.header-row{display:flex;align-items:center;justify-content:space-between;}
header h1{font-family:'Cinzel',serif;font-size:20px;font-weight:700;color:var(--gold);letter-spacing:0.18em;text-shadow:0 0 30px rgba(201,168,76,0.35);}
header p{font-size:11px;color:var(--text2);letter-spacing:0.05em;margin-top:1px;}

/* â”€â”€ NAV TABS â”€â”€ */
.tab-bar{display:flex;background:var(--bg2);border-bottom:1px solid var(--border);overflow-x:auto;}
.tab-btn{flex:1;min-width:70px;background:none;border:none;border-bottom:2px solid transparent;color:var(--text2);padding:10px 6px;font-family:'Cinzel',serif;font-size:9px;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;transition:all 0.2s;display:flex;flex-direction:column;align-items:center;gap:3px;white-space:nowrap;}
.tab-btn svg{width:17px;height:17px;}
.tab-btn.active{color:var(--gold);border-bottom-color:var(--gold);}

/* â”€â”€ SECTIONS â”€â”€ */
.section{display:none;padding:16px 14px 90px;}
.section.active{display:block;}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{background:var(--bg3);border:1px solid var(--border2);color:var(--text);padding:8px 14px;border-radius:3px;font-family:'Cinzel',serif;font-size:11px;letter-spacing:0.08em;cursor:pointer;transition:all 0.2s;}
.btn:hover,.btn:active{background:var(--bg4);border-color:var(--gold);color:var(--gold);}
.btn-gold{background:linear-gradient(135deg,#8a6a20,var(--gold));border-color:var(--gold2);color:#1a1200;font-weight:700;}
.btn-gold:hover{filter:brightness(1.1);color:#1a1200;}
.btn-danger{border-color:var(--red);color:var(--red);}
.btn-sm{padding:4px 10px;font-size:10px;}

/* â”€â”€ INPUTS â”€â”€ */
input[type="text"],input[type="number"],textarea,select{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:3px;font-family:'Crimson Pro',serif;font-size:15px;width:100%;outline:none;transition:border-color 0.2s;}
input:focus,textarea:focus,select:focus{border-color:var(--gold);}
select option{background:var(--bg3);}
textarea{resize:vertical;min-height:70px;}
label{display:block;font-size:10px;letter-spacing:0.08em;color:var(--text2);font-family:'Cinzel',serif;text-transform:uppercase;margin-bottom:4px;}
.field{margin-bottom:12px;}
.row{display:flex;gap:8px;}.row>.field{flex:1;}

/* â”€â”€ DIVIDER â”€â”€ */
.divider{display:flex;align-items:center;gap:12px;margin:14px 0;color:var(--text2);font-family:'Cinzel',serif;font-size:10px;letter-spacing:0.15em;}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border);}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.78);z-index:200;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:8px 8px 0 0;width:100%;max-width:600px;max-height:92vh;overflow-y:auto;padding:20px;padding-bottom:calc(20px + env(safe-area-inset-bottom,0));}
.modal h2{font-family:'Cinzel',serif;font-size:16px;color:var(--gold);letter-spacing:0.1em;margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid var(--border);}
.modal-actions{display:flex;gap:8px;margin-top:16px;justify-content:flex-end;flex-wrap:wrap;}

/* â”€â”€ CARD GRID â”€â”€ */
.card-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.card-tile{background:var(--bg2);border:2px solid var(--border);border-radius:6px;padding:8px 6px 6px;cursor:pointer;transition:all 0.15s;position:relative;min-height:88px;display:flex;flex-direction:column;align-items:center;text-align:center;}
.card-tile:active{transform:scale(0.95);}
.card-tile .ct-icon{font-size:20px;margin-bottom:3px;}
.card-tile .ct-name{font-family:'Cinzel',serif;font-size:9px;letter-spacing:0.05em;color:var(--text);line-height:1.3;word-break:break-word;}
.card-tile .ct-type{font-size:8px;margin-top:2px;}
.card-tile .ct-cost{position:absolute;top:4px;right:5px;font-family:'Cinzel',serif;font-size:10px;color:var(--gold);}
.card-tile .ct-stats{font-size:8px;color:var(--text2);margin-top:3px;line-height:1.4;}
.card-tile .ct-game{font-size:7px;color:var(--text2);margin-top:2px;opacity:0.7;}

/* â”€â”€ GAME CARD â”€â”€ */
.game-card{background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:14px;margin-bottom:10px;position:relative;}
.game-card::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(180deg,var(--gold),transparent);border-radius:4px 0 0 4px;}
.game-card h3{font-family:'Cinzel',serif;font-size:14px;color:var(--gold2);margin-bottom:6px;}

/* â”€â”€ ATTACK ROW â”€â”€ */
.atk-row{display:flex;gap:6px;align-items:center;margin-bottom:8px;flex-wrap:wrap;}
.atk-row input,.atk-row select{flex:1;min-width:50px;font-size:12px;padding:6px 8px;}
.atk-tag{display:inline-flex;align-items:center;gap:4px;background:var(--bg4);border:1px solid var(--border2);border-radius:3px;padding:2px 7px;font-size:11px;margin:2px;}

/* â”€â”€ PLAYTEST TABLE â”€â”€ */
#playTable{background:var(--bg);padding:0;}

.pt-zone{padding:10px 14px 6px;}
.pt-zone-label{font-family:'Cinzel',serif;font-size:9px;letter-spacing:0.12em;color:var(--text2);text-transform:uppercase;margin-bottom:6px;}

.pt-hp-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.pt-hp-label{font-family:'Cinzel',serif;font-size:10px;color:var(--text2);min-width:36px;}
.pt-hp-track{flex:1;height:10px;background:var(--bg4);border-radius:5px;overflow:hidden;border:1px solid var(--border);}
.pt-hp-fill{height:100%;border-radius:5px;transition:width 0.35s,background 0.35s;}
.pt-hp-val{font-family:'Cinzel',serif;font-size:11px;min-width:24px;text-align:right;}
.pt-res{font-family:'Cinzel',serif;font-size:11px;color:var(--gold);}

.field-row{display:flex;gap:6px;overflow-x:auto;padding:4px 0 6px;min-height:86px;align-items:flex-start;}
.hand-row{display:flex;gap:6px;overflow-x:auto;padding:4px 0 6px;min-height:96px;}

/* play card */
.pc{background:var(--bg3);border:2px solid var(--border2);border-radius:6px;padding:6px 5px;min-width:68px;max-width:78px;cursor:pointer;transition:all 0.18s;position:relative;flex-shrink:0;text-align:center;user-select:none;}
.pc:active{transform:scale(0.93);}
.pc.selected{border-color:var(--gold);box-shadow:0 0 12px rgba(201,168,76,0.45);}
.pc.tapped{opacity:0.5;filter:brightness(0.7);}
.pc .pc-icon{font-size:16px;margin-bottom:2px;}
.pc .pc-name{font-family:'Cinzel',serif;font-size:8px;color:var(--text);line-height:1.2;margin-bottom:3px;}
.pc .pc-stats{font-size:8px;color:var(--text2);display:flex;flex-wrap:wrap;justify-content:center;gap:2px;}
.pc .pc-stats span{background:var(--bg4);border-radius:2px;padding:1px 3px;}
.pc .pc-cost{position:absolute;top:2px;right:3px;font-size:8px;color:var(--gold);font-family:'Cinzel',serif;}

/* opp card */
.oc{background:var(--bg4);border:2px solid var(--border);border-radius:6px;padding:5px 4px;min-width:64px;max-width:74px;cursor:pointer;flex-shrink:0;text-align:center;transition:border-color 0.15s;}
.oc:active{border-color:var(--red);}
.oc .oc-icon{font-size:14px;}
.oc .oc-name{font-family:'Cinzel',serif;font-size:8px;color:var(--text);line-height:1.2;}
.oc .oc-stats{font-size:8px;color:var(--text2);}

/* face-down */
.card-back{min-width:58px;height:80px;background:var(--bg4);border:2px solid var(--border2);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}

/* piles row */
.piles-row{display:flex;gap:8px;padding:6px 14px;}
.pile-box{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:8px;text-align:center;font-family:'Cinzel',serif;font-size:9px;color:var(--text2);cursor:pointer;transition:border-color 0.2s;letter-spacing:0.05em;line-height:1.6;}
.pile-box:hover{border-color:var(--gold);}

/* field effect */
.field-slot{background:var(--bg3);border:1px dashed var(--border2);border-radius:4px;padding:6px 10px;font-family:'Cinzel',serif;font-size:10px;color:var(--text2);cursor:pointer;text-align:center;transition:all 0.2s;}
.field-slot.active{border-style:solid;border-color:var(--accent);color:var(--accent2);}

/* divider line */
.battle-line{border-top:2px solid var(--border2);margin:4px 14px;position:relative;}
.battle-line::after{content:'âš”';position:absolute;left:50%;top:-10px;transform:translateX(-50%);background:var(--bg);padding:0 8px;font-size:14px;color:var(--border2);}

/* log */
.battle-log{background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:8px;max-height:90px;overflow-y:auto;font-size:11px;color:var(--text2);}
.log-line{padding:2px 0;border-bottom:1px solid var(--border);}
.log-line:last-child{border:none;}
.log-line.important{color:var(--text);}
.log-line.danger{color:var(--red);}
.log-line.success{color:var(--green);}

/* action bar */
.action-bar{display:flex;gap:6px;padding:8px 14px;background:var(--bg2);border-top:1px solid var(--border);position:sticky;bottom:0;z-index:40;flex-wrap:wrap;}
.action-bar .btn{flex:1;min-width:60px;font-size:10px;text-align:center;padding:8px 6px;}

/* toast */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);padding:8px 20px;border-radius:20px;font-family:'Cinzel',serif;font-size:12px;z-index:9000;transition:opacity 0.4s;pointer-events:none;white-space:nowrap;}

/* type rule tag */
.rule-tag{display:inline-block;background:rgba(123,108,238,0.15);border:1px solid rgba(123,108,238,0.3);color:var(--accent2);border-radius:3px;padding:1px 7px;font-size:10px;margin:2px;}

/* empty state */
.empty{text-align:center;padding:28px 16px;color:var(--text2);font-style:italic;font-size:15px;}

::-webkit-scrollbar{width:3px;height:3px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
</style>
</head>
<body>

<header>
  <div class="header-row">
    <div>
      <h1>FORGE</h1>
      <p id="headerSub">Card Game Laboratory</p>
    </div>
    <button class="btn btn-sm" onclick="openBackup()">âš” Backup</button>
  </div>
</header>

<!-- TAB BAR -->
<div class="tab-bar">
  <button class="tab-btn active" id="tab-cards" onclick="showTab('cards')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M2 10h20"/><circle cx="7" cy="15" r="1.5" fill="currentColor"/></svg>
    Cards
  </button>
  <button class="tab-btn" id="tab-games" onclick="showTab('games')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2l3 7h7l-5.5 4 2 7L12 16l-6.5 4 2-7L2 9h7z"/></svg>
    Games
  </button>
  <button class="tab-btn" id="tab-play" onclick="showTab('play')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="5,3 19,12 5,21"/></svg>
    Playtest
  </button>
  <button class="tab-btn" id="tab-rules" onclick="showTab('rules')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/></svg>
    Rules
  </button>
</div>

<!-- â•â• CARDS TAB â•â• -->
<section class="section active" id="sec-cards">
  <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
    <button class="btn btn-gold" style="flex:1;" onclick="openAddCard()">+ New Card</button>
    <select id="filterGame" onchange="renderCards()" style="flex:1;font-size:12px;padding:6px 8px;background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:3px;">
      <option value="">All Games</option>
    </select>
    <select id="filterType" onchange="renderCards()" style="flex:1;font-size:12px;padding:6px 8px;background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:3px;">
      <option value="">All Types</option>
    </select>
  </div>
  <div class="card-grid" id="cardGrid"></div>
</section>

<!-- â•â• GAMES TAB â•â• -->
<section class="section" id="sec-games">
  <button class="btn btn-gold" style="width:100%;margin-bottom:14px;" onclick="openAddGame()">+ New Game Config</button>
  <div id="gameList"></div>
</section>

<!-- â•â• PLAYTEST TAB â•â• -->
<section class="section" id="sec-play" style="padding:0;">
  <!-- Game select screen -->
  <div id="playSelect" style="padding:16px 14px 90px;">
    <p style="color:var(--text2);font-style:italic;margin-bottom:14px;font-size:14px;">Choose a game to playtest:</p>
    <div id="playGameList"></div>
  </div>

  <!-- Active play table -->
  <div id="playTable" style="display:none;">

    <!-- OPPONENT ZONE -->
    <div class="pt-zone" style="background:#110e18;border-bottom:1px solid var(--border);">
      <div class="pt-zone-label" style="color:var(--red);">âš” Opponent</div>
      <div class="pt-hp-row">
        <span class="pt-hp-label">HP</span>
        <div class="pt-hp-track"><div id="oppHpBar" class="pt-hp-fill" style="background:var(--red);width:100%;"></div></div>
        <span class="pt-hp-val" id="oppHpVal">20</span>
        <span class="pt-res">âš¡<span id="oppRes">0</span></span>
      </div>
      <div class="pt-zone-label" style="margin-top:4px;">Field Â· Hand <span id="oppHandCount" style="color:var(--text2);">(0)</span></div>
      <div class="hand-row" id="oppHandRow"></div>
      <div class="field-row" id="oppFieldRow"></div>
    </div>

    <!-- FIELD EFFECT SLOT -->
    <div style="padding:6px 14px;display:flex;align-items:center;gap:8px;">
      <div class="pt-zone-label" style="margin:0;min-width:44px;">ğŸŒ Field</div>
      <div class="field-slot" id="fieldSlotEl" onclick="fieldSlotClick()" style="flex:1;">Empty</div>
    </div>

    <!-- DIVIDER -->
    <div class="battle-line"></div>

    <!-- PLAYER ZONE -->
    <div class="pt-zone">
      <div class="pt-zone-label" style="color:var(--green);">ğŸ›¡ You</div>
      <div class="pt-hp-row">
        <span class="pt-hp-label">HP</span>
        <div class="pt-hp-track"><div id="playerHpBar" class="pt-hp-fill" style="background:var(--green);width:100%;"></div></div>
        <span class="pt-hp-val" id="playerHpVal">20</span>
        <span class="pt-res">âš¡<span id="playerRes">0</span></span>
      </div>
      <div class="pt-zone-label" style="margin-top:4px;">Your Field</div>
      <div class="field-row" id="playerFieldRow"></div>
      <div class="pt-zone-label" style="margin-top:4px;">
        Hand (<span id="handCount">0</span>/7)
        <button class="btn btn-sm" style="margin-left:6px;padding:2px 8px;font-size:9px;" onclick="drawCard()">Draw</button>
      </div>
      <div class="hand-row" id="handRow"></div>
    </div>

    <!-- PILES -->
    <div class="piles-row">
      <div class="pile-box" onclick="viewGrave('player')">âš°<br>Your Grave<br><span id="playerGraveCount">0</span></div>
      <div class="pile-box">ğŸ“š<br>Deck<br><span id="deckCount">0</span></div>
      <div class="pile-box" onclick="viewGrave('opp')">âš°<br>Opp Grave<br><span id="oppGraveCount">0</span></div>
    </div>

    <!-- BATTLE LOG -->
    <div style="padding:6px 14px;">
      <div class="pt-zone-label">Battle Log</div>
      <div class="battle-log" id="battleLog"></div>
    </div>

    <!-- ACTION BAR -->
    <div class="action-bar">
      <button class="btn btn-gold" onclick="endTurn()">END TURN â–¶</button>
      <button class="btn" style="border-color:var(--red);color:var(--red);" onclick="attackDirect()">âš” Direct</button>
      <button class="btn btn-danger" onclick="resignGame()">Resign</button>
    </div>

  </div>
</section>

<!-- â•â• RULES TAB â•â• -->
<section class="section" id="sec-rules">
  <div style="font-family:'Cinzel',serif;font-size:13px;color:var(--gold);margin-bottom:12px;letter-spacing:0.1em;">HOW TO PLAY</div>
  <div style="line-height:1.9;font-size:15px;color:var(--text);">
    <p style="margin-bottom:12px;"><strong style="color:var(--gold2);">Setup:</strong> Create cards in the Cards tab, assign them to a game. Set up your game config in Games (HP, hand size, resources/turn, field limits, type rules).</p>
    <p style="margin-bottom:12px;"><strong style="color:var(--gold2);">Playing Cards:</strong> Tap a hand card once to select it (gold border). Tap it again to play it to the field. Cost shown in gold â€” you need enough âš¡ resources.</p>
    <p style="margin-bottom:12px;"><strong style="color:var(--gold2);">Attacking:</strong> Tap a card on your field to select it. Then tap an opponent's field card to attack it. Or tap <em>âš” Direct</em> to hit the opponent's HP directly (only if their field is clear).</p>
    <p style="margin-bottom:12px;"><strong style="color:var(--gold2);">Combat:</strong> ATK vs DEF â€” damage dealt = attacker ATK minus defender DEF (min 0). Counter-damage flows back too. If a card's HP or STA hits 0, it goes to the graveyard.</p>
    <p style="margin-bottom:12px;"><strong style="color:var(--gold2);">Resources:</strong> You get âš¡ resources at the start of each of your turns. Spend them to play cards. Unspent resources don't carry over.</p>
    <p style="margin-bottom:12px;"><strong style="color:var(--gold2);">Card Types & Rules:</strong> In Game Setup you can assign rules per card type â€” e.g. Spells can be "immediate effect" (play and discard instantly), Field cards go to the field effect slot, Creatures "stay until destroyed", etc.</p>
    <p style="margin-bottom:12px;"><strong style="color:var(--gold2);">Attacks/Abilities:</strong> When a card attacks another, its first listed ability also fires â€” e.g. a -2 to target ATK, or +5 to a stat. Use these to design complex mechanics.</p>
    <p style="margin-bottom:12px;"><strong style="color:var(--gold2);">Win Condition:</strong> Reduce the opponent's HP to 0. The AI opponent plays cards it can afford (prefers high ATK) and attacks your weakest field card, or hits you directly if your field is empty.</p>
    <p style="margin-bottom:12px;"><strong style="color:var(--gold2);">Turn Structure:</strong> You play â†’ End Turn â†’ AI plays and attacks â†’ Your turn starts (draw 1, resources refill).</p>
  </div>
  <div class="divider">Type Rules Reference</div>
  <div style="line-height:1.9;font-size:14px;color:var(--text2);">
    <div><span class="rule-tag">stays_until_destroyed</span> Stays on field until HP/STA hits 0</div>
    <div><span class="rule-tag">leaves_after_use</span> Removed from field after it attacks</div>
    <div><span class="rule-tag">leaves_end_of_turn</span> Removed at end of the turn it was played</div>
    <div><span class="rule-tag">cant_attack</span> Cannot be used to attack</div>
    <div><span class="rule-tag">blocks_only</span> Can only be targeted for defence, can't attack</div>
    <div><span class="rule-tag">one_per_field</span> Only one of this type allowed on your field</div>
    <div><span class="rule-tag">field_effect_slot</span> Goes to the global field effect slot instead of your field</div>
    <div><span class="rule-tag">immediate_effect</span> Effect fires on play, card goes straight to graveyard</div>
    <div><span class="rule-tag">can_attack_twice</span> May attack twice per turn</div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- BACKUP -->
<div class="modal-overlay" id="modal-backup">
  <div class="modal">
    <h2>âš” Backup & Restore</h2>
    <div class="divider">Export</div>
    <div class="field">
      <label>Encryption password (optional)</label>
      <div style="position:relative;">
        <input type="password" id="exportPw" placeholder="Leave blank for plain JSON" oninput="checkStrength()">
        <button onclick="togglePwShow('exportPw',this)" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text2);cursor:pointer;font-size:10px;font-family:'Cinzel',serif;">SHOW</button>
      </div>
    </div>
    <div id="exportStrength" style="font-size:11px;min-height:16px;margin-top:-6px;margin-bottom:10px;"></div>
    <button class="btn btn-gold" style="width:100%;" onclick="doExport()">â†“ Download Backup</button>
    <div class="divider">Import</div>
    <div class="field"><label>Backup file (.json)</label><input type="file" id="importFile" accept=".json" style="padding:6px;color:var(--text);"></div>
    <div class="field"><label>Password (if encrypted)</label><input type="password" id="importPw" placeholder="Leave blank if unencrypted"></div>
    <button class="btn btn-gold" style="width:100%;" onclick="doImport()">â†‘ Import</button>
    <div id="importStatus" style="margin-top:8px;font-size:12px;text-align:center;min-height:18px;font-family:'Cinzel',serif;"></div>
    <div class="divider">Danger</div>
    <button class="btn btn-danger" style="width:100%;" onclick="clearAll()">âœ• Clear All Data</button>
    <div class="modal-actions"><button class="btn" onclick="closeModal('modal-backup')">Close</button></div>
  </div>
</div>

<!-- CARD EDITOR -->
<div class="modal-overlay" id="modal-card">
  <div class="modal">
    <h2 id="cardModalTitle">New Card</h2>
    <div class="row">
      <div class="field"><label>Name</label><input type="text" id="cName" placeholder="Fire Drake"></div>
      <div class="field"><label>Icon</label><input type="text" id="cEmoji" placeholder="ğŸ‰" maxlength="2" style="text-align:center;font-size:22px;"></div>
    </div>
    <div class="row">
      <div class="field">
        <label>Type</label>
        <select id="cType">
          <option>Creature</option><option>Spell</option><option>Resource</option>
          <option>Field</option><option>Equipment</option><option>Hero</option>
          <option>Trap</option><option>Support</option><option>Custom</option>
        </select>
      </div>
      <div class="field"><label>Custom Type</label><input type="text" id="cCustomType" placeholder="e.g. Dragon"></div>
    </div>
    <div class="field"><label>Game</label><select id="cGame"><option value="">â€” No Game â€”</option></select></div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;">
      <div class="field"><label>â¤ HP</label><input type="number" id="cHp" value="0" min="0"></div>
      <div class="field"><label>âš” ATK</label><input type="number" id="cAtk" value="0" min="0"></div>
      <div class="field"><label>ğŸ›¡ DEF</label><input type="number" id="cDef" value="0" min="0"></div>
      <div class="field"><label>ğŸ’¨ STA</label><input type="number" id="cSta" value="0" min="0"></div>
      <div class="field"><label>âš¡ Cost</label><input type="number" id="cCost" value="0" min="0"></div>
      <div class="field"><label>ğŸ‘Ÿ MOV</label><input type="number" id="cMov" value="0" min="0"></div>
    </div>
    <div class="field"><label>Description / Flavour</label><textarea id="cDesc" placeholder="Card text..."></textarea></div>
    <div class="field"><label>Rule Tags (comma separated)</label><input type="text" id="cRules" placeholder="flying, haste, taunt..."></div>
    <div class="divider">Attacks & Abilities</div>
    <div id="atkList" data-atks="[]"></div>
    <button class="btn" style="width:100%;margin-top:6px;font-size:11px;" onclick="addAtk()">+ Add Attack / Ability</button>
    <div class="modal-actions">
      <button class="btn btn-danger" id="delCardBtn" onclick="delCard()" style="display:none;">Delete</button>
      <button class="btn" onclick="closeModal('modal-card')">Cancel</button>
      <button class="btn btn-gold" onclick="saveCard()">Save Card</button>
    </div>
  </div>
</div>

<!-- GAME EDITOR -->
<div class="modal-overlay" id="modal-game">
  <div class="modal">
    <h2 id="gameModalTitle">New Game Config</h2>
    <div class="field"><label>Game Name</label><input type="text" id="gName" placeholder="Dragon Wars"></div>
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
      <div class="field"><label>Start HP</label><input type="number" id="gHp" value="20" min="1"></div>
      <div class="field"><label>Hand Size (max 7)</label><input type="number" id="gHand" value="5" min="1" max="7"></div>
      <div class="field"><label>Resources / Turn</label><input type="number" id="gRes" value="3" min="1"></div>
      <div class="field"><label>Max Field Cards</label><input type="number" id="gField" value="5" min="1" max="12"></div>
    </div>
    <div class="field"><label>Win Condition Note</label><textarea id="gDesc" placeholder="Reduce opponent HP to 0..." style="min-height:50px;"></textarea></div>
    <div class="divider">Card Type Rules</div>
    <p style="font-size:12px;color:var(--text2);margin-bottom:10px;">Define special behaviour per card type. Leave blank for default (stays until destroyed).</p>
    <div id="typeRuleList" data-rules="[]"></div>
    <button class="btn" style="width:100%;margin-top:6px;font-size:11px;" onclick="addTypeRule()">+ Add Type Rule</button>
    <div class="modal-actions">
      <button class="btn btn-danger" id="delGameBtn" onclick="delGame()" style="display:none;">Delete</button>
      <button class="btn" onclick="closeModal('modal-game')">Cancel</button>
      <button class="btn btn-gold" onclick="saveGame()">Save Game</button>
    </div>
  </div>
</div>

<!-- CARD DETAIL (in play) -->
<div class="modal-overlay" id="modal-detail">
  <div class="modal">
    <h2 id="detailTitle">Card Details</h2>
    <div id="detailBody" style="font-size:14px;line-height:1.8;"></div>
    <div class="modal-actions"><button class="btn" onclick="closeModal('modal-detail')">Close</button></div>
  </div>
</div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STORAGE â€” own key, isolated from Chronicle
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORE_KEY = 'forge_v1';

let D = { cards:[], games:[] }; // all persistent data

function persist() {
  localStorage.setItem(STORE_KEY, JSON.stringify(D));
}

function hydrate() {
  try {
    const raw = localStorage.getItem(STORE_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      D = { cards:[], games:[], ...parsed };
    }
  } catch(e) { console.warn('Forge: hydrate error', e); }
}

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TYPE COLOURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TYPE_COLORS = {
  Creature:'#4a6fa5', Spell:'#9955cc', Resource:'#55aa77',
  Field:'#cc8844', Equipment:'#8899bb', Hero:'#c9a84c',
  Trap:'#cc5555', Support:'#5588cc', Custom:'#667788'
};
function typeColor(t) { return TYPE_COLORS[t] || '#667799'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('sec-'+name).classList.add('active');
  document.getElementById('tab-'+name).classList.add('active');
  const subs = {cards:'Card Builder',games:'Game Setup',play:'Playtest Table',rules:'How to Play'};
  document.getElementById('headerSub').textContent = subs[name] || '';
  if (name==='cards') { refreshGameSelects(); renderCards(); }
  if (name==='games') renderGames();
  if (name==='play')  renderPlaySelect();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id)  { document.getElementById(id).classList.add('open');  document.body.style.overflow='hidden'; }
function closeModal(id) { document.getElementById(id).classList.remove('open'); document.body.style.overflow=''; }
document.querySelectorAll('.modal-overlay').forEach(o =>
  o.addEventListener('click', e => { if (e.target===o) closeModal(o.id); })
);

function toast(msg, type='') {
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  const bg = type==='win'?'var(--green)':type==='loss'?'var(--red)':'var(--accent)';
  Object.assign(el.style, {background:bg, color:'#fff'});
  document.body.appendChild(el);
  setTimeout(() => { el.style.opacity='0'; setTimeout(()=>el.remove(), 400); }, 2000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CARD BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editCardId = null;

function refreshGameSelects() {
  ['cGame','filterGame'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const v = el.value;
    const isFilter = id === 'filterGame';
    el.innerHTML = isFilter ? '<option value="">All Games</option>' : '<option value="">â€” No Game â€”</option>';
    D.games.forEach(g => el.innerHTML += `<option value="${g.id}">${esc(g.name)}</option>`);
    el.value = v;
  });
  // type filter
  const tf = document.getElementById('filterType');
  if (tf) {
    const v = tf.value;
    const types = [...new Set(D.cards.map(c=>c.type).filter(Boolean))];
    tf.innerHTML = '<option value="">All Types</option>';
    types.forEach(t => tf.innerHTML += `<option value="${t}">${t}</option>`);
    tf.value = v;
  }
}

function renderCards() {
  const gf = document.getElementById('filterGame')?.value || '';
  const tf = document.getElementById('filterType')?.value || '';
  let cards = D.cards;
  if (gf) cards = cards.filter(c => c.gameId === gf);
  if (tf) cards = cards.filter(c => c.type === tf);
  const grid = document.getElementById('cardGrid');
  if (!cards.length) {
    grid.innerHTML = '<div class="empty" style="grid-column:1/-1;">No cards yet â€” hit + New Card</div>';
    return;
  }
  grid.innerHTML = cards.map(c => {
    const col = typeColor(c.type);
    const game = D.games.find(g => g.id === c.gameId);
    const statsLine = [
      c.hp  ? `â¤${c.hp}`  : '',
      c.atk ? `âš”${c.atk}` : '',
      c.def ? `ğŸ›¡${c.def}` : '',
      c.sta ? `ğŸ’¨${c.sta}` : '',
    ].filter(Boolean).join(' ');
    return `<div class="card-tile" style="border-color:${col};border-top:3px solid ${col};" onclick="openEditCard('${c.id}')">
      <div class="ct-cost">âš¡${c.cost||0}</div>
      <div class="ct-icon">${c.emoji||'ğŸƒ'}</div>
      <div class="ct-name">${esc(c.name)}</div>
      <div class="ct-type" style="color:${col};">${c.type}</div>
      ${statsLine ? `<div class="ct-stats">${statsLine}</div>` : ''}
      ${game ? `<div class="ct-game">${esc(game.name)}</div>` : ''}
    </div>`;
  }).join('');
}

function openAddCard() {
  editCardId = null;
  document.getElementById('cardModalTitle').textContent = 'New Card';
  document.getElementById('delCardBtn').style.display = 'none';
  ['cName','cEmoji','cDesc','cRules','cCustomType'].forEach(id => {
    const el = document.getElementById(id); if(el) el.value = '';
  });
  ['cHp','cAtk','cDef','cSta','cCost','cMov'].forEach(id => {
    const el = document.getElementById(id); if(el) el.value = '0';
  });
  document.getElementById('cType').value = 'Creature';
  refreshGameSelects();
  document.getElementById('cGame').value = '';
  setAtkList([]);
  openModal('modal-card');
}

function openEditCard(id) {
  editCardId = id;
  const c = D.cards.find(x => x.id === id);
  if (!c) return;
  document.getElementById('cardModalTitle').textContent = 'Edit: ' + c.name;
  document.getElementById('delCardBtn').style.display = 'inline-block';
  document.getElementById('cName').value    = c.name  || '';
  document.getElementById('cEmoji').value   = c.emoji || '';
  document.getElementById('cDesc').value    = c.desc  || '';
  document.getElementById('cRules').value   = (c.rules||[]).join(', ');
  document.getElementById('cHp').value      = c.hp    || 0;
  document.getElementById('cAtk').value     = c.atk   || 0;
  document.getElementById('cDef').value     = c.def   || 0;
  document.getElementById('cSta').value     = c.sta   || 0;
  document.getElementById('cCost').value    = c.cost  || 0;
  document.getElementById('cMov').value     = c.mov   || 0;
  // Type: built-in or custom
  const builtins = ['Creature','Spell','Resource','Field','Equipment','Hero','Trap','Support'];
  if (builtins.includes(c.type)) {
    document.getElementById('cType').value = c.type;
    document.getElementById('cCustomType').value = '';
  } else {
    document.getElementById('cType').value = 'Custom';
    document.getElementById('cCustomType').value = c.type || '';
  }
  refreshGameSelects();
  document.getElementById('cGame').value = c.gameId || '';
  setAtkList(c.attacks || []);
  openModal('modal-card');
}

function saveCard() {
  const name = document.getElementById('cName').value.trim();
  if (!name) { toast('Name required'); return; }
  const typeRaw = document.getElementById('cType').value;
  const type = typeRaw === 'Custom'
    ? (document.getElementById('cCustomType').value.trim() || 'Custom')
    : typeRaw;
  const atks = getAtkList();
  const rules = document.getElementById('cRules').value.split(',').map(x=>x.trim()).filter(Boolean);
  const obj = {
    id: editCardId || uid(), name, type,
    emoji:  document.getElementById('cEmoji').value || 'ğŸƒ',
    desc:   document.getElementById('cDesc').value.trim(),
    gameId: document.getElementById('cGame').value,
    hp:   int('cHp'),  atk:  int('cAtk'),
    def:  int('cDef'), sta:  int('cSta'),
    cost: int('cCost'), mov: int('cMov'),
    rules, attacks: atks
  };
  if (editCardId) {
    const i = D.cards.findIndex(x => x.id === editCardId);
    if (i >= 0) D.cards[i] = obj;
  } else {
    D.cards.push(obj);
  }
  persist();
  closeModal('modal-card');
  refreshGameSelects();
  renderCards();
}

function delCard() {
  if (!confirm('Delete this card?')) return;
  D.cards = D.cards.filter(x => x.id !== editCardId);
  persist();
  closeModal('modal-card');
  refreshGameSelects();
  renderCards();
}

// â”€â”€ Attack list â”€â”€
function setAtkList(atks) {
  const el = document.getElementById('atkList');
  el.dataset.atks = JSON.stringify(atks);
  renderAtkList();
}
function getAtkList() {
  return JSON.parse(document.getElementById('atkList').dataset.atks || '[]');
}
function renderAtkList() {
  const el = document.getElementById('atkList');
  const atks = JSON.parse(el.dataset.atks || '[]');
  el.innerHTML = atks.map((a,i) => `
    <div class="atk-row">
      <input type="text" value="${esc(a.name||'')}" placeholder="Ability name" style="flex:2;"
        onchange="updAtk(${i},'name',this.value)">
      <input type="text" value="${esc(a.value||'')}" placeholder="-3" style="flex:0 0 50px;"
        onchange="updAtk(${i},'value',this.value)">
      <select style="flex:1;font-size:11px;padding:6px 4px;" onchange="updAtk(${i},'target',this.value)">
        <option value="hp"   ${a.target==='hp'   ?'selected':''}>HP</option>
        <option value="atk"  ${a.target==='atk'  ?'selected':''}>ATK</option>
        <option value="def"  ${a.target==='def'  ?'selected':''}>DEF</option>
        <option value="sta"  ${a.target==='sta'  ?'selected':''}>STA</option>
        <option value="player_hp" ${a.target==='player_hp'?'selected':''}>Player HP</option>
      </select>
      <input type="text" value="${esc(a.desc||'')}" placeholder="Description" style="flex:2;"
        onchange="updAtk(${i},'desc',this.value)">
      <button class="btn btn-danger btn-sm" style="flex:0 0 auto;" onclick="rmAtk(${i})">âœ•</button>
    </div>`).join('');
}
function updAtk(i,f,v) {
  const el=document.getElementById('atkList');
  const atks=JSON.parse(el.dataset.atks||'[]');
  if(atks[i]) atks[i][f]=v;
  el.dataset.atks=JSON.stringify(atks);
}
function rmAtk(i) {
  const el=document.getElementById('atkList');
  const atks=JSON.parse(el.dataset.atks||'[]');
  atks.splice(i,1);
  el.dataset.atks=JSON.stringify(atks);
  renderAtkList();
}
function addAtk() {
  const el=document.getElementById('atkList');
  const atks=JSON.parse(el.dataset.atks||'[]');
  atks.push({name:'Attack',value:'-1',target:'hp',desc:''});
  el.dataset.atks=JSON.stringify(atks);
  renderAtkList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editGameId = null;

function renderGames() {
  const list = document.getElementById('gameList');
  if (!D.games.length) { list.innerHTML='<div class="empty">No game configs yet.</div>'; return; }
  list.innerHTML = D.games.map(g => {
    const n = D.cards.filter(c=>c.gameId===g.id).length;
    return `<div class="game-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <h3>${esc(g.name)}</h3>
        <button class="btn btn-sm" onclick="openEditGame('${g.id}')">Edit</button>
      </div>
      <div style="font-size:12px;color:var(--text2);">
        ${n} cards &nbsp;Â·&nbsp; HP:${g.hp} &nbsp;Â·&nbsp; Hand:${g.hand} &nbsp;Â·&nbsp; Res/turn:${g.res} &nbsp;Â·&nbsp; Field max:${g.field}
      </div>
      ${g.desc?`<div style="font-size:13px;color:var(--text2);font-style:italic;margin-top:6px;">${esc(g.desc)}</div>`:''}
      <div style="margin-top:8px;">
        ${(g.typeRules||[]).map(r=>`<span class="rule-tag">${esc(r.type)}: ${esc((r.rule||'').replace(/_/g,' '))}</span>`).join('')}
      </div>
    </div>`;
  }).join('');
}

function openAddGame() {
  editGameId = null;
  document.getElementById('gameModalTitle').textContent = 'New Game Config';
  document.getElementById('delGameBtn').style.display = 'none';
  document.getElementById('gName').value = '';
  document.getElementById('gHp').value = '20';
  document.getElementById('gHand').value = '5';
  document.getElementById('gRes').value = '3';
  document.getElementById('gField').value = '5';
  document.getElementById('gDesc').value = '';
  setTypeRules([]);
  openModal('modal-game');
}

function openEditGame(id) {
  editGameId = id;
  const g = D.games.find(x=>x.id===id);
  if (!g) return;
  document.getElementById('gameModalTitle').textContent = 'Edit: '+g.name;
  document.getElementById('delGameBtn').style.display = 'inline-block';
  document.getElementById('gName').value  = g.name||'';
  document.getElementById('gHp').value   = g.hp||20;
  document.getElementById('gHand').value = g.hand||5;
  document.getElementById('gRes').value  = g.res||3;
  document.getElementById('gField').value= g.field||5;
  document.getElementById('gDesc').value = g.desc||'';
  setTypeRules(g.typeRules||[]);
  openModal('modal-game');
}

function saveGame() {
  const name = document.getElementById('gName').value.trim();
  if (!name) { toast('Game name required'); return; }
  const obj = {
    id:editGameId||uid(), name,
    hp:   int('gHp'),
    hand: Math.min(int('gHand'),7),
    res:  int('gRes'),
    field:int('gField'),
    desc: document.getElementById('gDesc').value.trim(),
    typeRules: getTypeRules()
  };
  if (editGameId) {
    const i = D.games.findIndex(x=>x.id===editGameId);
    if (i>=0) D.games[i] = obj;
  } else {
    D.games.push(obj);
  }
  persist();
  closeModal('modal-game');
  renderGames();
  refreshGameSelects();
}

function delGame() {
  if (!confirm('Delete this game config?')) return;
  D.games = D.games.filter(x=>x.id!==editGameId);
  persist();
  closeModal('modal-game');
  renderGames();
  refreshGameSelects();
}

// â”€â”€ Type rules â”€â”€
function setTypeRules(rules) {
  const el = document.getElementById('typeRuleList');
  el.dataset.rules = JSON.stringify(rules);
  renderTypeRules();
}
function getTypeRules() { return JSON.parse(document.getElementById('typeRuleList').dataset.rules||'[]'); }
function renderTypeRules() {
  const el = document.getElementById('typeRuleList');
  const rules = JSON.parse(el.dataset.rules||'[]');
  const RULE_OPTS = [
    ['stays_until_destroyed','Stays until destroyed'],
    ['leaves_after_use','Leaves after use'],
    ['leaves_end_of_turn','Leaves end of turn'],
    ['cant_attack','Cannot attack'],
    ['blocks_only','Blocks only'],
    ['one_per_field','One per field'],
    ['field_effect_slot','Field effect slot'],
    ['immediate_effect','Immediate effect'],
    ['can_attack_twice','Attack twice/turn'],
  ];
  el.innerHTML = rules.map((r,i) => `
    <div class="atk-row">
      <input type="text" value="${esc(r.type||'')}" placeholder="Type name" style="flex:1;"
        onchange="updRule(${i},'type',this.value)">
      <select style="flex:2;font-size:11px;padding:6px 4px;" onchange="updRule(${i},'rule',this.value)">
        ${RULE_OPTS.map(([v,l])=>`<option value="${v}"${r.rule===v?' selected':''}>${l}</option>`).join('')}
      </select>
      <button class="btn btn-danger btn-sm" style="flex:0 0 auto;" onclick="rmRule(${i})">âœ•</button>
    </div>`).join('');
}
function updRule(i,f,v){
  const el=document.getElementById('typeRuleList');
  const r=JSON.parse(el.dataset.rules||'[]');
  if(r[i])r[i][f]=v;el.dataset.rules=JSON.stringify(r);
}
function rmRule(i){
  const el=document.getElementById('typeRuleList');
  const r=JSON.parse(el.dataset.rules||'[]');
  r.splice(i,1);el.dataset.rules=JSON.stringify(r);renderTypeRules();
}
function addTypeRule(){
  const el=document.getElementById('typeRuleList');
  const r=JSON.parse(el.dataset.rules||'[]');
  r.push({type:'',rule:'stays_until_destroyed'});
  el.dataset.rules=JSON.stringify(r);renderTypeRules();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYTEST ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let G = null; // active game state

function renderPlaySelect() {
  document.getElementById('playSelect').style.display = 'block';
  document.getElementById('playTable').style.display = 'none';
  const list = document.getElementById('playGameList');
  if (!D.games.length) { list.innerHTML='<div class="empty">No game configs yet. Create one in Games tab.</div>'; return; }
  list.innerHTML = D.games.map(g => {
    const n = D.cards.filter(c=>c.gameId===g.id).length;
    return `<div class="game-card">
      <h3>${esc(g.name)}</h3>
      <div style="font-size:12px;color:var(--text2);margin-bottom:8px;">${n} cards Â· HP ${g.hp} Â· Hand ${g.hand} Â· Res/turn ${g.res}</div>
      ${n<4?`<div style="font-size:12px;color:var(--amber);">âš  Need at least 4 cards assigned to this game to play.</div>`
           :`<button class="btn btn-gold" style="width:100%;margin-top:4px;" onclick="startGame('${g.id}')">â–¶ Playtest</button>`}
    </div>`;
  }).join('');
}

// â”€â”€ deep-copy a card into play state â”€â”€
function liveCard(c) {
  return {
    ...c,
    attacks: (c.attacks||[]).map(a=>({...a})),
    _hp:  c.hp,
    _atk: c.atk,
    _def: c.def,
    _sta: c.sta,
    _tapped: false,
    _atkCount: 0,
    _iid: uid()   // unique instance id
  };
}

function shuffle(arr) {
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){const j=0|Math.random()*(i+1);[a[i],a[j]]=[a[j],a[i]];}
  return a;
}

function startGame(gameId) {
  const game = D.games.find(x=>x.id===gameId);
  if (!game) return;
  const pool = D.cards.filter(c=>c.gameId===gameId);
  if (pool.length < 4) { toast('Need â‰¥4 cards!'); return; }

  const makeDeck = () => shuffle(pool.map(liveCard));

  G = {
    game,
    turn: 1,
    phase: 'player',  // 'player' | 'opp'
    over: false,
    sel: null,        // currently selected live card object
    fieldSlot: null,
    log: [],
    player: { hp:game.hp, maxHp:game.hp, res:game.res, hand:[], field:[], grave:[], deck:makeDeck() },
    opp:    { hp:game.hp, maxHp:game.hp, res:game.res, hand:[], field:[], grave:[], deck:makeDeck() }
  };

  const hs = Math.min(game.hand, 7);
  for(let i=0;i<hs;i++) { deal('player'); deal('opp'); }

  document.getElementById('playSelect').style.display = 'none';
  document.getElementById('playTable').style.display = 'block';

  glog('âš” Game started: '+game.name, 'important');
  glog('Your turn 1 Â· âš¡'+game.res+' resources', '');
  render();
}

// â”€â”€ deal one card â”€â”€
function deal(who) {
  const s = G[who];
  if (!s.deck.length) { glog((who==='player'?'You':'Opp')+' ran out of cards!','danger'); return; }
  if (who==='player' && s.hand.length>=7) { glog('Hand full!',''); return; }
  s.hand.push(s.deck.pop());
}

// â”€â”€ log â”€â”€
function glog(msg, cls='') {
  if (!G) return;
  G.log.push({msg, cls});
  const el = document.getElementById('battleLog');
  if (!el) return;
  el.innerHTML = G.log.slice(-40).reverse()
    .map(e=>`<div class="log-line ${e.cls}">${esc(e.msg)}</div>`).join('');
}

// â”€â”€ get type rule for a card â”€â”€
function getRule(type) {
  const r = (G.game.typeRules||[]).find(x=>x.type===type);
  return r ? r.rule : 'stays_until_destroyed';
}

// â•â•â•â• RENDER â•â•â•â•
function render() {
  if (!G) return;
  const {player, opp} = G;

  // HP bars
  const setHp = (barId, valId, cur, max) => {
    const pct = Math.max(0, cur/max*100);
    document.getElementById(barId).style.width = pct+'%';
    document.getElementById(barId).style.background =
      pct>50?'var(--green)':pct>25?'var(--amber)':'var(--red)';
    document.getElementById(valId).textContent = cur;
  };
  setHp('playerHpBar','playerHpVal', player.hp, player.maxHp);
  setHp('oppHpBar',   'oppHpVal',   opp.hp,    opp.maxHp);
  document.getElementById('playerRes').textContent = player.res;
  document.getElementById('oppRes').textContent    = opp.res;

  // Hand
  document.getElementById('handCount').textContent = player.hand.length;
  document.getElementById('handRow').innerHTML = player.hand.map((c,i) => {
    const col = typeColor(c.type);
    const canAfford = player.res >= c.cost;
    const isSel = G.sel === c;
    return `<div class="pc${isSel?' selected':''}" style="border-color:${col};" onclick="selectHand(${i})">
      <div class="pc-cost">âš¡${c.cost}</div>
      <div class="pc-icon">${c.emoji||'ğŸƒ'}</div>
      <div class="pc-name">${esc(c.name)}</div>
      <div class="pc-stats">
        ${c.hp  ?`<span>â¤${c._hp}</span>`:''}
        ${c.atk ?`<span>âš”${c._atk}</span>`:''}
        ${c.def ?`<span>ğŸ›¡${c._def}</span>`:''}
      </div>
      <div style="font-size:8px;color:${canAfford?'var(--gold)':'var(--red)'};margin-top:2px;">âš¡${c.cost}</div>
    </div>`;
  }).join('');

  // Player field
  document.getElementById('playerFieldRow').innerHTML = player.field.length
    ? player.field.map((c,i) => {
        const col = typeColor(c.type);
        const isSel = G.sel === c;
        return `<div class="pc${isSel?' selected':''}${c._tapped?' tapped':''}" style="border-color:${col};" onclick="selectField(${i})">
          <div class="pc-icon">${c.emoji||'ğŸƒ'}</div>
          <div class="pc-name">${esc(c.name)}</div>
          <div class="pc-stats">
            ${c.hp  ?`<span>â¤${c._hp}</span>`:''}
            ${c.atk ?`<span>âš”${c._atk}</span>`:''}
            ${c.def ?`<span>ğŸ›¡${c._def}</span>`:''}
            ${c.sta ?`<span>ğŸ’¨${c._sta}</span>`:''}
          </div>
          ${c._tapped?'<div style="font-size:7px;color:var(--amber);margin-top:2px;">tapped</div>':''}
        </div>`;
      }).join('')
    : '<div style="color:var(--text2);font-size:11px;font-style:italic;padding:8px 0;align-self:center;">Empty field</div>';

  // Opp field
  document.getElementById('oppFieldRow').innerHTML = opp.field.length
    ? opp.field.map((c,i) => {
        const col = typeColor(c.type);
        return `<div class="oc" style="border-color:${col};" onclick="targetOpp(${i})" oncontextmenu="showDetail(${i},'opp');return false;">
          <div class="oc-icon">${c.emoji||'ğŸƒ'}</div>
          <div class="oc-name">${esc(c.name)}</div>
          <div class="oc-stats">â¤${c._hp} âš”${c._atk} ğŸ›¡${c._def}</div>
        </div>`;
      }).join('')
    : '<div style="color:var(--text2);font-size:11px;font-style:italic;padding:4px 0;align-self:center;">Empty</div>';

  // Opp hand (face down)
  document.getElementById('oppHandCount').textContent = opp.hand.length;
  document.getElementById('oppHandRow').innerHTML = opp.hand.map(() =>
    '<div class="card-back">ğŸ‚ </div>'
  ).join('');

  // Counts
  document.getElementById('playerGraveCount').textContent = player.grave.length;
  document.getElementById('oppGraveCount').textContent    = opp.grave.length;
  document.getElementById('deckCount').textContent        = player.deck.length;

  // Field slot
  const fs = document.getElementById('fieldSlotEl');
  if (G.fieldSlot) {
    fs.textContent = (G.fieldSlot.emoji||'ğŸƒ') + ' ' + G.fieldSlot.name;
    fs.classList.add('active');
  } else {
    fs.textContent = 'Empty';
    fs.classList.remove('active');
  }

  // End turn button dim during opp turn
  const eb = document.querySelector('.action-bar button');
  if (eb) eb.style.opacity = G.phase==='player' ? '1' : '0.4';
}

// â•â•â•â• INTERACTIONS â•â•â•â•

// Tap hand card: first tap = select, second tap = play
function selectHand(i) {
  if (G.phase!=='player' || G.over) return;
  const card = G.player.hand[i];
  if (G.sel === card) {
    playCard(i);
  } else {
    G.sel = card;
    const canAfford = G.player.res >= card.cost;
    glog('Selected '+card.name+' (âš¡'+card.cost+')'+(canAfford?'. Tap again to play.':' â€” not enough resources (âš¡'+G.player.res+').'));
    render();
  }
}

// Tap player field card: select for attacking
function selectField(i) {
  if (G.phase!=='player' || G.over) return;
  const card = G.player.field[i];
  if (G.sel === card) {
    G.sel = null;
    glog('Deselected '+card.name+'.');
  } else {
    G.sel = card;
    glog('Selected '+card.name+' â€” tap an opponent card to attack it, or âš” Direct to hit opponent.');
  }
  render();
}

// Play card from hand to field
function playCard(idx) {
  const card = G.player.hand[idx];
  if (G.player.res < card.cost) {
    glog('âš¡ Not enough resources (need '+card.cost+', have '+G.player.res+').','danger');
    G.sel = null; render(); return;
  }
  const rule = getRule(card.type);
  if (rule==='one_per_field' && G.player.field.find(c=>c.type===card.type)) {
    glog('Only one '+card.type+' allowed on field!','danger');
    G.sel = null; render(); return;
  }
  if (G.player.field.length >= G.game.field
      && rule!=='field_effect_slot' && rule!=='immediate_effect') {
    glog('Field full! (max '+G.game.field+')','danger');
    G.sel = null; render(); return;
  }

  G.player.res -= card.cost;
  G.player.hand.splice(idx, 1);
  G.sel = null;

  if (rule === 'field_effect_slot') {
    G.fieldSlot = card;
    glog(card.name+' â†’ field effect slot.');
  } else if (rule === 'immediate_effect') {
    applyCardEffect(card, 'player');
    G.player.grave.push(card);
    glog(card.name+' â†’ immediate effect fired, sent to graveyard.');
  } else {
    G.player.field.push(card);
    card._leaveFlag = (rule==='leaves_after_use'||rule==='leaves_end_of_turn') ? rule : null;
    glog(card.name+' played to field. (âš¡'+card.cost+' spent, '+G.player.res+' left)');
  }
  checkDead(); winCheck(); render();
}

// Attack an opponent field card
function targetOpp(i) {
  if (G.phase!=='player' || G.over) return;
  const sel = G.sel;
  if (!sel) { glog('Select one of your field cards first.',''); return; }
  if (!G.player.field.includes(sel)) {
    glog(sel.name+' is in your hand â€” play it to the field first (tap once to select, tap again to play).','danger');
    return;
  }
  const rule = getRule(sel.type);
  if (rule==='cant_attack'||rule==='blocks_only') { glog(sel.name+' cannot attack!','danger'); return; }
  if (sel._tapped) { glog(sel.name+' already attacked this turn.','danger'); return; }
  const maxAtk = rule==='can_attack_twice' ? 2 : 1;
  if (sel._atkCount >= maxAtk) { glog(sel.name+' has no attacks left this turn.','danger'); return; }

  const target = G.opp.field[i];
  if (!target) return;
  resolve(sel, target, G.opp);
  G.sel = null;
  if (getRule(sel.type)==='leaves_after_use') {
    G.player.field = G.player.field.filter(c=>c!==sel);
    G.player.grave.push(sel);
    glog(sel.name+' leaves field after use.');
  }
  checkDead(); winCheck(); render();
}

// Direct attack on opponent player HP
function attackDirect() {
  if (G.phase!=='player' || G.over) return;
  const sel = G.sel;
  if (!sel) { glog('Select a field card first.','danger'); return; }
  if (!G.player.field.includes(sel)) { glog(sel.name+' is not on the field yet.','danger'); return; }
  const rule = getRule(sel.type);
  if (rule==='cant_attack'||rule==='blocks_only') { glog(sel.name+' cannot attack!','danger'); return; }
  if (sel._tapped) { glog(sel.name+' already attacked this turn.','danger'); return; }
  if (G.opp.field.length > 0) {
    glog('Opponent has '+G.opp.field.length+' card(s) on the field â€” clear them first.','danger');
    return;
  }
  const dmg = Math.max(0, sel._atk);
  G.opp.hp -= dmg;
  sel._atkCount = (sel._atkCount||0) + 1;
  sel._tapped = sel._atkCount >= (rule==='can_attack_twice'?2:1);
  glog('âš” '+sel.name+' attacks opponent directly for '+dmg+'!','important');
  G.sel = null;
  winCheck(); render();
}

// â•â•â•â• COMBAT â•â•â•â•
function resolve(atk, def, defOwner) {
  const dmgToDef = Math.max(0, atk._atk - def._def);
  const dmgToAtk = Math.max(0, def._atk - atk._def);
  def._hp -= dmgToDef;
  atk._hp -= dmgToAtk;
  atk._atkCount = (atk._atkCount||0) + 1;
  const maxAtk = getRule(atk.type)==='can_attack_twice' ? 2 : 1;
  atk._tapped = atk._atkCount >= maxAtk;
  glog('âš” '+atk.name+' vs '+def.name+': deals '+dmgToDef+', takes '+dmgToAtk+' counter','important');

  // Fire first ability
  const ab = (atk.attacks||[])[0];
  if (ab) {
    const v = parseFloat(ab.value)||0;
    if (v !== 0) {
      const n = ab.name ? '"'+ab.name+'"' : 'Ability';
      if      (ab.target==='hp')        { def._hp  += v; glog('  '+n+': '+def.name+' HP '+(v>0?'+':'')+v); }
      else if (ab.target==='atk')       { def._atk += v; glog('  '+n+': '+def.name+' ATK '+(v>0?'+':'')+v); }
      else if (ab.target==='def')       { def._def += v; glog('  '+n+': '+def.name+' DEF '+(v>0?'+':'')+v); }
      else if (ab.target==='sta')       { def._sta += v; glog('  '+n+': '+def.name+' STA '+(v>0?'+':'')+v); }
      else if (ab.target==='player_hp') { defOwner.hp += v; glog('  '+n+': Opp HP '+(v>0?'+':'')+v); }
    }
  }
}

// Apply spell/immediate effect
function applyCardEffect(card, who) {
  const enemy = who==='player' ? G.opp : G.player;
  (card.attacks||[]).forEach(a => {
    const v = parseFloat(a.value)||0; if (!v) return;
    if (a.target==='player_hp') {
      enemy.hp += v;
      glog('  '+card.name+' "'+a.name+'": enemy HP '+(v>0?'+':'')+v);
    } else if (a.target==='hp' && enemy.field.length) {
      const t = enemy.field[0|Math.random()*enemy.field.length];
      t._hp += v;
      glog('  '+card.name+' "'+a.name+'": '+t.name+' HP '+(v>0?'+':'')+v);
    }
  });
}

// Kill dead cards
function checkDead() {
  [G.player, G.opp].forEach(side => {
    const dead = side.field.filter(c => c._hp<=0 || (c.sta>0 && c._sta<=0));
    dead.forEach(c => { glog('â˜  '+c.name+' destroyed â†’ graveyard','danger'); side.grave.push(c); });
    side.field = side.field.filter(c => !(c._hp<=0 || (c.sta>0 && c._sta<=0)));
  });
}

// Check win
function winCheck() {
  if (G.over) return;
  if (G.opp.hp <= 0) {
    G.over = true;
    glog('ğŸ† YOU WIN! Opponent HP reached 0.','success');
    toast('ğŸ† Victory!','win');
  }
  if (G.player.hp <= 0) {
    G.over = true;
    glog('ğŸ’€ DEFEATED. Your HP reached 0.','danger');
    toast('ğŸ’€ Defeated...','loss');
  }
}

// â•â•â•â• END TURN â•â•â•â•
function endTurn() {
  if (!G) return;
  if (G.over) { glog('Game over. Resign to return.',''); return; }
  if (G.phase !== 'player') { glog("Opponent's turn â€” please wait...",''); return; }

  endOfTurnCleanup(G.player);
  G.sel = null;
  G.phase = 'opp';
  glog('â”€â”€ Opponent\'s turn â”€â”€','');
  render();
  setTimeout(aiTurn, 500);
}

function endOfTurnCleanup(side) {
  const rem = [];
  side.field.forEach(c => {
    const r = getRule(c.type)||c._leaveFlag;
    if (r==='leaves_end_of_turn') { rem.push(c); glog(c.name+' leaves field (end of turn).'); }
  });
  rem.forEach(c => { side.field=side.field.filter(x=>x!==c); side.grave.push(c); });
  side.field.forEach(c => { c._tapped=false; c._atkCount=0; });
}

// â•â•â•â• AI â•â•â•â•
function aiTurn() {
  if (!G || G.over) return;
  const ai = G.opp, you = G.player, game = G.game;

  // Refresh resources & draw
  ai.res = game.res;
  deal('opp');

  // 1. Play affordable cards (highest ATK first)
  const sortedHand = [...ai.hand].sort((a,b)=>(b.atk||0)-(a.atk||0)||(a.cost||0)-(b.cost||0));
  for (const c of sortedHand) {
    if (ai.res < c.cost) continue;
    const rule = getRule(c.type);
    if (rule==='one_per_field' && ai.field.find(f=>f.type===c.type)) continue;
    if (ai.field.length>=game.field && rule!=='field_effect_slot' && rule!=='immediate_effect') continue;
    ai.res -= c.cost;
    ai.hand = ai.hand.filter(x=>x!==c);
    if (rule==='field_effect_slot')   { G.fieldSlot=c; glog('Opp plays '+c.name+' â†’ field slot.'); }
    else if (rule==='immediate_effect'){ applyCardEffect(c,'opp'); ai.grave.push(c); glog('Opp plays '+c.name+' (immediate).'); }
    else { ai.field.push(c); glog('Opp plays '+c.name+' to field.'); }
  }
  checkDead(); winCheck();
  if (G.over) { render(); return; }

  // 2. Attack (after short delay so log is readable)
  setTimeout(() => {
    if (!G || G.over) return;
    const attackers = ai.field.filter(c => {
      const r = getRule(c.type);
      return !c._tapped && r!=='cant_attack' && r!=='blocks_only';
    });

    for (const atk of attackers) {
      if (G.over) break;
      if (you.field.length > 0) {
        // Attack lowest-HP target
        const target = [...you.field].sort((a,b)=>a._hp-b._hp)[0];
        resolve(atk, target, you);
        checkDead(); winCheck();
      } else {
        const dmg = Math.max(0, atk._atk);
        you.hp -= dmg;
        atk._tapped = true;
        glog('Opp '+atk.name+' attacks you directly for '+dmg+'!','danger');
        winCheck();
      }
      if (G.over) break;
    }

    endOfTurnCleanup(ai);
    G.phase = 'player';
    G.turn++;
    you.res = game.res;
    deal('player');
    glog('â”€â”€ Your turn '+G.turn+' Â· âš¡'+you.res+' resources â”€â”€','');
    render();
  }, 600);
}

// Resign
function resignGame() {
  if (!G) return;
  if (!confirm('Resign and return to game select?')) return;
  G = null;
  document.getElementById('playTable').style.display = 'none';
  document.getElementById('playSelect').style.display = 'block';
  renderPlaySelect();
}

// Draw card button
function drawCard() {
  if (!G || G.phase!=='player' || G.over) return;
  deal('player'); render();
}

// Graveyard viewer
function viewGrave(who) {
  if (!G) return;
  const g = G[who].grave;
  if (!g.length) { toast('Graveyard is empty.'); return; }
  const label = who==='player' ? 'Your' : "Opponent's";
  document.getElementById('detailTitle').textContent = label+' Graveyard';
  document.getElementById('detailBody').innerHTML = g.map(c =>
    `<div style="padding:6px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;">
      <span style="font-size:20px;">${c.emoji||'ğŸƒ'}</span>
      <div>
        <div style="font-family:'Cinzel',serif;font-size:13px;">${esc(c.name)}</div>
        <div style="font-size:12px;color:var(--text2);">${c.type} Â· â¤${c.hp} âš”${c.atk} ğŸ›¡${c.def}</div>
      </div>
    </div>`
  ).join('');
  openModal('modal-detail');
}

// Show card detail on long-press
function showDetail(i, who) {
  if (!G) return;
  const c = G[who].field[i];
  if (!c) return;
  document.getElementById('detailTitle').textContent = c.name;
  document.getElementById('detailBody').innerHTML = `
    <div style="font-size:24px;margin-bottom:8px;">${c.emoji||'ğŸƒ'}</div>
    <div style="font-size:12px;color:var(--text2);margin-bottom:8px;">${c.type}</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px;font-family:'Cinzel',serif;font-size:12px;">
      ${c.hp  ?`<div>â¤ HP: ${c._hp}/${c.hp}</div>`:''}
      ${c.atk ?`<div>âš” ATK: ${c._atk}</div>`:''}
      ${c.def ?`<div>ğŸ›¡ DEF: ${c._def}</div>`:''}
      ${c.sta ?`<div>ğŸ’¨ STA: ${c._sta}</div>`:''}
      ${c.cost?`<div>âš¡ Cost: ${c.cost}</div>`:''}
      ${c.mov ?`<div>ğŸ‘Ÿ MOV: ${c.mov}</div>`:''}
    </div>
    ${c.desc?`<p style="font-style:italic;color:var(--text2);margin-bottom:10px;">${esc(c.desc)}</p>`:''}
    ${(c.attacks||[]).length?`<div style="font-family:'Cinzel',serif;font-size:10px;color:var(--text2);margin-bottom:6px;">ATTACKS</div>`:''}
    ${(c.attacks||[]).map(a=>`
      <div style="background:var(--bg3);border-radius:3px;padding:6px 10px;margin-bottom:6px;">
        <div style="font-family:'Cinzel',serif;font-size:12px;">${esc(a.name||'Unnamed')} <span style="color:var(--red);">${esc(a.value||'')}</span> â†’ ${esc(a.target)}</div>
        ${a.desc?`<div style="font-size:12px;color:var(--text2);">${esc(a.desc)}</div>`:''}
      </div>`).join('')}
    ${(c.rules||[]).length?`<div style="margin-top:8px;">${c.rules.map(r=>`<span class="rule-tag">${esc(r)}</span>`).join('')}</div>`:''}
  `;
  openModal('modal-detail');
}

// Field slot click
function fieldSlotClick() {
  if (!G || G.phase!=='player') return;
  if (G.sel && G.player.hand.includes(G.sel)) {
    const i = G.player.hand.indexOf(G.sel);
    if (i >= 0) playCard(i);
  } else if (G.fieldSlot) {
    showDetail(-1, null); // show field slot card
    document.getElementById('detailTitle').textContent = G.fieldSlot.name+' (Field Effect)';
    document.getElementById('detailBody').innerHTML = `<div style="font-size:24px;">${G.fieldSlot.emoji||'ğŸƒ'}</div>
      <div style="font-size:13px;color:var(--text2);margin-top:6px;">${esc(G.fieldSlot.desc||'No description.')}</div>`;
    openModal('modal-detail');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BACKUP / EXPORT / IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openBackup() { openModal('modal-backup'); }

function togglePwShow(id, btn) {
  const el = document.getElementById(id);
  el.type = el.type==='password' ? 'text' : 'password';
  btn.textContent = el.type==='password' ? 'SHOW' : 'HIDE';
}

function checkStrength() {
  const pw = document.getElementById('exportPw').value;
  const el = document.getElementById('exportStrength');
  if (!pw) { el.textContent=''; return; }
  let s=0;
  if(pw.length>=8)s++;if(pw.length>=14)s++;
  if(/[A-Z]/.test(pw))s++;if(/[0-9]/.test(pw))s++;if(/[^A-Za-z0-9]/.test(pw))s++;
  const labels=['','Weak','Fair','Good','Strong','Very Strong'];
  const colors=['','var(--red)','var(--amber)','var(--amber)','var(--green)','var(--green)'];
  el.textContent='â— '+labels[s]; el.style.color=colors[s]||'var(--red)';
}

async function deriveKey(pw, salt) {
  const km = await crypto.subtle.importKey('raw', new TextEncoder().encode(pw), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations:310000, hash:'SHA-256'},
    km, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']
  );
}
async function encText(pt, pw) {
  const salt=crypto.getRandomValues(new Uint8Array(16)), iv=crypto.getRandomValues(new Uint8Array(12));
  const key=await deriveKey(pw,salt);
  const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,new TextEncoder().encode(pt));
  const buf=new Uint8Array(28+ct.byteLength);buf.set(salt,0);buf.set(iv,16);buf.set(new Uint8Array(ct),28);
  return btoa(String.fromCharCode(...buf));
}
async function decText(b64, pw) {
  const buf=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
  const key=await deriveKey(pw,buf.slice(0,16));
  return new TextDecoder().decode(
    await crypto.subtle.decrypt({name:'AES-GCM',iv:buf.slice(16,28)},key,buf.slice(28))
  );
}

async function doExport() {
  const pw = document.getElementById('exportPw').value;
  const ts = new Date().toISOString().slice(0,16).replace('T','_').replace(':','-');
  const payload = JSON.stringify({version:1, exported:new Date().toISOString(), data:D});
  let content, filename;
  if (pw) {
    try { content=JSON.stringify({forge_enc:true,v:1,payload:await encText(payload,pw)}); filename=`forge_${ts}.enc.json`; }
    catch(e) { toast('Encryption failed'); return; }
  } else {
    content=payload; filename=`forge_${ts}.json`;
  }
  const a=Object.assign(document.createElement('a'),{
    href:URL.createObjectURL(new Blob([content],{type:'application/json'})), download:filename
  });
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

async function doImport() {
  const file=document.getElementById('importFile').files[0];
  const st=document.getElementById('importStatus');
  if(!file){st.textContent='No file selected.';st.style.color='var(--amber)';return;}
  st.textContent='Readingâ€¦';st.style.color='var(--text2)';
  let parsed;
  try{parsed=JSON.parse(await file.text());}
  catch(e){st.textContent='âœ• Invalid file.';st.style.color='var(--red)';return;}
  let imported;
  if(parsed.forge_enc){
    const pw=document.getElementById('importPw').value;
    if(!pw){st.textContent='âœ• Enter password.';st.style.color='var(--amber)';return;}
    try{imported=JSON.parse(await decText(parsed.payload,pw)).data;}
    catch(e){st.textContent='âœ• Wrong password.';st.style.color='var(--red)';return;}
  } else if(parsed.data){
    imported=parsed.data;
  } else {
    st.textContent='âœ• Unrecognised format.';st.style.color='var(--red)';return;
  }
  // Merge
  let ac=0,ag=0;
  const ci=new Set(D.cards.map(x=>x.id)),gi=new Set(D.games.map(x=>x.id));
  (imported.cards||[]).forEach(c=>{if(!ci.has(c.id)){D.cards.push(c);ac++;}});
  (imported.games||[]).forEach(g=>{if(!gi.has(g.id)){D.games.push(g);ag++;}});
  persist();
  renderCards();renderGames();refreshGameSelects();
  st.style.color='var(--green)';
  st.textContent=`âœ“ ${ac} cards, ${ag} games imported`;
}

function clearAll() {
  if(!confirm('Delete ALL Forge data?'))return;
  if(!confirm('This cannot be undone. Continue?'))return;
  D={cards:[],games:[]};persist();
  closeModal('modal-backup');renderCards();renderGames();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function int(id){return parseInt(document.getElementById(id).value)||0;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
hydrate();
refreshGameSelects();
renderCards();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHRONICLE MIGRATION
//  One-time import of card game data
//  from Chronicle's localStorage key
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function migrateFromChronicle() {
  try {
    const raw = localStorage.getItem('chronicle_data');
    if (!raw) return 0;
    const d = JSON.parse(raw);
    const cg = d.cardgame;
    if (!cg) return 0;
    let imported = 0;
    const ci = new Set(D.cards.map(x=>x.id));
    const gi = new Set(D.games.map(x=>x.id));
    (cg.cards||[]).forEach(c => { if(!ci.has(c.id)){ D.cards.push(c); imported++; }});
    (cg.games||[]).forEach(g => { if(!gi.has(g.id)){ D.games.push(g); imported++; }});
    if (imported > 0) persist();
    return imported;
  } catch(e) { return 0; }
}

// Run migration once on first load
if (!localStorage.getItem('forge_migrated')) {
  const n = migrateFromChronicle();
  if (n > 0) {
    localStorage.setItem('forge_migrated','1');
    toast('âœ“ Imported '+n+' items from Chronicle');
    renderCards(); renderGames(); refreshGameSelects();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SERVICE WORKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./forge_sw.js')
      .then(r => {
        r.addEventListener('updatefound', () => {
          const nw = r.installing;
          nw.addEventListener('statechange', () => {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              if (confirm('Forge has been updated. Reload now?')) window.location.reload();
            }
          });
        });
      })
      .catch(e => console.warn('Forge SW:', e));
  });
}

</script>
</body>
</html>
