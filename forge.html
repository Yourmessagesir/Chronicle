<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Card Forge</title>
<link rel="manifest" href="./forge_manifest.json">
<meta name="theme-color" content="#0d0d0f">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d0f14;--bg2:#141720;--bg3:#1c2030;--bg4:#242840;
  --border:#2a2f45;--border2:#3a4060;
  --gold:#c9a84c;--gold2:#e8c96a;--gold3:#f5e0a0;
  --red:#cc4444;--red2:#ff6666;
  --green:#44aa66;--green2:#66cc88;
  --blue:#4488cc;--blue2:#66aaee;
  --purple:#8855cc;--purple2:#aa77ee;
  --text:#d4cfc0;--text2:#8a8878;--text3:#5a5848;
  --accent:#e8c96a;--accent2:#c9a84c;
  --radius:6px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',serif;font-size:15px;min-height:100vh;}
/* â”€â”€ LAYOUT â”€â”€ */
#app{display:flex;flex-direction:column;height:100vh;overflow:hidden;}
header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 16px;display:flex;align-items:center;gap:12px;height:48px;flex-shrink:0;}
header h1{font-family:'Cinzel',serif;font-size:15px;color:var(--gold2);letter-spacing:.12em;white-space:nowrap;}
header .sub{font-size:11px;color:var(--text3);letter-spacing:.08em;}
.tabs{display:flex;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;}
.tabs::-webkit-scrollbar{display:none;}
.tab{padding:10px 18px;font-family:'Cinzel',serif;font-size:11px;letter-spacing:.1em;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all .15s;}
.tab:hover{color:var(--text);}
.tab.active{color:var(--gold2);border-bottom-color:var(--gold);}
.pane{display:none;flex:1;overflow:hidden;}
.pane.active{display:flex;flex-direction:column;overflow:hidden;}
.pane-scroll{flex:1;overflow-y:auto;padding:16px;}
.pane-scroll::-webkit-scrollbar{width:4px;}
.pane-scroll::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
/* â”€â”€ TOOLBAR â”€â”€ */
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:10px 16px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;}
/* â”€â”€ BUTTONS â”€â”€ */
.btn{padding:6px 14px;border:1px solid var(--border2);background:var(--bg3);color:var(--text);border-radius:var(--radius);cursor:pointer;font-family:'Cinzel',serif;font-size:10px;letter-spacing:.08em;transition:all .15s;white-space:nowrap;}
.btn:hover{border-color:var(--gold);color:var(--gold2);}
.btn.primary{background:var(--gold);color:#1a1400;border-color:var(--gold);font-weight:700;}
.btn.primary:hover{background:var(--gold2);}
.btn.danger{border-color:var(--red);color:var(--red);}
.btn.danger:hover{background:rgba(204,68,68,.15);}
.btn.small{padding:3px 9px;font-size:9px;}
.btn.ghost{background:transparent;border-color:transparent;color:var(--text2);}
.btn.ghost:hover{color:var(--text);border-color:var(--border);}
/* â”€â”€ CARDS GRID â”€â”€ */
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;}
.card-tile{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;transition:all .18s;position:relative;}
.card-tile:hover{border-color:var(--gold);transform:translateY(-2px);}
.card-tile .ct-emoji{font-size:28px;text-align:center;display:block;margin-bottom:6px;}
.card-tile .ct-name{font-family:'Cinzel',serif;font-size:11px;color:var(--gold2);text-align:center;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.card-tile .ct-type{font-size:10px;color:var(--text2);text-align:center;margin-bottom:6px;}
.card-tile .ct-stats{display:flex;justify-content:center;gap:8px;font-size:10px;}
.ct-stat{display:flex;flex-direction:column;align-items:center;gap:1px;}
.ct-stat span:first-child{color:var(--text3);font-size:8px;letter-spacing:.05em;}
.ct-stat span:last-child{color:var(--text);font-weight:600;}
.ct-kws{display:flex;flex-wrap:wrap;gap:3px;margin-top:6px;justify-content:center;}
.kw{display:inline-block;padding:1px 5px;border-radius:3px;font-size:8px;border:1px solid;letter-spacing:.04em;}
.kw-Flying{background:rgba(68,136,204,.2);border-color:#4488cc;color:#88bbee;}
.kw-Taunt{background:rgba(204,85,85,.2);border-color:#cc5555;color:#ee9999;}
.kw-Lifesteal{background:rgba(85,170,119,.2);border-color:#55aa77;color:#88ccaa;}
.kw-Poison{background:rgba(100,180,80,.25);border-color:#64b450;color:#99dd77;}
.kw-Regen{background:rgba(85,200,140,.2);border-color:#55c88c;color:#77eeaa;}
.kw-Haste{background:rgba(204,136,68,.2);border-color:#cc8844;color:#eebb77;}
.kw-Shield{background:rgba(136,153,187,.25);border-color:#8899bb;color:#aabbdd;}
.kw-Trample{background:rgba(180,100,60,.2);border-color:#b4643c;color:#dd9966;}
.kw-Burn{background:rgba(220,80,40,.2);border-color:#dc5028;color:#ff8866;}
.kw-Freeze{background:rgba(80,160,220,.2);border-color:#50a0dc;color:#88ccff;}
.kw-Stealth{background:rgba(80,80,120,.2);border-color:#505078;color:#9999bb;}
.kw-Charge{background:rgba(201,168,76,.2);border-color:var(--gold);color:var(--gold2);}
.kw-Deathtouch{background:rgba(160,40,100,.2);border-color:#a02864;color:#dd77aa;}
.kw-Indestructible{background:rgba(201,168,76,.3);border-color:var(--gold2);color:#fff0a0;}
.kw-Prowess{background:rgba(150,80,200,.2);border-color:#9650c8;color:#cc88ff;}
.kw-Cascade{background:rgba(200,100,200,.2);border-color:#c864c8;color:#ff99ff;}
.kw-Reborn{background:rgba(100,180,200,.2);border-color:#64b4c8;color:#88ddff;}
.kw-Piercing{background:rgba(220,180,50,.2);border-color:#dcb432;color:#ffdd66;}
.kw-Silence{background:rgba(120,120,120,.2);border-color:#888;color:#aaa;}
.kw-Defender{background:rgba(80,100,160,.2);border-color:#5064a0;color:#8899cc;}
.kw-Vigilance{background:rgba(100,160,80,.2);border-color:#64a050;color:#88cc66;}
.kw-Collector{background:rgba(200,160,50,.2);border-color:#c8a032;color:#f0c060;}
.kw-Mobile{background:rgba(60,180,180,.2);border-color:#3cb4b4;color:#66dddd;}
/* â”€â”€ FORMS â”€â”€ */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.form-grid.cols3{grid-template-columns:1fr 1fr 1fr;}
.form-grid.cols4{grid-template-columns:1fr 1fr 1fr 1fr;}
.field{display:flex;flex-direction:column;gap:4px;}
.field label{font-size:10px;color:var(--text2);letter-spacing:.06em;font-family:'Cinzel',serif;}
.field input,.field select,.field textarea{background:var(--bg3);border:1px solid var(--border2);color:var(--text);padding:7px 10px;border-radius:var(--radius);font-family:'Crimson Pro',serif;font-size:14px;transition:border-color .15s;}
.field input:focus,.field select,.field textarea:focus{outline:none;border-color:var(--gold);}
.field select{cursor:pointer;}
.field textarea{resize:vertical;min-height:60px;}
.field input[type=number]{-moz-appearance:textfield;}
.full{grid-column:1/-1;}
/* â”€â”€ ATTACK BUILDER â”€â”€ */
.atk-block{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:10px;margin-bottom:8px;}
.atk-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.atk-header input{flex:1;background:var(--bg2);border:1px solid var(--border2);color:var(--gold2);padding:5px 8px;border-radius:4px;font-family:'Cinzel',serif;font-size:11px;}
.effect-row{display:grid;grid-template-columns:2fr 1fr 2fr auto;gap:6px;align-items:center;margin-bottom:5px;}
.effect-row select,.effect-row input{background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:4px 7px;border-radius:4px;font-size:12px;}
.effect-row .rm-btn{background:none;border:none;color:var(--red);cursor:pointer;font-size:14px;padding:2px 6px;}
.effect-row .rm-btn:hover{color:var(--red2);}
/* â”€â”€ KEYWORDS â”€â”€ */
.kw-grid{display:flex;flex-wrap:wrap;gap:5px;}
.kw-toggle{padding:3px 8px;border-radius:3px;font-size:10px;border:1px solid var(--border2);background:var(--bg3);color:var(--text2);cursor:pointer;transition:all .15s;font-family:'Cinzel',serif;letter-spacing:.04em;}
.kw-toggle.on{border-color:var(--gold);color:var(--gold2);background:rgba(201,168,76,.12);}
/* â”€â”€ MODAL â”€â”€ */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:1000;align-items:center;justify-content:center;}
.modal-bg.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:10px;width:min(700px,96vw);max-height:90vh;overflow-y:auto;padding:20px;}
.modal::-webkit-scrollbar{width:4px;}
.modal::-webkit-scrollbar-thumb{background:var(--border2);}
.modal h2{font-family:'Cinzel',serif;font-size:15px;color:var(--gold2);margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.modal-foot{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:12px;border-top:1px solid var(--border);}
/* â”€â”€ GAMES LIST â”€â”€ */
.game-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:10px;cursor:pointer;transition:all .18s;}
.game-card:hover{border-color:var(--gold2);}
.game-card h3{font-family:'Cinzel',serif;font-size:13px;color:var(--gold2);margin-bottom:4px;}
.game-card .gc-meta{font-size:11px;color:var(--text2);display:flex;gap:12px;flex-wrap:wrap;}
.badge{display:inline-block;padding:2px 7px;border-radius:3px;font-size:9px;background:var(--bg3);border:1px solid var(--border2);color:var(--text2);font-family:'Cinzel',serif;letter-spacing:.05em;}
/* â”€â”€ FUSION â”€â”€ */
.fusion-card{background:var(--bg2);border:1px solid var(--purple);border-radius:8px;padding:12px;margin-bottom:10px;cursor:pointer;}
.fusion-card:hover{border-color:var(--purple2);}
.fusion-card h3{font-family:'Cinzel',serif;font-size:12px;color:var(--purple2);}
/* â”€â”€ RULE TOGGLES â”€â”€ */
.rule-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.rule-item{display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg3);border-radius:5px;border:1px solid var(--border);}
.rule-item label{font-size:12px;color:var(--text);flex:1;cursor:pointer;}
.rule-item input[type=checkbox]{accent-color:var(--gold);width:14px;height:14px;cursor:pointer;}
/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--border2);color:var(--text);padding:8px 18px;border-radius:20px;font-size:13px;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;}
#toast.show{opacity:1;}
#toast.win{border-color:var(--gold);color:var(--gold2);}
#toast.bad{border-color:var(--red);color:var(--red2);}
#toast.good{border-color:var(--green);color:var(--green2);}
/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;color:var(--text3);padding:40px 20px;font-size:13px;font-style:italic;}
/* â”€â”€ SEARCH â”€â”€ */
.search-bar{display:flex;gap:8px;align-items:center;}
.search-bar input{background:var(--bg3);border:1px solid var(--border2);color:var(--text);padding:6px 12px;border-radius:20px;font-family:'Crimson Pro',serif;font-size:13px;width:200px;}
.search-bar input:focus{outline:none;border-color:var(--gold);}
/* â”€â”€ SECTION LABELS â”€â”€ */
.sec-label{font-family:'Cinzel',serif;font-size:10px;color:var(--text3);letter-spacing:.12em;margin:14px 0 8px;text-transform:uppercase;border-bottom:1px solid var(--border);padding-bottom:4px;}
/* â”€â”€ DIVIDER â”€â”€ */
hr.dim{border:none;border-top:1px solid var(--border);margin:12px 0;}
/* â”€â”€ FILTER PILLS â”€â”€ */
.filter-pills{display:flex;gap:6px;flex-wrap:wrap;}
.pill{padding:3px 10px;border-radius:12px;font-size:10px;border:1px solid var(--border2);background:var(--bg3);color:var(--text2);cursor:pointer;font-family:'Cinzel',serif;transition:all .15s;}
.pill.active{border-color:var(--gold);color:var(--gold2);background:rgba(201,168,76,.1);}
/* â”€â”€ GUIDE â”€â”€ */
.guide-kw{display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid var(--border);}
.guide-kw:last-child{border-bottom:none;}
.guide-kw .gk-desc{font-size:12px;color:var(--text2);}
/* responsive */
@media(max-width:500px){.form-grid{grid-template-columns:1fr;}.form-grid.cols3,.form-grid.cols4{grid-template-columns:1fr 1fr;}}
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>âš™ CARD FORGE</h1>
    <span class="sub" id="hSub">CARD BUILDER</span>
    <div style="flex:1"></div>
    <button class="btn small" onclick="openPlaytest()">â–¶ PLAYTEST</button>
    <button class="btn small" onclick="openLayoutBuilder()">ğŸ—º LAYOUTS</button>
  </header>
  <div class="tabs">
    <div class="tab active" onclick="showTab('cards')">CARDS</div>
    <div class="tab" onclick="showTab('decks')">DECKS</div>
    <div class="tab" onclick="showTab('fusion')">FUSION</div>
    <div class="tab" onclick="showTab('games')">GAME CONFIG</div>
    <div class="tab" onclick="showTab('export')">EXPORT</div>
    <div class="tab" onclick="showTab('guide')">KEYWORDS</div>
  </div>

  <!-- â•â•â• CARDS TAB â•â•â• -->
  <div class="pane active" id="pane-cards">
    <div class="toolbar">
      <button class="btn primary" onclick="openAddCard()">+ NEW CARD</button>
      <div class="search-bar">
        <input type="text" id="cardSearch" placeholder="Search cardsâ€¦" oninput="renderCards()">
      </div>
      <div class="filter-pills" id="typeFilter"></div>
      <div style="flex:1"></div>
      <select id="cardGameFilter" onchange="renderCards()" style="background:var(--bg3);border:1px solid var(--border2);color:var(--text);padding:5px 8px;border-radius:var(--radius);font-size:12px;">
        <option value="">All Games</option>
      </select>
    </div>
    <div class="pane-scroll">
      <div class="cards-grid" id="cardsGrid"></div>
    </div>
  </div>

  <!-- â•â•â• DECKS TAB â•â•â• -->
  <div class="pane" id="pane-decks">
    <div class="toolbar">
      <button class="btn primary" onclick="openAddDeck()">+ NEW DECK</button>
    </div>
    <div class="pane-scroll" id="decksPane"></div>
  </div>

  <!-- â•â•â• FUSION TAB â•â•â• -->
  <div class="pane" id="pane-fusion">
    <div class="toolbar">
      <button class="btn primary" onclick="openAddFusion()">+ NEW RECIPE</button>
    </div>
    <div class="pane-scroll" id="fusionsPane"></div>
  </div>

  <!-- â•â•â• GAMES TAB â•â•â• -->
  <div class="pane" id="pane-games">
    <div class="toolbar">
      <button class="btn primary" onclick="openAddGame()">+ NEW GAME CONFIG</button>
    </div>
    <div class="pane-scroll" id="gamesPane"></div>
  </div>

  <!-- â•â•â• EXPORT TAB â•â•â• -->
  <div class="pane" id="pane-export">
    <div class="pane-scroll">
      <div class="sec-label">CSV EXPORT</div>
      <p style="color:var(--text2);font-size:13px;margin-bottom:14px;">Export cards to CSV for import into your card layout software. Choose which game's cards to export, or export all.</p>
      <div class="form-grid" style="max-width:400px;margin-bottom:16px;">
        <div class="field">
          <label>GAME FILTER</label>
          <select id="exportGameFilter">
            <option value="">All Cards</option>
          </select>
        </div>
        <div class="field">
          <label>CARD TYPE FILTER</label>
          <select id="exportTypeFilter">
            <option value="">All Types</option>
          </select>
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;">
        <button class="btn primary" onclick="exportCSV()">â¬‡ EXPORT CSV</button>
        <button class="btn" onclick="exportJSON()">â¬‡ EXPORT JSON (BACKUP)</button>
        <button class="btn" onclick="document.getElementById('importFile').click()">â¬† IMPORT JSON</button>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
      </div>
      <div class="sec-label">EXPORT PREVIEW</div>
      <div id="exportPreview" style="font-size:11px;color:var(--text2);background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:12px;max-height:300px;overflow-y:auto;white-space:pre;font-family:monospace;"></div>
    </div>
  </div>

  <!-- â•â•â• GUIDE TAB â•â•â• -->
  <div class="pane" id="pane-guide">
    <div class="pane-scroll" id="guidePane"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• CARD MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="cardModal">
<div class="modal">
  <h2>ğŸƒ <span id="cardModalTitle">NEW CARD</span></h2>
  <input type="hidden" id="editCardId">
  <div class="sec-label">IDENTITY</div>
  <div class="form-grid cols4">
    <div class="field full"><label>CARD NAME</label><input type="text" id="cName" placeholder="Enter card nameâ€¦"></div>
    <div class="field"><label>EMOJI / ICON</label><input type="text" id="cEmoji" placeholder="ğŸƒ" maxlength="4"></div>
    <div class="field"><label>CARD ID</label><input type="text" id="cCardId" placeholder="AUTO"></div>
    <div class="field"><label>SET NAME</label><input type="text" id="cSet" placeholder="Core Set"></div>
    <div class="field">
      <label>TYPE</label>
      <select id="cType" onchange="toggleCustomType()">
        <option>Creature</option><option>Spell</option><option>Construct</option>
        <option>Field</option><option>Event</option><option>Resource</option>
        <option>Item</option><option>Trap</option><option>Fusion</option>
        <option>Assistant</option><option>Collector</option><option>Customâ€¦</option>
      </select>
    </div>
    <div class="field" id="customTypeField" style="display:none"><label>CUSTOM TYPE</label><input type="text" id="cCustomType" placeholder="Your typeâ€¦"></div>
    <div class="field">
      <label>RARITY</label>
      <select id="cRarity">
        <option>Common</option><option>Uncommon</option><option>Rare</option>
        <option>Epic</option><option>Legendary</option>
      </select>
    </div>
    <div class="field">
      <label>GAME CONFIG</label>
      <select id="cGameId"><option value="">None</option></select>
    </div>
  </div>
  <div class="sec-label" style="margin-top:14px;">STATS</div>
  <div class="form-grid cols4">
    <div class="field"><label>HP</label><input type="number" id="cHp" value="10" min="0"></div>
    <div class="field"><label>ATK</label><input type="number" id="cAtk" value="3" min="0"></div>
    <div class="field"><label>DEF</label><input type="number" id="cDef" value="0" min="0"></div>
    <div class="field"><label>COST</label><input type="number" id="cCost" value="1" min="0"></div>
    <div class="field"><label>MOVEMENT</label><input type="number" id="cMove" value="1" min="0"></div>
    <div class="field"><label>LEVEL</label><input type="number" id="cLevel" value="1" min="1"></div>
    <div class="field"><label>TRIBUTE REQ</label><input type="number" id="cTribute" value="0" min="0" title="Cards to sacrifice to play this"></div>
    <div class="field"><label>RESOURCE TYPE</label><input type="text" id="cResType" placeholder="Mana / Energyâ€¦"></div>
  </div>
  <div class="sec-label" style="margin-top:14px;">KEYWORDS</div>
  <div class="kw-grid" id="kwSelector"></div>
  <div class="sec-label" style="margin-top:14px;">ATTACKS / ABILITIES</div>
  <div id="atkList"></div>
  <button class="btn small" onclick="addAttack('atkList')" style="margin-top:4px;">+ ADD ATTACK</button>
  <div class="sec-label" style="margin-top:14px;">TEXT</div>
  <div class="form-grid">
    <div class="field full"><label>RULES TEXT / ABILITY DESCRIPTION</label><textarea id="cRules" placeholder="Card effect textâ€¦" rows="3"></textarea></div>
    <div class="field full"><label>FLAVOR TEXT</label><textarea id="cFlavor" placeholder="Italic flavor textâ€¦" rows="2"></textarea></div>
    <div class="field full"><label>IMAGE URL (optional)</label><input type="text" id="cImage" placeholder="https://â€¦"></div>
  </div>
  <div class="modal-foot">
    <button class="btn danger" id="delCardBtn" onclick="delCard()" style="display:none;margin-right:auto;">DELETE</button>
    <button class="btn ghost" onclick="closeModal('cardModal')">CANCEL</button>
    <button class="btn primary" onclick="saveCard()">SAVE CARD</button>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• DECK MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="deckModal">
<div class="modal">
  <h2>ğŸ“¦ <span id="deckModalTitle">NEW DECK</span></h2>
  <input type="hidden" id="editDeckId">
  <div class="form-grid">
    <div class="field"><label>DECK NAME</label><input type="text" id="dName" placeholder="My Deck"></div>
    <div class="field"><label>LINKED GAME</label><select id="dGameId"><option value="">None</option></select></div>
    <div class="field full"><label>DESCRIPTION</label><textarea id="dDesc" rows="2" placeholder="Deck strategy notesâ€¦"></textarea></div>
  </div>
  <div class="sec-label" style="margin-top:12px;">CARDS IN DECK</div>
  <div id="deckCardPicker" style="max-height:300px;overflow-y:auto;"></div>
  <div class="modal-foot">
    <button class="btn danger" id="delDeckBtn" onclick="delDeck()" style="display:none;margin-right:auto;">DELETE</button>
    <button class="btn ghost" onclick="closeModal('deckModal')">CANCEL</button>
    <button class="btn primary" onclick="saveDeck()">SAVE DECK</button>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• FUSION MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="fusionModal">
<div class="modal">
  <h2>ğŸ”€ <span id="fusionModalTitle">NEW FUSION RECIPE</span></h2>
  <input type="hidden" id="editFusionId">
  <div class="form-grid">
    <div class="field"><label>RECIPE NAME</label><input type="text" id="fName" placeholder="Dragon Fusionâ€¦"></div>
    <div class="field"><label>GAME CONFIG</label><select id="fGameId"><option value="">None</option></select></div>
  </div>
  <div class="sec-label" style="margin-top:12px;">INGREDIENT CARDS (select 2â€“4)</div>
  <div id="fusionIngredients" style="max-height:180px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;padding:8px;"></div>
  <div class="sec-label" style="margin-top:12px;">RESULT CARD STATS</div>
  <div class="form-grid cols4">
    <div class="field"><label>NAME</label><input type="text" id="fResName" placeholder="Elder Dragonâ€¦"></div>
    <div class="field"><label>EMOJI</label><input type="text" id="fResEmoji" placeholder="ğŸ‰"></div>
    <div class="field"><label>TYPE</label><input type="text" id="fResType" placeholder="Fusion Creature"></div>
    <div class="field"><label>RARITY</label><select id="fResRarity"><option>Rare</option><option>Epic</option><option>Legendary</option></select></div>
    <div class="field"><label>HP</label><input type="number" id="fResHp" value="20" min="1"></div>
    <div class="field"><label>ATK</label><input type="number" id="fResAtk" value="8" min="0"></div>
    <div class="field"><label>DEF</label><input type="number" id="fResDef" value="0" min="0"></div>
    <div class="field"><label>MOVE</label><input type="number" id="fResMove" value="1" min="0"></div>
  </div>
  <div class="sec-label" style="margin-top:10px;">RESULT KEYWORDS</div>
  <div class="kw-grid" id="fkwSelector"></div>
  <div class="sec-label" style="margin-top:10px;">RESULT ATTACKS</div>
  <div id="fAtkList"></div>
  <button class="btn small" onclick="addAttack('fAtkList')" style="margin-top:4px;">+ ADD ATTACK</button>
  <div class="field full" style="margin-top:10px;"><label>RULES TEXT</label><textarea id="fResRules" rows="2" placeholder="Fusion effectâ€¦"></textarea></div>
  <div class="modal-foot">
    <button class="btn danger" id="delFusionBtn" onclick="delFusion()" style="display:none;margin-right:auto;">DELETE</button>
    <button class="btn ghost" onclick="closeModal('fusionModal')">CANCEL</button>
    <button class="btn primary" onclick="saveFusion()">SAVE RECIPE</button>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="gameModal">
<div class="modal">
  <h2>âš™ <span id="gameModalTitle">NEW GAME CONFIG</span></h2>
  <input type="hidden" id="editGameId">
  <div class="form-grid">
    <div class="field"><label>CONFIG NAME</label><input type="text" id="gName" placeholder="My Game Mode"></div>
    <div class="field">
      <label>PLAY MODE</label>
      <select id="gMode">
        <option value="standard">Standard (table layout)</option>
        <option value="grid">Grid Battle (chess-style movement)</option>
        <option value="arena">Arena (positional free play)</option>
        <option value="lanes">Lane Battle (3 lanes)</option>
        <option value="traverse">Traversible Field (crystal hunt)</option>
        <option value="coop">Co-op Combo</option>
        <option value="draft">Draft / Deck-builder</option>
      </select>
    </div>
    <div class="field"><label>STARTING HP</label><input type="number" id="gHp" value="30" min="1"></div>
    <div class="field"><label>HAND SIZE</label><input type="number" id="gHand" value="5" min="1"></div>
    <div class="field"><label>FIELD SIZE</label><input type="number" id="gField" value="5" min="1"></div>
    <div class="field"><label>RESOURCE/TURN</label><input type="number" id="gRes" value="3" min="1"></div>
    <div class="field"><label>MAX RESOURCE</label><input type="number" id="gMaxRes" value="10" min="1"></div>
    <div class="field"><label>PLAYERS (1â€“4)</label><input type="number" id="gPlayers" value="2" min="1" max="4"></div>
    <div class="field"><label>CRYSTAL HP (traverse)</label><input type="number" id="gCrystalHp" value="20" min="1"></div>
    <div class="field"><label>GRID SIZE (grid/traverse)</label><input type="number" id="gGridSize" value="6" min="4" max="12"></div>
    <div class="field"><label>AI STYLE</label>
      <select id="gAi">
        <option value="aggressive">Aggressive</option>
        <option value="control">Control</option>
        <option value="combo">Combo</option>
        <option value="random">Random</option>
      </select>
    </div>
    <div class="field"><label>AI DIFFICULTY</label>
      <select id="gAiDiff">
        <option value="easy">Easy</option>
        <option value="medium" selected>Medium</option>
        <option value="hard">Hard</option>
      </select>
    </div>
  </div>
  <div class="sec-label" style="margin-top:14px;">WIN CONDITIONS</div>
  <div class="rule-grid" id="winCondGrid"></div>
  <div class="sec-label" style="margin-top:14px;">RULE TOGGLES</div>
  <div class="rule-grid" id="ruleToggleGrid"></div>
  <div class="sec-label" style="margin-top:14px;">TURN PHASES</div>
  <div id="phaseEditor" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
  <div class="sec-label" style="margin-top:14px;">NOTES</div>
  <div class="field"><textarea id="gNotes" rows="3" placeholder="Design notes, intended play styleâ€¦"></textarea></div>
  <div class="modal-foot">
    <button class="btn danger" id="delGameBtn" onclick="delGame()" style="display:none;margin-right:auto;">DELETE</button>
    <button class="btn ghost" onclick="closeModal('gameModal')">CANCEL</button>
    <button class="btn primary" onclick="saveGame()">SAVE CONFIG</button>
  </div>
</div>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORE = 'cardforge_v3';
const ALL_KEYWORDS = [
  'Flying','Taunt','Lifesteal','Poison','Regen','Haste','Shield','Trample',
  'Piercing','Burn','Freeze','Silence','Stealth','Charge','Deathtouch',
  'Defender','Indestructible','Vigilance','Prowess','Cascade','Reborn',
  'Collector','Mobile'
];
const WIN_CONDS = [
  {id:'hp0',label:'Reduce opponent HP to 0'},
  {id:'deckout',label:'Opponent decks out (empty draw pile)'},
  {id:'objective',label:'Control objective zones'},
  {id:'crystal',label:'Destroy opponent crystal (traverse mode)'},
  {id:'lanes2',label:'Win 2 of 3 lanes'},
  {id:'combo',label:'Reach combo threshold score'},
];
const RULE_TOGGLES = [
  {id:'tributeEnabled',label:'Tribute summon (high-level cards need sacrifices)'},
  {id:'fusionEnabled',label:'Fusion / crafting enabled'},
  {id:'resourceSystem',label:'Resource/cost system active'},
  {id:'assistantZone',label:'Assistant zone (limited co-op helper card)'},
  {id:'collectorZone',label:'Collector zone (item grabber on field)'},
  {id:'fieldCardsActive',label:'Field cards affect all cards'},
  {id:'eventCards',label:'Event cards trigger globally'},
  {id:'spellSlots',label:'Spell slots (limited spells per turn)'},
  {id:'maxSpellSlots',label:''},
  {id:'firstStrike',label:'First strike resolves before normal combat'},
  {id:'stackResources',label:'Resources stack between turns'},
  {id:'coopSimultaneous',label:'Co-op: simultaneous play mode'},
];
const PHASES = ['Draw','Main','Combat','End','Craft','Move','Collect','Combo'];
const EFFECT_TYPES = [
  {v:'dmg_hp',l:'Damage HP'},
  {v:'dmg_atk',l:'Reduce ATK'},
  {v:'dmg_def',l:'Reduce DEF'},
  {v:'heal_self',l:'Heal Self HP'},
  {v:'heal_ally',l:'Heal Ally HP'},
  {v:'boost_atk',l:'Boost ATK'},
  {v:'boost_def',l:'Boost DEF'},
  {v:'boost_hp',l:'Boost HP'},
  {v:'draw',l:'Draw Cards'},
  {v:'discard_opp',l:'Opponent Discards'},
  {v:'gain_res',l:'Gain Resources'},
  {v:'drain_res',l:'Drain Opponent Resources'},
  {v:'apply_poison',l:'Apply Poison'},
  {v:'apply_freeze',l:'Apply Freeze'},
  {v:'apply_burn',l:'Apply Burn'},
  {v:'apply_silence',l:'Apply Silence'},
  {v:'destroy',l:'Destroy Target'},
  {v:'exile',l:'Exile Target'},
  {v:'collect_item',l:'Collect Item (traverse)'},
  {v:'move_card',l:'Move Card on Field'},
  {v:'summon',l:'Summon Token'},
  {v:'copy_atk',l:'Copy Target ATK'},
];
const TARGETS = [
  {v:'opp_card',l:'Target Opp Card'},
  {v:'opp_all',l:'All Opp Cards'},
  {v:'opp_player',l:'Opp Player'},
  {v:'self_card',l:'This Card'},
  {v:'ally_card',l:'Target Ally'},
  {v:'all_allies',l:'All Allies'},
  {v:'all_field',l:'All Cards on Field'},
  {v:'nearest_enemy',l:'Nearest Enemy (traverse)'},
  {v:'item_on_field',l:'Item on Field (traverse)'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let D = {cards:[], decks:[], fusions:[], games:[], nextId:1};
function persist(){localStorage.setItem(STORE, JSON.stringify(D));}
function hydrate(){
  try{const s=localStorage.getItem(STORE);if(s){D=JSON.parse(s);D.nextId=D.nextId||1;}}catch(e){}
}
function uid(){return 'cf_'+(D.nextId++);}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function toast(msg,cls=''){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='show '+(cls||'');
  clearTimeout(t._t); t._t=setTimeout(()=>t.className='',2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(name){
  document.querySelectorAll('.tab').forEach((t,i)=>{
    const names=['cards','decks','fusion','games','export','guide'];
    t.classList.toggle('active',names[i]===name);
  });
  document.querySelectorAll('.pane').forEach(p=>p.classList.toggle('active',p.id==='pane-'+name));
  const labels={cards:'CARD BUILDER',decks:'DECK MANAGER',fusion:'FUSION & CRAFTING',
    games:'GAME CONFIGS',export:'EXPORT / IMPORT',guide:'KEYWORD REFERENCE'};
  document.getElementById('hSub').textContent=labels[name]||'';
  if(name==='export')refreshExportPreview();
  if(name==='guide')renderGuide();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){document.getElementById(id).classList.add('open');document.body.style.overflow='hidden';}
function closeModal(id){document.getElementById(id).classList.remove('open');document.body.style.overflow='';}
document.querySelectorAll('.modal-bg').forEach(bg=>bg.addEventListener('click',e=>{if(e.target===bg)closeModal(bg.id);}));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYWORD SELECTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildKwSelector(containerId, selected=[]){
  const el=document.getElementById(containerId);
  el.innerHTML=ALL_KEYWORDS.map(kw=>`
    <span class="kw-toggle${selected.includes(kw)?' on':''}" onclick="toggleKw(this,'${kw}','${containerId}')">${kw}</span>
  `).join('');
}
function toggleKw(el,kw,cId){el.classList.toggle('on');}
function getSelectedKws(cId){
  return [...document.getElementById(cId).querySelectorAll('.kw-toggle.on')].map(e=>e.textContent);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ATTACK BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addAttack(listId){
  const el=document.getElementById(listId);
  const atks=JSON.parse(el.dataset.atks||'[]');
  atks.push({id:Date.now(),name:'Attack',cost:0,effects:[{type:'dmg_hp',value:3,target:'opp_card'}]});
  el.dataset.atks=JSON.stringify(atks);
  renderAtkList(listId);
}
function renderAtkList(listId){
  const el=document.getElementById(listId);
  const atks=JSON.parse(el.dataset.atks||'[]');
  el.innerHTML=atks.map((a,ai)=>`
    <div class="atk-block">
      <div class="atk-header">
        <input type="text" value="${esc(a.name)}" oninput="updAtk('${listId}',${ai},'name',this.value)" placeholder="Attack name">
        <span style="font-size:11px;color:var(--text3);">COST:</span>
        <input type="number" value="${a.cost||0}" oninput="updAtk('${listId}',${ai},'cost',+this.value)" style="width:50px;background:var(--bg2);border:1px solid var(--border2);color:var(--text);padding:4px;border-radius:4px;font-size:12px;" min="0">
        <button class="btn small danger" onclick="rmAtk('${listId}',${ai})" style="margin-left:auto;">âœ•</button>
      </div>
      <div style="font-size:9px;color:var(--text3);margin-bottom:5px;font-family:'Cinzel',serif;letter-spacing:.06em;">EFFECTS (max 4)</div>
      <div id="${listId}_eff_${ai}">
        ${renderEffects(a.effects||[], listId, ai)}
      </div>
      ${(a.effects||[]).length<4?`<button class="btn small" onclick="addEffect('${listId}',${ai})" style="margin-top:4px;">+ EFFECT</button>`:''}
      <div style="margin-top:6px;">
        <input type="text" value="${esc(a.desc||'')}" oninput="updAtk('${listId}',${ai},'desc',this.value)" placeholder="Description (optional)â€¦" style="width:100%;background:var(--bg2);border:1px solid var(--border);color:var(--text2);padding:4px 8px;border-radius:4px;font-size:12px;">
      </div>
    </div>
  `).join('');
}
function renderEffects(effects, listId, ai){
  return effects.map((ef,ei)=>`
    <div class="effect-row">
      <select onchange="updEffect('${listId}',${ai},${ei},'type',this.value)">
        ${EFFECT_TYPES.map(t=>`<option value="${t.v}"${ef.type===t.v?' selected':''}>${t.l}</option>`).join('')}
      </select>
      <input type="number" value="${ef.value||0}" oninput="updEffect('${listId}',${ai},${ei},'value',+this.value)" placeholder="Val" min="-99" max="999" style="width:60px;">
      <select onchange="updEffect('${listId}',${ai},${ei},'target',this.value)">
        ${TARGETS.map(t=>`<option value="${t.v}"${ef.target===t.v?' selected':''}>${t.l}</option>`).join('')}
      </select>
      <button class="rm-btn" onclick="rmEffect('${listId}',${ai},${ei})">âœ•</button>
    </div>
  `).join('');
}
function updAtk(listId,ai,field,val){
  const el=document.getElementById(listId);
  const atks=JSON.parse(el.dataset.atks||'[]');
  if(atks[ai])atks[ai][field]=val;
  el.dataset.atks=JSON.stringify(atks);
  if(field!=='name'&&field!=='desc'&&field!=='cost')renderAtkList(listId);
}
function rmAtk(listId,ai){
  const el=document.getElementById(listId);
  const atks=JSON.parse(el.dataset.atks||'[]');
  atks.splice(ai,1);
  el.dataset.atks=JSON.stringify(atks);
  renderAtkList(listId);
}
function addEffect(listId,ai){
  const el=document.getElementById(listId);
  const atks=JSON.parse(el.dataset.atks||'[]');
  if(!atks[ai].effects)atks[ai].effects=[];
  if(atks[ai].effects.length>=4)return;
  atks[ai].effects.push({type:'dmg_hp',value:2,target:'opp_card'});
  el.dataset.atks=JSON.stringify(atks);
  renderAtkList(listId);
}
function updEffect(listId,ai,ei,field,val){
  const el=document.getElementById(listId);
  const atks=JSON.parse(el.dataset.atks||'[]');
  if(atks[ai]&&atks[ai].effects&&atks[ai].effects[ei])atks[ai].effects[ei][field]=val;
  el.dataset.atks=JSON.stringify(atks);
}
function rmEffect(listId,ai,ei){
  const el=document.getElementById(listId);
  const atks=JSON.parse(el.dataset.atks||'[]');
  if(atks[ai]&&atks[ai].effects)atks[ai].effects.splice(ei,1);
  el.dataset.atks=JSON.stringify(atks);
  renderAtkList(listId);
}
function setAtkList(listId,atks){
  document.getElementById(listId).dataset.atks=JSON.stringify(atks||[]);
  renderAtkList(listId);
}
function getAtkList(listId){return JSON.parse(document.getElementById(listId).dataset.atks||'[]');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REFRESH SELECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshSelects(){
  const gameOpts='<option value="">None</option>'+D.games.map(g=>`<option value="${g.id}">${esc(g.name)}</option>`).join('');
  ['cGameId','dGameId','fGameId'].forEach(id=>{
    const el=document.getElementById(id);if(el)el.innerHTML=gameOpts;
  });
  // game filter dropdowns
  const filterOpts='<option value="">All Games</option>'+D.games.map(g=>`<option value="${g.id}">${esc(g.name)}</option>`).join('');
  ['cardGameFilter','exportGameFilter'].forEach(id=>{
    const el=document.getElementById(id);if(el)el.innerHTML=filterOpts;
  });
  // type filter for export
  const types=[...new Set(D.cards.map(c=>c.type||'').filter(Boolean))];
  const typeEl=document.getElementById('exportTypeFilter');
  if(typeEl)typeEl.innerHTML='<option value="">All Types</option>'+types.map(t=>`<option>${esc(t)}</option>`).join('');
}
function toggleCustomType(){
  const v=document.getElementById('cType').value;
  document.getElementById('customTypeField').style.display=v==='Customâ€¦'?'flex':'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeTypeFilter='';
function renderCards(){
  const search=document.getElementById('cardSearch').value.toLowerCase();
  const gameF=document.getElementById('cardGameFilter').value;
  let cards=D.cards;
  if(gameF)cards=cards.filter(c=>c.gameId===gameF);
  if(activeTypeFilter)cards=cards.filter(c=>c.type===activeTypeFilter);
  if(search)cards=cards.filter(c=>(c.name||'').toLowerCase().includes(search)||(c.type||'').toLowerCase().includes(search));
  const grid=document.getElementById('cardsGrid');
  if(!cards.length){grid.innerHTML='<div class="empty" style="grid-column:1/-1">No cards yet â€” click + NEW CARD to start.</div>';return;}
  grid.innerHTML=cards.map(c=>`
    <div class="card-tile" onclick="openEditCard('${c.id}')">
      <span class="ct-emoji">${c.emoji||'ğŸƒ'}</span>
      <div class="ct-name">${esc(c.name)}</div>
      <div class="ct-type" style="color:${typeColor(c.type)}">${esc(c.type||'Card')}</div>
      <div class="ct-stats">
        ${c.hp?`<div class="ct-stat"><span>HP</span><span>${c.hp}</span></div>`:''}
        ${c.atk?`<div class="ct-stat"><span>ATK</span><span>${c.atk}</span></div>`:''}
        ${c.def?`<div class="ct-stat"><span>DEF</span><span>${c.def}</span></div>`:''}
        ${c.cost!==undefined?`<div class="ct-stat"><span>COST</span><span>${c.cost}</span></div>`:''}
        ${c.move?`<div class="ct-stat"><span>MOV</span><span>${c.move}</span></div>`:''}
      </div>
      <div class="ct-kws">${(c.keywords||[]).slice(0,3).map(k=>`<span class="kw kw-${k}" style="font-size:7px;">${k}</span>`).join('')}</div>
      ${c.set?`<div style="font-size:8px;color:var(--text3);text-align:center;margin-top:4px;">${esc(c.set)}</div>`:''}
    </div>
  `).join('');
  // build type pills
  const types=[...new Set(D.cards.map(c=>c.type||'').filter(Boolean))];
  const pills=document.getElementById('typeFilter');
  pills.innerHTML='<span class="pill'+(activeTypeFilter?'':' active')+'" onclick="setTypeFilter(\'\')">All</span>'
    +types.map(t=>`<span class="pill${activeTypeFilter===t?' active':''}" onclick="setTypeFilter('${esc(t)}')">${esc(t)}</span>`).join('');
}
function setTypeFilter(t){activeTypeFilter=t;renderCards();}
function typeColor(t){
  const map={Creature:'#6688aa',Spell:'#aa66cc',Construct:'#cc8844',Field:'#44aa66',
    Event:'#cc6644',Resource:'#aaaa44',Item:'#44aaaa',Trap:'#aa4466',
    Fusion:'#9944cc',Assistant:'#4466cc',Collector:'#66aa44'};
  return map[t]||'#667799';
}
function openAddCard(){
  document.getElementById('cardModalTitle').textContent='NEW CARD';
  document.getElementById('editCardId').value='';
  document.getElementById('delCardBtn').style.display='none';
  // reset
  ['cName','cEmoji','cCardId','cSet','cResType','cRules','cFlavor','cImage','cCustomType'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('cType').value='Creature';
  document.getElementById('cRarity').value='Common';
  document.getElementById('cHp').value=10;document.getElementById('cAtk').value=3;
  document.getElementById('cDef').value=0;document.getElementById('cCost').value=1;
  document.getElementById('cMove').value=1;document.getElementById('cLevel').value=1;
  document.getElementById('cTribute').value=0;
  document.getElementById('customTypeField').style.display='none';
  buildKwSelector('kwSelector',[]);
  setAtkList('atkList',[]);
  refreshSelects();
  openModal('cardModal');
}
function openEditCard(id){
  const c=D.cards.find(x=>x.id===id);if(!c)return;
  document.getElementById('cardModalTitle').textContent='EDIT CARD';
  document.getElementById('editCardId').value=id;
  document.getElementById('delCardBtn').style.display='';
  document.getElementById('cName').value=c.name||'';
  document.getElementById('cEmoji').value=c.emoji||'';
  document.getElementById('cCardId').value=c.cardId||'';
  document.getElementById('cSet').value=c.set||'';
  document.getElementById('cType').value=c.type||'Creature';
  document.getElementById('cRarity').value=c.rarity||'Common';
  document.getElementById('cHp').value=c.hp||10;
  document.getElementById('cAtk').value=c.atk||0;
  document.getElementById('cDef').value=c.def||0;
  document.getElementById('cCost').value=c.cost||0;
  document.getElementById('cMove').value=c.move||1;
  document.getElementById('cLevel').value=c.level||1;
  document.getElementById('cTribute').value=c.tribute||0;
  document.getElementById('cResType').value=c.resType||'';
  document.getElementById('cRules').value=c.rules||'';
  document.getElementById('cFlavor').value=c.flavor||'';
  document.getElementById('cImage').value=c.image||'';
  document.getElementById('customTypeField').style.display='none';
  buildKwSelector('kwSelector',c.keywords||[]);
  setAtkList('atkList',c.attacks||[]);
  refreshSelects();
  setTimeout(()=>{if(c.gameId)document.getElementById('cGameId').value=c.gameId;},50);
  openModal('cardModal');
}
function saveCard(){
  const name=document.getElementById('cName').value.trim();
  if(!name)return toast('Card needs a name.','bad');
  const id=document.getElementById('editCardId').value;
  let type=document.getElementById('cType').value;
  if(type==='Customâ€¦')type=document.getElementById('cCustomType').value.trim()||'Custom';
  const card={
    id:id||uid(), name, type,
    emoji:document.getElementById('cEmoji').value||'ğŸƒ',
    cardId:document.getElementById('cCardId').value||uid(),
    set:document.getElementById('cSet').value,
    rarity:document.getElementById('cRarity').value,
    hp:+document.getElementById('cHp').value,
    atk:+document.getElementById('cAtk').value,
    def:+document.getElementById('cDef').value,
    cost:+document.getElementById('cCost').value,
    move:+document.getElementById('cMove').value||1,
    level:+document.getElementById('cLevel').value||1,
    tribute:+document.getElementById('cTribute').value||0,
    resType:document.getElementById('cResType').value,
    keywords:getSelectedKws('kwSelector'),
    attacks:getAtkList('atkList'),
    rules:document.getElementById('cRules').value,
    flavor:document.getElementById('cFlavor').value,
    image:document.getElementById('cImage').value,
    gameId:document.getElementById('cGameId').value,
  };
  const idx=D.cards.findIndex(c=>c.id===card.id);
  if(idx>=0)D.cards[idx]=card; else D.cards.push(card);
  persist(); renderCards(); closeModal('cardModal');
  toast(id?'Card updated.':'Card created!','good');
}
function delCard(){
  const id=document.getElementById('editCardId').value;
  if(!id||!confirm('Delete this card?'))return;
  D.cards=D.cards.filter(c=>c.id!==id);
  persist(); renderCards(); closeModal('cardModal');
  toast('Card deleted.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DECKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDecks(){
  const el=document.getElementById('decksPane');
  if(!D.decks.length){el.innerHTML='<div class="empty">No decks yet â€” create one to get started.</div>';return;}
  el.innerHTML=D.decks.map(dk=>`
    <div class="game-card" onclick="openEditDeck('${dk.id}')">
      <h3>ğŸ“¦ ${esc(dk.name)}</h3>
      <div class="gc-meta">
        <span>${dk.cards?dk.cards.length:0} cards</span>
        ${dk.gameId?`<span class="badge">${esc(D.games.find(g=>g.id===dk.gameId)?.name||dk.gameId)}</span>`:''}
        ${dk.desc?`<span style="color:var(--text3)">${esc(dk.desc.slice(0,60))}</span>`:''}
      </div>
    </div>
  `).join('');
}
function openAddDeck(){
  document.getElementById('deckModalTitle').textContent='NEW DECK';
  document.getElementById('editDeckId').value='';
  document.getElementById('delDeckBtn').style.display='none';
  document.getElementById('dName').value='';
  document.getElementById('dDesc').value='';
  refreshSelects();
  renderDeckCardPicker([]);
  openModal('deckModal');
}
function openEditDeck(id){
  const dk=D.decks.find(x=>x.id===id);if(!dk)return;
  document.getElementById('deckModalTitle').textContent='EDIT DECK';
  document.getElementById('editDeckId').value=id;
  document.getElementById('delDeckBtn').style.display='';
  document.getElementById('dName').value=dk.name||'';
  document.getElementById('dDesc').value=dk.desc||'';
  refreshSelects();
  setTimeout(()=>{if(dk.gameId)document.getElementById('dGameId').value=dk.gameId;},50);
  renderDeckCardPicker(dk.cards||[]);
  openModal('deckModal');
}
function renderDeckCardPicker(selected){
  const el=document.getElementById('deckCardPicker');
  if(!D.cards.length){el.innerHTML='<div class="empty">No cards yet.</div>';return;}
  el.innerHTML=D.cards.map(c=>{
    const cnt=selected.filter(id=>id===c.id).length;
    return `<div style="display:flex;align-items:center;gap:8px;padding:6px;border-bottom:1px solid var(--border);">
      <span style="font-size:18px;">${c.emoji||'ğŸƒ'}</span>
      <div style="flex:1;"><div style="font-size:12px;font-family:'Cinzel',serif;color:var(--gold2);">${esc(c.name)}</div>
      <div style="font-size:10px;color:var(--text2);">${esc(c.type||'')} Â· Cost ${c.cost||0}</div></div>
      <button class="btn small" onclick="deckRemoveCard('${c.id}')">âˆ’</button>
      <span style="min-width:20px;text-align:center;font-family:'Cinzel',serif;font-size:12px;" id="dkCount_${c.id}">${cnt}</span>
      <button class="btn small primary" onclick="deckAddCard('${c.id}')">+</button>
    </div>`;
  }).join('');
  el.dataset.selected=JSON.stringify(selected);
}
function deckAddCard(cId){
  const el=document.getElementById('deckCardPicker');
  const sel=JSON.parse(el.dataset.selected||'[]');
  sel.push(cId);
  el.dataset.selected=JSON.stringify(sel);
  const cnt=sel.filter(id=>id===cId).length;
  const el2=document.getElementById('dkCount_'+cId);
  if(el2)el2.textContent=cnt;
}
function deckRemoveCard(cId){
  const el=document.getElementById('deckCardPicker');
  const sel=JSON.parse(el.dataset.selected||'[]');
  const idx=sel.lastIndexOf(cId);
  if(idx>=0)sel.splice(idx,1);
  el.dataset.selected=JSON.stringify(sel);
  const cnt=sel.filter(id=>id===cId).length;
  const el2=document.getElementById('dkCount_'+cId);
  if(el2)el2.textContent=cnt;
}
function saveDeck(){
  const name=document.getElementById('dName').value.trim();
  if(!name)return toast('Deck needs a name.','bad');
  const id=document.getElementById('editDeckId').value;
  const cards=JSON.parse(document.getElementById('deckCardPicker').dataset.selected||'[]');
  const deck={id:id||uid(),name,desc:document.getElementById('dDesc').value,
    gameId:document.getElementById('dGameId').value,cards};
  const idx=D.decks.findIndex(d=>d.id===deck.id);
  if(idx>=0)D.decks[idx]=deck; else D.decks.push(deck);
  persist(); renderDecks(); closeModal('deckModal');
  toast(id?'Deck updated.':'Deck created!','good');
}
function delDeck(){
  const id=document.getElementById('editDeckId').value;
  if(!id||!confirm('Delete this deck?'))return;
  D.decks=D.decks.filter(d=>d.id!==id);
  persist(); renderDecks(); closeModal('deckModal');
  toast('Deck deleted.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FUSIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFusions(){
  const el=document.getElementById('fusionsPane');
  if(!D.fusions.length){el.innerHTML='<div class="empty">No fusion recipes yet.</div>';return;}
  el.innerHTML=D.fusions.map(f=>`
    <div class="fusion-card" onclick="openEditFusion('${f.id}')">
      <h3>ğŸ”€ ${esc(f.name)}</h3>
      <div style="font-size:11px;color:var(--text2);margin-top:4px;">
        ${(f.ingredients||[]).map(id=>{const c=D.cards.find(x=>x.id===id);return c?`<span class="badge">${c.emoji||'ğŸƒ'} ${esc(c.name)}</span>`:''}).join(' + ')}
        ${f.result?`<span style="color:var(--purple2)"> â†’ ${f.result.emoji||'âœ¨'} ${esc(f.result.name)}</span>`:''}
      </div>
    </div>
  `).join('');
}
function openAddFusion(){
  document.getElementById('fusionModalTitle').textContent='NEW FUSION RECIPE';
  document.getElementById('editFusionId').value='';
  document.getElementById('delFusionBtn').style.display='none';
  document.getElementById('fName').value='';
  document.getElementById('fResName').value='';
  document.getElementById('fResEmoji').value='âœ¨';
  document.getElementById('fResType').value='Fusion';
  document.getElementById('fResHp').value=20;
  document.getElementById('fResAtk').value=8;
  document.getElementById('fResDef').value=0;
  document.getElementById('fResMove').value=1;
  document.getElementById('fResRules').value='';
  buildKwSelector('fkwSelector',[]);
  setAtkList('fAtkList',[]);
  refreshSelects();
  renderFusionIngredients([]);
  openModal('fusionModal');
}
function openEditFusion(id){
  const f=D.fusions.find(x=>x.id===id);if(!f)return;
  document.getElementById('fusionModalTitle').textContent='EDIT RECIPE';
  document.getElementById('editFusionId').value=id;
  document.getElementById('delFusionBtn').style.display='';
  document.getElementById('fName').value=f.name||'';
  const r=f.result||{};
  document.getElementById('fResName').value=r.name||'';
  document.getElementById('fResEmoji').value=r.emoji||'âœ¨';
  document.getElementById('fResType').value=r.type||'Fusion';
  document.getElementById('fResHp').value=r.hp||20;
  document.getElementById('fResAtk').value=r.atk||8;
  document.getElementById('fResDef').value=r.def||0;
  document.getElementById('fResMove').value=r.move||1;
  document.getElementById('fResRules').value=r.rules||'';
  buildKwSelector('fkwSelector',r.keywords||[]);
  setAtkList('fAtkList',r.attacks||[]);
  refreshSelects();
  setTimeout(()=>{if(f.gameId)document.getElementById('fGameId').value=f.gameId;},50);
  renderFusionIngredients(f.ingredients||[]);
  openModal('fusionModal');
}
function renderFusionIngredients(selected){
  const el=document.getElementById('fusionIngredients');
  el.innerHTML=D.cards.filter(c=>!c._fusion).map(c=>{
    const on=selected.includes(c.id);
    return `<div style="display:flex;align-items:center;gap:8px;padding:5px;cursor:pointer;border-radius:4px;${on?'background:rgba(136,85,204,.15);border:1px solid var(--purple);':'border:1px solid transparent;'}"
      onclick="toggleIngredient(this,'${c.id}')">
      <span>${c.emoji||'ğŸƒ'}</span>
      <div style="flex:1;font-size:12px;">${esc(c.name)} <span style="color:var(--text2)">(${esc(c.type||'')})</span></div>
      ${on?'<span style="color:var(--purple2);font-size:14px;">âœ“</span>':''}
    </div>`;
  }).join('');
  el.dataset.selected=JSON.stringify(selected);
}
function toggleIngredient(el,id){
  const cont=document.getElementById('fusionIngredients');
  const sel=JSON.parse(cont.dataset.selected||'[]');
  const idx=sel.indexOf(id);
  if(idx>=0)sel.splice(idx,1); else if(sel.length<4)sel.push(id);
  renderFusionIngredients(sel);
}
function saveFusion(){
  const name=document.getElementById('fName').value.trim();
  if(!name)return toast('Recipe needs a name.','bad');
  const id=document.getElementById('editFusionId').value;
  const ing=JSON.parse(document.getElementById('fusionIngredients').dataset.selected||'[]');
  if(ing.length<2)return toast('Need at least 2 ingredient cards.','bad');
  const f={
    id:id||uid(), name,
    gameId:document.getElementById('fGameId').value,
    ingredients:ing,
    result:{
      name:document.getElementById('fResName').value||name+' Result',
      emoji:document.getElementById('fResEmoji').value||'âœ¨',
      type:document.getElementById('fResType').value||'Fusion',
      rarity:document.getElementById('fResRarity').value,
      hp:+document.getElementById('fResHp').value,
      atk:+document.getElementById('fResAtk').value,
      def:+document.getElementById('fResDef').value,
      move:+document.getElementById('fResMove').value||1,
      keywords:getSelectedKws('fkwSelector'),
      attacks:getAtkList('fAtkList'),
      rules:document.getElementById('fResRules').value,
      _fusion:true,
    }
  };
  const idx=D.fusions.findIndex(x=>x.id===f.id);
  if(idx>=0)D.fusions[idx]=f; else D.fusions.push(f);
  persist(); renderFusions(); closeModal('fusionModal');
  toast(id?'Recipe updated.':'Recipe created!','good');
}
function delFusion(){
  const id=document.getElementById('editFusionId').value;
  if(!id||!confirm('Delete this recipe?'))return;
  D.fusions=D.fusions.filter(f=>f.id!==id);
  persist(); renderFusions(); closeModal('fusionModal');
  toast('Recipe deleted.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAMES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGames(){
  const el=document.getElementById('gamesPane');
  if(!D.games.length){el.innerHTML='<div class="empty">No game configs â€” create one to set up play rules.</div>';return;}
  el.innerHTML=D.games.map(g=>`
    <div class="game-card" onclick="openEditGame('${g.id}')">
      <h3>âš™ ${esc(g.name)}</h3>
      <div class="gc-meta">
        <span class="badge">${esc(g.mode||'standard')}</span>
        <span>HP: ${g.startHp}</span>
        <span>Hand: ${g.maxHand}</span>
        <span>Field: ${g.maxField}</span>
        <span>Players: ${g.players||2}</span>
        ${g.notes?`<span style="color:var(--text3)">${esc(g.notes.slice(0,50))}</span>`:''}
      </div>
    </div>
  `).join('');
}
const DEFAULT_WIN=[{id:'hp0',on:true},{id:'crystal',on:false},{id:'deckout',on:false},{id:'objective',on:false},{id:'lanes2',on:false},{id:'combo',on:false}];
const DEFAULT_RULES={tributeEnabled:true,fusionEnabled:true,resourceSystem:true,assistantZone:false,
  collectorZone:false,fieldCardsActive:true,eventCards:true,spellSlots:false,
  firstStrike:true,stackResources:false,coopSimultaneous:false};
function buildWinCondUI(vals){
  const el=document.getElementById('winCondGrid');
  el.innerHTML=WIN_CONDS.map(w=>{
    const on=vals?vals.find(x=>x.id===w.id)?.on:w.id==='hp0';
    return `<div class="rule-item"><input type="checkbox" id="wc_${w.id}"${on?' checked':''}><label for="wc_${w.id}">${w.label}</label></div>`;
  }).join('');
}
function buildRuleUI(vals){
  const el=document.getElementById('ruleToggleGrid');
  el.innerHTML=RULE_TOGGLES.filter(r=>r.label).map(r=>{
    const on=vals?vals[r.id]:DEFAULT_RULES[r.id];
    return `<div class="rule-item"><input type="checkbox" id="rt_${r.id}"${on?' checked':''}><label for="rt_${r.id}">${r.label}</label></div>`;
  }).join('');
}
function buildPhaseUI(phases){
  const el=document.getElementById('phaseEditor');
  el.innerHTML=PHASES.map(p=>{
    const on=phases?phases.includes(p):['Draw','Main','Combat','End'].includes(p);
    return `<span class="kw-toggle${on?' on':''}" onclick="this.classList.toggle('on')" data-phase="${p}">${p}</span>`;
  }).join('');
}
function getWinConds(){return WIN_CONDS.map(w=>({id:w.id,on:document.getElementById('wc_'+w.id)?.checked||false}));}
function getRuleToggles(){
  const r={};
  RULE_TOGGLES.filter(x=>x.label).forEach(x=>{r[x.id]=document.getElementById('rt_'+x.id)?.checked||false;});
  return r;
}
function getPhases(){return [...document.getElementById('phaseEditor').querySelectorAll('.kw-toggle.on')].map(e=>e.dataset.phase);}
function openAddGame(){
  document.getElementById('gameModalTitle').textContent='NEW GAME CONFIG';
  document.getElementById('editGameId').value='';
  document.getElementById('delGameBtn').style.display='none';
  document.getElementById('gName').value='';
  document.getElementById('gMode').value='standard';
  document.getElementById('gHp').value=30;
  document.getElementById('gHand').value=5;
  document.getElementById('gField').value=5;
  document.getElementById('gRes').value=3;
  document.getElementById('gMaxRes').value=10;
  document.getElementById('gPlayers').value=2;
  document.getElementById('gCrystalHp').value=20;
  document.getElementById('gGridSize').value=6;
  document.getElementById('gAi').value='aggressive';
  document.getElementById('gAiDiff').value='medium';
  document.getElementById('gNotes').value='';
  buildWinCondUI(null); buildRuleUI(null); buildPhaseUI(null);
  openModal('gameModal');
}
function openEditGame(id){
  const g=D.games.find(x=>x.id===id);if(!g)return;
  document.getElementById('gameModalTitle').textContent='EDIT CONFIG';
  document.getElementById('editGameId').value=id;
  document.getElementById('delGameBtn').style.display='';
  document.getElementById('gName').value=g.name||'';
  document.getElementById('gMode').value=g.mode||'standard';
  document.getElementById('gHp').value=g.startHp||30;
  document.getElementById('gHand').value=g.maxHand||5;
  document.getElementById('gField').value=g.maxField||5;
  document.getElementById('gRes').value=g.resPerTurn||3;
  document.getElementById('gMaxRes').value=g.maxRes||10;
  document.getElementById('gPlayers').value=g.players||2;
  document.getElementById('gCrystalHp').value=g.crystalHp||20;
  document.getElementById('gGridSize').value=g.gridSize||6;
  document.getElementById('gAi').value=g.aiStyle||'aggressive';
  document.getElementById('gAiDiff').value=g.aiDiff||'medium';
  document.getElementById('gNotes').value=g.notes||'';
  buildWinCondUI(g.winConds||null);
  buildRuleUI(g.rules||null);
  buildPhaseUI(g.phases||null);
  openModal('gameModal');
}
function saveGame(){
  const name=document.getElementById('gName').value.trim();
  if(!name)return toast('Config needs a name.','bad');
  const id=document.getElementById('editGameId').value;
  const g={
    id:id||uid(), name,
    mode:document.getElementById('gMode').value,
    startHp:+document.getElementById('gHp').value,
    maxHand:+document.getElementById('gHand').value,
    maxField:+document.getElementById('gField').value,
    resPerTurn:+document.getElementById('gRes').value,
    maxRes:+document.getElementById('gMaxRes').value,
    players:+document.getElementById('gPlayers').value||2,
    crystalHp:+document.getElementById('gCrystalHp').value||20,
    gridSize:+document.getElementById('gGridSize').value||6,
    aiStyle:document.getElementById('gAi').value,
    aiDiff:document.getElementById('gAiDiff').value,
    notes:document.getElementById('gNotes').value,
    winConds:getWinConds(),
    rules:getRuleToggles(),
    phases:getPhases(),
  };
  const idx=D.games.findIndex(x=>x.id===g.id);
  if(idx>=0)D.games[idx]=g; else D.games.push(g);
  persist(); renderGames(); closeModal('gameModal');
  refreshSelects(); renderCards();
  toast(id?'Config updated.':'Config created!','good');
}
function delGame(){
  const id=document.getElementById('editGameId').value;
  if(!id||!confirm('Delete this game config?'))return;
  D.games=D.games.filter(g=>g.id!==id);
  persist(); renderGames(); refreshSelects();
  closeModal('gameModal'); toast('Config deleted.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getFilteredCards(){
  const gf=document.getElementById('exportGameFilter').value;
  const tf=document.getElementById('exportTypeFilter').value;
  let cards=D.cards;
  if(gf)cards=cards.filter(c=>c.gameId===gf);
  if(tf)cards=cards.filter(c=>c.type===tf);
  return cards;
}
function refreshExportPreview(){
  refreshSelects();
  const cards=getFilteredCards();
  const header='Card ID,Set,Name,Type,Rarity,HP,ATK,DEF,Cost,Move,Level,Tribute,Keywords,Rules Text,Flavor Text\n';
  const rows=cards.map(c=>[
    csvCell(c.cardId||c.id), csvCell(c.set), csvCell(c.name),
    csvCell(c.type), csvCell(c.rarity),
    c.hp||0, c.atk||0, c.def||0, c.cost||0, c.move||1, c.level||1, c.tribute||0,
    csvCell((c.keywords||[]).join('|')),
    csvCell(c.rules), csvCell(c.flavor)
  ].join(',')).join('\n');
  document.getElementById('exportPreview').textContent=header+rows;
}
function csvCell(v){const s=String(v||'');return s.includes(',')||s.includes('"')||s.includes('\n')?'"'+s.replace(/"/g,'""')+'"':s;}
function exportCSV(){
  refreshExportPreview();
  const content=document.getElementById('exportPreview').textContent;
  const cards=getFilteredCards();
  download('cards_export.csv','text/csv',content);
  toast(`Exported ${cards.length} cards.`,'good');
}
function exportJSON(){
  download('cardforge_backup.json','application/json',JSON.stringify(D,null,2));
  toast('JSON backup downloaded.','good');
}
function importJSON(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      if(!data.cards)throw new Error('Invalid format');
      if(!confirm(`Import ${data.cards.length} cards, ${data.decks?.length||0} decks, ${data.games?.length||0} game configs? This will MERGE with existing data.`))return;
      // merge by id
      data.cards?.forEach(c=>{if(!D.cards.find(x=>x.id===c.id))D.cards.push(c);});
      data.decks?.forEach(d=>{if(!D.decks.find(x=>x.id===d.id))D.decks.push(d);});
      data.fusions?.forEach(f=>{if(!D.fusions.find(x=>x.id===f.id))D.fusions.push(f);});
      data.games?.forEach(g=>{if(!D.games.find(x=>x.id===g.id))D.games.push(g);});
      D.nextId=Math.max(D.nextId||1,data.nextId||1)+1;
      persist(); renderCards(); renderDecks(); renderFusions(); renderGames(); refreshSelects();
      toast('Import successful!','good');
    }catch(err){toast('Invalid JSON file.','bad');}
  };
  r.readAsText(f);
  e.target.value='';
}
function download(filename,mime,content){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([content],{type:mime}));
  a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GUIDE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const KW_GUIDE=[
  {kw:'Flying',desc:'Can only be blocked by other Flying cards.'},
  {kw:'Taunt',desc:'Opponents must target this card first when attacking.'},
  {kw:'Lifesteal',desc:'Damage dealt heals your HP by the same amount.'},
  {kw:'Poison',desc:'Adds a poison counter on hit; counters drain HP each turn.'},
  {kw:'Regen',desc:'Restores 1 HP at the start of each turn (up to base max).'},
  {kw:'Haste',desc:'Can attack the same turn it is played.'},
  {kw:'Charge',desc:'Same as Haste â€” can act immediately when played.'},
  {kw:'Shield',desc:'Absorbs the first instance of damage completely.'},
  {kw:'Trample',desc:'Excess damage beyond target HP carries through to player.'},
  {kw:'Piercing',desc:'Damage ignores DEF entirely.'},
  {kw:'Burn',desc:'Deals 1 damage to attackers at the start of opponent\'s turn.'},
  {kw:'Freeze',desc:'Target cannot attack for 1 full turn.'},
  {kw:'Silence',desc:'Disables all keywords and abilities until end of turn.'},
  {kw:'Stealth',desc:'Cannot be targeted by abilities until it attacks first.'},
  {kw:'Deathtouch',desc:'Any damage dealt is lethal â€” kills regardless of HP.'},
  {kw:'Defender',desc:'Cannot attack; DEF is doubled when blocking.'},
  {kw:'Indestructible',desc:'Cannot be destroyed by damage (can still be exiled).'},
  {kw:'Vigilance',desc:'Does not tap/exhaust when attacking.'},
  {kw:'Prowess',desc:'Gains +1 ATK each time you play a non-creature card.'},
  {kw:'Cascade',desc:'When played, draw and immediately play the top card free.'},
  {kw:'Reborn',desc:'Returns from the graveyard once with 1 HP.'},
  {kw:'Collector',desc:'Can move onto item tiles and collect items from the field.'},
  {kw:'Mobile',desc:'Extra movement points on the traversible field.'},
];
function renderGuide(){
  const el=document.getElementById('guidePane');
  el.innerHTML=`<div style="padding:16px;"><div class="sec-label">KEYWORD REFERENCE</div>`
    +KW_GUIDE.map(k=>`<div class="guide-kw">
      <span class="kw kw-${k.kw}" style="min-width:90px;text-align:center;">${k.kw}</span>
      <span class="gk-desc">${k.desc}</span>
    </div>`).join('')
    +'</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAUNCH PLAYTEST / LAYOUT BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPlaytest(){
  window.open('playtest.html','_blank');
}
function openLayoutBuilder(){
  window.open('layout-builder.html','_blank');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
hydrate();
renderCards();
renderDecks();
renderFusions();
renderGames();
refreshSelects();

// Service Worker registration
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./forge_sw.js')
    .then(r=>{
      console.log('Forge SW registered');
      r.addEventListener('updatefound',()=>{
        const nw=r.installing;
        nw.addEventListener('statechange',()=>{
          if(nw.state==='installed'&&navigator.serviceWorker.controller){
            if(confirm('Card Forge has been updated. Reload now?'))window.location.reload();
          }
        });
      });
    })
    .catch(e=>console.warn('Forge SW error:',e));
}
</script>
</body>
</html>
