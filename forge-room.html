<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d0d0f">
<title>Forge Room</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
:root{
  --gold:#c9a84c;--gold2:#e8c96a;--gold3:#f5e0a0;
  --bg:#0d0f14;--bg2:#141720;--bg3:#1c2030;
  --border:#2a2f45;--text:#d4cfc0;--text2:#8a8878;
  --red:#cc4444;--green:#44aa66;
}
html,body{width:100%;height:100%;overflow:hidden;background:#000;touch-action:none;}

/* â”€â”€ CANVAS â”€â”€ */
#c{display:block;width:100%;height:100%;}

/* â”€â”€ HUD OVERLAY â”€â”€ */
#hud{position:fixed;inset:0;pointer-events:none;z-index:10;}

/* Crosshair */
#crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:20px;height:20px;pointer-events:none;opacity:0.7;}
#crosshair::before,#crosshair::after{content:'';position:absolute;background:rgba(201,168,76,0.8);}
#crosshair::before{width:2px;height:12px;top:4px;left:9px;}
#crosshair::after{width:12px;height:2px;top:9px;left:4px;}

/* Interaction hint */
#hint{position:absolute;bottom:38%;left:50%;transform:translateX(-50%);
  font-family:'Cinzel',serif;font-size:11px;letter-spacing:.12em;color:var(--gold2);
  background:rgba(13,15,20,0.85);border:1px solid var(--border);
  padding:6px 14px;border-radius:4px;opacity:0;transition:opacity .3s;pointer-events:none;
  white-space:nowrap;}
#hint.show{opacity:1;}

/* Top bar */
#topbar{position:absolute;top:0;left:0;right:0;height:44px;
  background:linear-gradient(to bottom,rgba(13,15,20,0.9),transparent);
  display:flex;align-items:center;padding:0 16px;gap:12px;pointer-events:auto;}
#topbar h1{font-family:'Cinzel',serif;font-size:13px;color:var(--gold2);letter-spacing:.15em;}
#topbar .sub{font-size:10px;color:var(--text2);letter-spacing:.08em;}
.hbtn{background:rgba(20,23,32,0.85);border:1px solid var(--border);color:var(--text);
  padding:5px 12px;border-radius:4px;font-family:'Cinzel',serif;font-size:9px;
  letter-spacing:.08em;cursor:pointer;pointer-events:auto;}
.hbtn:active,.hbtn:hover{border-color:var(--gold);color:var(--gold2);}
#topbar .spacer{flex:1;}

/* Compass / room label */
#roomlabel{position:absolute;top:52px;left:50%;transform:translateX(-50%);
  font-family:'Cinzel',serif;font-size:9px;letter-spacing:.18em;color:var(--text2);
  pointer-events:none;opacity:0;transition:opacity .5s;}
#roomlabel.show{opacity:1;}

/* â”€â”€ VIRTUAL JOYSTICK â”€â”€ */
#vjLeft,#vjRight{position:fixed;bottom:28px;width:120px;height:120px;
  border-radius:50%;background:rgba(201,168,76,0.06);
  border:1.5px solid rgba(201,168,76,0.2);pointer-events:auto;z-index:20;
  display:flex;align-items:center;justify-content:center;}
#vjLeft{left:28px;}
#vjRight{right:28px;}
.vj-knob{width:44px;height:44px;border-radius:50%;
  background:rgba(201,168,76,0.25);border:1.5px solid rgba(201,168,76,0.5);
  pointer-events:none;transition:transform .05s;}
#vjLabel{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);
  font-family:'Cinzel',serif;font-size:8px;letter-spacing:.1em;color:rgba(201,168,76,0.35);
  pointer-events:none;z-index:20;}

/* â”€â”€ BOTTOM ACTION BUTTONS â”€â”€ */
#actionBar{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);
  display:flex;gap:12px;z-index:20;pointer-events:auto;}
.abtn{width:48px;height:48px;border-radius:50%;
  background:rgba(13,15,20,0.85);border:1.5px solid var(--border);
  color:var(--text2);font-size:18px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-family:'Cinzel',serif;transition:all .2s;}
.abtn:active,.abtn.active{border-color:var(--gold);color:var(--gold2);
  background:rgba(201,168,76,0.12);}
.abtn-label{font-size:7px;letter-spacing:.05em;display:block;margin-top:2px;color:inherit;}

/* â”€â”€ MODAL OVERLAY â”€â”€ */
#modal{position:fixed;inset:0;z-index:100;display:none;
  background:rgba(0,0,0,0.85);backdrop-filter:blur(4px);
  align-items:center;justify-content:center;padding:16px;}
#modal.open{display:flex;}
#modalInner{background:var(--bg2);border:1px solid var(--border);border-radius:6px;
  width:100%;max-width:480px;max-height:90vh;overflow-y:auto;position:relative;
  animation:slideUp .25s ease;}
@keyframes slideUp{from{transform:translateY(20px);opacity:0;}to{transform:translateY(0);opacity:1;}}
#modalClose{position:sticky;top:0;float:right;margin:10px 10px 0 0;
  background:var(--bg3);border:1px solid var(--border);color:var(--text2);
  width:32px;height:32px;border-radius:4px;cursor:pointer;font-size:16px;
  display:flex;align-items:center;justify-content:center;z-index:1;}
#modalClose:hover{color:var(--gold);}
#modalBody{padding:16px;clear:both;}

/* â”€â”€ CARD DETAIL â”€â”€ */
.card-detail-frame{border:2px solid var(--gold);border-radius:8px;overflow:hidden;
  background:var(--bg3);margin-bottom:14px;}
.card-detail-header{background:linear-gradient(135deg,var(--bg2),var(--bg3));
  padding:14px 16px;display:flex;justify-content:space-between;align-items:flex-start;}
.card-detail-name{font-family:'Cinzel',serif;font-size:18px;color:var(--gold2);}
.card-detail-cost{font-family:'Cinzel',serif;font-size:22px;color:var(--gold);
  background:rgba(201,168,76,0.15);border:1.5px solid var(--gold);
  width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;}
.card-detail-type{font-size:11px;color:var(--text2);letter-spacing:.1em;margin-top:3px;}
.card-detail-body{padding:12px 16px;}
.card-stat-row{display:flex;gap:12px;margin-bottom:10px;}
.card-stat{background:var(--bg2);border:1px solid var(--border);border-radius:4px;
  padding:6px 12px;flex:1;text-align:center;}
.card-stat .sv{font-family:'Cinzel',serif;font-size:18px;color:var(--text);}
.card-stat .sl{font-size:9px;color:var(--text2);letter-spacing:.1em;}
.card-kw-list{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px;}
.card-kw{background:rgba(201,168,76,0.1);border:1px solid rgba(201,168,76,0.3);
  border-radius:3px;padding:2px 8px;font-size:10px;color:var(--gold2);letter-spacing:.05em;}
.card-desc{font-size:13px;color:var(--text2);line-height:1.6;font-style:italic;}

/* â”€â”€ SETTINGS PANEL â”€â”€ */
.settings-row{display:flex;align-items:center;justify-content:space-between;
  padding:10px 0;border-bottom:1px solid var(--border);}
.settings-row:last-child{border-bottom:none;}
.settings-label{font-family:'Cinzel',serif;font-size:10px;letter-spacing:.1em;color:var(--text);}
.settings-sub{font-size:10px;color:var(--text2);}
.settings-row input[type=range]{width:120px;accent-color:var(--gold);}
.settings-row select{background:var(--bg3);border:1px solid var(--border2);
  color:var(--text);padding:4px 8px;border-radius:4px;font-size:11px;}
.toggle-sw{width:40px;height:22px;border-radius:11px;background:var(--bg3);
  border:1px solid var(--border);position:relative;cursor:pointer;transition:background .2s;}
.toggle-sw.on{background:rgba(201,168,76,0.3);border-color:var(--gold);}
.toggle-sw::after{content:'';width:16px;height:16px;border-radius:50%;
  background:var(--text2);position:absolute;top:2px;left:2px;transition:all .2s;}
.toggle-sw.on::after{left:20px;background:var(--gold);}

/* â”€â”€ LOADING SCREEN â”€â”€ */
#loading{position:fixed;inset:0;background:var(--bg);z-index:1000;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
#loading h1{font-family:'Cinzel',serif;font-size:24px;color:var(--gold);letter-spacing:.2em;}
#loading p{font-size:12px;color:var(--text2);letter-spacing:.1em;}
.load-bar-outer{width:200px;height:3px;background:var(--border);border-radius:2px;overflow:hidden;}
.load-bar-inner{height:100%;background:var(--gold);width:0%;transition:width .3s;border-radius:2px;}

/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;bottom:180px;left:50%;transform:translateX(-50%);
  background:rgba(13,15,20,0.95);border:1px solid var(--border);
  color:var(--text);font-family:'Cinzel',serif;font-size:10px;letter-spacing:.1em;
  padding:8px 16px;border-radius:4px;z-index:200;opacity:0;
  transition:opacity .3s;pointer-events:none;white-space:nowrap;}
#toast.show{opacity:1;}
#toast.good{border-color:var(--green);color:var(--green);}
#toast.bad{border-color:var(--red);color:var(--red);}

/* â”€â”€ MINIMAP (future) â”€â”€ */
#minimap{position:fixed;top:52px;right:12px;width:70px;height:70px;
  border:1px solid var(--border);border-radius:4px;
  background:rgba(13,15,20,0.7);display:none;pointer-events:none;}

/* Scrollable card wall UI */
#wallNav{position:fixed;bottom:160px;left:50%;transform:translateX(-50%);
  display:flex;gap:8px;z-index:20;pointer-events:auto;opacity:0;
  transition:opacity .3s;}
#wallNav.show{opacity:1;}
.wallnav-btn{background:rgba(13,15,20,0.85);border:1px solid var(--border);
  color:var(--text2);padding:6px 14px;border-radius:4px;
  font-family:'Cinzel',serif;font-size:9px;letter-spacing:.08em;cursor:pointer;}
.wallnav-btn:hover{border-color:var(--gold);color:var(--gold);}
</style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div style="font-size:32px;margin-bottom:4px;">âœ¦</div>
  <h1>FORGE ROOM</h1>
  <p>PREPARING THE WORKSHOP...</p>
  <div class="load-bar-outer"><div class="load-bar-inner" id="loadBar"></div></div>
  <p id="loadMsg" style="font-size:10px;margin-top:4px;color:var(--text2);">Loading engine...</p>
</div>

<!-- 3D Canvas -->
<canvas id="c"></canvas>

<!-- HUD -->
<div id="hud">
  <div id="crosshair"></div>
  <div id="hint"></div>
  <div id="roomlabel"></div>

  <div id="topbar">
    <span style="font-size:20px;color:var(--gold);">âœ¦</span>
    <h1>FORGE ROOM</h1>
    <span class="sub" id="topSub">WORKSHOP</span>
    <div class="spacer"></div>
    <button class="hbtn" onclick="openSettings()">âš™</button>
    <button class="hbtn" onclick="window.location.href='forge.html'">FORGE</button>
    <button class="hbtn" onclick="window.location.href='lifeapp.html'">CHRONICLE</button>
  </div>
</div>

<!-- Virtual Joysticks -->
<div id="vjLeft"><div class="vj-knob" id="vjLKnob"></div></div>
<div id="vjRight"><div class="vj-knob" id="vjRKnob"></div></div>
<div id="vjLabel">MOVE &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LOOK</div>

<!-- Action Buttons -->
<div id="actionBar">
  <button class="abtn" id="btnDraw" onclick="toggleDrawMode()" title="Whiteboard">
    âœ<span class="abtn-label">DRAW</span>
  </button>
  <button class="abtn" id="btnInteract" onclick="triggerInteract()" title="Interact">
    â¬¡<span class="abtn-label">USE</span>
  </button>
  <button class="abtn" id="btnGallery" onclick="jumpToWall('north')" title="Card Gallery">
    ğŸƒ<span class="abtn-label">CARDS</span>
  </button>
</div>

<!-- Wall navigation -->
<div id="wallNav">
  <button class="wallnav-btn" onclick="galleryScroll(-1)">â—€ PREV</button>
  <span id="wallNavLabel" style="font-family:'Cinzel',serif;font-size:9px;color:var(--text2);display:flex;align-items:center;letter-spacing:.08em;">CARD GALLERY</span>
  <button class="wallnav-btn" onclick="galleryScroll(1)">NEXT â–¶</button>
</div>

<!-- Modal -->
<div id="modal">
  <div id="modalInner">
    <button id="modalClose" onclick="closeModal()">âœ•</button>
    <div id="modalBody"></div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Three.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS & CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORE_FORGE = 'cardforge_v3';
const STORE_ROOM_SETTINGS = 'forge_room_settings';
const STORE_CAMERA = 'forge_room_camera_pos';
const STORE_WB = key => `forge_room_whiteboard_${key}`;

const ROOM_W = 20, ROOM_H = 6, ROOM_D = 24;
const WALL_N = -ROOM_D/2 + 0.3;
const WALL_S =  ROOM_D/2 - 0.3;
const WALL_E =  ROOM_W/2 - 0.3;
const WALL_W = -ROOM_W/2 + 0.3;

let settings = {
  fov: 75,
  sensitivity: 2.5,
  speed: 4.0,
  invertY: false,
  deadzone: 0.15,
  sprintMult: 2.5,
  showJoystick: true,
  perfMode: false,
  ambientSound: false,
  cardSort: 'name',
  lighting: 'torch'
};

function loadSettings(){
  try{const s=localStorage.getItem(STORE_ROOM_SETTINGS);if(s)settings=Object.assign(settings,JSON.parse(s));}catch(e){}
}
function saveSettings(){
  localStorage.setItem(STORE_ROOM_SETTINGS, JSON.stringify(settings));
}
loadSettings();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FORGE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let forgeData = {cards:[],decks:[],fusions:[],games:[],nextId:1};
function loadForgeData(){
  try{const s=localStorage.getItem(STORE_FORGE);if(s)forgeData=JSON.parse(s);}catch(e){}
}
loadForgeData();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THREE.JS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({canvas, antialias:!settings.perfMode, alpha:false});
renderer.setPixelRatio(Math.min(window.devicePixelRatio, settings.perfMode?1:2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = !settings.perfMode;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.outputEncoding = THREE.sRGBEncoding;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 0.8;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x060810);
scene.fog = new THREE.Fog(0x060810, 12, 28);

const camera = new THREE.PerspectiveCamera(settings.fov, window.innerWidth/window.innerHeight, 0.1, 50);
camera.position.set(0, 1.7, ROOM_D/2 - 2);

const clock = new THREE.Clock();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TEXTURES & MATERIALS (procedural)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const texLoader = new THREE.TextureLoader();

function makeStoneTexture(w=256,h=256,dark=true){
  const c2 = document.createElement('canvas');c2.width=w;c2.height=h;
  const ctx = c2.getContext('2d');
  const base = dark ? '#0e1018' : '#181c28';
  ctx.fillStyle = base; ctx.fillRect(0,0,w,h);
  // stone blocks
  const bw=64,bh=32;
  for(let row=0;row<h/bh+1;row++){
    for(let col=0;col<w/bw+1;col++){
      const offset = (row%2)*bw/2;
      const bx = col*bw - offset, by = row*bh;
      const shade = Math.random()*20-10;
      const r=14+shade,g=16+shade,b=24+shade;
      ctx.fillStyle=`rgb(${r},${g},${b})`;
      ctx.fillRect(bx+1,by+1,bw-2,bh-2);
      ctx.strokeStyle='rgba(0,0,0,0.5)';
      ctx.lineWidth=1.5;
      ctx.strokeRect(bx+1,by+1,bw-2,bh-2);
    }
  }
  // noise overlay
  const id = ctx.getImageData(0,0,w,h);
  for(let i=0;i<id.data.length;i+=4){
    const n=(Math.random()-0.5)*15;
    id.data[i]+=n;id.data[i+1]+=n;id.data[i+2]+=n;
  }
  ctx.putImageData(id,0,0);
  const t = new THREE.CanvasTexture(c2);
  t.wrapS=t.wrapT=THREE.RepeatWrapping;
  return t;
}

function makeFloorTexture(){
  const c2=document.createElement('canvas');c2.width=256;c2.height=256;
  const ctx=c2.getContext('2d');
  ctx.fillStyle='#0c0e15';ctx.fillRect(0,0,256,256);
  const pw=32;
  for(let row=0;row<256/pw;row++){
    for(let col=0;col<256/pw;col++){
      const alt=(row+col)%2===0;
      const shade=Math.random()*12;
      ctx.fillStyle=alt?`rgb(${16+shade},${18+shade},${28+shade})`:`rgb(${12+shade},${14+shade},${22+shade})`;
      ctx.fillRect(col*pw+1,row*pw+1,pw-2,pw-2);
    }
  }
  const t=new THREE.CanvasTexture(c2);
  t.wrapS=t.wrapT=THREE.RepeatWrapping;
  t.repeat.set(4,6);
  return t;
}

function makeWoodTexture(){
  const c2=document.createElement('canvas');c2.width=256;c2.height=256;
  const ctx=c2.getContext('2d');
  for(let y=0;y<256;y++){
    const shade=Math.sin(y*0.4+Math.random()*0.3)*15;
    ctx.fillStyle=`rgb(${28+shade},${18+shade},${10+shade})`;
    ctx.fillRect(0,y,256,1);
  }
  const t=new THREE.CanvasTexture(c2);
  t.wrapS=t.wrapT=THREE.RepeatWrapping;
  return t;
}

const stoneTex = makeStoneTexture();
stoneTex.repeat.set(4,2);
const floorTex = makeFloorTexture();
const woodTex = makeWoodTexture();

const matWall = new THREE.MeshLambertMaterial({map:stoneTex});
const matFloor = new THREE.MeshLambertMaterial({map:floorTex});
const matCeiling = new THREE.MeshLambertMaterial({color:0x080a12});
const matWood = new THREE.MeshLambertMaterial({map:woodTex,color:0x8b6840});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROOM GEOMETRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildRoom(){
  // Floor
  const floor = new THREE.Mesh(new THREE.PlaneGeometry(ROOM_W,ROOM_D), matFloor);
  floor.rotation.x=-Math.PI/2; floor.receiveShadow=true; scene.add(floor);

  // Ceiling
  const ceil = new THREE.Mesh(new THREE.PlaneGeometry(ROOM_W,ROOM_D), matCeiling);
  ceil.rotation.x=Math.PI/2; ceil.position.y=ROOM_H; scene.add(ceil);

  // North wall (card gallery)
  const wallN = new THREE.Mesh(new THREE.PlaneGeometry(ROOM_W,ROOM_H), matWall);
  wallN.position.set(0,ROOM_H/2,-ROOM_D/2); scene.add(wallN);

  // South wall (chronicle)
  const wallS = new THREE.Mesh(new THREE.PlaneGeometry(ROOM_W,ROOM_H), matWall);
  wallS.rotation.y=Math.PI; wallS.position.set(0,ROOM_H/2,ROOM_D/2); scene.add(wallS);

  // East wall (whiteboard 1)
  const stE = makeStoneTexture(256,256,false);stE.repeat.set(3,2);
  const matWE = new THREE.MeshLambertMaterial({map:stE});
  const wallE = new THREE.Mesh(new THREE.PlaneGeometry(ROOM_D,ROOM_H), matWE);
  wallE.rotation.y=-Math.PI/2; wallE.position.set(ROOM_W/2,ROOM_H/2,0); scene.add(wallE);

  // West wall (whiteboard 2)
  const wallW = new THREE.Mesh(new THREE.PlaneGeometry(ROOM_D,ROOM_H), matWE.clone());
  wallW.rotation.y=Math.PI/2; wallW.position.set(-ROOM_W/2,ROOM_H/2,0); scene.add(wallW);

  // Wooden beams on ceiling
  for(let i=-8;i<=8;i+=4){
    const beam = new THREE.Mesh(new THREE.BoxGeometry(ROOM_W,0.2,0.3), matWood);
    beam.position.set(0,ROOM_H-0.1,i); scene.add(beam);
  }
  // Side pillars
  [-ROOM_W/2+0.15, ROOM_W/2-0.15].forEach(x=>{
    [-8,-4,0,4,8].forEach(z=>{
      const pillar=new THREE.Mesh(new THREE.BoxGeometry(0.3,ROOM_H,0.3),matWood);
      pillar.position.set(x,ROOM_H/2,z); scene.add(pillar);
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LIGHTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const torchLights = [];
function buildLighting(){
  // Ambient
  const ambient = new THREE.AmbientLight(0x1a1e2e, 0.4);
  scene.add(ambient);

  // Torch points along the room
  const torchPositions = [
    [-ROOM_W/2+0.5, 3, -6], [ROOM_W/2-0.5, 3, -6],
    [-ROOM_W/2+0.5, 3,  0], [ROOM_W/2-0.5, 3,  0],
    [-ROOM_W/2+0.5, 3,  6], [ROOM_W/2-0.5, 3,  6],
  ];
  torchPositions.forEach(([x,y,z])=>{
    const light = new THREE.PointLight(0xd4841a, 1.2, 10);
    light.position.set(x,y,z);
    light.castShadow = !settings.perfMode;
    scene.add(light);
    torchLights.push({light, baseInt:1.2, phase:Math.random()*Math.PI*2});

    // Torch mesh
    const torch = new THREE.Mesh(
      new THREE.CylinderGeometry(0.04,0.06,0.3,6),
      new THREE.MeshLambertMaterial({color:0x5a3a1a})
    );
    torch.position.set(x>0?x-0.15:x+0.15, y-0.2, z);
    scene.add(torch);
    const flame = new THREE.Mesh(
      new THREE.SphereGeometry(0.08,6,6),
      new THREE.MeshBasicMaterial({color:0xff8800, transparent:true, opacity:0.9})
    );
    flame.position.set(torch.position.x, y+0.05, z);
    scene.add(flame);
  });

  // Key light from above center
  const key = new THREE.DirectionalLight(0x8090cc, 0.3);
  key.position.set(0, ROOM_H, 0); key.target.position.set(0,0,0);
  scene.add(key); scene.add(key.target);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CARD GALLERY â€” NORTH WALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const cardMeshes = [];
let galleryPage = 0;
const CARDS_PER_PAGE = 5;
const CARD_W = 2.8, CARD_H = 3.8;

const TYPE_COLORS = {
  creature:'#4488cc', spell:'#aa44cc', trap:'#cc4444',
  artifact:'#cc8844', enchantment:'#44aa66', hero:'#c9a84c', default:'#556688'
};

function cardTypeColor(type=''){
  const t=type.toLowerCase();
  for(const [k,v] of Object.entries(TYPE_COLORS)){if(t.includes(k))return v;}
  return TYPE_COLORS.default;
}

function makeCardTexture(card){
  const w=160,h=224;
  const c2=document.createElement('canvas');c2.width=w;c2.height=h;
  const ctx=c2.getContext('2d');
  // Background gradient
  const grad=ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,'#1c2030');grad.addColorStop(1,'#0e1018');
  ctx.fillStyle=grad;ctx.fillRect(0,0,w,h);
  // Type color bar
  ctx.fillStyle=cardTypeColor(card.type||'');
  ctx.fillRect(0,0,w,8);
  // Gold border
  ctx.strokeStyle='#c9a84c';ctx.lineWidth=3;ctx.strokeRect(2,2,w-4,h-4);
  ctx.strokeStyle='rgba(201,168,76,0.3)';ctx.lineWidth=1;ctx.strokeRect(6,6,w-12,h-12);
  // Cost circle
  ctx.fillStyle='rgba(201,168,76,0.15)';
  ctx.beginPath();ctx.arc(w-22,22,14,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='#c9a84c';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.arc(w-22,22,14,0,Math.PI*2);ctx.stroke();
  ctx.fillStyle='#e8c96a';ctx.font='bold 14px Cinzel,serif';
  ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(String(card.cost||0),w-22,22);
  // Card name
  ctx.fillStyle='#d4cfc0';ctx.font='bold 11px Cinzel,serif';
  ctx.textAlign='left';ctx.textBaseline='top';
  const name=card.name||'Unknown';
  ctx.fillText(name.length>14?name.slice(0,13)+'â€¦':name, 10, 12);
  // Art area (color fill based on type)
  const artCol=cardTypeColor(card.type||'');
  ctx.fillStyle=artCol+'33';ctx.fillRect(10,36,w-20,80);
  ctx.strokeStyle=artCol+'88';ctx.lineWidth=1;ctx.strokeRect(10,36,w-20,80);
  // Type icon in art area
  const icons={creature:'ğŸ‰',spell:'âœ¨',trap:'âš ',artifact:'âš™',enchantment:'ğŸŒ€',hero:'âš”'};
  const t=(card.type||'').toLowerCase();
  let icon='ğŸƒ';
  for(const [k,v] of Object.entries(icons)){if(t.includes(k)){icon=v;break;}}
  ctx.font='32px serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(icon,w/2,76);
  // Type text
  ctx.fillStyle='#8a8878';ctx.font='9px Cinzel,serif';ctx.textAlign='center';
  ctx.fillText((card.type||'CARD').toUpperCase(),w/2,124);
  // Stats
  if(card.atk!==undefined||card.def!==undefined){
    ctx.fillStyle='rgba(201,168,76,0.1)';ctx.fillRect(10,132,w-20,28);
    ctx.strokeStyle='rgba(201,168,76,0.3)';ctx.lineWidth=1;ctx.strokeRect(10,132,w-20,28);
    ctx.fillStyle='#cc5555';ctx.font='bold 13px Cinzel,serif';
    ctx.textAlign='left';ctx.fillText('âš”'+String(card.atk||0),16,140);
    ctx.fillStyle='#4488cc';ctx.textAlign='right';
    ctx.fillText('ğŸ›¡'+String(card.def||0),w-14,140);
  }
  // Description
  if(card.desc||card.effect){
    const txt=card.desc||card.effect||'';
    ctx.fillStyle='#8a8878';ctx.font='8px Crimson Pro,serif';
    ctx.textAlign='left';ctx.textBaseline='top';
    const words=txt.split(' ');let line='',y2=166;
    for(const word of words){
      const test=line+word+' ';
      if(ctx.measureText(test).width>w-20&&line){ctx.fillText(line,10,y2);line=word+' ';y2+=11;if(y2>200)break;}
      else line=test;
    }
    if(y2<=200)ctx.fillText(line,10,y2);
  }
  return new THREE.CanvasTexture(c2);
}

function makeCardFrameMesh(card, x, y, z){
  // Frame (gold border)
  const frameMat = new THREE.MeshLambertMaterial({
    color: new THREE.Color(cardTypeColor(card.type||'')).lerp(new THREE.Color(0xc9a84c),.5)
  });
  const frame = new THREE.Group();

  // Card face
  const cardMat = new THREE.MeshLambertMaterial({map: makeCardTexture(card), side:THREE.FrontSide});
  const cardMesh = new THREE.Mesh(new THREE.PlaneGeometry(CARD_W, CARD_H), cardMat);

  // Backing plate (slight 3D pop)
  const backing = new THREE.Mesh(
    new THREE.BoxGeometry(CARD_W+0.2, CARD_H+0.2, 0.06),
    new THREE.MeshLambertMaterial({color:0x0a0c14})
  );
  backing.position.z = -0.04;

  // Gold frame strips
  const fmat = new THREE.MeshLambertMaterial({color:0xc9a84c});
  [[CARD_W+0.2, 0.08, 0, CARD_H/2+0.04],
   [CARD_W+0.2, 0.08, 0,-CARD_H/2-0.04],
   [0.08, CARD_H+0.2,-CARD_W/2-0.04, 0],
   [0.08, CARD_H+0.2, CARD_W/2+0.04, 0],
  ].forEach(([w2,h2,fx,fy])=>{
    const strip=new THREE.Mesh(new THREE.BoxGeometry(w2,h2,0.05),fmat);
    strip.position.set(fx,fy,0.02);frame.add(strip);
  });

  // Subtle glow plane behind card
  const glowMat = new THREE.MeshBasicMaterial({
    color: new THREE.Color(cardTypeColor(card.type||'')),
    transparent:true, opacity:0.08
  });
  const glow = new THREE.Mesh(new THREE.PlaneGeometry(CARD_W+0.5, CARD_H+0.5), glowMat);
  glow.position.z = -0.1;

  frame.add(glow, backing, cardMesh);
  frame.position.set(x, y, z + 0.1);
  frame.userData = {card, interactable:true, type:'card'};
  return frame;
}

function buildGallery(page=0){
  // Remove old card meshes
  cardMeshes.forEach(m=>{
    scene.remove(m);
    m.traverse(c=>{if(c.material)c.material.dispose();if(c.geometry)c.geometry.dispose();});
  });
  cardMeshes.length=0;

  let cards=[...forgeData.cards];
  if(!cards.length){
    // Placeholder cards
    cards=[
      {id:'demo1',name:'Shadow Drake',type:'Creature',cost:4,atk:3,def:2,desc:'Flying. Deals 1 damage on enter.'},
      {id:'demo2',name:'Arcane Bolt',type:'Spell',cost:2,desc:'Deal 3 damage to any target.'},
      {id:'demo3',name:'Iron Shield',type:'Artifact',cost:3,def:4,desc:'Shield. +2 DEF to holder.'},
      {id:'demo4',name:'Vine Trap',type:'Trap',cost:1,desc:'Freeze attacker for 1 turn.'},
      {id:'demo5',name:'Forest Sage',type:'Creature',cost:5,atk:2,def:5,desc:'Regen. Draw a card each turn.'},
      {id:'demo6',name:'Lightning',type:'Spell',cost:3,desc:'Deal 5 damage. Piercing.'},
      {id:'demo7',name:'The Wanderer',type:'Hero',cost:6,atk:4,def:4,desc:'Haste. Lifesteal.'},
    ];
  }
  if(settings.cardSort==='cost') cards.sort((a,b)=>(a.cost||0)-(b.cost||0));
  else if(settings.cardSort==='type') cards.sort((a,b)=>(a.type||'').localeCompare(b.type||''));
  else cards.sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  const start = page * CARDS_PER_PAGE;
  const pageCards = cards.slice(start, start+CARDS_PER_PAGE);
  const totalPages = Math.ceil(cards.length/CARDS_PER_PAGE);

  const spacing = 3.4;
  const totalW = (pageCards.length-1)*spacing;
  const startX = -totalW/2;

  pageCards.forEach((card,i)=>{
    const x = startX + i*spacing;
    const y = ROOM_H/2 + 0.2;
    const z = -ROOM_D/2 + 0.15;
    const m = makeCardFrameMesh(card, x, y, z);
    scene.add(m);
    cardMeshes.push(m);
  });

  // Update wall nav label
  const lbl = document.getElementById('wallNavLabel');
  if(lbl) lbl.textContent = `PAGE ${page+1}/${totalPages} Â· ${cards.length} CARDS`;
  galleryPage = page;
  return totalPages;
}

function galleryScroll(dir){
  loadForgeData();
  const cards = forgeData.cards.length ? forgeData.cards : [{},{},{},{},{},{},{}];
  const total = Math.ceil(cards.length/CARDS_PER_PAGE);
  const next = ((galleryPage+dir)+total)%total;
  buildGallery(next);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABLE (center)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tableMesh;
function buildTable(){
  const tableGroup = new THREE.Group();
  // Table top
  const top = new THREE.Mesh(
    new THREE.BoxGeometry(6,0.15,4),
    new THREE.MeshLambertMaterial({color:0x1a4422})
  );
  top.position.y=0.9; top.receiveShadow=true;
  tableGroup.add(top);
  // Felt surface detail
  const felt = new THREE.Mesh(
    new THREE.PlaneGeometry(5.7,3.7),
    new THREE.MeshLambertMaterial({color:0x163820})
  );
  felt.rotation.x=-Math.PI/2;felt.position.y=0.978;
  tableGroup.add(felt);
  // Table legs
  [[-2.8,0,-1.8],[-2.8,0,1.8],[2.8,0,-1.8],[2.8,0,1.8]].forEach(([x,y,z])=>{
    const leg=new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.12,0.9,8),matWood);
    leg.position.set(x,0.45,z);tableGroup.add(leg);
  });
  // Gold trim on table edge
  const trim=new THREE.Mesh(
    new THREE.BoxGeometry(6.1,0.05,4.1),
    new THREE.MeshLambertMaterial({color:0x8b6228})
  );
  trim.position.y=0.97;tableGroup.add(trim);

  tableGroup.position.set(0,0,2);
  tableGroup.userData={interactable:true,type:'table',label:'Open Playtest'};
  tableMesh=tableGroup;
  scene.add(tableGroup);

  // Subtle light over table
  const tableLight=new THREE.PointLight(0x446633, 0.8, 6);
  tableLight.position.set(0,3,2);scene.add(tableLight);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WALL LABELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeLabelTexture(text, subtext=''){
  const c2=document.createElement('canvas');c2.width=512;c2.height=64;
  const ctx=c2.getContext('2d');
  ctx.clearRect(0,0,512,64);
  ctx.fillStyle='rgba(201,168,76,0.08)';ctx.fillRect(0,0,512,64);
  ctx.strokeStyle='rgba(201,168,76,0.4)';ctx.lineWidth=1;ctx.strokeRect(1,1,510,62);
  ctx.fillStyle='#c9a84c';ctx.font='bold 22px Cinzel,serif';ctx.textAlign='center';
  ctx.textBaseline='middle';ctx.fillText(text,256,subtext?20:32);
  if(subtext){ctx.fillStyle='#6a6858';ctx.font='12px Cinzel,serif';ctx.fillText(subtext,256,44);}
  return new THREE.CanvasTexture(c2);
}

function addWallLabels(){
  // North wall - Gallery label
  const galLabel=new THREE.Mesh(
    new THREE.PlaneGeometry(5,0.6),
    new THREE.MeshBasicMaterial({map:makeLabelTexture('âœ¦ CARD GALLERY','TAP A CARD TO INSPECT'),transparent:true})
  );
  galLabel.position.set(0,ROOM_H-0.5,-ROOM_D/2+0.15);scene.add(galLabel);

  // South wall - Chronicle panels label
  const chrLabel=new THREE.Mesh(
    new THREE.PlaneGeometry(5,0.6),
    new THREE.MeshBasicMaterial({map:makeLabelTexture('âœ¦ THE CHRONICLE','CHARACTERS Â· WORLD Â· BOOKS'),transparent:true})
  );
  chrLabel.rotation.y=Math.PI;chrLabel.position.set(0,ROOM_H-0.5,ROOM_D/2-0.15);scene.add(chrLabel);

  // East wall - Whiteboard
  const wbLabel=new THREE.Mesh(
    new THREE.PlaneGeometry(4,0.6),
    new THREE.MeshBasicMaterial({map:makeLabelTexture('âœ¦ WHITEBOARD I','PRESS DRAW TO SKETCH'),transparent:true})
  );
  wbLabel.rotation.y=-Math.PI/2;wbLabel.position.set(ROOM_W/2-0.15,ROOM_H-0.5,0);scene.add(wbLabel);

  // Table sign
  const tableSign=new THREE.Mesh(
    new THREE.PlaneGeometry(2.5,0.45),
    new THREE.MeshBasicMaterial({map:makeLabelTexture('PLAYTEST TABLE','TAP TO PLAY'),transparent:true})
  );
  tableSign.position.set(0,2.0,0.05);tableSign.rotation.x=-0.2;scene.add(tableSign);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHRONICLE PANELS â€” SOUTH WALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHRONICLE_TABS = [
  {label:'CHARACTERS', icon:'ğŸ‘¤', key:'characters', color:'#4488cc'},
  {label:'WORLD',      icon:'ğŸ—º', key:'world',      color:'#44aa66'},
  {label:'BOOKS',      icon:'ğŸ“–', key:'books',      color:'#cc8844'},
  {label:'NOTES',      icon:'ğŸ“', key:'notes',      color:'#8855cc'},
];

function makeChroniclePanel(tab, x){
  const c2=document.createElement('canvas');c2.width=200;c2.height=280;
  const ctx=c2.getContext('2d');
  // BG
  const g=ctx.createLinearGradient(0,0,0,280);
  g.addColorStop(0,'#14172a');g.addColorStop(1,'#0d0f18');
  ctx.fillStyle=g;ctx.fillRect(0,0,200,280);
  // Color bar top
  ctx.fillStyle=tab.color;ctx.fillRect(0,0,200,6);
  // Border
  ctx.strokeStyle=tab.color+'66';ctx.lineWidth=2;ctx.strokeRect(2,2,196,276);
  // Icon
  ctx.font='40px serif';ctx.textAlign='center';ctx.textBaseline='top';
  ctx.fillText(tab.icon,100,30);
  // Label
  ctx.fillStyle='#c9a84c';ctx.font='bold 14px Cinzel,serif';ctx.textBaseline='middle';
  ctx.fillText(tab.label,100,100);
  // Tap hint
  ctx.fillStyle='#3a3828';ctx.font='9px Cinzel,serif';
  ctx.fillText('TAP TO OPEN',100,130);
  // Decorative lines
  ctx.strokeStyle=tab.color+'33';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(20,150);ctx.lineTo(180,150);ctx.stroke();
  for(let i=0;i<4;i++){
    ctx.fillStyle='#1e2030';ctx.fillRect(20,160+i*22,160,16);
    ctx.fillStyle='#333848';ctx.fillRect(20,160+i*22,(80+Math.random()*60)|0,16);
  }
  const t=new THREE.CanvasTexture(c2);
  const mat=new THREE.MeshLambertMaterial({map:t,side:THREE.FrontSide});
  const panel=new THREE.Mesh(new THREE.PlaneGeometry(2.2,3.0),mat);
  panel.rotation.y=Math.PI;
  panel.position.set(x, ROOM_H/2, ROOM_D/2-0.15);
  panel.userData={interactable:true,type:'chronicle',tab:tab.key,label:`Open ${tab.label}`};
  scene.add(panel);

  // Gold frame
  const fmat=new THREE.MeshLambertMaterial({color:new THREE.Color(tab.color).lerp(new THREE.Color(0xc9a84c),.4)});
  [[2.35,0.08,0,1.55],[2.35,0.08,0,-1.55],[0.08,3.15,-1.2,0],[0.08,3.15,1.2,0]].forEach(([w2,h2,fx,fy])=>{
    const strip=new THREE.Mesh(new THREE.BoxGeometry(w2,h2,0.04),fmat);
    strip.rotation.y=Math.PI;strip.position.set(x+fx,ROOM_H/2+fy,ROOM_D/2-0.18);scene.add(strip);
  });
}

function buildChroniclePanels(){
  const xs=[-6,-2,2,6];
  CHRONICLE_TABS.forEach((tab,i)=>makeChroniclePanel(tab,xs[i]));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RAYCASTING â€” INTERACTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const raycaster = new THREE.Raycaster();
const centerScreen = new THREE.Vector2(0,0);
let hoveredObj = null;
const hintEl = document.getElementById('hint');
const roomLabelEl = document.getElementById('roomlabel');

function getRoomLabel(){
  const p = camera.position;
  const angle = Math.atan2(p.x, p.z) * 180/Math.PI;
  if(p.z < -ROOM_D/2+3) return 'CARD GALLERY â€” NORTH';
  if(p.z > ROOM_D/2-3) return 'CHRONICLE PANELS â€” SOUTH';
  if(p.x > ROOM_W/2-3) return 'WHITEBOARD â€” EAST';
  if(p.x < -ROOM_W/2+3) return 'WHITEBOARD â€” WEST';
  return 'WORKSHOP â€” CENTER';
}

function checkInteraction(){
  raycaster.setFromCamera(centerScreen, camera);
  const interactables = [];
  scene.traverse(obj=>{if(obj.userData?.interactable)interactables.push(obj);});
  const hits = raycaster.intersectObjects(interactables, true);
  if(hits.length){
    const obj = hits[0].object;
    let target = obj;
    while(target.parent && !target.userData?.interactable) target=target.parent;
    if(target.userData?.interactable){
      hoveredObj=target;
      hintEl.textContent=(target.userData.label||'Interact') + ' [TAP â¬¡]';
      hintEl.classList.add('show');
      return;
    }
  }
  hoveredObj=null;
  hintEl.classList.remove('show');
}

function triggerInteract(){
  if(hoveredObj){
    doInteract(hoveredObj);
  }
}

function doInteract(obj){
  if(!obj?.userData) return;
  const {type, card, tab} = obj.userData;
  if(type==='card') openCardModal(card||obj.userData);
  else if(type==='table') openPlaytest();
  else if(type==='chronicle') openChronicle(tab);
}

// Tap on canvas
canvas.addEventListener('click', e=>{
  if(drawMode) return;
  raycaster.setFromCamera(centerScreen, camera);
  const interactables=[];
  scene.traverse(obj=>{if(obj.userData?.interactable)interactables.push(obj);});
  const hits=raycaster.intersectObjects(interactables,true);
  if(hits.length){
    let t=hits[0].object;
    while(t.parent&&!t.userData?.interactable)t=t.parent;
    if(t.userData?.interactable)doInteract(t);
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCardModal(card){
  if(!card||!card.id)return;
  const el=document.getElementById('modalBody');
  const kws=card.keywords||card.kws||[];
  el.innerHTML=`
    <div class="card-detail-frame">
      <div class="card-detail-header">
        <div>
          <div class="card-detail-name">${esc(card.name||'Unknown')}</div>
          <div class="card-detail-type">${esc((card.type||'CARD').toUpperCase())}</div>
        </div>
        <div class="card-detail-cost">${card.cost||0}</div>
      </div>
      <div class="card-detail-body">
        ${(card.atk!==undefined||card.def!==undefined)?`
        <div class="card-stat-row">
          ${card.atk!==undefined?`<div class="card-stat"><div class="sv" style="color:#cc5555">âš” ${card.atk}</div><div class="sl">ATTACK</div></div>`:''}
          ${card.def!==undefined?`<div class="card-stat"><div class="sv" style="color:#4488cc">ğŸ›¡ ${card.def}</div><div class="sl">DEFENSE</div></div>`:''}
          ${card.hp!==undefined?`<div class="card-stat"><div class="sv" style="color:#44aa66">â™¥ ${card.hp}</div><div class="sl">HP</div></div>`:''}
        </div>`:''}
        ${kws.length?`<div class="card-kw-list">${kws.map(k=>`<span class="card-kw">${esc(k)}</span>`).join('')}</div>`:''}
        ${card.desc||card.effect?`<div class="card-desc">${esc(card.desc||card.effect||'')}</div>`:''}
      </div>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="hbtn" style="flex:1;padding:10px;" onclick="window.location.href='forge.html'">âœ Edit in Forge</button>
      <button class="hbtn" style="flex:1;padding:10px;" onclick="closeModal()">Close</button>
    </div>`;
  document.getElementById('modal').classList.add('open');
}

function openPlaytest(){
  document.getElementById('modalBody').innerHTML=`
    <div style="padding:20px;text-align:center;">
      <div style="font-size:36px;margin-bottom:12px;">âš”</div>
      <div style="font-family:'Cinzel',serif;font-size:16px;color:var(--gold2);margin-bottom:8px;">PLAYTEST TABLE</div>
      <p style="color:var(--text2);font-size:13px;margin-bottom:20px;">Launch the full playtest interface to play your card game or run a board game simulation.</p>
      <div style="display:flex;gap:8px;justify-content:center;">
        <button class="hbtn" style="padding:12px 24px;" onclick="window.open('playtest.html','_blank')">â–¶ Launch Playtest</button>
        <button class="hbtn" style="padding:12px 24px;" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
  document.getElementById('modal').classList.add('open');
}

function openChronicle(tab){
  document.getElementById('modalBody').innerHTML=`
    <div style="padding:20px;text-align:center;">
      <div style="font-size:36px;margin-bottom:12px;">${CHRONICLE_TABS.find(t=>t.key===tab)?.icon||'ğŸ“–'}</div>
      <div style="font-family:'Cinzel',serif;font-size:16px;color:var(--gold2);margin-bottom:8px;">${(tab||'CHRONICLE').toUpperCase()}</div>
      <p style="color:var(--text2);font-size:13px;margin-bottom:20px;">Open Chronicle to view and edit your ${tab||'records'}. Changes sync automatically.</p>
      <div style="display:flex;gap:8px;justify-content:center;">
        <button class="hbtn" style="padding:12px 24px;" onclick="window.open('lifeapp.html','_blank')">Open Chronicle</button>
        <button class="hbtn" style="padding:12px 24px;" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
  document.getElementById('modal').classList.add('open');
}

function closeModal(){document.getElementById('modal').classList.remove('open');}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSettings(){
  const el=document.getElementById('modalBody');
  el.innerHTML=`
    <div style="font-family:'Cinzel',serif;font-size:13px;color:var(--gold2);letter-spacing:.12em;margin-bottom:16px;">âš™ ROOM SETTINGS</div>
    <div class="settings-row">
      <div><div class="settings-label">CAMERA FOV</div><div class="settings-sub">Field of view (${settings.fov}Â°)</div></div>
      <input type="range" min="55" max="100" value="${settings.fov}" oninput="settings.fov=+this.value;camera.fov=+this.value;camera.updateProjectionMatrix();this.previousElementSibling.children[1].textContent='Field of view ('+this.value+'Â°)'">
    </div>
    <div class="settings-row">
      <div><div class="settings-label">LOOK SENSITIVITY</div><div class="settings-sub">${settings.sensitivity}</div></div>
      <input type="range" min="0.5" max="6" step="0.1" value="${settings.sensitivity}" oninput="settings.sensitivity=+this.value;this.previousElementSibling.children[1].textContent=this.value">
    </div>
    <div class="settings-row">
      <div><div class="settings-label">MOVE SPEED</div><div class="settings-sub">${settings.speed}</div></div>
      <input type="range" min="1" max="10" step="0.5" value="${settings.speed}" oninput="settings.speed=+this.value;this.previousElementSibling.children[1].textContent=this.value">
    </div>
    <div class="settings-row">
      <div><div class="settings-label">INVERT Y LOOK</div></div>
      <div class="toggle-sw ${settings.invertY?'on':''}" onclick="this.classList.toggle('on');settings.invertY=this.classList.contains('on')"></div>
    </div>
    <div class="settings-row">
      <div><div class="settings-label">VIRTUAL JOYSTICK</div></div>
      <div class="toggle-sw ${settings.showJoystick?'on':''}" onclick="this.classList.toggle('on');settings.showJoystick=this.classList.contains('on');updateJoystickVisibility()"></div>
    </div>
    <div class="settings-row">
      <div><div class="settings-label">PERFORMANCE MODE</div><div class="settings-sub">Lower quality, better FPS</div></div>
      <div class="toggle-sw ${settings.perfMode?'on':''}" onclick="this.classList.toggle('on');settings.perfMode=this.classList.contains('on')"></div>
    </div>
    <div class="settings-row">
      <div><div class="settings-label">CARD SORT</div></div>
      <select onchange="settings.cardSort=this.value;buildGallery(0)">
        <option value="name" ${settings.cardSort==='name'?'selected':''}>By Name</option>
        <option value="cost" ${settings.cardSort==='cost'?'selected':''}>By Cost</option>
        <option value="type" ${settings.cardSort==='type'?'selected':''}>By Type</option>
      </select>
    </div>
    <div class="settings-row">
      <div><div class="settings-label">GAMEPAD DEADZONE</div><div class="settings-sub">${settings.deadzone}</div></div>
      <input type="range" min="0.05" max="0.35" step="0.01" value="${settings.deadzone}" oninput="settings.deadzone=+this.value;this.previousElementSibling.children[1].textContent=this.value">
    </div>
    <div style="margin-top:16px;display:flex;gap:8px;">
      <button class="hbtn" style="flex:1;padding:10px;" onclick="saveSettings();closeModal();toast('Settings saved','good')">âœ“ Save Settings</button>
      <button class="hbtn" style="flex:1;padding:10px;" onclick="closeModal()">Cancel</button>
    </div>
    <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px;">
      <div style="font-family:'Cinzel',serif;font-size:10px;color:var(--text2);letter-spacing:.1em;margin-bottom:8px;">GAMEPAD BUTTONS (GameSir G8+)</div>
      <div style="font-size:11px;color:var(--text2);line-height:1.9;">
        Left Stick â€” Move &nbsp;|&nbsp; Right Stick â€” Look<br>
        A â€” Interact &nbsp;|&nbsp; B â€” Back/Close<br>
        Y â€” Toggle Draw Mode &nbsp;|&nbsp; X â€” Jump to Gallery<br>
        LT â€” Sprint &nbsp;|&nbsp; Start â€” Settings
      </div>
    </div>`;
  document.getElementById('modal').classList.add('open');
}

function updateJoystickVisibility(){
  const v=settings.showJoystick;
  document.getElementById('vjLeft').style.display=v?'flex':'none';
  document.getElementById('vjRight').style.display=v?'flex':'none';
  document.getElementById('vjLabel').style.display=v?'block':'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAW MODE (placeholder â€” full whiteboard in Phase 2)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let drawMode = false;
function toggleDrawMode(){
  drawMode=!drawMode;
  const btn=document.getElementById('btnDraw');
  btn.classList.toggle('active',drawMode);
  toast(drawMode?'Draw mode ON â€” tap wall to draw':'Draw mode OFF',drawMode?'good':'');
  if(drawMode){
    document.getElementById('vjLeft').style.opacity='0.2';
    document.getElementById('vjRight').style.opacity='0.2';
  } else {
    document.getElementById('vjLeft').style.opacity='1';
    document.getElementById('vjRight').style.opacity='1';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WALL JUMP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function jumpToWall(wall){
  const targets={
    north:{x:0,y:1.7,z:WALL_N+3, rx:0, ry:0},
    south:{x:0,y:1.7,z:WALL_S-3, rx:0, ry:Math.PI},
    east: {x:WALL_E-3,y:1.7,z:0, rx:0, ry:-Math.PI/2},
    west: {x:WALL_W+3,y:1.7,z:0, rx:0, ry:Math.PI/2},
    center:{x:0,y:1.7,z:3, rx:0, ry:0},
  };
  const t=targets[wall];if(!t)return;
  jumpTarget=t; jumpStart={x:camera.position.x,y:camera.position.y,z:camera.position.z,yaw:yaw,pitch:pitch};
  jumpT=0;
  if(wall==='north'){
    document.getElementById('wallNav').classList.add('show');
  } else {
    document.getElementById('wallNav').classList.remove('show');
  }
}

let jumpTarget=null, jumpStart=null, jumpT=1;
function doJump(delta){
  if(!jumpTarget||jumpT>=1)return;
  jumpT=Math.min(1,jumpT+delta*1.5);
  const t=jumpT<0.5?2*jumpT*jumpT:1-Math.pow(-2*jumpT+2,2)/2;
  camera.position.x=jumpStart.x+(jumpTarget.x-jumpStart.x)*t;
  camera.position.y=jumpStart.y+(jumpTarget.y-jumpStart.y)*t;
  camera.position.z=jumpStart.z+(jumpTarget.z-jumpStart.z)*t;
  yaw=jumpStart.yaw+(jumpTarget.ry-jumpStart.yaw)*t;
  pitch=jumpStart.pitch+(jumpTarget.rx-jumpStart.pitch)*t;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CAMERA CONTROL â€” LOOK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let yaw=Math.PI, pitch=0;
const euler = new THREE.Euler(0,0,0,'YXZ');

function applyCamera(){
  euler.set(pitch, yaw, 0);
  camera.quaternion.setFromEuler(euler);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VIRTUAL JOYSTICK SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const vjL={active:false,id:-1,startX:0,startY:0,dx:0,dy:0};
const vjR={active:false,id:-1,startX:0,startY:0,dx:0,dy:0};
const VJ_RADIUS=60;

function setupVirtualJoysticks(){
  const LEFT=document.getElementById('vjLeft');
  const RIGHT=document.getElementById('vjRight');
  const lKnob=document.getElementById('vjLKnob');
  const rKnob=document.getElementById('vjRKnob');

  function onStart(el,vj,knob,e){
    const touch=[...e.changedTouches].find(t=>{
      const r=el.getBoundingClientRect();
      return t.clientX>=r.left&&t.clientX<=r.right&&t.clientY>=r.top&&t.clientY<=r.bottom;
    });
    if(!touch||vj.active)return;
    vj.active=true;vj.id=touch.identifier;
    vj.startX=touch.clientX;vj.startY=touch.clientY;
    vj.dx=0;vj.dy=0;
  }
  function onMove(vj,knob,e){
    if(!vj.active)return;
    const touch=[...e.changedTouches].find(t=>t.identifier===vj.id);
    if(!touch)return;
    let dx=touch.clientX-vj.startX, dy=touch.clientY-vj.startY;
    const d=Math.sqrt(dx*dx+dy*dy);
    if(d>VJ_RADIUS){dx*=VJ_RADIUS/d;dy*=VJ_RADIUS/d;}
    vj.dx=dx/VJ_RADIUS; vj.dy=dy/VJ_RADIUS;
    knob.style.transform=`translate(${dx}px,${dy}px)`;
  }
  function onEnd(vj,knob,e){
    const t=[...e.changedTouches].find(t=>t.identifier===vj.id);
    if(!t)return;
    vj.active=false;vj.id=-1;vj.dx=0;vj.dy=0;
    knob.style.transform='translate(0,0)';
  }

  document.addEventListener('touchstart',e=>{
    onStart(LEFT,vjL,lKnob,e);
    onStart(RIGHT,vjR,rKnob,e);
  },{passive:true});
  document.addEventListener('touchmove',e=>{
    onMove(vjL,lKnob,e);
    onMove(vjR,rKnob,e);
  },{passive:true});
  document.addEventListener('touchend',e=>{onEnd(vjL,lKnob,e);onEnd(vjR,rKnob,e);});
  document.addEventListener('touchcancel',e=>{onEnd(vjL,lKnob,e);onEnd(vjR,rKnob,e);});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAMEPAD (GameSir G8+ / Xbox layout)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GP={connected:false,index:-1};
const GP_PREV_BTN=new Array(17).fill(false);

function pollGamepad(delta){
  const gamepads=navigator.getGamepads?navigator.getGamepads():[];
  let gp=null;
  for(const g of gamepads){if(g&&g.connected){gp=g;GP.index=g.index;GP.connected=true;break;}}
  if(!gp){GP.connected=false;return;}

  const dead=settings.deadzone;
  const axes=gp.axes;
  const btns=gp.buttons;

  // Left stick â€” move
  const lx=Math.abs(axes[0])>dead?axes[0]:0;
  const ly=Math.abs(axes[1])>dead?axes[1]:0;

  // Right stick â€” look
  const rx=Math.abs(axes[2])>dead?axes[2]:0;
  const ry=Math.abs(axes[3])>dead?axes[3]:0;

  // Sprint (LT = axis 6 or button 6)
  const lt=btns[6]?btns[6].value||0:0;
  const sprint=lt>0.3?settings.sprintMult:1;
  const spd=settings.speed*sprint*delta;

  // Movement
  if(lx||ly){
    const fwd=new THREE.Vector3(-Math.sin(yaw),0,-Math.cos(yaw));
    const right=new THREE.Vector3(-Math.sin(yaw-Math.PI/2),0,-Math.cos(yaw-Math.PI/2));
    camera.position.addScaledVector(fwd,-ly*spd);
    camera.position.addScaledVector(right,lx*spd);
    clampCamera();
  }

  // Look
  if(rx||ry){
    const sens=settings.sensitivity*delta*1.5;
    yaw -= rx*sens;
    pitch += (settings.invertY?-1:1)*ry*sens;
    pitch=Math.max(-Math.PI/2.2,Math.min(Math.PI/2.2,pitch));
  }

  // Button events (edge detect)
  const pressed=i=>btns[i]&&btns[i].pressed&&!GP_PREV_BTN[i];
  if(pressed(0)){triggerInteract();}        // A
  if(pressed(1)){closeModal();}              // B
  if(pressed(3)){toggleDrawMode();}          // Y
  if(pressed(2)){jumpToWall('north');}       // X
  if(pressed(9)){openSettings();}            // Start
  // D-pad
  if(pressed(12))galleryScroll(-1);          // Up
  if(pressed(13))galleryScroll(1);           // Down

  for(let i=0;i<btns.length;i++)GP_PREV_BTN[i]=btns[i]?btns[i].pressed:false;
}

window.addEventListener('gamepadconnected',e=>{
  GP.connected=true;GP.index=e.gamepad.index;
  toast('Controller connected: '+e.gamepad.id.slice(0,30),'good');
});
window.addEventListener('gamepaddisconnected',()=>{GP.connected=false;toast('Controller disconnected');});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const keys={};
window.addEventListener('keydown',e=>{keys[e.code]=true;});
window.addEventListener('keyup',e=>{keys[e.code]=false;});
window.addEventListener('keydown',e=>{
  if(e.code==='KeyE')triggerInteract();
  if(e.code==='Escape')closeModal();
  if(e.code==='KeyF')document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();
});

function pollKeyboard(delta){
  const spd=settings.speed*(keys['ShiftLeft']?settings.sprintMult:1)*delta;
  const fwd=new THREE.Vector3(-Math.sin(yaw),0,-Math.cos(yaw));
  const right=new THREE.Vector3(-Math.sin(yaw-Math.PI/2),0,-Math.cos(yaw-Math.PI/2));
  if(keys['KeyW']||keys['ArrowUp'])   {camera.position.addScaledVector(fwd,spd);clampCamera();}
  if(keys['KeyS']||keys['ArrowDown']) {camera.position.addScaledVector(fwd,-spd);clampCamera();}
  if(keys['KeyA']||keys['ArrowLeft']) {camera.position.addScaledVector(right,-spd);clampCamera();}
  if(keys['KeyD']||keys['ArrowRight']){camera.position.addScaledVector(right,spd);clampCamera();}
}

// Mouse look (desktop)
let mouseLook=false;
canvas.addEventListener('mousedown',()=>{mouseLook=true;});
window.addEventListener('mouseup',()=>{mouseLook=false;});
window.addEventListener('mousemove',e=>{
  if(!mouseLook)return;
  const sens=settings.sensitivity*0.003;
  yaw-=e.movementX*sens;
  pitch+=(settings.invertY?-1:1)*e.movementY*sens;
  pitch=Math.max(-Math.PI/2.2,Math.min(Math.PI/2.2,pitch));
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOVEMENT & CLAMP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clampCamera(){
  camera.position.x=Math.max(-ROOM_W/2+0.5, Math.min(ROOM_W/2-0.5, camera.position.x));
  camera.position.y=1.7; // locked height
  camera.position.z=Math.max(-ROOM_D/2+0.5, Math.min(ROOM_D/2-0.5, camera.position.z));
}

function applyVJMovement(delta){
  if(!vjL.active&&!vjR.active) return;
  const spd=settings.speed*delta;
  const fwd=new THREE.Vector3(-Math.sin(yaw),0,-Math.cos(yaw));
  const right=new THREE.Vector3(-Math.sin(yaw-Math.PI/2),0,-Math.cos(yaw-Math.PI/2));
  if(vjL.active){
    camera.position.addScaledVector(fwd,-vjL.dy*spd);
    camera.position.addScaledVector(right,vjL.dx*spd);
    clampCamera();
  }
  if(vjR.active){
    const sens=settings.sensitivity*delta*1.8;
    yaw-=vjR.dx*sens;
    pitch+=(settings.invertY?-1:1)*vjR.dy*sens;
    pitch=Math.max(-Math.PI/2.2,Math.min(Math.PI/2.2,pitch));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARTICLES (dust motes)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let particleSystem;
function buildParticles(){
  if(settings.perfMode)return;
  const count=120;
  const geo=new THREE.BufferGeometry();
  const pos=new Float32Array(count*3);
  for(let i=0;i<count*3;i+=3){
    pos[i]=(Math.random()-0.5)*ROOM_W*0.9;
    pos[i+1]=Math.random()*ROOM_H;
    pos[i+2]=(Math.random()-0.5)*ROOM_D*0.9;
  }
  geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
  const mat=new THREE.PointsMaterial({color:0xc9a84c,size:0.03,transparent:true,opacity:0.25});
  particleSystem=new THREE.Points(geo,mat);
  scene.add(particleSystem);
}

function animateParticles(t){
  if(!particleSystem)return;
  const pos=particleSystem.geometry.attributes.position.array;
  for(let i=0;i<pos.length;i+=3){
    pos[i+1]+=Math.sin(t*0.3+i)*0.001;
    if(pos[i+1]>ROOM_H)pos[i+1]=0;
  }
  particleSystem.geometry.attributes.position.needsUpdate=true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TORCH FLICKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function animateTorches(t){
  torchLights.forEach(({light,baseInt,phase})=>{
    light.intensity=baseInt+Math.sin(t*4+phase)*0.2+Math.sin(t*7+phase*2)*0.1;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const toastEl=document.getElementById('toast');
let toastTimer;
function toast(msg,cls=''){
  toastEl.textContent=msg;toastEl.className='show '+(cls||'');
  clearTimeout(toastTimer);toastTimer=setTimeout(()=>toastEl.className='',2400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('resize',()=>{
  renderer.setSize(window.innerWidth,window.innerHeight);
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let frameCount=0;
function animate(){
  requestAnimationFrame(animate);
  const delta=Math.min(clock.getDelta(),0.05);
  const t=clock.elapsedTime;

  pollGamepad(delta);
  pollKeyboard(delta);
  applyVJMovement(delta);
  doJump(delta);
  applyCamera();

  // Interaction check every 3 frames
  if(frameCount%3===0) checkInteraction();

  // Room label
  const rl=getRoomLabel();
  if(roomLabelEl.textContent!==rl){roomLabelEl.textContent=rl;roomLabelEl.classList.add('show');}

  animateTorches(t);
  animateParticles(t);

  renderer.render(scene,camera);
  frameCount++;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setLoad(pct,msg){
  document.getElementById('loadBar').style.width=pct+'%';
  document.getElementById('loadMsg').textContent=msg;
}

async function init(){
  setLoad(10,'Building room...');
  buildRoom();
  setLoad(30,'Lighting torches...');
  buildLighting();
  setLoad(45,'Placing table...');
  buildTable();
  setLoad(55,'Loading card gallery...');
  buildGallery(0);
  setLoad(70,'Setting up chronicle panels...');
  buildChroniclePanels();
  setLoad(80,'Adding wall labels...');
  addWallLabels();
  setLoad(88,'Summoning dust motes...');
  buildParticles();
  setLoad(94,'Setting up controls...');
  setupVirtualJoysticks();
  updateJoystickVisibility();
  setLoad(100,'Welcome to the Forge Room.');
  await new Promise(r=>setTimeout(r,600));
  document.getElementById('loading').style.display='none';
  animate();
  // Jump to gallery on start
  setTimeout(()=>{
    jumpToWall('north');
    document.getElementById('wallNav').classList.add('show');
    toast('Welcome to the Forge Room âœ¦','good');
  },400);
}

// Listen for data changes from other tabs
window.addEventListener('storage',e=>{
  if(e.key===STORE_FORGE){
    loadForgeData();
    buildGallery(galleryPage);
  }
});

init();
</script>
</body>
</html>
