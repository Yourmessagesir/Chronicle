<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Playtest â€” Card Forge</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0c10;--bg2:#111520;--bg3:#181c28;--bg4:#202438;
  --border:#252a3a;--border2:#323850;
  --gold:#c9a84c;--gold2:#e8c96a;--gold3:#f5e0a0;
  --red:#cc3333;--red2:#ff5555;
  --green:#33aa55;--green2:#55cc77;
  --blue:#3377cc;--blue2:#5599ee;
  --purple:#7744cc;--purple2:#9966ee;
  --text:#ccc8b8;--text2:#807870;--text3:#504840;
  --phase:#c9a84c;
  --safe-bot:env(safe-area-inset-bottom,0px);
  --bar-h:50px;
  --foot-h:56px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',serif;height:100vh;overflow:hidden;display:flex;flex-direction:column;}

/* â•â•â• SETUP SCREEN â•â•â• */
#setupScreen{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;align-items:center;}
#setupScreen h2{font-family:'Cinzel',serif;font-size:18px;color:var(--gold2);letter-spacing:.1em;margin-bottom:4px;}
#setupScreen p{color:var(--text2);font-size:13px;margin-bottom:20px;}
.setup-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;width:100%;max-width:900px;}
.setup-card{background:var(--bg2);border:1px solid var(--border2);border-radius:8px;padding:14px;cursor:pointer;transition:all .18s;}
.setup-card:hover{border-color:var(--gold2);transform:translateY(-2px);}
.setup-card h3{font-family:'Cinzel',serif;font-size:12px;color:var(--gold2);margin-bottom:4px;}
.setup-card .sc-meta{font-size:11px;color:var(--text2);display:flex;gap:10px;flex-wrap:wrap;}
.setup-card .sc-mode{display:inline-block;padding:2px 7px;background:var(--bg3);border:1px solid var(--border2);border-radius:3px;font-family:'Cinzel',serif;font-size:9px;color:var(--text2);}
.setup-section{font-family:'Cinzel',serif;font-size:10px;color:var(--text3);letter-spacing:.12em;width:100%;max-width:900px;margin:16px 0 8px;border-bottom:1px solid var(--border);padding-bottom:4px;}
.btn{padding:5px 12px;border:1px solid var(--border2);background:var(--bg3);color:var(--text);border-radius:4px;cursor:pointer;font-family:'Cinzel',serif;font-size:9px;letter-spacing:.07em;transition:all .15s;white-space:nowrap;}
.btn:hover{border-color:var(--gold);color:var(--gold2);}
.btn.primary{background:var(--gold);color:#1a1400;border-color:var(--gold);font-weight:700;}
.btn.primary:hover{background:var(--gold2);}
.btn.danger{border-color:var(--red);color:var(--red);}
.btn.sm{padding:3px 8px;font-size:8px;}

/* â•â•â• GAME SCREEN â•â•â• */
#gameScreen{flex:1;overflow:hidden;display:none;flex-direction:column;position:relative;}

/* â”€â”€ TOP BAR (slides from top) â”€â”€ */
#topBar{
  position:absolute;top:0;left:0;right:0;z-index:60;
  background:var(--bg2);border-bottom:1px solid var(--border);
  display:flex;flex-direction:column;
  transform:translateY(0);
  transition:transform .25s cubic-bezier(.4,0,.2,1);
  box-shadow:0 4px 20px rgba(0,0,0,.5);
}
#topBar.collapsed{transform:translateY(calc(-100% + 36px));}
#topBarHandle{
  height:36px;display:flex;align-items:center;padding:0 10px;gap:8px;
  cursor:pointer;flex-shrink:0;user-select:none;
}
#topBarHandle h1{font-family:'Cinzel',serif;font-size:12px;color:var(--gold2);letter-spacing:.1em;flex:1;}
#topBarChevron{font-size:14px;color:var(--text3);transition:transform .25s;}
#topBar.collapsed #topBarChevron{transform:rotate(180deg);}
#topBarContent{border-top:1px solid var(--border);overflow:hidden;flex-shrink:0;}

/* phase/turn row */
#phaseRow{padding:6px 10px;display:flex;align-items:center;gap:6px;overflow-x:auto;background:var(--bg2);}
#phaseRow::-webkit-scrollbar{display:none;}
#phaseBar{display:flex;gap:4px;align-items:center;}
.phase-pip{padding:3px 8px;border-radius:12px;font-family:'Cinzel',serif;font-size:8px;letter-spacing:.07em;color:var(--text3);border:1px solid var(--border);background:var(--bg3);cursor:pointer;white-space:nowrap;flex-shrink:0;}
.phase-pip.active{border-color:var(--gold);color:var(--gold2);background:rgba(201,168,76,.12);}
#turnLabel{font-family:'Cinzel',serif;font-size:10px;color:var(--text2);white-space:nowrap;flex-shrink:0;}
#phaseRow .spacer{flex:1;}
#phaseBtn{padding:4px 10px;border:1px solid var(--border2);background:var(--bg3);color:var(--text2);border-radius:4px;cursor:pointer;font-family:'Cinzel',serif;font-size:8px;white-space:nowrap;flex-shrink:0;}
#phaseBtn:hover{border-color:var(--gold);color:var(--gold2);}

/* player stat pills â€” horizontal scroll */
#playerBars{
  padding:6px 10px;display:flex;gap:6px;overflow-x:auto;background:rgba(17,21,32,.95);
  border-top:1px solid var(--border);
}
#playerBars::-webkit-scrollbar{display:none;}
.pstat-bar{background:var(--bg3);border:1px solid var(--border2);border-radius:6px;padding:5px 10px;display:flex;align-items:center;gap:8px;flex-shrink:0;}
.pstat-bar.active{border-color:var(--gold);}
.psb-name{font-family:'Cinzel',serif;font-size:9px;color:var(--gold2);white-space:nowrap;}
.psb-hp{font-size:11px;white-space:nowrap;}
.psb-res{font-size:10px;color:var(--blue2);white-space:nowrap;}
.psb-hand{font-size:10px;color:var(--text2);white-space:nowrap;}
.top-bar-actions{display:flex;gap:6px;padding:6px 10px;border-top:1px solid var(--border);background:var(--bg2);}
.tba-btn{flex:1;padding:6px 4px;border:1px solid var(--border2);background:var(--bg3);color:var(--text2);border-radius:4px;cursor:pointer;font-family:'Cinzel',serif;font-size:8px;letter-spacing:.05em;text-align:center;}
.tba-btn:active{border-color:var(--gold);color:var(--gold);}
.tba-btn.danger{border-color:var(--red);color:var(--red);}

/* â”€â”€ BOARD AREA (fills everything between top/bottom) â”€â”€ */
#boardWrap{
  position:absolute;inset:0;
  overflow:auto;
  background:repeating-conic-gradient(rgba(20,23,32,.9) 0% 25%,rgba(13,15,20,.9) 0% 50%) 0 0/30px 30px;
}
#boardInner{padding:20px;display:inline-block;min-width:100%;min-height:100%;}
#board{position:relative;background:rgba(20,23,32,.9);border:2px dashed var(--border2);border-radius:8px;transform-origin:top left;}

/* board zones */
.play-zone{position:absolute;border:1.5px solid;border-radius:5px;display:flex;flex-direction:column;overflow:hidden;}
.pz-header{font-family:'Cinzel',serif;font-size:7px;letter-spacing:.07em;padding:3px 6px;display:flex;align-items:center;gap:4px;flex-shrink:0;background:rgba(0,0,0,.3);}
.pz-header .pz-icon{font-size:10px;}
.pz-header .pz-label{flex:1;}
.pz-header .pz-count{opacity:.6;font-size:7px;}
.pz-cards{flex:1;overflow:hidden;display:flex;flex-wrap:wrap;gap:3px;padding:4px;align-content:flex-start;}

/* â”€â”€ BOARD SPACE (path zone) â”€â”€ */
.play-space{position:absolute;border:2px solid;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;user-select:none;transition:box-shadow .15s,border-color .15s;}
.play-space:hover{box-shadow:0 0 0 3px rgba(201,168,76,.4);}
.play-space.claimed{box-shadow:0 0 0 3px var(--claimColor,#c9a84c);}
.ps-num{font-family:'Cinzel',serif;font-size:13px;font-weight:700;pointer-events:none;line-height:1;}
.ps-lbl{font-family:'Cinzel',serif;font-size:7px;opacity:.8;pointer-events:none;text-align:center;padding:0 3px;line-height:1.2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%;}
.ps-owner{position:absolute;top:2px;right:2px;font-size:9px;font-family:'Cinzel',serif;font-weight:700;line-height:1;}
.ps-type-badge{position:absolute;bottom:2px;left:50%;transform:translateX(-50%);font-size:8px;opacity:.7;pointer-events:none;}
#boardConnections{position:absolute;inset:0;pointer-events:none;overflow:visible;z-index:0;}

/* mini card */
.mc{width:52px;height:72px;border:1.5px solid var(--border2);border-radius:4px;background:var(--bg3);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;padding:2px;transition:all .12s;position:relative;flex-shrink:0;}
.mc:hover{border-color:var(--gold);transform:scale(1.06);z-index:10;}
.mc.selected{border-color:var(--gold2)!important;box-shadow:0 0 8px rgba(201,168,76,.5);}
.mc.tapped{transform:rotate(15deg);opacity:.75;}
.mc.tapped:hover{transform:rotate(15deg) scale(1.06);}
.mc.face-down{background:var(--bg4);}
.mc .mc-emoji{font-size:16px;}
.mc .mc-name{font-family:'Cinzel',serif;font-size:5.5px;color:var(--gold2);text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;}
.mc .mc-stats{font-size:7px;color:var(--text2);display:flex;gap:3px;}
.mc .mc-kw{font-size:5px;color:var(--text3);text-align:center;}
.mc .mc-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;font-size:6px;pointer-events:none;}
.mc .status-icons{position:absolute;top:1px;right:1px;display:flex;flex-wrap:wrap;gap:1px;}
.mc .si{width:8px;height:8px;border-radius:50%;font-size:5px;display:flex;align-items:center;justify-content:center;}
.play-token{transition:opacity .18s;}
.play-token:active{transform:scale(.92);}
.piece-token{position:absolute;width:36px;height:36px;border-radius:50%;border:3px solid;display:flex;align-items:center;justify-content:center;font-size:16px;cursor:grab;user-select:none;z-index:50;box-shadow:0 2px 8px rgba(0,0,0,.5);touch-action:none;transition:box-shadow .1s;}
.piece-token:active{cursor:grabbing;box-shadow:0 6px 20px rgba(0,0,0,.7);}
.piece-token.selected-piece{box-shadow:0 0 0 3px var(--gold),0 4px 16px rgba(0,0,0,.6)!important;}
.hp-bar-wrap{margin:3px 0;width:100%;}
.hp-bar{height:6px;background:var(--bg4);border-radius:3px;overflow:hidden;}
.hp-fill{height:100%;border-radius:3px;transition:width .3s;}
.grid-cell{position:absolute;border:1px solid rgba(255,255,255,.04);pointer-events:none;}

/* â”€â”€ ZOOM CONTROLS â”€â”€ */
#zoomControls{
  position:absolute;right:12px;bottom:calc(var(--foot-h) + 16px + var(--safe-bot));
  display:flex;flex-direction:column;gap:4px;z-index:55;
}
.zoom-btn{width:36px;height:36px;border:1px solid var(--border2);background:rgba(17,21,32,.9);
  color:var(--text2);border-radius:8px;cursor:pointer;font-family:'Cinzel',serif;font-size:13px;
  display:flex;align-items:center;justify-content:center;touch-action:manipulation;
  backdrop-filter:blur(4px);}
.zoom-btn:active{border-color:var(--gold);color:var(--gold);}
#zoomLbl{font-family:'Cinzel',serif;font-size:8px;color:var(--text3);text-align:center;white-space:nowrap;}

/* â”€â”€ BOTTOM TOOLBAR â”€â”€ */
#bottomBar{
  position:absolute;bottom:0;left:0;right:0;z-index:60;
  height:calc(var(--foot-h) + var(--safe-bot));
  background:var(--bg2);border-top:1px solid var(--border);
  display:flex;align-items:flex-start;padding:6px 8px 0;gap:4px;
  padding-bottom:var(--safe-bot);
}
.foot-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;
  padding:5px 2px;border:1px solid transparent;border-radius:6px;
  cursor:pointer;touch-action:manipulation;background:none;transition:all .12s;}
.foot-btn.active{border-color:var(--gold);background:rgba(201,168,76,.08);}
.foot-btn:active{border-color:var(--border2);background:var(--bg3);}
.foot-btn .fbi{font-size:18px;line-height:1;}
.foot-btn .fbl{font-family:'Cinzel',serif;font-size:7px;color:var(--text3);letter-spacing:.04em;}
.foot-btn.active .fbl{color:var(--gold);}

/* â”€â”€ PULL-UP SHEETS â”€â”€ */
.pull-sheet{
  position:absolute;bottom:0;left:0;right:0;z-index:70;
  background:var(--bg2);border-top:2px solid var(--border2);
  border-radius:14px 14px 0 0;
  transform:translateY(100%);
  transition:transform .28s cubic-bezier(.4,0,.2,1);
  display:flex;flex-direction:column;
  max-height:78vh;
  padding-bottom:calc(var(--foot-h) + var(--safe-bot));
  box-shadow:0 -8px 40px rgba(0,0,0,.6);
}
.pull-sheet.open{transform:translateY(0);}
.sheet-handle{width:44px;height:5px;background:var(--border2);border-radius:3px;margin:10px auto 0;flex-shrink:0;}
.sheet-header{
  font-family:'Cinzel',serif;font-size:12px;color:var(--gold2);
  padding:8px 16px 10px;border-bottom:1px solid var(--border);flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between;letter-spacing:.08em;
}
.sheet-close{background:none;border:none;color:var(--text2);font-size:22px;cursor:pointer;padding:0;line-height:1;}
.sheet-body{flex:1;overflow-y:auto;padding:12px 16px;}
.sheet-body::-webkit-scrollbar{width:3px;}
.sheet-body::-webkit-scrollbar-thumb{background:var(--border2);}
/* sheet tab bar */
.sheet-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;padding:0 16px;}
.sh-tab{flex:1;padding:7px 4px;font-family:'Cinzel',serif;font-size:8px;letter-spacing:.06em;color:var(--text3);border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;touch-action:manipulation;}
.sh-tab.active{color:var(--gold);border-bottom-color:var(--gold);}

/* â”€â”€ CARD DETAIL SHEET (pull-up when card selected) â”€â”€ */
#cardSheet{}
.icp-name{font-family:'Cinzel',serif;font-size:14px;color:var(--gold2);margin-bottom:8px;}
.icp-stat{display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;padding:3px 0;border-bottom:1px solid var(--border);}
.icp-stat span:first-child{color:var(--text2);}
.icp-text{font-size:12px;color:var(--text2);margin-top:6px;font-style:italic;line-height:1.5;}
.icp-kw-row{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;}
.icp-kw{padding:2px 6px;border-radius:3px;font-size:8px;background:rgba(201,168,76,.1);border:1px solid var(--gold);color:var(--gold2);font-family:'Cinzel',serif;}
.atk-btn{width:100%;text-align:left;padding:8px 10px;background:var(--bg4);border:1px solid var(--border);border-radius:5px;color:var(--text);cursor:pointer;font-size:11px;margin-bottom:5px;transition:all .12s;}
.atk-btn:hover{border-color:var(--gold);color:var(--gold2);}
.atk-btn .ab-name{font-family:'Cinzel',serif;font-size:10px;color:var(--gold2);}
.atk-btn .ab-fx{font-size:9px;color:var(--text2);margin-top:2px;}
.atk-btn .ab-cost{float:right;font-size:9px;color:var(--text3);}
.card-action-row{display:flex;gap:8px;margin-top:10px;}
.card-action-row button{flex:1;padding:10px;border:1px solid var(--border2);background:var(--bg3);color:var(--text);border-radius:5px;font-family:'Cinzel',serif;font-size:9px;cursor:pointer;}
.card-action-row button:active{background:var(--bg4);}
.card-action-row .primary{background:var(--gold);color:#1a1400;border-color:var(--gold);font-weight:700;}
.card-action-row .danger{border-color:var(--red);color:var(--red);}
.no-card-hint{color:var(--text3);font-size:12px;font-style:italic;text-align:center;padding:20px;line-height:1.6;}

/* counters */
.ctr-block{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:10px;margin-bottom:8px;}
.ctr-name{font-family:'Cinzel',serif;font-size:9px;color:var(--text3);letter-spacing:.07em;margin-bottom:6px;}
.ctr-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.ctr-label{font-size:12px;color:var(--text2);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.ctr-val{font-family:'Cinzel',serif;font-size:18px;color:var(--gold);min-width:36px;text-align:center;}
.ctr-btn{width:32px;height:32px;border:1px solid var(--border2);background:var(--bg2);color:var(--text);border-radius:5px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;touch-action:manipulation;flex-shrink:0;}
.ctr-btn:active{border-color:var(--gold);color:var(--gold);}
.owned-spaces-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);}
.owned-spaces-row .osn{font-family:'Cinzel',serif;font-size:10px;color:var(--gold2);}
.owned-spaces-row .osc{font-size:11px;}

/* pieces */
.piece-spawn{display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;margin-bottom:6px;cursor:pointer;touch-action:manipulation;}
.piece-spawn:active{border-color:var(--gold);background:var(--bg4);}
.ps-dot{width:32px;height:32px;border-radius:50%;border:3px solid;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.ps-label{font-family:'Cinzel',serif;font-size:10px;color:var(--text2);}

/* log sheet */
#logSheet .sheet-body{padding:8px;}
.ll{font-size:11px;padding:3px 6px;border-bottom:1px solid rgba(255,255,255,.03);line-height:1.4;}
.ll.good{color:var(--green2);}
.ll.bad{color:var(--red2);}
.ll.phase{color:var(--gold2);font-family:'Cinzel',serif;font-size:10px;letter-spacing:.06em;}
.ll.atk{color:var(--blue2);}

/* â”€â”€ DICE â”€â”€ */
#dicePanel{position:absolute;bottom:calc(var(--foot-h) + 12px + var(--safe-bot));right:12px;z-index:500;display:none;
  background:var(--bg2);border:1px solid var(--border2);border-radius:10px;
  padding:12px;box-shadow:0 4px 24px rgba(0,0,0,.6);min-width:200px;max-width:240px;}
#dicePanel.open{display:block;}
.dice-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;}
.die-btn{width:38px;height:38px;border:1px solid var(--border2);background:var(--bg3);
  color:var(--gold2);border-radius:6px;cursor:pointer;font-family:'Cinzel',serif;
  font-size:10px;letter-spacing:.04em;display:flex;align-items:center;justify-content:center;
  transition:all .12s;touch-action:manipulation;}
.die-btn:hover,.die-btn:active{border-color:var(--gold);background:var(--bg4);}
.die-btn.rolling{animation:dieSpin .4s ease;}
@keyframes dieSpin{0%{transform:rotate(0) scale(1)}40%{transform:rotate(180deg) scale(1.3)}100%{transform:rotate(360deg) scale(1)}}
#diceResult{font-family:'Cinzel',serif;font-size:28px;color:var(--gold2);text-align:center;
  min-height:44px;display:flex;align-items:center;justify-content:center;
  border:1px solid var(--border);border-radius:6px;background:var(--bg3);margin-bottom:8px;}
#diceFormula{font-size:10px;color:var(--text3);text-align:center;margin-bottom:6px;}
.dice-custom-row{display:flex;gap:6px;align-items:center;}
.dice-custom-row input{background:var(--bg3);border:1px solid var(--border2);color:var(--text);
  padding:4px 8px;border-radius:4px;font-size:12px;width:56px;}

/* â”€â”€ CLAIM TOAST â”€â”€ */
.claim-toast{position:absolute;bottom:calc(var(--foot-h) + 16px + var(--safe-bot));left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--gold);padding:12px 18px;border-radius:10px;z-index:800;display:none;flex-direction:column;align-items:center;gap:8px;min-width:200px;box-shadow:0 4px 24px rgba(0,0,0,.6);}
.claim-toast.open{display:flex;}
.claim-toast h4{font-family:'Cinzel',serif;font-size:11px;color:var(--gold2);letter-spacing:.06em;}
.claim-btn-row{display:flex;gap:8px;width:100%;}
.claim-btn-row button{flex:1;padding:8px;border-radius:5px;font-family:'Cinzel',serif;font-size:9px;cursor:pointer;border:1px solid var(--border2);background:var(--bg3);color:var(--text);}
.claim-btn-row button.primary{background:var(--gold);color:#1a1400;border-color:var(--gold);font-weight:700;}
.claim-btn-row button.danger{border-color:var(--red);color:var(--red);}

/* toast */
#toast{position:absolute;bottom:calc(var(--foot-h) + 56px + var(--safe-bot));left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--border2);padding:7px 16px;border-radius:16px;font-size:12px;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap;}
#toast.show{opacity:1;}
#toast.win{border-color:var(--gold);color:var(--gold2);}
#toast.bad{border-color:var(--red);color:var(--red2);}
#toast.good{border-color:var(--green);color:var(--green2);}

/* â”€â”€ SELECTED CARD INDICATOR on board â”€â”€ */
.sel-hint{position:absolute;top:calc(var(--bar-h) + 8px);left:50%;transform:translateX(-50%);
  background:rgba(201,168,76,.15);border:1px solid var(--gold);border-radius:8px;
  padding:4px 12px;font-family:'Cinzel',serif;font-size:9px;color:var(--gold2);
  z-index:55;pointer-events:none;opacity:0;transition:opacity .2s;white-space:nowrap;}
.sel-hint.show{opacity:1;}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â• SETUP SCREEN â•â•â•â•â•â•â•â•â•â•â• -->
<div id="setupScreen">
  <h2>âš” PLAYTEST</h2>
  <p>Select a game config to start playtesting. Layouts are loaded from the Layout Builder.</p>
  <div class="setup-section">GAME CONFIGS</div>
  <div class="setup-grid" id="gameConfigList"></div>
  <div class="setup-section">SAVED LAYOUTS <span style="font-size:9px;color:var(--text3);font-family:'Crimson Pro',serif;letter-spacing:0;">â€” layouts with ğŸ² mode launch as board games with dice, pieces &amp; counters</span></div>
  <div class="setup-grid" id="layoutConfigList"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• GAME SCREEN â•â•â•â•â•â•â•â•â•â•â• -->
<div id="gameScreen">

  <!-- BOARD (fills everything) -->
  <div id="boardWrap">
    <div id="boardInner"><div id="board"></div></div>
  </div>

  <!-- TOP BAR (collapsible) -->
  <div id="topBar">
    <div id="topBarHandle" onclick="toggleTopBar()">
      <h1 id="gameTitle">PLAYTEST</h1>
      <span id="turnLabel"></span>
      <span id="topBarChevron">â–²</span>
    </div>
    <div id="topBarContent">
      <div id="phaseRow">
        <div id="phaseBar"></div>
        <span class="spacer"></span>
        <button id="phaseBtn" onclick="advancePhase()">NEXT â–¶</button>
      </div>
      <div id="playerBars"></div>
      <div class="top-bar-actions">
        <button class="tba-btn" onclick="endTurn()">END TURN â­</button>
        <button class="tba-btn danger" onclick="resignGame()">âœ• RESIGN</button>
      </div>
    </div>
  </div>

  <!-- ZOOM CONTROLS -->
  <div id="zoomControls">
    <button class="zoom-btn" onclick="boardZoomBy(.25)" title="Zoom in">ï¼‹</button>
    <div id="zoomLbl">100%</div>
    <button class="zoom-btn" onclick="boardZoomBy(-.25)" title="Zoom out">ï¼</button>
    <button class="zoom-btn" onclick="boardZoomFit()" title="Fit" style="font-size:9px;letter-spacing:-.02em;">FIT</button>
  </div>

  <!-- BOTTOM TOOLBAR -->
  <div id="bottomBar">
    <button class="foot-btn" id="fb-card" onclick="openSheet('cardSheet')">
      <span class="fbi">ğŸƒ</span><span class="fbl">CARD</span>
    </button>
    <button class="foot-btn" id="fb-counters" onclick="openSheet('countersSheet');renderCounterPanel()">
      <span class="fbi">ğŸ“Š</span><span class="fbl">COUNTERS</span>
    </button>
    <button class="foot-btn" id="fb-pieces" onclick="openSheet('piecesSheet');renderPiecePanel()">
      <span class="fbi">ğŸ¯</span><span class="fbl">PIECES</span>
    </button>
    <button class="foot-btn" id="fb-log" onclick="openSheet('logSheet');renderLog()">
      <span class="fbi">ğŸ“œ</span><span class="fbl">LOG</span>
    </button>
    <button class="foot-btn" id="fb-dice" onclick="toggleDicePanel()">
      <span class="fbi">ğŸ²</span><span class="fbl">DICE</span>
    </button>
  </div>

  <!-- SELECTED CARD HINT -->
  <div class="sel-hint" id="selHint">TAP A TARGET Â· LONG-PRESS TO CANCEL</div>

  <!-- â”€â”€â”€ PULL-UP SHEETS â”€â”€â”€ -->

  <!-- CARD SHEET -->
  <div class="pull-sheet" id="cardSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span id="cardSheetTitle">SELECTED CARD</span>
      <button class="sheet-close" onclick="closeSheet('cardSheet')">Ã—</button>
    </div>
    <div class="sheet-body" id="infoPanel">
      <p class="no-card-hint">Tap any card on the board to see its details and available actions here.</p>
    </div>
  </div>

  <!-- COUNTERS SHEET -->
  <div class="pull-sheet" id="countersSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span>COUNTERS</span>
      <button class="sheet-close" onclick="closeSheet('countersSheet')">Ã—</button>
    </div>
    <div class="sheet-body" id="counterPanel"></div>
  </div>

  <!-- PIECES SHEET -->
  <div class="pull-sheet" id="piecesSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span>PIECES &amp; TOKENS</span>
      <button class="sheet-close" onclick="closeSheet('piecesSheet')">Ã—</button>
    </div>
    <div class="sheet-body" id="piecePanel"></div>
  </div>

  <!-- LOG SHEET -->
  <div class="pull-sheet" id="logSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span>GAME LOG</span>
      <button class="sheet-close" onclick="closeSheet('logSheet')">Ã—</button>
    </div>
    <div class="sheet-body" id="logPanel"></div>
  </div>

  <!-- DICE PANEL (floating) -->
  <div id="dicePanel">
    <div style="font-family:'Cinzel',serif;font-size:10px;color:var(--text3);letter-spacing:.08em;margin-bottom:8px;">ğŸ² DICE ROLLER</div>
    <div id="diceResult">â€”</div>
    <div id="diceFormula">tap a die to roll</div>
    <div class="dice-row">
      <button class="die-btn" onclick="rollDie(4)">d4</button>
      <button class="die-btn" onclick="rollDie(6)">d6</button>
      <button class="die-btn" onclick="rollDie(8)">d8</button>
      <button class="die-btn" onclick="rollDie(10)">d10</button>
      <button class="die-btn" onclick="rollDie(12)">d12</button>
      <button class="die-btn" onclick="rollDie(20)">d20</button>
    </div>
    <div class="dice-custom-row">
      <span style="font-size:10px;color:var(--text3);">Qty:</span>
      <input type="number" id="diceQty" value="1" min="1" max="10" style="width:46px;">
      <span style="font-size:10px;color:var(--text3);">d</span>
      <input type="number" id="diceSides" value="6" min="2" max="100" style="width:52px;">
      <button class="die-btn" style="width:auto;padding:0 10px;" onclick="rollCustom()">ROLL</button>
    </div>
    <div style="margin-top:8px;border-top:1px solid var(--border);padding-top:6px;">
      <div style="font-family:'Cinzel',serif;font-size:8px;color:var(--text3);margin-bottom:4px;">LAST ROLLS</div>
      <div id="diceHistory" style="font-size:10px;color:var(--text2);max-height:60px;overflow-y:auto;"></div>
    </div>
  </div>

  <!-- CLAIM SPACE PANEL -->
  <div id="claimToast" class="claim-toast">
    <h4 id="claimToastTitle">BOARD SPACE</h4>
    <div class="claim-btn-row">
      <button class="primary" id="claimBtn" onclick="claimSpace()">â›³ CLAIM</button>
      <button class="danger" id="unclaimBtn" onclick="unclaimSpace()" style="display:none;">âœ• UNCLAIM</button>
      <button onclick="closeClaimToast()">CANCEL</button>
    </div>
    <div id="claimPlayerRow" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:2px;"></div>
  </div>

</div><!-- /#gameScreen -->

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHARED DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORE='cardforge_v3';
const LB_STORE='cardforge_layouts_v2';
const ACTIVE_LAYOUT_STORE='cardforge_active_layout';

let D={cards:[],decks:[],fusions:[],games:[]};
let savedLayouts=[];
function loadData(){
  try{const s=localStorage.getItem(STORE);if(s)D=JSON.parse(s);}catch(e){}
  try{savedLayouts=JSON.parse(localStorage.getItem(LB_STORE)||'[]');}catch(e){}
}

function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function toast(msg,cls=''){
  const t=document.getElementById('toast');t.textContent=msg;t.className='show '+(cls||'');
  clearTimeout(t._t);t._t=setTimeout(()=>t.className='',2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSetup(){
  const gcEl=document.getElementById('gameConfigList');
  const lcEl=document.getElementById('layoutConfigList');
  if(!D.games.length){
    gcEl.innerHTML='<div style="color:var(--text3);font-size:12px;grid-column:1/-1;font-style:italic;padding:10px;">No game configs found. Create one in Card Forge first.</div>';
  } else {
    gcEl.innerHTML=D.games.map(g=>`
      <div class="setup-card" onclick="startGame('${g.id}')">
        <h3>${esc(g.name)}</h3>
        <div class="sc-meta">
          <span class="sc-mode">${esc(g.mode||'standard')}</span>
          <span>HP: ${g.startHp}</span>
          <span>Hand: ${g.maxHand}</span>
          <span>${g.players||2}P</span>
        </div>
        ${g.notes?`<div style="margin-top:5px;font-size:10px;color:var(--text3);">${esc(g.notes.slice(0,60))}</div>`:''}
      </div>
    `).join('');
  }
  const activeLayout=JSON.parse(localStorage.getItem(ACTIVE_LAYOUT_STORE)||'null');
  const allLayouts=activeLayout?[activeLayout,...savedLayouts]:savedLayouts;
  if(!allLayouts.length){
    lcEl.innerHTML='<div style="color:var(--text3);font-size:12px;grid-column:1/-1;font-style:italic;padding:10px;">No layouts found. Use the Layout Builder to create one.</div>';
  } else {
    const modeIcon2={standard:'âš”',grid:'â™Ÿ',arena:'ğŸŸ',lanes:'ğŸ›£',traverse:'ğŸ—º',coop:'ğŸ¤',draft:'ğŸ“‹',boardgame:'ğŸ²',freeplay:'ğŸ²',any:'ğŸƒ'};
    lcEl.innerHTML=allLayouts.map(l=>{
      const isBG=l.mode==='boardgame'||l.mode==='freeplay';
      const hasTokens=(l.zones||[]).filter(z=>z.isToken).length;
      return `<div class="setup-card" onclick="startGameWithLayout(null,'${l.id}')">
        <h3>${l.id===activeLayout?.id?'ğŸ“ ':''}${modeIcon2[l.mode||'any']||'ğŸƒ'} ${esc(l.name)}</h3>
        <div class="sc-meta">
          <span class="sc-mode" style="${isBG?'border-color:var(--gold);color:var(--gold2);':''}">${esc(l.mode||'any')}</span>
          <span>${(l.zones||[]).filter(z=>!z.isToken).length} zones</span>
          ${hasTokens?`<span>ğŸ² ${hasTokens} tokens</span>`:''}
          <span>${l.players||2}P</span>
          ${l.bgImage?'<span>ğŸ–¼ bg</span>':''}
          ${isBG?'<span style="color:var(--gold2);">ğŸ² Dice + Pieces</span>':''}
        </div>
      </div>`;
    }).join('');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let G=null;

function mkPlayer(id,name,isAI){
  return {id,name,isAI,
    hp:0,maxHp:0,res:0,maxRes:0,
    hand:[],deck:[],graveyard:[],exile:[],
    field:[],assistant:null,collector:null,
    score:0, poisonCounters:0,
    crystalHp:0,
  };
}
function liveCard(c){
  return {...c,
    _id:'lc_'+Math.random().toString(36).slice(2),
    _hp:c.hp||1, _atk:c.atk||0, _def:c.def||0,
    _move:c.move||1, _movesLeft:c.move||1,
    _tapped:false, _atkCount:0,
    _shield:hasKw(c,'Shield'),
    _reborn:hasKw(c,'Reborn'),
    _rebornUsed:false,
    _frozen:false, _silenced:false,
    _stealthed:hasKw(c,'Stealth'),
    _poisonCounters:0, _prowessBonus:0,
    _x:0,_y:0,
  };
}
function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=0|Math.random()*(i+1);[a[i],a[j]]=[a[j],a[i]];}return a;}
function hasKw(card,kw){return !card._silenced&&((card.keywords||[]).includes(kw));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  START GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(gameId, layoutOverride){
  const game=D.games.find(g=>g.id===gameId);
  if(!game)return toast('Game config not found.','bad');
  const activeLayout=layoutOverride||JSON.parse(localStorage.getItem(ACTIVE_LAYOUT_STORE)||'null')||null;
  _initGame(game, activeLayout);
}
function startGameWithLayout(gameId, layoutId){
  const allLayouts=[...savedLayouts];
  const activeLayout=JSON.parse(localStorage.getItem(ACTIVE_LAYOUT_STORE)||'null');
  if(activeLayout)allLayouts.unshift(activeLayout);
  const layout=allLayouts.find(l=>l.id===layoutId)||null;
  if(!gameId&&layout&&(layout.mode==='boardgame'||layout.mode==='freeplay'||!D.games.length)){
    startBoardGame(layout);return;
  }
  if(gameId){
    startGame(gameId, layout);
  } else {
    const game=D.games[0]||{id:'default',name:'Default',mode:layout?.mode||'standard',
      startHp:30,maxHand:5,maxField:5,resPerTurn:3,maxRes:10,players:2,
      aiStyle:'aggressive',aiDiff:'medium',crystalHp:20,gridSize:6,
      winConds:[{id:'hp0',on:true}],rules:{fusionEnabled:true,resourceSystem:true},
      phases:['Draw','Main','Combat','End']};
    _initGame(game, layout);
  }
}
function _initGame(game, layout){
  const numPlayers=game.players||2;
  const players=[];
  for(let i=0;i<numPlayers;i++){
    const p=mkPlayer('p'+(i+1), i===0?'You':'Opp '+(i+1), i>0);
    p.hp=game.startHp||30; p.maxHp=game.startHp||30;
    p.res=game.resPerTurn||3; p.maxRes=game.maxRes||10;
    p.crystalHp=game.crystalHp||20;
    const pool=D.cards.filter(c=>!c._fusion&&(c.gameId===game.id||!c.gameId));
    const deckCards=pool.length?shuffle([...pool,...pool,...pool]).slice(0,30):[];
    p.deck=deckCards.map(liveCard);
    for(let j=0;j<(game.maxHand||5)&&p.deck.length;j++) p.hand.push(p.deck.pop());
    players.push(p);
  }
  G={
    game, layout, players,
    turn:0, activePlayer:0,
    phase:0, phases:game.phases?.length?game.phases:['Draw','Main','Combat','End'],
    log:[], over:false, winner:null,
    selCard:null, selOwner:null, selLocation:null,
    grid:null, lanes:null,
    comboStack:[],comboScore:0,
    fusions:D.fusions.filter(f=>!f.gameId||f.gameId===game.id),
    constructStage:[],
    zoneOwners:{},
  };
  if(game.mode==='grid'||game.mode==='traverse')initGrid(game);
  if(game.mode==='lanes')initLanes(game);
  pieces=[];
  showGameScreen(game,layout);
  initCounters();
  glog(`âš” ${game.name} â€” ${game.mode} mode started!`,'phase');
  glog(`Turn 1: ${G.players[0].name}`,'phase');
  if(game.mode==='boardgame'||game.mode==='freeplay'){glog('Board game mode â€” use dice, pieces, and counters. No decks.','phase');return;}
  doDrawPhase();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GRID INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initGrid(game){
  const size=game.gridSize||6;
  G.grid={size, cells:[]};
  for(let r=0;r<size;r++){
    G.grid.cells.push([]);
    for(let c=0;c<size;c++) G.grid.cells[r].push(null);
  }
  if(game.mode==='traverse'){
    G.crystals={p1:{r:size-1,c:Math.floor(size/2),hp:game.crystalHp||20,maxHp:game.crystalHp||20},
                p2:{r:0,c:Math.floor(size/2),hp:game.crystalHp||20,maxHp:game.crystalHp||20}};
    G.items=[];
    for(let i=0;i<Math.floor(size*size*0.15);i++){
      G.items.push({r:1+Math.floor(Math.random()*(size-2)),c:Math.floor(Math.random()*size),
        name:'Item',emoji:'ğŸ’°',effect:'gain_res',value:2,collected:false});
    }
  }
}
function initLanes(game){
  G.lanes=[
    {name:'LEFT LANE',player:null,opp:null,playerWon:false,oppWon:false},
    {name:'CENTER',player:null,opp:null,playerWon:false,oppWon:false},
    {name:'RIGHT LANE',player:null,opp:null,playerWon:false,oppWon:false},
  ];
  const ai=G.players[1];
  G.lanes.forEach((lane,i)=>{
    if(ai.hand[i]){lane.opp={...ai.hand[i],_who:'opp'};ai.hand.splice(i,1);}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHOW GAME SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let boardZoom=1;

function showGameScreen(game, layout){
  document.getElementById('setupScreen').style.display='none';
  const gs=document.getElementById('gameScreen');gs.style.display='flex';
  document.getElementById('gameTitle').textContent='âš” '+game.name.toUpperCase();
  // Start with top bar collapsed so board has max space
  document.getElementById('topBar').classList.add('collapsed');
  renderPhaseBar();
  renderPlayerBars();
  buildBoard(layout, game);
  renderBoard();
  renderInfoPanel();
  // Fit board after a short delay
  setTimeout(boardZoomFit, 80);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOP BAR TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTopBar(){
  document.getElementById('topBar').classList.toggle('collapsed');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHEET SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _openSheet=null;
function openSheet(id){
  // close all others
  document.querySelectorAll('.pull-sheet').forEach(s=>{
    if(s.id!==id)s.classList.remove('open');
  });
  document.querySelectorAll('.foot-btn').forEach(b=>b.classList.remove('active'));
  const sheet=document.getElementById(id);
  const already=sheet.classList.contains('open');
  sheet.classList.toggle('open',!already);
  // Highlight matching foot button
  const map={cardSheet:'fb-card',countersSheet:'fb-counters',piecesSheet:'fb-pieces',logSheet:'fb-log'};
  if(!already&&map[id])document.getElementById(map[id])?.classList.add('active');
  _openSheet=already?null:id;
  // Close dice if opening another sheet
  if(id!=='dice')document.getElementById('dicePanel').classList.remove('open');
}
function closeSheet(id){
  document.getElementById(id).classList.remove('open');
  document.querySelectorAll('.foot-btn').forEach(b=>b.classList.remove('active'));
  if(_openSheet===id)_openSheet=null;
}
// Swipe down to close sheets
document.addEventListener('touchstart',e=>{
  const sh=document.querySelector('.pull-sheet.open');
  if(!sh)return;
  sh._swipeY=e.touches[0].clientY;
},{passive:true});
document.addEventListener('touchmove',e=>{
  const sh=document.querySelector('.pull-sheet.open');
  if(!sh||sh._swipeY==null)return;
  const dy=e.touches[0].clientY-sh._swipeY;
  if(dy>0)sh.style.transform=`translateY(${dy}px)`;
},{passive:true});
document.addEventListener('touchend',e=>{
  const sh=document.querySelector('.pull-sheet.open');
  if(!sh||sh._swipeY==null)return;
  const dy=e.changedTouches[0].clientY-sh._swipeY;
  sh._swipeY=null;sh.style.transform='';
  if(dy>90)closeSheet(sh.id);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOARD ZOOM / PAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function boardZoomBy(delta){
  boardZoom=Math.max(.25,Math.min(3,boardZoom+delta));
  applyBoardZoom();
}
function boardZoomFit(){
  const wrap=document.getElementById('boardWrap');
  const board=document.getElementById('board');
  const bw=+board.style.width||800;
  const bh=+board.style.height||580;
  if(!bw||!bh)return;
  const scaleX=(wrap.clientWidth-40)/bw;
  const scaleY=(wrap.clientHeight-40)/bh;
  boardZoom=Math.min(scaleX,scaleY,.98);
  if(boardZoom<.1)boardZoom=.5;
  applyBoardZoom();
}
function applyBoardZoom(){
  const board=document.getElementById('board');
  const inner=document.getElementById('boardInner');
  const bw=+board.style.width||800;
  const bh=+board.style.height||580;
  board.style.transform=`scale(${boardZoom})`;
  inner.style.width=(bw*boardZoom+40)+'px';
  inner.style.height=(bh*boardZoom+40)+'px';
  document.getElementById('zoomLbl').textContent=Math.round(boardZoom*100)+'%';
}
// Pinch-to-zoom on board
let _pinch=null;
document.addEventListener('touchstart',e=>{
  if(e.touches.length===2&&document.getElementById('boardWrap').contains(e.target)){
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    _pinch={dist:Math.sqrt(dx*dx+dy*dy),zoom:boardZoom};
  }
},{passive:true});
document.addEventListener('touchmove',e=>{
  if(_pinch&&e.touches.length===2){
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    const dist=Math.sqrt(dx*dx+dy*dy);
    boardZoom=Math.max(.25,Math.min(3,_pinch.zoom*(dist/_pinch.dist)));
    applyBoardZoom();
  }
},{passive:true});
document.addEventListener('touchend',()=>{_pinch=null;});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PHASES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPhaseBar(){
  const el=document.getElementById('phaseBar');
  el.innerHTML=G.phases.map((p,i)=>`<span class="phase-pip${i===G.phase?' active':''}">${p}</span>`).join('');
  document.getElementById('turnLabel').textContent=`T${G.turn+1} Â· ${G.players[G.activePlayer].name}`;
}
function advancePhase(){
  if(G.over)return;
  G.phase++;
  if(G.phase>=G.phases.length){endTurn();return;}
  const phase=G.phases[G.phase];
  glog(`â”€â”€ ${phase} Phase â”€â”€`,'phase');
  renderPhaseBar();
  if(phase==='Draw')doDrawPhase();
  if(phase==='Combat'){glog('Combat: select your cards to attack.','');}
  if(phase==='Move'){glog('Move: select a card and a destination cell.','');}
  if(phase==='Collect'){glog('Collect: cards with Collector keyword can grab nearby items.','');}
  if(phase==='Combo'){glog('Combo: play cards onto the stack to build combos.','');}
  renderBoard();renderInfoPanel();
}
function doDrawPhase(){
  const p=G.players[G.activePlayer];
  if(p.deck.length){
    p.hand.push(p.deck.pop());
    glog(`${p.name} draws. (${p.deck.length} remaining)`);
  } else {
    glog(`${p.name}'s deck is empty!`,'bad');
  }
  // Resource refresh
  p.res=Math.min(p.maxRes,p.res+(G.game.resPerTurn||3));
  applyStartOfTurnEffects(p);
  renderBoard(); renderPlayerBars();
}
function endTurn(){
  if(G.over)return;
  // Reset tapped cards
  const p=G.players[G.activePlayer];
  p.field.forEach(c=>{c._tapped=false;c._atkCount=0;c._movesLeft=c._move||1;});
  G.activePlayer=(G.activePlayer+1)%G.players.length;
  G.turn++;
  G.phase=0;
  glog(`â”€â”€ Turn ${G.turn+1}: ${G.players[G.activePlayer].name} â”€â”€`,'phase');
  renderPhaseBar();
  if(G.players[G.activePlayer].isAI){setTimeout(aiTurn,300);}
  else{doDrawPhase();}
  renderBoard(); renderInfoPanel(); renderPlayerBars();
}
function applyStartOfTurnEffects(p){
  p.field.forEach(c=>{
    if(hasKw(c,'Regenerate'))c._hp=Math.min(c.hp,c._hp+1);
    if(hasKw(c,'Cursed'))c._hp=Math.max(0,c._hp-1);
    if(c._poisonCounters>0)c._hp=Math.max(0,c._hp-c._poisonCounters);
    if(hasKw(c,'Poison')&&!hasKw(c,'Cursed')){}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CARD PLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectCard(card, ownerIdx, source, extraInfo){
  G.selCard={...card, source, ...extraInfo};
  G.selOwner=ownerIdx;
  renderBoard();
  renderInfoPanel();
  // Open card sheet automatically
  openSheet('cardSheet');
  // Update sheet title
  document.getElementById('cardSheetTitle').textContent=esc(card.name||'CARD');
  glog(`Selected: ${card.name}`);
}
function playCardFromHand(pi, handIdx){
  const p=G.players[pi];
  const card=p.hand[handIdx];
  if(!card)return;
  if(G.game.rules?.resourceSystem&&card.cost>p.res)return glog(`Not enough resources.`,'bad');
  if(p.field.length>=(G.game.maxField||6))return glog('Field full.','bad');
  if(G.game.rules?.resourceSystem)p.res-=card.cost||0;
  p.hand.splice(handIdx,1);
  card._tapped=!(hasKw(card,'Haste')||hasKw(card,'Charge'));
  p.field.push(card);
  G.selCard=null;
  glog(`${p.name} plays ${card.name}.`,'good');
  applyOnPlayEffects(card, p);
  renderBoard(); renderPlayerBars(); renderInfoPanel();
  closeSheet('cardSheet');
}
function applyOnPlayEffects(card, player){
  if(hasKw(card,'Rally'))player.field.forEach(c=>{if(c._id!==card._id)c._atk+=1;});
  if(hasKw(card,'Surge')){player.res=Math.min(player.maxRes,player.res+2);glog(`Surge: +2 resources.`);}
  if(hasKw(card,'Scout')&&player.deck.length){player.hand.push(player.deck.pop());glog(`Scout: draw a card.`);}
  if(card.type==='spell'){applySpellEffect(card,player);player.field.pop();}
}
function applySpellEffect(card,caster){
  const opp=G.players.find(x=>x.id!==caster.id);
  (card.attacks||[]).forEach(atk=>{
    (atk.effects||[]).forEach(ef=>applyEffects([ef],card,caster,opp?.field[0]||null,opp));
  });
}
function attackDirectly(pi,card){
  const p=G.players[pi];
  if(card._tapped||card._frozen)return glog(`${card.name} can't attack.`,'bad');
  if(hasKw(card,'Defender'))return glog(`${card.name} can't attack (Defender).`,'bad');
  const opp=G.players.find(x=>x.id!==p.id);
  opp.hp-=card._atk;
  glog(`${card.name} attacks ${opp.name} directly for ${card._atk}!`,'atk');
  card._tapped=true;
  if(hasKw(card,'Vigilance'))card._tapped=false;
  if(hasKw(card,'Lifesteal')){p.hp=Math.min(p.maxHp,p.hp+card._atk);glog(`Lifesteal: +${card._atk} HP.`);}
  checkWin();
  renderBoard(); renderPlayerBars();
}
function resolveCombat(attacker,defender,atkPlayer,defPlayer){
  let atkDmg=attacker._atk; let defDmg=defender._atk;
  if(hasKw(attacker,'Pierce'))defDmg=0;
  if(hasKw(defender,'Shield')&&defender._shield){defender._shield=false;atkDmg=0;glog(`${defender.name}'s Shield blocks!`);}
  defender._hp-=atkDmg; attacker._hp-=defDmg;
  glog(`${attacker.name}(${attacker._atk}) vs ${defender.name}(${defender._atk}): dealt ${atkDmg}/${defDmg}.`,'atk');
  attacker._tapped=true;
  if(hasKw(attacker,'Lifesteal')&&atkDmg>0){atkPlayer.hp=Math.min(atkPlayer.maxHp,atkPlayer.hp+atkDmg);}
  checkDead(); checkWin();
}
function applyEffects(effects,sourceCard,sourcePlayer,targetCard,targetPlayer){
  effects.forEach(ef=>{
    const v=ef.value||0;
    switch(ef.type){
      case 'damage':if(targetCard)targetCard._hp-=v;else if(targetPlayer)targetPlayer.hp-=v;break;
      case 'heal':if(targetCard)targetCard._hp=Math.min(targetCard.hp,targetCard._hp+v);else if(targetPlayer)targetPlayer.hp=Math.min(targetPlayer.maxHp,targetPlayer.hp+v);break;
      case 'buff_atk':if(targetCard)targetCard._atk+=v;break;
      case 'buff_hp':if(targetCard){targetCard.hp+=v;targetCard._hp+=v;}break;
      case 'debuff_atk':if(targetCard)targetCard._atk=Math.max(0,targetCard._atk-v);break;
      case 'draw':for(let i=0;i<v&&sourcePlayer.deck.length;i++)sourcePlayer.hand.push(sourcePlayer.deck.pop());break;
      case 'gain_res':if(sourcePlayer)sourcePlayer.res=Math.min(sourcePlayer.maxRes,sourcePlayer.res+v);break;
      case 'steal_res':if(sourcePlayer&&targetPlayer){const amt=Math.min(v,targetPlayer.res);targetPlayer.res-=amt;sourcePlayer.res=Math.min(sourcePlayer.maxRes,sourcePlayer.res+amt);}break;
      case 'poison':if(targetCard)targetCard._poisonCounters=(targetCard._poisonCounters||0)+v;break;
      case 'freeze':if(targetCard)targetCard._frozen=true;break;
      case 'silence':if(targetCard)targetCard._silenced=true;break;
      case 'destroy':if(targetCard&&targetPlayer){targetPlayer.graveyard.push(targetCard);targetPlayer.field=targetPlayer.field.filter(c=>c._id!==targetCard._id);}break;
      case 'return_to_hand':if(targetCard&&targetPlayer){targetPlayer.hand.push(targetCard);targetPlayer.field=targetPlayer.field.filter(c=>c._id!==targetCard._id);}break;
    }
  });
  if(sourceCard&&hasKw(sourceCard,'Prowess'))sourceCard._prowessBonus=(sourceCard._prowessBonus||0)+1;
}
function checkDead(){
  G.players.forEach(p=>{
    p.field=p.field.filter(c=>{
      if(c._hp<=0){
        if(hasKw(c,'Reborn')&&!c._rebornUsed){c._hp=1;c._rebornUsed=true;glog(`${c.name} reborn!`,'good');return true;}
        glog(`${c.name} is destroyed.`,'bad');
        p.graveyard.push(c);
        return false;
      }
      return true;
    });
  });
  if(G.grid){
    const size=G.grid.size;
    for(let r=0;r<size;r++)for(let c=0;c<size;c++){
      const card=G.grid.cells[r][c];
      if(card&&card._hp<=0){
        const owner=G.players.find(p=>p.id===card._owner);
        if(owner){if(hasKw(card,'Reborn')&&!card._rebornUsed){card._hp=1;card._rebornUsed=true;}
        else{glog(`${card.name} destroyed at [${r},${c}].`,'bad');owner.graveyard.push(card);G.grid.cells[r][c]=null;}}
      }
    }
  }
}
function checkWin(){
  if(G.over)return;
  const winCond=(id)=>G.game.winConds?.find(w=>w.id===id&&w.on);
  if(winCond('hp0')){
    G.players.forEach(p=>{if(p.hp<=0){G.over=true;G.winner=G.players.find(x=>x.id!==p.id);}});
  }
  if(winCond('deck0')){
    G.players.forEach(p=>{if(!p.deck.length&&!p.hand.length){G.over=true;G.winner=G.players.find(x=>x.id!==p.id);}});
  }
  if(winCond('crystal')&&G.crystals){
    if(G.crystals.p1.hp<=0){G.over=true;G.winner=G.players[1];glog(`P1 Crystal destroyed!`,'bad');}
    if(G.crystals.p2.hp<=0){G.over=true;G.winner=G.players[0];glog(`P2 Crystal destroyed!`,'bad');}
  }
  if(winCond('lanes2')&&G.lanes){
    const pw=G.lanes.filter(l=>l.playerWon).length;
    const ow=G.lanes.filter(l=>l.oppWon).length;
    if(pw>=2){G.over=true;G.winner=G.players[0];}
    if(ow>=2){G.over=true;G.winner=G.players[1];}
  }
  if(G.over&&G.winner){
    glog(`ğŸ† ${G.winner.name} WINS!`,'phase');
    toast(`ğŸ† ${G.winner.name} Wins!`,'win');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function glog(msg,cls=''){
  if(!G)return;
  G.log.push({msg,cls});
  renderLog();
}
function renderLog(){
  const el=document.getElementById('logPanel');
  if(!el||!G)return;
  el.innerHTML=G.log.slice(-80).reverse().map(e=>`<div class="ll ${e.cls||''}">${esc(e.msg)}</div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOARD BUILDING (layout-driven)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildBoard(layout, game){
  const board=document.getElementById('board');
  board.innerHTML='';
  if(layout&&layout.zones&&layout.zones.length){
    board.style.width=layout.canvasW+'px';
    board.style.height=layout.canvasH+'px';
    if(layout.bgImage){
      const bg=document.createElement('div');
      bg.style.cssText=`position:absolute;inset:0;border-radius:6px;pointer-events:none;z-index:0;background:url(${layout.bgImage}) center/cover no-repeat;opacity:${layout.bgOpacity!=null?layout.bgOpacity:0.35};`;
      board.appendChild(bg);
    }
    // SVG path connections
    const svgNS='http://www.w3.org/2000/svg';
    const svg=document.createElementNS(svgNS,'svg');
    svg.id='boardConnections';
    svg.setAttribute('width',layout.canvasW||800);
    svg.setAttribute('height',layout.canvasH||580);
    svg.setAttribute('viewBox',`0 0 ${layout.canvasW||800} ${layout.canvasH||580}`);
    const defs=document.createElementNS(svgNS,'defs');
    const marker=document.createElementNS(svgNS,'marker');
    marker.setAttribute('id','ptArrow');marker.setAttribute('markerWidth','8');marker.setAttribute('markerHeight','6');
    marker.setAttribute('refX','8');marker.setAttribute('refY','3');marker.setAttribute('orient','auto');
    const poly=document.createElementNS(svgNS,'polygon');
    poly.setAttribute('points','0 0, 8 3, 0 6');poly.setAttribute('fill','rgba(201,168,76,.5)');
    marker.appendChild(poly);defs.appendChild(marker);svg.appendChild(defs);
    const conns=layout.connections||[];
    conns.forEach(conn=>{
      const a=layout.zones.find(z=>z.id===conn.from);
      const b=layout.zones.find(z=>z.id===conn.to);
      if(!a||!b)return;
      const ax=a.x+a.w/2, ay=a.y+a.h/2;
      const bx=b.x+b.w/2, by=b.y+b.h/2;
      const dist=Math.sqrt((bx-ax)**2+(by-ay)**2);
      const r=Math.min(a.w,a.h)/2+4;
      const ratio=dist>0?(dist-r)/dist:1;
      const line=document.createElementNS(svgNS,'line');
      line.setAttribute('x1',ax+(bx-ax)*(1-ratio));
      line.setAttribute('y1',ay+(by-ay)*(1-ratio));
      line.setAttribute('x2',ax+(bx-ax)*ratio);
      line.setAttribute('y2',ay+(by-ay)*ratio);
      line.setAttribute('stroke','rgba(201,168,76,.45)');
      line.setAttribute('stroke-width','2');
      line.setAttribute('stroke-dasharray','6 3');
      line.setAttribute('marker-end','url(#ptArrow)');
      svg.appendChild(line);
    });
    board.appendChild(svg);
    layout.zones.forEach(z=>{
      if(z.isToken){
        const tk=document.createElement('div');
        tk.className='play-token';
        tk.id='ptk_'+z.id;
        tk.style.cssText=`position:absolute;left:${z.x}px;top:${z.y}px;width:${z.w}px;height:${z.h}px;border:2px solid ${z.border};background:${z.color};border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;user-select:none;opacity:${z.opacity!=null?z.opacity:1};z-index:10;`;
        tk.dataset.count=z.tokenCount||1;
        tk.innerHTML=`<span style="font-size:20px;pointer-events:none;">${z.icon}</span><span class="ptk-count" style="font-family:'Cinzel',serif;font-size:11px;color:${z.border};font-weight:700;pointer-events:none;">${z.tokenCount||1}</span>`;
        tk.addEventListener('click',()=>{
          let n=+tk.dataset.count+1;if(n>20)n=0;
          tk.dataset.count=n;tk.querySelector('.ptk-count').textContent=n;
          tk.style.opacity=n===0?'0.25':(z.opacity!=null?z.opacity:1);
        });
        tk.addEventListener('contextmenu',e=>{
          e.preventDefault();let n=Math.max(0,+tk.dataset.count-1);
          tk.dataset.count=n;tk.querySelector('.ptk-count').textContent=n;
          tk.style.opacity=n===0?'0.25':(z.opacity!=null?z.opacity:1);
        });
        board.appendChild(tk);return;
      }
      if(z.type==='space'){renderBoardSpace(z,board);return;}
      const el=document.createElement('div');
      el.className='play-zone';
      el.id='pz_'+z.type+'_'+(z.player||'any')+'_'+z.id;
      el.dataset.zoneId=z.id;
      el.dataset.zoneType=z.type;
      el.dataset.zonePlayer=z.player||'any';
      el.style.cssText=`left:${z.x}px;top:${z.y}px;width:${z.w}px;height:${z.h}px;border-color:${z.border};background:${z.color};opacity:${z.opacity!=null?z.opacity:1};`;
      el.innerHTML=`<div class="pz-header"><span class="pz-icon">${z.icon}</span><span class="pz-label">${esc(z.label)}</span><span class="pz-count" id="pzc_${z.id}"></span></div>
      <div class="pz-cards" id="pzCards_${z.id}"></div>`;
      board.appendChild(el);
    });
  } else {
    buildDefaultLayout(game, board);
  }
  if(game.mode==='grid'||game.mode==='traverse'){buildGridOverlay(game);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOARD SPACE ZONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLAYER_COLORS=['#4488cc','#cc4444','#44aa66','#c9a84c','#8855cc','#cc8844'];
let _claimTargetZoneId=null;
function renderBoardSpace(z, board){
  const el=document.createElement('div');
  el.className='play-space';
  el.id='ps_'+z.id;
  el.dataset.zoneId=z.id;
  const ownerIdx=G?.zoneOwners?.[z.id];
  const isOwned=ownerIdx!=null;
  const ownerColor=isOwned?PLAYER_COLORS[ownerIdx%PLAYER_COLORS.length]:null;
  let bgColor=z.color||'rgba(100,100,120,.2)';
  let borderColor=z.border||'#606480';
  if(isOwned){bgColor=ownerColor+'33';borderColor=ownerColor;}
  const typeColors={start:'rgba(68,200,100,.15)',corner:'rgba(80,80,80,.3)',jail:'rgba(200,68,68,.15)',chance:'rgba(200,160,68,.15)',bonus:'rgba(100,200,68,.15)'};
  if(z.spaceType&&z.spaceType!=='normal'&&!isOwned)bgColor=(typeColors[z.spaceType]||bgColor);
  el.style.cssText=`left:${z.x}px;top:${z.y}px;width:${z.w}px;height:${z.h}px;border-color:${borderColor};background:${bgColor};opacity:${z.opacity!=null?z.opacity:1};z-index:2;`;
  if(isOwned)el.style.setProperty('--claimColor',ownerColor);
  if(isOwned)el.classList.add('claimed');
  const numLabel=z.spaceNum!=null?`<span class="ps-num" style="color:${isOwned?ownerColor:'inherit'}">${z.spaceNum}</span>`:'';
  const lbl=z.label&&z.label!=='Board Space'?`<span class="ps-lbl">${esc(z.label)}</span>`:'';
  const ownerBadge=isOwned?`<span class="ps-owner" style="color:${ownerColor}">P${ownerIdx+1}</span>`:'';
  const typeBadge=z.spaceType&&z.spaceType!=='normal'?`<span class="ps-type-badge">${{start:'ğŸ',corner:'ğŸ”²',jail:'ğŸš”',chance:'â“',bonus:'â­'}[z.spaceType]||''}</span>`:'';
  el.innerHTML=numLabel+lbl+ownerBadge+typeBadge;
  if(z.claimable&&isBoardGameMode()){
    el.addEventListener('click',()=>openClaimToast(z.id));
  }
  board.appendChild(el);
}
function isBoardGameMode(){
  return G&&(G.game.mode==='boardgame'||G.game.mode==='freeplay');
}
function openClaimToast(zoneId){
  if(!G)return;
  _claimTargetZoneId=zoneId;
  const z=G.layout?.zones?.find(x=>x.id===zoneId);
  const title=document.getElementById('claimToastTitle');
  if(title)title.textContent=(z?.spaceNum!=null?'#'+z.spaceNum+' â€” ':'')+esc(z?.label||'Space');
  const isOwned=G.zoneOwners?.[zoneId]!=null;
  const claimBtn=document.getElementById('claimBtn');
  const unclaimBtn=document.getElementById('unclaimBtn');
  if(claimBtn)claimBtn.style.display=isOwned?'none':'block';
  if(unclaimBtn)unclaimBtn.style.display=isOwned?'block':'none';
  const row=document.getElementById('claimPlayerRow');
  if(row){
    row.innerHTML=G.players.map((p,i)=>`<button onclick="claimSpaceByPlayer(${i})" style="padding:5px 10px;border-radius:4px;font-family:'Cinzel',serif;font-size:9px;cursor:pointer;border:2px solid ${PLAYER_COLORS[i%PLAYER_COLORS.length]};background:${G.zoneOwners[_claimTargetZoneId]===i?PLAYER_COLORS[i%PLAYER_COLORS.length]+'44':'var(--bg3)'};color:${PLAYER_COLORS[i%PLAYER_COLORS.length]};">${p.name}</button>`).join('');
  }
  document.getElementById('claimToast').classList.add('open');
}
function claimSpaceByPlayer(pIdx){
  if(!G||_claimTargetZoneId==null)return;
  G.zoneOwners[_claimTargetZoneId]=pIdx;
  const z=G.layout?.zones?.find(x=>x.id===_claimTargetZoneId);
  glog(`${G.players[pIdx].name} claimed Space${z?.spaceNum!=null?' #'+z.spaceNum:''}${z?.label&&z.label!=='Board Space'?' ('+z.label+')':''}.`,'good');
  closeClaimToast();
  const board=document.getElementById('board');
  const old=document.getElementById('ps_'+_claimTargetZoneId);
  if(old&&z){old.replaceWith((()=>{const d=document.createElement('div');renderBoardSpace(z,{appendChild:c=>d.appendChild(c)});return d.firstChild;})());}
  renderCounters();
}
function claimSpace(){if(!G||_claimTargetZoneId==null)return;claimSpaceByPlayer(G.activePlayer);}
function unclaimSpace(){
  if(!G||_claimTargetZoneId==null)return;
  const z=G.layout?.zones?.find(x=>x.id===_claimTargetZoneId);
  delete G.zoneOwners[_claimTargetZoneId];
  glog(`Space${z?.spaceNum!=null?' #'+z.spaceNum:''} unclaimed.`);
  closeClaimToast();
  const old=document.getElementById('ps_'+_claimTargetZoneId);
  if(old&&z){old.replaceWith((()=>{const d=document.createElement('div');renderBoardSpace(z,{appendChild:c=>d.appendChild(c)});return d.firstChild;})());}
  renderCounters();
}
function closeClaimToast(){document.getElementById('claimToast').classList.remove('open');_claimTargetZoneId=null;}
function refreshAllSpaces(){
  if(!G||!G.layout?.zones)return;
  G.layout.zones.filter(z=>z.type==='space').forEach(z=>{
    const old=document.getElementById('ps_'+z.id);
    if(!old)return;
    const newEl=document.createElement('div');
    renderBoardSpace(z,{appendChild:c=>newEl.appendChild(c)});
    if(newEl.firstChild)old.replaceWith(newEl.firstChild);
  });
}

function buildDefaultLayout(game, board){
  const mode=game.mode||'standard';
  let w=820,h=580;
  board.style.width=w+'px'; board.style.height=h+'px';
  const zones=defaultZones(mode, w, h);
  zones.forEach(z=>{
    const el=document.createElement('div');
    el.className='play-zone';
    el.id='pz_default_'+z.type+'_'+z.id;
    el.dataset.zoneType=z.type;
    el.dataset.zonePlayer=z.player||'any';
    el.dataset.defaultZoneId=z.id;
    el.style.cssText=`left:${z.x}px;top:${z.y}px;width:${z.w}px;height:${z.h}px;border-color:${z.border};background:${z.color};`;
    el.innerHTML=`<div class="pz-header"><span class="pz-icon">${z.icon}</span><span class="pz-label">${esc(z.label)}</span><span class="pz-count" id="pzc_${z.id}"></span></div>
    <div class="pz-cards" id="pzCards_${z.id}"></div>`;
    board.appendChild(el);
  });
}
function defaultZones(mode, w, h){
  if(mode==='lanes') return lanesDefaultZones(w,h);
  if(mode==='grid'||mode==='traverse') return [];
  if(mode==='coop') return coopDefaultZones(w,h);
  return [
    {id:'opp_hand',type:'hand',player:'p2',label:"Opp Hand",icon:'ğŸ¤š',x:10,y:5,w:w-120,h:70,color:'rgba(204,68,68,.08)',border:'#664444'},
    {id:'opp_deck',type:'draw',player:'p2',label:"Opp Deck",icon:'ğŸ“š',x:w-110,y:5,w:100,h:70,color:'rgba(201,168,76,.08)',border:'#664444'},
    {id:'opp_field',type:'battlefield',player:'p2',label:"Opp Field",icon:'âš”',x:10,y:85,w:w-20,h:130,color:'rgba(200,80,80,.05)',border:'#553333'},
    {id:'middle',type:'field_card',player:'shared',label:"Field / Events",icon:'ğŸŒ',x:10,y:225,w:w-20,h:50,color:'rgba(100,180,60,.06)',border:'#406020'},
    {id:'player_field',type:'battlefield',player:'p1',label:"Your Field",icon:'âš”',x:10,y:285,w:w-20,h:130,color:'rgba(60,120,80,.08)',border:'#335533'},
    {id:'player_hand',type:'hand',player:'p1',label:"Your Hand",icon:'âœ‹',x:10,y:425,w:w-190,h:140,color:'rgba(68,136,204,.08)',border:'#334466'},
    {id:'player_deck',type:'draw',player:'p1',label:"Deck",icon:'ğŸ“š',x:w-180,y:425,w:80,h:65,color:'rgba(201,168,76,.08)',border:'#665533'},
    {id:'player_discard',type:'discard',player:'p1',label:"Discard",icon:'ğŸ—‘',x:w-90,y:425,w:80,h:65,color:'rgba(180,60,60,.08)',border:'#553333'},
    {id:'player_grave',type:'graveyard',player:'p1',label:"Grave",icon:'ğŸ’€',x:w-180,y:495,w:80,h:70,color:'rgba(100,80,80,.12)',border:'#443333'},
    {id:'construct_stage',type:'construct_stage',player:'p1',label:"Construct",icon:'ğŸ”§',x:w-90,y:495,w:80,h:70,color:'rgba(136,85,204,.1)',border:'#553388'},
  ];
}
function lanesDefaultZones(w,h){
  const laneW=Math.floor((w-40)/3);
  const zones=[];
  ['LEFT','CENTER','RIGHT'].forEach((name,i)=>{
    const x=10+i*(laneW+10);
    zones.push({id:`lane_opp_${i}`,type:'lane',player:'p2',label:`${name} (Opp)`,icon:'ğŸ”´',x,y:40,w:laneW,h:160,color:'rgba(200,80,80,.08)',border:'#664444'});
    zones.push({id:`lane_mid_${i}`,type:'score',player:'shared',label:`${name} LANE`,icon:'ğŸ›£',x,y:205,w:laneW,h:30,color:'rgba(80,80,80,.1)',border:'#444'});
    zones.push({id:`lane_pl_${i}`,type:'lane',player:'p1',label:`${name} (You)`,icon:'ğŸŸ¢',x,y:240,w:laneW,h:160,color:'rgba(60,120,80,.08)',border:'#335533'});
  });
  zones.push({id:'hand_opp',type:'hand',player:'p2',label:'Opp Hand',icon:'ğŸ¤š',x:10,y:5,w:w-20,h:30,color:'rgba(200,80,80,.05)',border:'#443333'});
  zones.push({id:'hand_pl',type:'hand',player:'p1',label:'Your Hand',icon:'âœ‹',x:10,y:405,w:w-20,h:140,color:'rgba(68,136,204,.08)',border:'#334466'});
  return zones;
}
function coopDefaultZones(w,h){
  return [
    {id:'combo_stack',type:'combo_stack',player:'shared',label:'COMBO STACK',icon:'ğŸ”—',x:10,y:80,w:w-20,h:140,color:'rgba(200,100,200,.1)',border:'#884488'},
    {id:'p1_hand',type:'hand',player:'p1',label:'P1 Hand',icon:'âœ‹',x:10,y:230,w:Math.floor(w/2)-15,h:120,color:'rgba(68,136,204,.08)',border:'#334466'},
    {id:'p2_hand',type:'hand',player:'p2',label:'P2 Hand',icon:'âœ‹',x:Math.floor(w/2)+5,y:230,w:Math.floor(w/2)-15,h:120,color:'rgba(204,136,68,.08)',border:'#664433'},
    {id:'score_display',type:'score',player:'shared',label:'COMBO SCORE',icon:'ğŸ†',x:10,y:10,w:w-20,h:60,color:'rgba(201,168,76,.08)',border:'#665533'},
    {id:'p1_deck',type:'draw',player:'p1',label:'P1 Deck',icon:'ğŸ“š',x:10,y:360,w:80,h:70,color:'rgba(201,168,76,.06)',border:'#665533'},
    {id:'p2_deck',type:'draw',player:'p2',label:'P2 Deck',icon:'ğŸ“š',x:w-90,y:360,w:80,h:70,color:'rgba(201,168,76,.06)',border:'#665533'},
  ];
}
function buildGridOverlay(game){
  const size=G.grid.size;
  const cellSize=72;
  const board=document.getElementById('board');
  const gridW=size*cellSize,gridH=size*cellSize;
  board.style.width=(gridW+20)+'px';
  board.style.height=(gridH+100)+'px';
  const gridEl=document.createElement('div');
  gridEl.id='gridOverlay';
  gridEl.style.cssText=`position:absolute;left:10px;top:10px;width:${gridW}px;height:${gridH}px;`;
  for(let r=0;r<size;r++){
    for(let c=0;c<size;c++){
      const cell=document.createElement('div');
      cell.style.cssText=`position:absolute;left:${c*cellSize}px;top:${r*cellSize}px;width:${cellSize}px;height:${cellSize}px;border:1px solid var(--border);border-radius:3px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s;`;
      cell.id=`gcell_${r}_${c}`;
      if(r<Math.floor(size/2))cell.style.background='rgba(200,80,80,.04)';
      else cell.style.background='rgba(60,120,80,.04)';
      cell.addEventListener('click',()=>gridCellClick(r,c));
      cell.addEventListener('mouseenter',()=>{if(!G.grid.cells[r][c])cell.style.background='rgba(201,168,76,.1)';});
      cell.addEventListener('mouseleave',()=>{if(!G.grid.cells[r][c])cell.style.background=r<Math.floor(size/2)?'rgba(200,80,80,.04)':'rgba(60,120,80,.04)';});
      gridEl.appendChild(cell);
    }
  }
  if(G.game.mode==='traverse'&&G.crystals){
    [G.crystals.p1,G.crystals.p2].forEach((crys,i)=>{
      const cx=document.createElement('div');
      cx.id='crystal_p'+(i+1);
      cx.style.cssText=`position:absolute;left:${crys.c*cellSize+cellSize/2-20}px;top:${crys.r*cellSize+cellSize/2-20}px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:24px;pointer-events:none;`;
      cx.textContent='ğŸ”®';
      gridEl.appendChild(cx);
    });
  }
  board.appendChild(gridEl);
  const handZone=document.createElement('div');
  handZone.className='play-zone';
  handZone.id='grid_hand_zone';
  handZone.style.cssText=`left:10px;top:${gridH+15}px;width:${gridW}px;height:70px;border-color:var(--blue);background:rgba(51,119,204,.08);`;
  handZone.innerHTML=`<div class="pz-header"><span class="pz-icon">âœ‹</span><span class="pz-label">YOUR HAND â€” click card then click grid cell</span></div><div class="pz-cards" id="pzCards_grid_hand"></div>`;
  board.appendChild(handZone);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER BOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBoard(){
  if(!G)return;
  const mode=G.game.mode;
  if(mode==='grid'||mode==='traverse'){renderGrid();return;}
  if(mode==='lanes'){renderLanes();return;}
  if(mode==='coop'){renderCoop();return;}
  renderStandard();
}
function renderStandard(){
  if(!G)return;
  const layout=G.layout;
  const board=document.getElementById('board');
  board.querySelectorAll('.pz-cards').forEach(el=>el.innerHTML='');
  board.querySelectorAll('.pz-count').forEach(el=>el.textContent='');
  const zones=layout?.zones||defaultZones(G.game.mode||'standard',820,580);
  const p1=G.players[0], p2=G.players[1]||G.players[0];
  zones.forEach(z=>{
    const el=document.getElementById('pzCards_'+z.id)||document.getElementById('pzCards_'+z.id);
    const countEl=document.getElementById('pzc_'+z.id);
    if(!el)return;
    const player=z.player==='p2'?p2:p1;
    switch(z.type){
      case 'hand':
        const cards=z.player==='p2'?p2.hand:p1.hand;
        el.innerHTML=cards.map((c,i)=>{
          const pi=z.player==='p2'?1:0;
          return renderMiniCard(c,pi,'hand',i,z.player==='p2');
        }).join('');
        if(countEl)countEl.textContent=cards.length;
        break;
      case 'battlefield':
        const fieldCards=z.player==='p2'?p2.field:p1.field;
        el.innerHTML=fieldCards.map((c,i)=>renderMiniCard(c,z.player==='p2'?1:0,'field',i,false)).join('');
        if(countEl)countEl.textContent=fieldCards.length;
        break;
      case 'draw':
        const deck=z.player==='p2'?p2.deck:p1.deck;
        if(countEl)countEl.textContent=deck.length+'ğŸ“š';
        el.innerHTML=deck.length?`<div class="mc face-down"><div class="mc-emoji">ğŸ“š</div><div class="mc-name">${deck.length}</div></div>`:'';
        break;
      case 'discard':
        const grave=z.player==='p2'?p2.graveyard:p1.graveyard;
        if(countEl)countEl.textContent=grave.length;
        el.innerHTML=grave.slice(-3).map(c=>renderMiniCard(c,-1,'grave',0,false)).join('');
        break;
      case 'graveyard':
        const gv=z.player==='p2'?p2.graveyard:p1.graveyard;
        if(countEl)countEl.textContent=gv.length;
        el.innerHTML=gv.slice(-3).map(c=>renderMiniCard(c,-1,'grave',0,false)).join('');
        break;
      case 'score':
        if(countEl)countEl.textContent=p1.score;
        break;
      case 'combo_stack':
        el.innerHTML=G.comboStack.map((c,i)=>renderMiniCard(c,0,'combo',i,false)).join('');
        if(countEl)countEl.textContent=`${G.comboStack.length} cards`;
        break;
      case 'construct_stage':
        const cs=G.constructStage||[];
        el.innerHTML=cs.map((c,i)=>`<div onclick="useConstructCard(${i})">${renderMiniCard(c,0,'construct',i,false)}</div>`).join('');
        if(countEl)countEl.textContent=cs.length;
        break;
    }
  });
}
function renderMiniCard(c, pi, source, idx, faceDown){
  if(!c)return '';
  const sel=G.selCard?._id===c._id;
  const statusIcons=[];
  if(c._frozen)statusIcons.push('<span class="si" style="background:#3399ff20">â„</span>');
  if(c._silenced)statusIcons.push('<span class="si" style="background:#99336620">ğŸ”‡</span>');
  if(c._poisonCounters>0)statusIcons.push(`<span class="si" style="background:#33cc4420">â˜ ${c._poisonCounters}</span>`);
  if(c._stealthed)statusIcons.push('<span class="si" style="background:#33336620">ğŸ‘</span>');
  const typeColors={creature:'#334466',spell:'#443366',trap:'#443333',item:'#334433',field_card:'#334433',fusion:'#443355',token:'#444433',tactic:'#664433',construct:'#553344'};
  const borderC=typeColors[c.type]||'var(--border2)';
  if(faceDown)return `<div class="mc face-down" title="Face down"><div class="mc-emoji">ğŸ‚ </div></div>`;
  return `<div class="mc${sel?' selected':''}${c._tapped?' tapped':''}" 
    style="border-color:${sel?'var(--gold2)':borderC};"
    onclick="selectCard(${JSON.stringify(c).replace(/"/g,'&quot;')},${pi},'${source}',{${source==='hand'?`handIdx:${idx}`:source==='field'?`fieldIdx:${idx}`:''}})"
    title="${esc(c.name)}">
    <div class="status-icons">${statusIcons.join('')}</div>
    <div class="mc-emoji">${c.emoji||'ğŸƒ'}</div>
    <div class="mc-name">${esc(c.name)}</div>
    ${c._atk||c._hp?`<div class="mc-stats">${c._atk?`<span>âš”${c._atk}</span>`:''}${c._hp?`<span>â¤${c._hp}</span>`:''}</div>`:''}
    ${(c.keywords||[]).length?`<div class="mc-kw">${c.keywords.slice(0,2).join(' Â· ')}</div>`:''}
  </div>`;
}
function renderLanes(){
  if(!G||!G.lanes)return;
  const p1=G.players[0],p2=G.players[1]||G.players[0];
  // Render hand
  const handEl=document.getElementById('pzCards_hand_pl');
  if(handEl)handEl.innerHTML=p1.hand.map((c,i)=>renderMiniCard(c,0,'hand',i,false)).join('');
  const oppHand=document.getElementById('pzCards_hand_opp');
  if(oppHand)oppHand.innerHTML=p2.hand.map(()=>`<div class="mc face-down"></div>`).join('');
  G.lanes.forEach((lane,i)=>{
    const plEl=document.getElementById('pzCards_lane_pl_'+i);
    const oppEl=document.getElementById('pzCards_lane_opp_'+i);
    const midEl=document.getElementById('pzc_lane_mid_'+i);
    if(plEl)plEl.innerHTML=lane.player?renderMiniCard(lane.player,0,'field',i,false):'';
    if(oppEl)oppEl.innerHTML=lane.opp?renderMiniCard(lane.opp,1,'opp_field',i,false):'';
    if(midEl)midEl.innerHTML=lane.playerWon?'âœ…':lane.oppWon?'âŒ':'';
    const plZone=document.getElementById('pz_default_lane_p1_lane_pl_'+i)||document.getElementById('pz_lane_p1_lane_pl_'+i);
    if(plZone)plZone.style.cursor='pointer';
    if(plZone&&!lane.player&&G.selCard?.source==='hand'){
      plZone.onclick=()=>playCardToLane(0,i);
    }
  });
}
function playCardToLane(pi,laneIdx){
  const p=G.players[pi];
  if(!G.selCard||G.selCard.source!=='hand')return;
  const idx=G.selCard.handIdx;
  const card=p.hand[idx];
  if(!card)return;
  if(G.game.rules?.resourceSystem&&card.cost>p.res)return glog('Not enough resources.','bad');
  if(G.game.rules?.resourceSystem)p.res-=card.cost||0;
  p.hand.splice(idx,1);
  G.lanes[laneIdx].player={...card,_who:'player',_tapped:false};
  G.selCard=null;
  glog(`${p.name} plays ${card.name} to ${G.lanes[laneIdx].name}.`,'good');
  renderBoard();renderPlayerBars();renderInfoPanel();
}
function renderCoop(){
  if(!G)return;
  const p1=G.players[0],p2=G.players[1]||G.players[0];
  const p1h=document.getElementById('pzCards_p1_hand');if(p1h)p1h.innerHTML=p1.hand.map((c,i)=>renderMiniCard(c,0,'hand',i,false)).join('');
  const p2h=document.getElementById('pzCards_p2_hand');if(p2h)p2h.innerHTML=p2.hand.map((c,i)=>renderMiniCard(c,1,'hand',i,false)).join('');
  const cs=document.getElementById('pzCards_combo_stack');if(cs)cs.innerHTML=G.comboStack.map((c,i)=>renderMiniCard(c,0,'combo',i,false)).join('');
  const sc=document.getElementById('pzc_score_display');if(sc)sc.textContent='Score: '+G.comboScore;
  const pd1=document.getElementById('pzc_p1_deck');if(pd1)pd1.textContent=p1.deck.length+'ğŸ“š';
  const pd2=document.getElementById('pzc_p2_deck');if(pd2)pd2.textContent=p2.deck.length+'ğŸ“š';
}
function renderGrid(){
  if(!G||!G.grid)return;
  const size=G.grid.size;
  const cellSize=72;
  for(let r=0;r<size;r++){
    for(let c=0;c<size;c++){
      const cell=document.getElementById(`gcell_${r}_${c}`);
      if(!cell)continue;
      const card=G.grid.cells[r][c];
      if(card){
        cell.innerHTML=`<div class="mc${card._tapped?' tapped':''}" style="width:60px;height:60px;" onclick="selectCard(${JSON.stringify(card).replace(/"/g,'&quot;')},${card._owner==='p1'?0:1},'field',0,false)">
          <div class="mc-emoji">${card.emoji||'ğŸƒ'}</div>
          <div class="mc-name" style="font-size:5px;">${esc(card.name)}</div>
          <div class="mc-stats" style="font-size:7px;">${card._atk?`âš”${card._atk}`:''}â¤${card._hp}</div>
        </div>`;
        cell.style.background=card._owner==='p1'?'rgba(51,119,204,.15)':'rgba(204,68,68,.15)';
      } else {
        cell.innerHTML='';
        if(G.game.mode==='traverse'&&G.items){
          const item=G.items.find(it=>it.r===r&&it.c===c&&!it.collected);
          if(item)cell.innerHTML=`<span style="font-size:22px;">${item.emoji}</span>`;
        }
        cell.style.background=r<Math.floor(size/2)?'rgba(200,80,80,.04)':'rgba(60,120,80,.04)';
      }
    }
  }
  if(G.crystals){
    ['p1','p2'].forEach(k=>{const crys=G.crystals[k];const el=document.getElementById('crystal_'+k);if(el)el.style.display=crys.hp>0?'flex':'none';});
  }
  const handEl=document.getElementById('pzCards_grid_hand');
  if(handEl)handEl.innerHTML=G.players[0].hand.map((c,i)=>renderMiniCard(c,0,'hand',i,false)).join('');
}
function gridCellClick(r,c){
  if(!G||!G.grid)return;
  const sel=G.selCard;
  if(!sel)return;
  if(G.grid.cells[r][c]){
    // Attack target
    const target=G.grid.cells[r][c];
    if(sel.source==='field'&&sel._owner!==target._owner){
      resolveCombat(G.players[G.activePlayer].field.find(x=>x._id===sel._id)||sel,target,G.players[G.activePlayer],G.players.find(p=>p.id!==G.players[G.activePlayer].id));
      G.selCard=null;
    }
    return;
  }
  if(sel.source==='hand'){
    const p=G.players[G.activePlayer];
    if(G.game.rules?.resourceSystem&&sel.cost>p.res)return glog('Not enough resources.','bad');
    if(G.game.rules?.resourceSystem)p.res-=sel.cost||0;
    const idx=p.hand.indexOf(p.hand.find(c=>c._id===sel._id));
    if(idx>=0)p.hand.splice(idx,1);
    sel._owner=p.id;sel._tapped=!(hasKw(sel,'Haste')||hasKw(sel,'Charge'));
    G.grid.cells[r][c]=sel;sel._y=r;sel._x=c;
    glog(`${p.name} places ${sel.name} at [${r},${c}].`,'good');
    G.selCard=null;
    renderBoard();renderPlayerBars();renderInfoPanel();
  } else if(sel.source==='field'&&sel._movesLeft>0&&!sel._tapped){
    const prevR=sel._y||0,prevC=sel._x||0;
    if(G.grid.cells[prevR][prevC]===sel){G.grid.cells[prevR][prevC]=null;}
    G.grid.cells[r][c]=sel;sel._y=r;sel._x=c;sel._movesLeft--;
    glog(`${sel.name} moved to [${r},${c}].`);
    G.selCard=null;
    renderBoard();renderInfoPanel();
  }
  // Collect items (traverse mode)
  if(G.game.mode==='traverse'&&G.items){
    const item=G.items.find(it=>it.r===r&&it.c===c&&!it.collected);
    if(item&&sel){
      item.collected=true;
      const p=G.players[G.activePlayer];
      if(item.effect==='gain_res')p.res=Math.min(p.maxRes,p.res+item.value);
      glog(`Collected ${item.name}! +${item.value} resources.`,'good');
      renderPlayerBars();
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INFO PANEL (card detail sheet)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderInfoPanel(){
  const el=document.getElementById('infoPanel');
  if(!el||!G)return;
  const c=G.selCard;
  if(!c){
    el.innerHTML=`<p class="no-card-hint">Tap any card on the board to see its details and available actions here.</p>`;
    document.getElementById('cardSheetTitle').textContent='CARD DETAILS';
    return;
  }
  document.getElementById('cardSheetTitle').textContent=esc(c.name||'CARD');
  const pi=G.selOwner??0;
  let html=`<div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
      <span style="font-size:32px;">${c.emoji||'ğŸƒ'}</span>
      <div>
        <div class="icp-name">${esc(c.name)}</div>
        <div style="font-size:11px;color:var(--text3);">${esc(c.type||'')} ${c.cost?`Â· Cost: ${c.cost}ğŸ’`:''}</div>
      </div>
    </div>
    ${c._hp?`<div class="icp-stat"><span>HP</span><span style="color:var(--red2)">${c._hp} / ${c.hp}</span></div>`:''}
    ${c._atk?`<div class="icp-stat"><span>ATK</span><span>${c._atk}</span></div>`:''}
    ${c._def?`<div class="icp-stat"><span>DEF</span><span>${c._def}</span></div>`:''}
    ${c.cost?`<div class="icp-stat"><span>Cost</span><span style="color:var(--blue2)">${c.cost}ğŸ’</span></div>`:''}
    ${c._move?`<div class="icp-stat"><span>Move</span><span>${c._movesLeft||c._move} / ${c._move}</span></div>`:''}
    ${c._poisonCounters?`<div class="icp-stat"><span>Poison</span><span style="color:var(--green2)">${c._poisonCounters}â˜ </span></div>`:''}
    ${(c.keywords||[]).length?`<div class="icp-kw-row">${c.keywords.map(k=>`<span class="icp-kw">${k}</span>`).join('')}</div>`:''}
    ${c.rules?`<div class="icp-text">${esc(c.rules.slice(0,200))}</div>`:''}
  </div>`;
  // Actions
  html+=`<div class="card-action-row">`;
  if(c.source==='hand'&&pi===G.activePlayer){
    html+=`<button class="primary" onclick="playCardFromHand(${pi},${c.handIdx})">â–¶ PLAY TO FIELD</button>`;
  }
  if(c.source==='field'&&pi===G.activePlayer&&!c._tapped){
    html+=`<button onclick="attackDirectly(${pi},G.players[${pi}].field[${c.fieldIdx}])">âš” ATTACK</button>`;
  }
  html+=`<button onclick="G.selCard=null;renderBoard();renderInfoPanel();closeSheet('cardSheet');">DESELECT</button>`;
  html+=`</div>`;
  // Attacks
  if((c.attacks||[]).length){
    html+=`<div style="font-family:Cinzel,serif;font-size:9px;color:var(--text3);letter-spacing:.06em;margin:12px 0 6px;">ATTACKS</div>`;
    c.attacks.forEach((atk,ai)=>{
      const fxDesc=(atk.effects||[]).map(ef=>`${ef.type} ${ef.value>0?'+':''}${ef.value} (${ef.target})`).join(', ');
      html+=`<button class="atk-btn" onclick="useAttack(${JSON.stringify(c.fieldIdx)},${ai})">
        <span class="ab-name">${esc(atk.name)}</span>
        <span class="ab-cost">${atk.cost||0}ğŸ’</span>
        <div class="ab-fx">${fxDesc||'No effects defined'}</div>
      </button>`;
    });
  }
  el.innerHTML=html;
}
function useAttack(fieldIdx,atkIdx){
  if(fieldIdx===undefined||fieldIdx===null)return;
  const pi=G.activePlayer;
  const p=G.players[pi];
  const card=p.field[fieldIdx];
  if(!card)return;
  const atk=card.attacks?.[atkIdx];
  if(!atk)return;
  if(card._tapped)return glog(`${card.name} has already acted.`,'bad');
  if(G.game.rules?.resourceSystem&&atk.cost>p.res)return glog(`Not enough resources for ${atk.name}.`,'bad');
  if(G.game.rules?.resourceSystem)p.res-=atk.cost||0;
  const oppP=G.players.find(x=>x.id!==p.id);
  (atk.effects||[]).forEach(ef=>{
    let targetCard=null,targetOwner=null;
    switch(ef.target){
      case 'opp_card': targetCard=oppP?.field[0]||null; targetOwner=oppP; break;
      case 'opp_all': oppP?.field.forEach(tc=>applyEffects([ef],card,p,tc,oppP)); return;
      case 'opp_player': targetOwner=oppP; break;
      case 'self_card': targetCard=card; targetOwner=p; break;
      case 'ally_card': targetCard=p.field.find(c=>c._id!==card._id)||null; targetOwner=p; break;
      case 'all_allies': p.field.filter(c=>c._id!==card._id).forEach(tc=>applyEffects([ef],card,p,tc,p)); return;
      case 'all_field': [...(p.field||[]),...(oppP?.field||[])].forEach(tc=>applyEffects([ef],card,p,tc,null)); return;
      case 'nearest_enemy': targetCard=oppP?.field[0]||null; targetOwner=oppP; break;
    }
    applyEffects([ef],card,p,targetCard,targetOwner);
  });
  glog(`${card.name} uses ${atk.name}.`,'atk');
  card._tapped=true;
  if(hasKw(card,'Vigilance'))card._tapped=false;
  checkDead(); checkWin();
  renderBoard(); renderPlayerBars(); renderInfoPanel();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYER BARS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPlayerBars(){
  const el=document.getElementById('playerBars');
  const bgMode=isBoardGameMode();
  el.innerHTML=G.players.map((p,i)=>`
    <div class="pstat-bar${i===G.activePlayer?' active':''}">
      <span class="psb-name">${esc(p.name)}</span>
      ${bgMode?'':`<span class="psb-hp" style="color:${(p.maxHp>0)?(p.hp/p.maxHp>.5?'var(--green2)':p.hp/p.maxHp>.25?'var(--gold2)':'var(--red2)'):'var(--text2)'}">â¤${p.hp}</span>`}
      ${!bgMode&&G.game.mode==='traverse'?`<span style="font-size:10px;color:var(--blue2);">ğŸ”®${p.id==='p1'?G.crystals?.p1.hp:G.crystals?.p2.hp}</span>`:''}
      ${bgMode?'':`<span class="psb-res">ğŸ’${p.res}/${p.maxRes}</span>`}
      ${bgMode?'':`<span class="psb-hand">âœ‹${p.hand.length} ğŸ“š${p.deck.length}</span>`}
      ${bgMode?`<span style="font-size:10px;color:var(--text2);">Pieces: ${pieces.filter(pc=>pc.label?.includes(p.name)||false).length||'â€”'}</span>`:''}
      ${i===G.activePlayer?`<span style="font-size:8px;color:var(--gold);margin-left:auto;">â–¶ ACTIVE</span>`:''}
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI TURN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function aiTurn(){
  if(!G||G.over)return;
  const ai=G.players[G.activePlayer];
  if(!ai.isAI)return;
  glog(`${ai.name} is thinkingâ€¦`);
  ai.res=Math.min(ai.maxRes,ai.res+(G.game.resPerTurn||3));
  applyStartOfTurnEffects(ai);
  const player=G.players.find(x=>!x.isAI);
  const style=G.game.aiStyle||'aggressive';
  const diff=G.game.aiDiff||'medium';
  let played=0;
  const maxPlay=diff==='hard'?5:diff==='medium'?3:2;
  let sortedHand=[...ai.hand];
  if(style==='aggressive')sortedHand.sort((a,b)=>(b.atk||0)-(a.atk||0));
  else if(style==='control')sortedHand.sort((a,b)=>(b.hp||0)-(a.hp||0));
  for(const card of sortedHand){
    if(played>=maxPlay)break;
    if(G.game.rules?.resourceSystem&&card.cost>ai.res)continue;
    const mode=G.game.mode;
    if(mode==='grid'||mode==='traverse'){
      const size=G.grid.size;
      let placed=false;
      for(let r=0;r<Math.ceil(size/2)&&!placed;r++){
        for(let c=0;c<size&&!placed;c++){
          if(!G.grid.cells[r][c]){
            if(G.game.rules?.resourceSystem)ai.res-=card.cost;
            ai.hand.splice(ai.hand.indexOf(card),1);
            card._owner=ai.id;card._tapped=!(hasKw(card,'Haste')||hasKw(card,'Charge'));
            G.grid.cells[r][c]=card;
            glog(`${ai.name} places ${card.name} at [${r},${c}].`);
            placed=true;played++;
          }
        }
      }
    } else if(mode==='lanes'){
      const emptyLane=G.lanes.findIndex(l=>!l.opp);
      if(emptyLane>=0){
        if(G.game.rules?.resourceSystem)ai.res-=card.cost;
        ai.hand.splice(ai.hand.indexOf(card),1);
        G.lanes[emptyLane].opp={...card,_who:'opp',_tapped:false};
        glog(`${ai.name} plays ${card.name} in ${G.lanes[emptyLane].name}.`);
        played++;
      }
    } else {
      if(ai.field.length<(G.game.maxField||6)){
        if(G.game.rules?.resourceSystem)ai.res-=card.cost;
        ai.hand.splice(ai.hand.indexOf(card),1);
        card._tapped=!(hasKw(card,'Haste')||hasKw(card,'Charge'));
        ai.field.push(card);
        glog(`${ai.name} plays ${card.name}.`);
        played++;
      }
    }
  }
  setTimeout(()=>{
    const mode=G.game.mode;
    if(mode==='grid'||mode==='traverse'){aiGridAttack(ai, player);}
    else if(mode==='lanes'){aiLanesAttack(ai, player);}
    else{aiStandardAttack(ai, player);}
    setTimeout(()=>{glog(`${ai.name} ends turn.`);endTurn();},400);
  },400);
}
function aiStandardAttack(ai, player){
  ai.field.forEach(c=>{
    if(c._tapped||c._frozen)return;
    if(hasKw(c,'Defender'))return;
    if(player.field.length){
      let target=player.field.find(t=>hasKw(t,'Taunt'))||player.field[0];
      if(G.game.aiStyle==='aggressive')target=player.field.sort((a,b)=>a._hp-b._hp)[0];
      resolveCombat(c,target,ai,player);
    } else {
      attackDirectly(G.players.indexOf(ai),c);
    }
  });
}
function aiGridAttack(ai, player){
  const size=G.grid.size;
  for(let r=0;r<size;r++){
    for(let c=0;c<size;c++){
      const card=G.grid.cells[r][c];
      if(!card||card._owner!==ai.id||card._tapped||card._frozen)continue;
      const adj=[[r-1,c],[r+1,c],[r,c-1],[r,c+1]];
      let attacked=false;
      for(const [nr,nc] of adj){
        if(nr>=0&&nc>=0&&nr<size&&nc<size){
          const target=G.grid.cells[nr][nc];
          if(target&&target._owner===player.id){
            resolveCombat(card,target,ai,player);attacked=true;break;
          }
          if(G.game.mode==='traverse'&&G.crystals&&G.crystals.p1.r===nr&&G.crystals.p1.c===nc){
            G.crystals.p1.hp-=card._atk;
            glog(`${card.name} attacks P1 Crystal for ${card._atk}!`,'atk');
            card._tapped=true;attacked=true;checkWin();break;
          }
        }
      }
      if(!attacked){
        let targetR=size-1,targetC=Math.floor(size/2);
        if(G.game.mode==='traverse'&&G.crystals)targetR=G.crystals.p1.r,targetC=G.crystals.p1.c;
        else if(player.field.length){const pf=player.field[0];targetR=pf._y||size-1;targetC=pf._x||Math.floor(size/2);}
        const dr=targetR>r?1:targetR<r?-1:0;
        const dc=targetC>c?1:targetC<c?-1:0;
        if(dr&&!G.grid.cells[r+dr]?.[c]){G.grid.cells[r+dr][c]=card;G.grid.cells[r][c]=null;card._y=r+dr;}
        else if(dc&&!G.grid.cells[r]?.[c+dc]){G.grid.cells[r][c+dc]=card;G.grid.cells[r][c]=null;card._x=c+dc;}
      }
    }
  }
}
function aiLanesAttack(ai, player){
  G.lanes.forEach((lane,i)=>{
    if(!lane.opp||lane.opp._tapped)return;
    if(lane.player){
      resolveCombat(lane.opp,lane.player,ai,player);
      if(!lane.player){lane.oppWon=true;glog(`Opp wins ${lane.name}.`,'bad');}
    } else {
      player.hp-=lane.opp._atk;
      glog(`${lane.opp.name} attacks you directly for ${lane.opp._atk}!`,'bad');
      checkWin();
    }
    if(lane.opp)lane.opp._tapped=true;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FUSION / CONSTRUCT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function useConstructCard(idx){
  const card=G.constructStage[idx];
  if(!card)return;
  G.selCard={...card,source:'construct',constructIdx:idx};
  renderInfoPanel();
  openSheet('cardSheet');
  glog(`${card.name} selected from construct stage.`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIGN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resignGame(){
  if(!confirm('Resign? Return to game select?'))return;
  G=null;
  document.getElementById('gameScreen').style.display='none';
  const ss=document.getElementById('setupScreen');ss.style.display='flex';
  loadData(); renderSetup();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DICE ROLLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let diceHistory=[];
function toggleDicePanel(){
  const p=document.getElementById('dicePanel');
  const open=p.classList.toggle('open');
  // Close all sheets when opening dice
  if(open){
    document.querySelectorAll('.pull-sheet').forEach(s=>s.classList.remove('open'));
    document.querySelectorAll('.foot-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('fb-dice').classList.add('active');
  } else {
    document.getElementById('fb-dice').classList.remove('active');
  }
}
function rollDie(sides){rollCustomDice(1,sides);}
function rollCustom(){
  const qty=Math.max(1,Math.min(10,+document.getElementById('diceQty').value||1));
  const sides=Math.max(2,Math.min(100,+document.getElementById('diceSides').value||6));
  rollCustomDice(qty,sides);
}
function rollCustomDice(qty,sides){
  const results=[];
  for(let i=0;i<qty;i++) results.push(1+Math.floor(Math.random()*sides));
  const total=results.reduce((a,b)=>a+b,0);
  const formula=`${qty}d${sides}`;
  const detail=qty>1?` (${results.join('+')})`:''
  const resEl=document.getElementById('diceResult');
  const fmEl=document.getElementById('diceFormula');
  resEl.textContent='â€¦';
  fmEl.textContent=formula+detail;
  document.querySelectorAll('.die-btn').forEach(b=>{if(b.textContent==='d'+sides||b.textContent==='ROLL'){b.classList.add('rolling');setTimeout(()=>b.classList.remove('rolling'),450);}});
  setTimeout(()=>{
    resEl.textContent=total;
    fmEl.textContent=formula+detail+(qty>1?` = ${total}`:'');
    const entry=`${formula}: ${total}${detail}`;
    diceHistory.unshift(entry);
    if(diceHistory.length>20)diceHistory.pop();
    document.getElementById('diceHistory').innerHTML=diceHistory.slice(0,8).map(e=>`<div style="border-bottom:1px solid rgba(255,255,255,.04);padding:1px 0;">${e}</div>`).join('');
    if(G)glog(`ğŸ² Rolled ${entry}`,'');
  },280);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COUNTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let gameCounters=[];
function initCounters(){
  gameCounters=[];
  const defaults=[
    {id:'score',label:'Score',perPlayer:true},
    {id:'round',label:'Round',perPlayer:false},
    {id:'custom1',label:'Counter 1',perPlayer:true},
    {id:'custom2',label:'Counter 2',perPlayer:true},
  ];
  const players=G?.players||[];
  defaults.forEach(d=>{
    const vals={shared:0};
    players.forEach(p=>vals[p.id]=0);
    gameCounters.push({...d,vals});
  });
}
function renderCounterPanel(){
  const el=document.getElementById('counterPanel');
  if(!el)return;
  const players=G?.players||[];
  let html='';
  if(G&&isBoardGameMode()&&G.layout?.zones){
    const spaces=G.layout.zones.filter(z=>z.type==='space'&&z.claimable);
    if(spaces.length){
      html+=`<div style="font-family:'Cinzel',serif;font-size:9px;color:var(--text3);letter-spacing:.07em;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border);">OWNED SPACES</div>`;
      players.forEach((p,i)=>{
        const owned=spaces.filter(z=>G.zoneOwners[z.id]===i);
        const col=PLAYER_COLORS[i%PLAYER_COLORS.length];
        html+=`<div class="owned-spaces-row" style="border-color:${col}22;">
          <span class="osn" style="color:${col};">${esc(p.name)}</span>
          <span class="osc" style="color:${col};">${owned.length} space${owned.length!==1?'s':''}</span>
        </div>`;
      });
      const unclaimed=spaces.filter(z=>G.zoneOwners[z.id]==null);
      html+=`<div class="owned-spaces-row"><span style="font-size:10px;color:var(--text3);">Unclaimed</span><span style="font-size:10px;color:var(--text3);">${unclaimed.length}</span></div>`;
      html+='<div style="height:8px;"></div>';
    }
  }
  html+=`<button onclick="addCustomCounter()" style="width:100%;margin-bottom:8px;background:var(--bg3);border:1px solid var(--border2);color:var(--text2);padding:8px;border-radius:5px;font-family:'Cinzel',serif;font-size:9px;cursor:pointer;">+ ADD COUNTER</button>`;
  gameCounters.forEach((ctr,ci)=>{
    html+=`<div class="ctr-block">`;
    html+=`<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">`;
    html+=`<input value="${esc(ctr.label)}" oninput="gameCounters[${ci}].label=this.value" style="flex:1;background:var(--bg2);border:1px solid var(--border);color:var(--gold2);padding:4px 8px;border-radius:4px;font-family:'Cinzel',serif;font-size:9px;">`;
    html+=`<button onclick="removeCounter(${ci})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:14px;line-height:1;">âœ•</button>`;
    html+='</div>';
    if(ctr.perPlayer){
      players.forEach(p=>{
        const v=ctr.vals[p.id]||0;
        html+=`<div class="ctr-row">
          <span class="ctr-label">${esc(p.name)}</span>
          <button class="ctr-btn" onclick="adjCtr(${ci},'${p.id}',-1)">âˆ’</button>
          <span class="ctr-val" id="cv_${ci}_${p.id}">${v}</span>
          <button class="ctr-btn" onclick="adjCtr(${ci},'${p.id}',1)">+</button>
        </div>`;
      });
    } else {
      const v=ctr.vals.shared||0;
      html+=`<div class="ctr-row">
        <span class="ctr-label" style="color:var(--text);">Shared</span>
        <button class="ctr-btn" onclick="adjCtr(${ci},'shared',-1)">âˆ’</button>
        <span class="ctr-val" id="cv_${ci}_shared">${v}</span>
        <button class="ctr-btn" onclick="adjCtr(${ci},'shared',1)">+</button>
      </div>`;
    }
    html+='</div>';
  });
  el.innerHTML=html;
}
function renderCounters(){renderCounterPanel();}
function adjCtr(ci,key,delta){
  if(!gameCounters[ci])return;
  gameCounters[ci].vals[key]=(gameCounters[ci].vals[key]||0)+delta;
  const el=document.getElementById(`cv_${ci}_${key}`);
  if(el)el.textContent=gameCounters[ci].vals[key];
}
function addCustomCounter(){
  const players=G?.players||[];
  const vals={shared:0};
  players.forEach(p=>vals[p.id]=0);
  gameCounters.push({id:'c'+Date.now(),label:'Counter '+(gameCounters.length+1),perPlayer:true,vals});
  renderCounterPanel();
}
function removeCounter(ci){gameCounters.splice(ci,1);renderCounterPanel();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PIECE TOKENS (draggable)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pieces=[];
let selPiece=null;
let pieceDrag=null;

const PIECE_PRESETS=[
  {emoji:'âšª',color:'rgba(220,220,220,.2)',border:'#ccc',label:'White'},
  {emoji:'âš«',color:'rgba(40,40,40,.4)',border:'#666',label:'Black'},
  {emoji:'ğŸ”´',color:'rgba(204,68,68,.25)',border:'#cc4444',label:'Red'},
  {emoji:'ğŸ”µ',color:'rgba(68,136,204,.25)',border:'#4488cc',label:'Blue'},
  {emoji:'ğŸŸ¢',color:'rgba(68,204,68,.25)',border:'#44cc44',label:'Green'},
  {emoji:'ğŸŸ¡',color:'rgba(201,168,76,.25)',border:'#c9a84c',label:'Yellow'},
  {emoji:'ğŸŸ£',color:'rgba(136,68,204,.25)',border:'#8844cc',label:'Purple'},
  {emoji:'ğŸŸ ',color:'rgba(204,120,40,.25)',border:'#cc7828',label:'Orange'},
  {emoji:'ğŸ’€',color:'rgba(80,60,60,.3)',border:'#664444',label:'Skull'},
  {emoji:'â­',color:'rgba(201,168,76,.3)',border:'#e8c96a',label:'Star'},
  {emoji:'ğŸ ',color:'rgba(100,160,80,.25)',border:'#64a050',label:'Base'},
  {emoji:'ğŸš©',color:'rgba(200,60,60,.25)',border:'#c83c3c',label:'Flag'},
  {emoji:'ğŸ¯',color:'rgba(200,140,40,.25)',border:'#c88c28',label:'Target'},
  {emoji:'ğŸ‘‘',color:'rgba(201,168,76,.35)',border:'#e8c96a',label:'Crown'},
  {emoji:'ğŸ”®',color:'rgba(100,60,180,.3)',border:'#6440b4',label:'Crystal'},
  {emoji:'ğŸ—',color:'rgba(160,140,60,.3)',border:'#a08c3c',label:'Key'},
];

function renderPiecePanel(){
  const el=document.getElementById('piecePanel');
  if(!el)return;
  let html=`<div style="font-family:'Cinzel',serif;font-size:9px;color:var(--text3);letter-spacing:.07em;margin-bottom:8px;">TAP TO SPAWN ON BOARD</div>`;
  html+=PIECE_PRESETS.map(p=>`
    <div class="piece-spawn" onclick="spawnPiece('${p.emoji}','${p.color}','${p.border}','${p.label}')">
      <div class="ps-dot" style="background:${p.color};border-color:${p.border};">${p.emoji}</div>
      <span class="ps-label">${p.label}</span>
    </div>`).join('');
  html+=`<div style="padding:10px 0;border-top:1px solid var(--border);margin-top:4px;">
    <div style="font-family:'Cinzel',serif;font-size:9px;color:var(--text3);margin-bottom:6px;">CUSTOM PIECE</div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <input id="customPieceEmoji" value="â™Ÿ" maxlength="4" style="width:46px;background:var(--bg3);border:1px solid var(--border2);color:var(--text);padding:5px;border-radius:4px;font-size:16px;text-align:center;">
      <input type="color" id="customPieceColor" value="#4488cc" style="width:36px;height:34px;padding:2px;background:var(--bg3);border:1px solid var(--border2);border-radius:4px;cursor:pointer;">
      <button onclick="spawnCustomPiece()" style="flex:1;background:var(--bg3);border:1px solid var(--border2);color:var(--text2);padding:5px;border-radius:4px;font-family:'Cinzel',serif;font-size:9px;cursor:pointer;">SPAWN</button>
    </div>
  </div>
  <div style="border-top:1px solid var(--border);padding-top:8px;">
    <div style="font-family:'Cinzel',serif;font-size:9px;color:var(--text3);margin-bottom:4px;">ON BOARD (${pieces.length})</div>
    ${pieces.map((p,i)=>`<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--border);">
      <div style="width:24px;height:24px;border-radius:50%;background:${p.color};border:2px solid ${p.border};display:flex;align-items:center;justify-content:center;font-size:11px;">${p.emoji}</div>
      <span style="flex:1;font-size:11px;color:var(--text2);">${p.label||p.emoji}</span>
      <button onclick="removePiece(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:13px;padding:0 4px;">âœ•</button>
    </div>`).join('')}
  </div>`;
  el.innerHTML=html;
}
function spawnPiece(emoji,color,border,label){
  const board=document.getElementById('board');
  const wrap=document.getElementById('boardWrap');
  const scrollX=wrap.scrollLeft, scrollY=wrap.scrollTop;
  const cx=(scrollX+wrap.clientWidth/2)/boardZoom;
  const cy=(scrollY+wrap.clientHeight/2)/boardZoom;
  const id='piece_'+Date.now();
  const piece={id,emoji,color,border,label,x:cx-18,y:cy-18};
  pieces.push(piece);
  addPieceToBoard(piece,board);
  renderPiecePanel();
}
function spawnCustomPiece(){
  const emoji=document.getElementById('customPieceEmoji').value||'â™Ÿ';
  const color=document.getElementById('customPieceColor').value||'#4488cc';
  spawnPiece(emoji,`${color}44`,color,'Custom');
}
function addPieceToBoard(p,board){
  if(!board)board=document.getElementById('board');
  const el=document.createElement('div');
  el.className='piece-token';
  el.id=p.id;
  el.style.cssText=`left:${p.x}px;top:${p.y}px;background:${p.color};border-color:${p.border};`;
  el.textContent=p.emoji;
  el.addEventListener('pointerdown',e=>{
    e.stopPropagation();
    // Toggle select on tap
    if(selPiece===p.id){selPiece=null;el.classList.remove('selected-piece');return;}
    document.querySelectorAll('.piece-token').forEach(t=>t.classList.remove('selected-piece'));
    selPiece=p.id;
    el.classList.add('selected-piece');
    pieceDrag={id:p.id,startX:e.clientX,startY:e.clientY,pieceX:p.x,pieceY:p.y,moved:false};
    el.setPointerCapture(e.pointerId);
  });
  el.addEventListener('pointermove',e=>{
    if(!pieceDrag||pieceDrag.id!==p.id)return;
    const dx=(e.clientX-pieceDrag.startX)/boardZoom;
    const dy=(e.clientY-pieceDrag.startY)/boardZoom;
    if(Math.abs(dx)>4||Math.abs(dy)>4)pieceDrag.moved=true;
    if(pieceDrag.moved){p.x=pieceDrag.pieceX+dx;p.y=pieceDrag.pieceY+dy;el.style.left=p.x+'px';el.style.top=p.y+'px';}
  });
  el.addEventListener('pointerup',()=>{if(pieceDrag&&!pieceDrag.moved){/* tap select handled above */}pieceDrag=null;});
  board.appendChild(el);
}
function removePiece(i){
  const p=pieces[i];
  if(p){const el=document.getElementById(p.id);if(el)el.remove();}
  pieces.splice(i,1);
  renderPiecePanel();
}

// Close dice on outside click
document.addEventListener('click',e=>{
  const dp=document.getElementById('dicePanel');
  if(dp&&dp.classList.contains('open')&&!dp.contains(e.target)&&!e.target.closest('#fb-dice')){
    dp.classList.remove('open');
    document.getElementById('fb-dice').classList.remove('active');
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOARDGAME MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startBoardGame(layout){
  const game={
    id:'bg_'+Date.now(), name:layout?.name||'Board Game',
    mode:'boardgame',
    startHp:0,maxHand:0,maxField:0,resPerTurn:0,maxRes:0,
    players:layout?.players||2,
    phases:['Turn 1','Turn 2','Turn 3','Turn 4'].slice(0,layout?.players||2),
    winConds:[],rules:{},aiStyle:'none',aiDiff:'none',
  };
  const numPlayers=game.players;
  const players=[];
  for(let i=0;i<numPlayers;i++){
    players.push({id:'p'+(i+1),name:'Player '+(i+1),isAI:false,
      hp:0,maxHp:0,res:0,maxRes:0,hand:[],deck:[],graveyard:[],exile:[],
      field:[],score:0,poisonCounters:0,crystalHp:0});
  }
  G={game,layout,players,turn:0,activePlayer:0,phase:0,
    phases:game.phases,log:[],over:false,winner:null,
    selCard:null,selOwner:null,selLocation:null,
    grid:null,lanes:null,comboStack:[],comboScore:0,fusions:[],constructStage:[],
    zoneOwners:{}};
  pieces=[];
  showGameScreen(game,layout);
  initCounters();
  document.getElementById('phaseBtn').style.display='none';
  glog('Board game started. Use dice, pieces, and counters as needed.','phase');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadData();
renderSetup();
</script>
</body>
</html>
