<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
:root{--bg:#0d0d0f;--bg2:#13131a;--bg3:#1a1a24;--bg4:#222230;--border:#2e2e42;--border2:#3d3d58;--gold:#c9a84c;--gold2:#e8c97a;--text:#d4d4e8;--text2:#9090aa;--text3:#5a5870;--red:#cc5555;--green:#55aa77;--accent:#7b6cee;--accent2:#a99bff;}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:16px;min-height:100vh;display:flex;flex-direction:column;}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.4;}
.btn{padding:7px 12px;border:1px solid var(--border2);background:var(--bg3);color:var(--text);border-radius:3px;font-family:'Cinzel',serif;font-size:10px;letter-spacing:.06em;cursor:pointer;transition:all .15s;white-space:nowrap;}
.btn:active{border-color:var(--gold);color:var(--gold);}
.btn-gold{background:linear-gradient(135deg,#8a6a20,var(--gold));border-color:var(--gold2);color:#1a1200;font-weight:600;}
.btn-danger{border-color:var(--red);color:var(--red);}
.field{margin-bottom:12px;}
label{display:block;font-family:'Cinzel',serif;font-size:10px;letter-spacing:.08em;color:var(--text2);text-transform:uppercase;margin-bottom:4px;}
input[type="text"],input[type="color"],textarea,select{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:3px;font-family:'Crimson Pro',serif;font-size:15px;width:100%;outline:none;transition:border-color .2s;}
input:focus,textarea:focus{border-color:var(--gold);}
select option{background:var(--bg3);}
textarea{resize:vertical;min-height:80px;}

/* Board tabs */
.board-tabs{display:flex;gap:4px;padding:10px 14px;overflow-x:auto;flex-shrink:0;border-bottom:1px solid var(--border);}
.board-tabs::-webkit-scrollbar{display:none;}
.board-tab{padding:5px 12px;border:1px solid var(--border);border-radius:14px;font-family:'Cinzel',serif;font-size:9px;letter-spacing:.06em;cursor:pointer;white-space:nowrap;color:var(--text2);background:transparent;transition:all .15s;}
.board-tab.active{border-color:var(--gold);color:var(--gold);background:rgba(201,168,76,.08);}

/* Actions row */
.actions-row{display:flex;gap:6px;padding:8px 14px;flex-wrap:wrap;}

/* Kanban */
.kanban{flex:1;overflow-x:auto;overflow-y:hidden;display:flex;gap:10px;padding:10px 14px 20px;align-items:flex-start;}
.kanban::-webkit-scrollbar{height:4px;}.kanban::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.kanban-col{background:var(--bg2);border:1px solid var(--border);border-radius:6px;min-width:200px;max-width:280px;flex-shrink:0;display:flex;flex-direction:column;max-height:calc(100vh - 180px);}
.kanban-col-hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);}
.kanban-col-title{font-family:'Cinzel',serif;font-size:11px;color:var(--gold);letter-spacing:.08em;}
.kanban-col-count{background:var(--bg4);color:var(--text2);border-radius:10px;padding:1px 6px;font-family:'Cinzel',serif;font-size:9px;}
.kcol-del{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:0 2px;}
.kanban-cards{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:6px;}
.kanban-cards::-webkit-scrollbar{width:3px;}
.kanban-card{background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:10px;cursor:pointer;transition:border-color .15s;}
.kanban-card:active{border-color:var(--gold);}
.kanban-card-title{font-family:'Cinzel',serif;font-size:11px;color:var(--text);letter-spacing:.04em;}
.kanban-card-notes{font-size:12px;color:var(--text2);margin-top:4px;line-height:1.4;}
.tag-chip{display:inline-block;font-family:'Cinzel',serif;font-size:8px;letter-spacing:.06em;padding:2px 7px;border-radius:10px;border:1px solid;margin-top:6px;}
.kanban-add{background:none;border:1px dashed var(--border);color:var(--text3);padding:8px;border-radius:4px;cursor:pointer;font-family:'Cinzel',serif;font-size:10px;text-align:center;margin:8px;transition:all .15s;}
.kanban-add:active{border-color:var(--gold);color:var(--gold);}
.empty-state{text-align:center;padding:20px;color:var(--text3);font-style:italic;font-size:13px;}

/* Modals */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:8px 8px 0 0;width:100%;max-width:600px;max-height:92vh;overflow-y:auto;padding:20px;padding-bottom:calc(20px + env(safe-area-inset-bottom,0));}
.modal h2{font-family:'Cinzel',serif;font-size:16px;color:var(--gold);letter-spacing:.1em;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);}
.modal-actions{display:flex;gap:8px;margin-top:16px;justify-content:flex-end;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:var(--bg);}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
</style>
</head>
<body>

<div class="board-tabs" id="boardTabs"></div>
<div class="actions-row">
  <button class="btn" onclick="openAddCol()">+ Column</button>
  <button class="btn" onclick="openTagManager()">üè∑ Tags</button>
</div>
<div class="kanban" id="kanban"></div>

<!-- Card Modal -->
<div class="modal-overlay" id="modal-card">
  <div class="modal">
    <h2 id="cardModalTitle">Add Card</h2>
    <div class="field"><label>Title</label><input type="text" id="bcTitle" placeholder="Card title"></div>
    <div class="field"><label>Notes</label><textarea id="bcNotes" placeholder="Details‚Ä¶"></textarea></div>
    <div class="field"><label>Column</label><select id="bcCol"></select></div>
    <div class="field"><label>Tag</label><select id="bcTag"></select></div>
    <div class="modal-actions">
      <button class="btn btn-danger" id="delCardBtn" onclick="deleteCard()" style="display:none;">Delete</button>
      <button class="btn" onclick="closeModal('modal-card')">Cancel</button>
      <button class="btn btn-gold" onclick="saveCard()">Save</button>
    </div>
  </div>
</div>

<!-- Add Board Modal -->
<div class="modal-overlay" id="modal-board">
  <div class="modal">
    <h2>New Board</h2>
    <div class="field"><label>Board Name</label><input type="text" id="newBoardName" placeholder="e.g. My Project"></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('modal-board')">Cancel</button>
      <button class="btn btn-gold" onclick="saveNewBoard()">Create</button>
    </div>
  </div>
</div>

<!-- Add Column Modal -->
<div class="modal-overlay" id="modal-col">
  <div class="modal">
    <h2>New Column</h2>
    <div class="field"><label>Column Name</label><input type="text" id="newColName" placeholder="e.g. In Progress"></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('modal-col')">Cancel</button>
      <button class="btn btn-gold" onclick="saveNewCol()">Create</button>
    </div>
  </div>
</div>

<!-- Tag Manager Modal -->
<div class="modal-overlay" id="modal-tags">
  <div class="modal">
    <h2>Manage Tags</h2>
    <div id="tagList"></div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <input type="text" id="newTagName" placeholder="New tag name" style="flex:1;">
      <input type="color" id="newTagColor" value="#c9a84c" style="width:44px;padding:4px;cursor:pointer;">
      <button class="btn btn-gold" onclick="saveNewTag()">Add</button>
    </div>
    <div class="modal-actions"><button class="btn" onclick="closeModal('modal-tags')">Close</button></div>
  </div>
</div>

<script>
'use strict';
const DEFAULT_TAGS=[{id:'ngy',name:'No Gods Yet',color:'#e05050'},{id:'north',name:'North Eden Studios',color:'#c9a84c'},{id:'personal',name:'Personal',color:'#7b6cee'}];
let activeBoardId=null, editingCardId=null;

function getData(){try{const s=localStorage.getItem('chronicle_data');return s?JSON.parse(s):{};}catch(e){return{};}}
function saveData(d){localStorage.setItem('chronicle_data',JSON.stringify(d));}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2);}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function toast(m){if(window.parent!==window)window.parent.postMessage({type:'toast',msg:m},'*');}

function getBd(){const d=getData();if(!d.boards)d.boards={boards:[],cols:[],cards:[],tags:[]};return d;}
function getTags(bd){if(!bd.boards.tags||!bd.boards.tags.length)bd.boards.tags=[...DEFAULT_TAGS];return bd.boards.tags;}

function initBoards(){
  const d=getBd();const bd=d.boards;
  if(!bd.boards.length){
    const b1={id:uid(),name:'No Gods Yet'},b2={id:uid(),name:'Current Projects'};
    bd.boards.push(b1,b2);if(!bd.cols)bd.cols=[];
    ['Story','Art','RPG','Done'].forEach((n,i)=>bd.cols.push({id:uid(),boardId:b1.id,name:n,order:i}));
    ['To Do','In Progress','Done'].forEach((n,i)=>bd.cols.push({id:uid(),boardId:b2.id,name:n,order:i}));
    if(!bd.cards)bd.cards=[];
    activeBoardId=b1.id;saveData(d);
  } else {activeBoardId=bd.boards[0].id;}
  renderBoard();
}

function renderBoard(){
  const d=getBd();const bd=d.boards;const tags=getTags(d);
  // Tabs
  document.getElementById('boardTabs').innerHTML=bd.boards.map(b=>
    `<button class="board-tab${b.id===activeBoardId?' active':''}" onclick="switchBoard('${b.id}')">${esc(b.name)}</button>`
  ).join('')+`<button class="board-tab" onclick="openModal('modal-board')">+ Board</button>`;
  // Columns
  const cols=(bd.cols||[]).filter(c=>c.boardId===activeBoardId).sort((a,b)=>a.order-b.order);
  const k=document.getElementById('kanban');k.innerHTML='';
  cols.forEach(col=>{
    const cards=(bd.cards||[]).filter(c=>c.colId===col.id);
    const colEl=document.createElement('div');colEl.className='kanban-col';
    const cardsHtml=cards.map(card=>{
      const tag=tags.find(t=>t.id===card.tag);
      const tagHtml=tag?`<div><span class="tag-chip" style="color:${tag.color};border-color:${tag.color}40;background:${tag.color}15;">${esc(tag.name)}</span></div>`:'';
      return`<div class="kanban-card" onclick="openEditCard('${card.id}')"><div class="kanban-card-title">${esc(card.title)}</div>${card.notes?`<div class="kanban-card-notes">${esc(card.notes.slice(0,80))}${card.notes.length>80?'‚Ä¶':''}</div>`:''}${tagHtml}</div>`;
    }).join('');
    colEl.innerHTML=`<div class="kanban-col-hdr"><span class="kanban-col-title">${esc(col.name)}</span><div style="display:flex;align-items:center;gap:6px;"><span class="kanban-col-count">${cards.length}</span><button class="kcol-del" onclick="deleteCol('${col.id}')">√ó</button></div></div><div class="kanban-cards">${cardsHtml}</div><button class="kanban-add" onclick="openAddCard('${col.id}')">+ Add card</button>`;
    k.appendChild(colEl);
  });
}

function switchBoard(id){activeBoardId=id;renderBoard();}

// ‚ïê‚ïê‚ïê BOARD CRUD ‚ïê‚ïê‚ïê
function saveNewBoard(){
  const name=document.getElementById('newBoardName').value.trim();if(!name)return;
  const d=getBd();const b={id:uid(),name};d.boards.boards.push(b);
  if(!d.boards.cols)d.boards.cols=[];
  ['To Do','In Progress','Done'].forEach((n,i)=>d.boards.cols.push({id:uid(),boardId:b.id,name:n,order:i}));
  activeBoardId=b.id;saveData(d);closeModal('modal-board');renderBoard();toast('Board created ‚ú¶');
}

// ‚ïê‚ïê‚ïê COLUMN CRUD ‚ïê‚ïê‚ïê
function openAddCol(){document.getElementById('newColName').value='';openModal('modal-col');}
function saveNewCol(){
  const name=document.getElementById('newColName').value.trim();if(!name)return;
  const d=getBd();if(!d.boards.cols)d.boards.cols=[];
  const mx=Math.max(-1,...d.boards.cols.filter(c=>c.boardId===activeBoardId).map(c=>c.order));
  d.boards.cols.push({id:uid(),boardId:activeBoardId,name,order:mx+1});
  saveData(d);closeModal('modal-col');renderBoard();toast('Column added ‚ú¶');
}
function deleteCol(id){
  if(!confirm('Delete this column and all its cards?'))return;
  const d=getBd();d.boards.cols=(d.boards.cols||[]).filter(c=>c.id!==id);d.boards.cards=(d.boards.cards||[]).filter(c=>c.colId!==id);
  saveData(d);renderBoard();
}

// ‚ïê‚ïê‚ïê CARD CRUD ‚ïê‚ïê‚ïê
function populateSelects(colId,tagId){
  const d=getBd();const tags=getTags(d);
  const cols=(d.boards.cols||[]).filter(c=>c.boardId===activeBoardId).sort((a,b)=>a.order-b.order);
  document.getElementById('bcCol').innerHTML=cols.map(c=>`<option value="${c.id}"${c.id===colId?' selected':''}>${esc(c.name)}</option>`).join('');
  document.getElementById('bcTag').innerHTML='<option value="">None</option>'+tags.map(t=>`<option value="${t.id}"${t.id===tagId?' selected':''}>${esc(t.name)}</option>`).join('');
}
function openAddCard(colId){
  editingCardId=null;document.getElementById('cardModalTitle').textContent='Add Card';
  document.getElementById('bcTitle').value='';document.getElementById('bcNotes').value='';
  document.getElementById('delCardBtn').style.display='none';populateSelects(colId,'');openModal('modal-card');
}
function openEditCard(id){
  const d=getBd();const card=(d.boards.cards||[]).find(c=>c.id===id);if(!card)return;
  editingCardId=id;document.getElementById('cardModalTitle').textContent='Edit Card';
  document.getElementById('bcTitle').value=card.title;document.getElementById('bcNotes').value=card.notes||'';
  document.getElementById('delCardBtn').style.display='inline-block';populateSelects(card.colId,card.tag||'');openModal('modal-card');
}
function saveCard(){
  const title=document.getElementById('bcTitle').value.trim();if(!title)return;
  const d=getBd();if(!d.boards.cards)d.boards.cards=[];
  const card={id:editingCardId||uid(),boardId:activeBoardId,colId:document.getElementById('bcCol').value,title,notes:document.getElementById('bcNotes').value.trim(),tag:document.getElementById('bcTag').value};
  if(editingCardId){const i=d.boards.cards.findIndex(c=>c.id===editingCardId);if(i>=0)d.boards.cards[i]=card;}
  else d.boards.cards.push(card);
  saveData(d);closeModal('modal-card');renderBoard();toast('Card saved ‚ú¶');
}
function deleteCard(){
  if(!confirm('Delete this card?'))return;
  const d=getBd();d.boards.cards=(d.boards.cards||[]).filter(c=>c.id!==editingCardId);
  saveData(d);closeModal('modal-card');renderBoard();
}

// ‚ïê‚ïê‚ïê TAG MANAGER ‚ïê‚ïê‚ïê
function openTagManager(){renderTagList();openModal('modal-tags');}
function renderTagList(){
  const d=getBd();const tags=getTags(d);
  document.getElementById('tagList').innerHTML=tags.length?tags.map(t=>
    `<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><span class="tag-chip" style="color:${t.color};border-color:${t.color}40;background:${t.color}15;flex:1;">${esc(t.name)}</span><button class="btn btn-danger" style="font-size:9px;padding:3px 8px;" onclick="deleteTag('${t.id}')">Remove</button></div>`
  ).join(''):'<div class="empty-state">No tags yet.</div>';
}
function saveNewTag(){
  const name=document.getElementById('newTagName').value.trim();if(!name)return;
  const d=getBd();getTags(d);
  d.boards.tags.push({id:uid(),name,color:document.getElementById('newTagColor').value});
  saveData(d);renderTagList();document.getElementById('newTagName').value='';toast('Tag added ‚ú¶');
}
function deleteTag(id){
  const d=getBd();d.boards.tags=(d.boards.tags||[]).filter(t=>t.id!==id);
  (d.boards.cards||[]).forEach(c=>{if(c.tag===id)c.tag='';});
  saveData(d);renderTagList();renderBoard();
}

// ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê
function openModal(id){document.getElementById(id).classList.add('open');document.body.style.overflow='hidden';}
function closeModal(id){document.getElementById(id).classList.remove('open');document.body.style.overflow='';}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)closeModal(o.id);}));

initBoards();
document.addEventListener('visibilitychange',()=>{if(!document.hidden)renderBoard();});
</script>
</body>
</html>
