<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
:root{--bg:#0d0d0f;--bg2:#13131a;--bg3:#1a1a24;--bg4:#222230;--border:#2e2e42;--border2:#3d3d58;--gold:#c9a84c;--gold2:#e8c97a;--text:#d4d4e8;--text2:#9090aa;--text3:#5a5870;--red:#cc5555;--green:#55aa77;--accent:#7b6cee;--accent2:#a99bff;}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:16px;padding:10px 14px 40px;min-height:100vh;}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.4;}
.btn{padding:7px 12px;border:1px solid var(--border2);background:var(--bg3);color:var(--text);border-radius:3px;font-family:'Cinzel',serif;font-size:10px;letter-spacing:.06em;cursor:pointer;transition:all .15s;white-space:nowrap;}
.btn:active{border-color:var(--gold);color:var(--gold);}
.btn-gold{background:linear-gradient(135deg,#8a6a20,var(--gold));border-color:var(--gold2);color:#1a1200;font-weight:600;}
.btn-danger{border-color:var(--red);color:var(--red);}
.field{margin-bottom:12px;}
label{display:block;font-family:'Cinzel',serif;font-size:10px;letter-spacing:.08em;color:var(--text2);text-transform:uppercase;margin-bottom:4px;}
input[type="text"],textarea,select{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:3px;font-family:'Crimson Pro',serif;font-size:15px;width:100%;outline:none;}
input:focus,textarea:focus{border-color:var(--gold);}
select option{background:var(--bg3);}
textarea{resize:vertical;min-height:80px;line-height:1.6;}
.empty-state{text-align:center;padding:20px;color:var(--text3);font-style:italic;font-size:13px;}

/* View tabs */
.view-tabs{display:flex;gap:6px;margin-bottom:12px;}
.view-tabs .btn.active{background:linear-gradient(135deg,#8a6a20,var(--gold));border-color:var(--gold2);color:#1a1200;font-weight:600;}
.rpg-view{display:none;}
.rpg-view.active{display:block;}

/* Map */
.map-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:3px;margin-bottom:12px;}
.rpg-cell{aspect-ratio:1;background:var(--bg2);border:1px solid var(--border);border-radius:3px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;overflow:hidden;padding:2px;}
.rpg-cell:active{border-color:var(--gold);}
.rpg-cell.room{background:var(--bg3);border-color:var(--border2);}
.rpg-cell.selected{border-color:var(--gold);box-shadow:0 0 8px rgba(201,168,76,.3);}
.rpg-cell-label{font-family:'Cinzel',serif;font-size:6px;color:var(--text2);text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;}
#roomEditor{background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:14px;margin-bottom:12px;display:none;}

/* Scene Tree */
.tree-node{margin-left:0;margin-bottom:6px;}
.tree-card{background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:10px 12px;cursor:default;}
.tree-card.tree-start{border-left:3px solid var(--green);}
.tree-card.tree-end{border-left:3px solid var(--red);}
.tree-card-title{font-family:'Cinzel',serif;font-size:12px;color:var(--text);letter-spacing:.04em;}
.tree-badge{font-family:'Cinzel',serif;font-size:8px;letter-spacing:.06em;padding:1px 6px;border-radius:10px;margin-left:6px;}
.tree-badge-start{background:rgba(85,170,119,.2);color:var(--green);border:1px solid rgba(85,170,119,.4);}
.tree-badge-end{background:rgba(204,85,85,.2);color:var(--red);border:1px solid rgba(204,85,85,.4);}
.tree-card-narr{font-size:12px;color:var(--text2);margin-top:4px;font-style:italic;line-height:1.4;}
.tree-children{margin-left:16px;border-left:2px solid var(--border);padding-left:12px;margin-top:4px;}
.tree-branch-label{font-family:'Cinzel',serif;font-size:10px;color:var(--accent2);padding:4px 0;margin-bottom:4px;}
.tree-add{background:none;border:1px dashed var(--border);color:var(--text3);padding:5px 10px;border-radius:3px;font-family:'Cinzel',serif;font-size:9px;cursor:pointer;margin:4px 0;display:block;transition:all .15s;}
.tree-add:active{border-color:var(--gold);color:var(--gold);}

/* Playtest */
.pt-stats{display:flex;gap:8px;margin-bottom:12px;}
.pt-stat{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:8px;text-align:center;}
.pt-stat-label{font-family:'Cinzel',serif;font-size:8px;color:var(--text3);letter-spacing:.08em;margin-bottom:4px;}
.pt-stat-bar{height:5px;background:var(--bg4);border-radius:3px;overflow:hidden;margin-bottom:2px;}
.pt-stat-fill{height:100%;border-radius:3px;transition:width .5s;}
.pt-stat-val{font-family:'Cinzel',serif;font-size:12px;color:var(--gold);}
.pt-scene{font-family:'Cinzel',serif;font-size:10px;color:var(--text3);letter-spacing:.1em;text-align:center;margin-bottom:8px;}
.pt-narr{background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:14px;font-size:15px;line-height:1.7;margin-bottom:12px;}
.pt-btn{display:block;width:100%;padding:12px;background:var(--bg3);border:1px solid var(--border2);border-radius:4px;color:var(--text);font-family:'Crimson Pro',serif;font-size:15px;cursor:pointer;margin-bottom:6px;text-align:left;transition:all .15s;}
.pt-btn:active{border-color:var(--gold);color:var(--gold);}

/* Modals */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:8px 8px 0 0;width:100%;max-width:600px;max-height:92vh;overflow-y:auto;padding:20px;padding-bottom:calc(20px + env(safe-area-inset-bottom,0));}
.modal h2{font-family:'Cinzel',serif;font-size:16px;color:var(--gold);letter-spacing:.1em;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);}
.modal-actions{display:flex;gap:8px;margin-top:16px;justify-content:flex-end;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:var(--bg);}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
</style>
</head>
<body>

<div class="view-tabs">
  <button class="btn active" id="vMap" onclick="switchView('map')">üó∫ Map</button>
  <button class="btn" id="vScenes" onclick="switchView('scenes')">üå≥ Scenes</button>
  <button class="btn" id="vPlay" onclick="switchView('play')">‚ñ∂ Playtest</button>
  <button class="btn btn-gold" id="addSceneBtn" onclick="openAddScene()" style="margin-left:auto;">+ Scene</button>
</div>

<!-- MAP VIEW -->
<div class="rpg-view active" id="view-map">
  <div class="map-grid" id="mapGrid"></div>
  <div id="roomEditor">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <span style="font-family:Cinzel,serif;font-size:11px;color:var(--gold);letter-spacing:.08em;" id="roomEdTitle">Add Location</span>
      <button class="btn" style="font-size:9px;padding:4px 8px;" onclick="closeRoomEditor()">‚úï</button>
    </div>
    <div class="field"><label>Icon</label><input type="text" id="roomIcon" value="üìç" style="width:60px;text-align:center;font-size:20px;"></div>
    <div class="field"><label>Name</label><input type="text" id="roomName" placeholder="Location name"></div>
    <div class="field"><label>District</label><input type="text" id="roomDistrict" placeholder="e.g. Midstack"></div>
    <div class="field"><label>Description</label><textarea id="roomDesc" placeholder="Brief description‚Ä¶" style="min-height:50px;"></textarea></div>
    <div style="display:flex;gap:6px;">
      <button class="btn btn-gold" onclick="saveRoom()">Save</button>
      <button class="btn btn-danger" onclick="deleteRoom()">Delete</button>
    </div>
  </div>
</div>

<!-- SCENES VIEW -->
<div class="rpg-view" id="view-scenes">
  <div id="sceneTree"></div>
</div>

<!-- PLAYTEST VIEW -->
<div class="rpg-view" id="view-play">
  <div class="pt-stats">
    <div class="pt-stat"><div class="pt-stat-label">HEALTH</div><div class="pt-stat-bar"><div class="pt-stat-fill" id="pt-hp" style="width:100%;background:var(--red);"></div></div><div class="pt-stat-val" id="pt-hp-v">100</div></div>
    <div class="pt-stat"><div class="pt-stat-label">ASCENSION</div><div class="pt-stat-bar"><div class="pt-stat-fill" id="pt-asc" style="width:20%;background:var(--accent2);"></div></div><div class="pt-stat-val" id="pt-asc-v">20</div></div>
    <div class="pt-stat"><div class="pt-stat-label">TOTEMS</div><div class="pt-stat-bar"><div class="pt-stat-fill" id="pt-tot" style="width:100%;background:var(--gold);"></div></div><div class="pt-stat-val" id="pt-tot-v">3</div></div>
  </div>
  <div class="pt-scene" id="ptScene"></div>
  <div class="pt-narr" id="ptNarr"></div>
  <div id="ptChoices"></div>
  <div id="ptLog" style="margin-top:12px;"></div>
</div>

<!-- Scene Modal -->
<div class="modal-overlay" id="modal-scene">
  <div class="modal">
    <h2 id="sceneModalTitle">New Scene</h2>
    <div class="field"><label>Title</label><input type="text" id="sceneTitle" placeholder="Scene title"></div>
    <div class="field"><label>Type</label>
      <select id="sceneType"><option value="normal">Normal</option><option value="start">Start</option><option value="end">End</option></select>
    </div>
    <div class="field"><label>Narration</label><textarea id="sceneNarr" placeholder="What happens in this scene‚Ä¶" style="min-height:120px;"></textarea></div>
    <div style="font-family:Cinzel,serif;font-size:10px;color:var(--gold);letter-spacing:.1em;margin:12px 0 8px;">CHOICES</div>
    <div id="choiceFields"></div>
    <button class="btn" style="width:100%;margin-top:4px;" onclick="addChoiceField()">+ Add Choice</button>
    <div class="modal-actions">
      <button class="btn btn-danger" id="delSceneBtn" onclick="deleteScene()" style="display:none;">Delete</button>
      <button class="btn" onclick="closeModal('modal-scene')">Cancel</button>
      <button class="btn btn-gold" onclick="saveScene()">Save</button>
    </div>
  </div>
</div>

<script>
'use strict';
const ROWS=6,COLS=8;
let selectedCell=null,editingSceneId=null,ptState=null,parentLinkInfo=null;

function getData(){try{const s=localStorage.getItem('chronicle_data');return s?JSON.parse(s):{};}catch(e){return{};}}
function saveData(d){localStorage.setItem('chronicle_data',JSON.stringify(d));}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2);}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function toast(m){if(window.parent!==window)window.parent.postMessage({type:'toast',msg:m},'*');}

function getRpg(){const d=getData();if(!d.rpg)d.rpg={rooms:{},scenes:[],ptHistory:[]};return d;}
function initRpg(){
  const d=getRpg();
  if(!d.rpg.scenes||!d.rpg.scenes.length){
    // Seed default scenes
    const s1=uid(),s2a=uid(),s2b=uid(),s3=uid(),s4=uid();
    d.rpg.scenes=[
      {id:s1,title:'The Alley Shortcut',type:'start',narr:'The shortcut reeks. Scratch shifts on your shoulder.\n\n"Smells like piss and death."\n\nTimer\'s running.',choices:[
        {text:'Take the shortcut',outcome:'You move fast. Something moves in the shadows.',nextId:s2a,effect:{hp:-5,asc:0}},
        {text:'Go the long way',outcome:'Slower. Timer is tight but you arrive intact.',nextId:s2b,effect:{hp:0,asc:0}},
      ]},
      {id:s2a,title:'First Delivery',type:'normal',narr:'Customer has partial Beast features. Takes the package and pauses.\n\n"Westside Collective is recruiting aggressive today."',choices:[{text:'Continue',outcome:'The window closes.',nextId:s3,effect:{hp:0,asc:0}}]},
      {id:s2b,title:'The Long Route',type:'normal',narr:'Clean streets. Quiet. Scratch dozes on your shoulder.',choices:[{text:'Keep moving',outcome:'Uneventful. On time.',nextId:s3,effect:{hp:0,asc:0}}]},
      {id:s3,title:'The Encounter',type:'normal',narr:'A Kin flickers, fades ‚Äî defeated. The antagonist notices you watching.',choices:[
        {text:'Break eye contact',outcome:'Not my problem.',nextId:s4,effect:{hp:0,asc:-5}},
        {text:'Hold eye contact',outcome:'A long second. They smile.',nextId:s4,effect:{hp:0,asc:5}},
      ]},
      {id:s4,title:'The Call',type:'end',narr:'Home. Your phone rings. Sister\'s face.\n\n"They took my Totem, Cross. Just because they could."',choices:[]},
    ];
    if(!Object.keys(d.rpg.rooms||{}).length){
      d.rpg.rooms={'0,0':{name:'Lowstack',district:'Feral',icon:'üêÄ',desc:'Bottom rung.'},'2,3':{name:'Midstack',district:'Residential',icon:'üè†',desc:'Cross\' home district.'},'2,4':{name:'Cross\' Apt',district:'Midstack',icon:'üö™',desc:'Small, lived in.'},'3,4':{name:'Dispatch Hub',district:'Midstack',icon:'üì¶',desc:'Delivery pickups.'},'4,2':{name:'Titan Corp',district:'Corporate',icon:'üè¢',desc:'Major corp.'},'5,6':{name:'The Ascended',district:'High Spire',icon:'‚ú®',desc:'Near the top.'}};
    }
    saveData(d);
  }
}

// ‚ïê‚ïê‚ïê VIEW SWITCHING ‚ïê‚ïê‚ïê
function switchView(v){
  ['map','scenes','play'].forEach(n=>{
    document.getElementById('view-'+n).classList.toggle('active',n===v);
    document.getElementById('v'+n.charAt(0).toUpperCase()+n.slice(1)).classList.toggle('active',n===v);
  });
  document.getElementById('addSceneBtn').style.display=v==='scenes'?'block':'none';
  if(v==='map')renderMap();
  if(v==='scenes')renderSceneTree();
  if(v==='play')initPlaytest();
}

// ‚ïê‚ïê‚ïê MAP ‚ïê‚ïê‚ïê
function renderMap(){
  const d=getRpg();const grid=document.getElementById('mapGrid');grid.innerHTML='';
  for(let r=0;r<ROWS;r++){for(let c=0;c<COLS;c++){
    const key=`${r},${c}`;const room=d.rpg.rooms[key];
    const cell=document.createElement('div');
    cell.className='rpg-cell'+(room?' room':'')+(key===selectedCell?' selected':'');
    if(room)cell.innerHTML=`<span style="font-size:14px">${room.icon||'üìç'}</span><span class="rpg-cell-label">${esc((room.name||'').slice(0,8))}</span>`;
    cell.onclick=()=>selectCell(key);grid.appendChild(cell);
  }}
}
function selectCell(key){
  selectedCell=key;renderMap();
  const d=getRpg();const room=d.rpg.rooms[key];
  document.getElementById('roomEditor').style.display='block';
  document.getElementById('roomEdTitle').textContent=room?'Edit Location':'Add Location';
  document.getElementById('roomName').value=room?room.name:'';
  document.getElementById('roomDistrict').value=room?room.district:'';
  document.getElementById('roomDesc').value=room?room.desc:'';
  document.getElementById('roomIcon').value=room?room.icon:'üìç';
}
function saveRoom(){
  const name=document.getElementById('roomName').value.trim();if(!name||!selectedCell)return;
  const d=getRpg();d.rpg.rooms[selectedCell]={name,district:document.getElementById('roomDistrict').value.trim(),desc:document.getElementById('roomDesc').value.trim(),icon:document.getElementById('roomIcon').value||'üìç'};
  saveData(d);closeRoomEditor();renderMap();toast('Location saved ‚ú¶');
}
function deleteRoom(){if(!selectedCell||!confirm('Remove?'))return;const d=getRpg();delete d.rpg.rooms[selectedCell];saveData(d);closeRoomEditor();renderMap();}
function closeRoomEditor(){selectedCell=null;document.getElementById('roomEditor').style.display='none';renderMap();}

// ‚ïê‚ïê‚ïê SCENE TREE ‚ïê‚ïê‚ïê
function renderSceneTree(){
  const d=getRpg();const el=document.getElementById('sceneTree');
  if(!d.rpg.scenes||!d.rpg.scenes.length){el.innerHTML='<div class="empty-state">No scenes yet. Add one to start.</div>';return;}
  const referenced=new Set(d.rpg.scenes.flatMap(s=>(s.choices||[]).map(c=>c.nextId).filter(Boolean)));
  const roots=d.rpg.scenes.filter(s=>s.type==='start'||(s.type!=='end'&&!referenced.has(s.id)));
  if(!roots.length)roots.push(d.rpg.scenes[0]);
  const rendered=new Set();el.innerHTML='';
  roots.forEach(r=>el.appendChild(buildNode(r,d.rpg,rendered,0)));
  d.rpg.scenes.filter(s=>!rendered.has(s.id)).forEach(s=>{
    const lbl=document.createElement('div');lbl.style.cssText='font-family:Cinzel,serif;font-size:10px;color:var(--text2);margin:14px 0 6px;letter-spacing:.08em;';lbl.textContent='‚Äî UNLINKED ‚Äî';
    el.appendChild(lbl);el.appendChild(buildNode(s,d.rpg,rendered,0));
  });
}
function buildNode(scene,rpg,rendered,depth){
  if(rendered.has(scene.id)||depth>10){const ref=document.createElement('div');ref.style.cssText='font-size:11px;color:var(--accent2);padding:4px 10px;font-style:italic;';ref.textContent=`‚Ü© ${scene.title} (above)`;return ref;}
  rendered.add(scene.id);
  const node=document.createElement('div');node.className='tree-node';
  const card=document.createElement('div');card.className='tree-card'+(scene.type==='start'?' tree-start':scene.type==='end'?' tree-end':'');
  card.innerHTML=`<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px;"><div style="flex:1;"><div class="tree-card-title">${esc(scene.title)}${scene.type==='start'?'<span class="tree-badge tree-badge-start">START</span>':scene.type==='end'?'<span class="tree-badge tree-badge-end">END</span>':''}</div><div class="tree-card-narr">${esc((scene.narr||'').slice(0,80))}${(scene.narr||'').length>80?'‚Ä¶':''}</div></div><button class="btn" style="font-size:9px;padding:2px 7px;" onclick="event.stopPropagation();editScene('${scene.id}')">Edit</button></div>`;
  node.appendChild(card);
  (scene.choices||[]).forEach((ch,ci)=>{
    const branch=document.createElement('div');branch.className='tree-children';
    const lbl=document.createElement('div');lbl.className='tree-branch-label';
    lbl.textContent=`‚ñ∏ ${ch.text}${ch.outcome?' ‚Äî "'+ch.outcome.slice(0,40)+(ch.outcome.length>40?'‚Ä¶':'')+'"':''}`;
    branch.appendChild(lbl);
    if(ch.nextId){const child=rpg.scenes.find(s=>s.id===ch.nextId);if(child)branch.appendChild(buildNode(child,rpg,rendered,depth+1));else{const m=document.createElement('div');m.style.cssText='font-size:11px;color:var(--red);padding:4px;';m.textContent='‚ö† Missing scene';branch.appendChild(m);}}
    else{const ab=document.createElement('button');ab.className='tree-add';ab.textContent='+ Link next scene';ab.onclick=()=>{parentLinkInfo={sceneId:scene.id,choiceIdx:ci};openAddScene();};branch.appendChild(ab);}
    node.appendChild(branch);
  });
  if(scene.type!=='end'){const ac=document.createElement('button');ac.className='tree-add';ac.style.marginTop='4px';ac.textContent='+ Add choice';ac.onclick=()=>editScene(scene.id);node.appendChild(ac);}
  return node;
}

// ‚ïê‚ïê‚ïê SCENE CRUD ‚ïê‚ïê‚ïê
function openAddScene(){
  editingSceneId=null;document.getElementById('sceneModalTitle').textContent='New Scene';
  document.getElementById('sceneTitle').value='';document.getElementById('sceneNarr').value='';document.getElementById('sceneType').value='normal';
  document.getElementById('delSceneBtn').style.display='none';document.getElementById('choiceFields').innerHTML='';
  addChoiceField();openModal('modal-scene');
}
function editScene(id){
  const d=getRpg();const s=d.rpg.scenes.find(x=>x.id===id);if(!s)return;
  editingSceneId=id;parentLinkInfo=null;
  document.getElementById('sceneModalTitle').textContent='Edit Scene';
  document.getElementById('sceneTitle').value=s.title;document.getElementById('sceneNarr').value=s.narr||'';document.getElementById('sceneType').value=s.type||'normal';
  document.getElementById('delSceneBtn').style.display='inline-block';document.getElementById('choiceFields').innerHTML='';
  (s.choices||[]).forEach(ch=>addChoiceField(ch.text,ch.outcome,ch.nextId));
  if(!(s.choices||[]).length)addChoiceField();openModal('modal-scene');
}
function addChoiceField(text='',outcome='',nextId=''){
  const fields=document.getElementById('choiceFields');if(fields.children.length>=5)return;
  const i=fields.children.length;const d=getRpg();
  const opts=(d.rpg.scenes||[]).filter(s=>s.id!==editingSceneId).map(s=>`<option value="${s.id}"${s.id===nextId?' selected':''}>${esc(s.title)}</option>`).join('');
  const div=document.createElement('div');div.style.cssText='margin-bottom:10px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:10px;';
  div.innerHTML=`<div style="display:flex;justify-content:space-between;margin-bottom:6px;"><span style="font-family:Cinzel,serif;font-size:10px;color:var(--text2);">Choice ${i+1}</span><button type="button" onclick="this.closest('div[style]').remove()" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:14px;">√ó</button></div><div class="field" style="margin-bottom:6px;"><label>Text</label><input type="text" class="ch-text" value="${esc(text)}" placeholder="What the player does‚Ä¶"></div><div class="field" style="margin-bottom:6px;"><label>Outcome</label><textarea class="ch-out" style="min-height:40px;" placeholder="What happens‚Ä¶">${esc(outcome)}</textarea></div><div class="field"><label>‚Üí Leads to</label><select class="ch-next"><option value="">‚Äî Dead end ‚Äî</option>${opts}</select></div>`;
  fields.appendChild(div);
}
function saveScene(){
  const title=document.getElementById('sceneTitle').value.trim();if(!title)return;
  const choices=[];
  document.querySelectorAll('#choiceFields>[style]').forEach(div=>{
    const t=div.querySelector('.ch-text').value.trim();const o=div.querySelector('.ch-out').value.trim();const n=div.querySelector('.ch-next').value;
    if(t)choices.push({text:t,outcome:o,nextId:n||null,effect:{hp:0,asc:0}});
  });
  const d=getRpg();const sceneId=editingSceneId||uid();
  const scene={id:sceneId,title,narr:document.getElementById('sceneNarr').value.trim(),type:document.getElementById('sceneType').value,choices};
  if(editingSceneId){const i=d.rpg.scenes.findIndex(s=>s.id===editingSceneId);if(i>=0)d.rpg.scenes[i]=scene;}
  else d.rpg.scenes.push(scene);
  if(parentLinkInfo){const p=d.rpg.scenes.find(s=>s.id===parentLinkInfo.sceneId);if(p&&p.choices[parentLinkInfo.choiceIdx])p.choices[parentLinkInfo.choiceIdx].nextId=sceneId;parentLinkInfo=null;}
  saveData(d);closeModal('modal-scene');renderSceneTree();toast('Scene saved ‚ú¶');
}
function deleteScene(){if(!confirm('Delete this scene?'))return;const d=getRpg();d.rpg.scenes=d.rpg.scenes.filter(s=>s.id!==editingSceneId);saveData(d);closeModal('modal-scene');renderSceneTree();}

// ‚ïê‚ïê‚ïê PLAYTEST ‚ïê‚ïê‚ïê
function initPlaytest(){
  const d=getRpg();
  if(!d.rpg.scenes||!d.rpg.scenes.length){document.getElementById('ptNarr').innerHTML='<em>No scenes yet.</em>';document.getElementById('ptChoices').innerHTML='';return;}
  if(!ptState){const start=d.rpg.scenes.find(s=>s.type==='start')||d.rpg.scenes[0];ptState={sceneId:start.id,hp:100,asc:20,totems:3,log:[]};}
  renderPlaytest();
}
function renderPlaytest(){
  if(!ptState)return;const d=getRpg();updateStats();
  const scene=d.rpg.scenes.find(s=>s.id===ptState.sceneId);
  if(!scene){document.getElementById('ptNarr').innerHTML='<em>Scene not found.</em>';document.getElementById('ptChoices').innerHTML=`<button class="pt-btn" onclick="ptRestart()">‚Ü∫ Restart</button>`;return;}
  document.getElementById('ptScene').textContent=`‚Äî ${scene.title.toUpperCase()} ‚Äî`;
  document.getElementById('ptNarr').innerHTML=scene.narr.replace(/\n/g,'<br>');
  const ce=document.getElementById('ptChoices');
  if(scene.type==='end'||!scene.choices||!scene.choices.length){ce.innerHTML=`<div style="font-family:Cinzel,serif;font-size:11px;color:var(--text2);text-align:center;margin-bottom:8px;">${scene.type==='end'?'‚Äî END ‚Äî':'‚Äî No choices ‚Äî'}</div><button class="pt-btn" onclick="ptRestart()">‚Ü∫ Play Again</button>`;}
  else{ce.innerHTML=scene.choices.map((ch,i)=>`<button class="pt-btn" onclick="ptChoose(${i})">‚ñ∏ ${esc(ch.text)}</button>`).join('');}
  renderLog();
}
function ptChoose(i){
  const d=getRpg();const scene=d.rpg.scenes.find(s=>s.id===ptState.sceneId);if(!scene)return;
  const ch=scene.choices[i];if(!ch)return;
  ptState.hp=Math.max(0,Math.min(100,ptState.hp+(ch.effect?.hp||0)));
  ptState.asc=Math.max(0,Math.min(100,ptState.asc+(ch.effect?.asc||0)));
  ptState.log.push({scene:scene.title,choice:ch.text,outcome:ch.outcome});
  updateStats();
  document.getElementById('ptScene').textContent=`‚Äî ${scene.title.toUpperCase()} ‚Äî`;
  document.getElementById('ptNarr').innerHTML=`<span style="color:var(--gold2);font-style:italic;">${esc(ch.outcome||'...')}</span>`;
  if(ch.nextId){document.getElementById('ptChoices').innerHTML=`<button class="pt-btn" onclick="ptGoto('${ch.nextId}')">‚ñ∏ Continue ‚Üí</button>`;}
  else{document.getElementById('ptChoices').innerHTML=`<div style="font-family:Cinzel,serif;font-size:11px;color:var(--text2);text-align:center;margin-bottom:8px;">‚Äî Dead end ‚Äî</div><button class="pt-btn" onclick="ptRestart()">‚Ü∫ Restart</button>`;}
  renderLog();
}
function ptGoto(id){ptState.sceneId=id;renderPlaytest();}
function ptRestart(){const d=getRpg();const s=d.rpg.scenes.find(x=>x.type==='start')||d.rpg.scenes[0];ptState={sceneId:s?s.id:null,hp:100,asc:20,totems:3,log:[]};renderPlaytest();}
function updateStats(){if(!ptState)return;['hp','asc'].forEach(k=>{const el=document.getElementById('pt-'+k);const v=document.getElementById('pt-'+k+'-v');if(el)el.style.width=ptState[k]+'%';if(v)v.textContent=ptState[k];});const t=document.getElementById('pt-tot');const tv=document.getElementById('pt-tot-v');if(t)t.style.width=(ptState.totems/3*100)+'%';if(tv)tv.textContent=ptState.totems;}
function renderLog(){const el=document.getElementById('ptLog');if(!ptState||!ptState.log.length){el.innerHTML='';return;}el.innerHTML=ptState.log.slice(-4).reverse().map(e=>`<div style="background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:8px 12px;margin-bottom:6px;"><div style="font-family:Cinzel,serif;font-size:10px;color:var(--text2);margin-bottom:3px;">${esc(e.scene)}</div><div style="font-size:12px;color:var(--text2);font-style:italic;">‚ñ∏ ${esc(e.choice)}</div>${e.outcome?`<div style="font-size:13px;color:var(--text);margin-top:4px;">${esc(e.outcome)}</div>`:''}</div>`).join('');}

// ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê
function openModal(id){document.getElementById(id).classList.add('open');document.body.style.overflow='hidden';}
function closeModal(id){document.getElementById(id).classList.remove('open');document.body.style.overflow='';}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)closeModal(o.id);}));

initRpg();renderMap();
document.addEventListener('visibilitychange',()=>{if(!document.hidden){renderMap();renderSceneTree();}});
</script>
</body>
</html>
